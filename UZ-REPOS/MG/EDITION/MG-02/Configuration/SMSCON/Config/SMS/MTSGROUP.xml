<templateGroup name="MTSGROUP">
   <macros>
      <define name="_ENCODING" value="unicodefffe" />
      <define name="_MTSGROUP_SERVICE_NUMBER" value="100" />
      <define name="_USSDCON" value="USSDCON_01" />
      <define name="_SMSCON" value="SMSCON_01" />
      <define name="_SMS_SERVICE_NUMBER" value="100" />
   </macros>
   <template procedureName="AddToGroup_onClean_MTSGROUP" sessionStorage="Memory">
      <condition>
         <test item="0" matches="1" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
            <Item sInvited="${sInvited}" sInviter="${sInviter}" timestamp="@{now}">
               <sGroupType>${sGroupType}</sGroupType>
            </Item>
         </Message>
      </receiveTemplate>
      <deliveryTemplate conditionEx="#{'${sGroupType}'='MTSGROUP' and '${sInviter}'!='${sInvited}'}" call="AddToGroup_onClean_MTSGROUP1">
         <set item="Content" value="${sInviter} ${sInvited}" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Sender" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
   </template>
   <template procedureName="AddToGroup_onClean_MTSGROUP1" onClean="AddToGroup_onClean" sessionStorage="Memory" sessionLifetime="86400">
      <condition>
         <test matches="1" item="0" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" session_id="@{setSessionId(MTSGROUP#{substring('${token1}',string-length('${token1}')-12)})}" type="verificationrequest" id="@{newGuid}">
            <Item customer="${Sender}">
               <Attribute value="0" name="checkivrservice" />
               <Attribute value="0" name="checkblocks" />
               <Attribute value="CUGCH" name="grouptype" />
            </Item>
         </Message>
      </receiveTemplate>
      <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'='${Customer}'}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Content" value="У абонента ${sInvited} есть ваше активное приглашение. Чтобы принять его абонент ${sInvited} должен отправить СМС со словом Да на номер 100" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'!='${Customer}'}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Content" value="У абонента ${sInvited} есть активное приглашение в другую группу. Повторите запрос позже" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate direction="input" conditionEx="#{'${Customer}'='#{substring('${session_id}',string-length('${session_id}')-11)}'}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Content" value="Номер приглашенного абонента ${Customer} совпадает с вашим. Заявка не принята" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate direction="input" call="AddToGroup1_MTSGROUP">
         <set item="Content" value="AddToGroup1(#{substring('${session_id}',string-length('${session_id}')-11)})" />
         <set item="Sender" value="${customer}" />
         <set item="Recipient" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{store(sAlreadyInvited,1)}" />
         <set conditionEx="0@{store(sInviter,${Customer})}" />
         <set conditionEx="0@{store(sInvited,#{substring('${session_id}',string-length('${session_id}')-11)})}" />
         <set conditionEx="0@{store(sTryCount,1)}" />
         <set conditionEx="0@{store(sGroupType,${grouptype})}" />
      </deliveryTemplate>
   </template>
   <template procedureName="AddToGroup1_MTSGROUP" sessionStorage="Memory" sessionLifetime="86400">
      <condition>
         <test matches="1" item="0" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" session_id="${SessionId}" type="verificationrequest" id="@{newGuid}">
            <Item customer="${sInviter}">
               <Attribute value="0" name="checkivrservice" />
               <Attribute value="0" name="checkblocks" />
            </Item>
         </Message>
      </receiveTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup1_MTSGROUP">
         <set conditionEx="0@{store(sTryCount,#{number('${sTryCount}')+1})}" />
         <set item="Content" value="AddToGroup1(0*${sInvited}*${sTryCount})" />
         <set item="Sender" value="${sInviter}" />
         <set item="Recipient" value="_MTSGROUP_SERVICE_NUMBER" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}!=0}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Content" value="На тарифном плане абонента ${sInviter} услуга недоступна" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/MTSGROUP/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Content" value="На тарифном плане абонента ${sInviter} услуга недоступна" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/MTSGROUP/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}" call="AddToGroup2_MTSGROUP">
         <set conditionEx="0@{store(sInviterRegion,${regioncode})}" />
         <set conditionEx="0@{store(sTryCount,1)}" />
         <set item="Content" value="AddToGroup2(0*${sInvited})" />
         <set item="Sender" value="${sInviter}" />
         <set item="Recipient" value="_MTSGROUP_SERVICE_NUMBER" />
      </deliveryTemplate>
   </template>
   <template procedureName="AddToGroup2_MTSGROUP" sessionStorage="Memory" sessionLifetime="86400">
      <condition>
         <test matches="1" item="0" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" session_id="${SessionId}" type="verificationrequest" id="@{newGuid}">
            <Item customer="${sInvited}">
               <Attribute value="0" name="checkivrservice" />
               <Attribute value="0" name="checkblocks" />
            </Item>
         </Message>
      </receiveTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup2_MTSGROUP">
         <set conditionEx="0@{store(sTryCount,#{number('${sTryCount}')+1})}" />
         <set item="Content" value="AddToGroup2(0*${sInvited}*${sTryCount})" />
         <set item="Sender" value="${sInviter}" />
         <set item="Recipient" value="_MTSGROUP_SERVICE_NUMBER" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}!=0}">
         <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/MTSGROUP/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
         <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and '${regioncode}'!='${sInviterRegion}'}">
         <set item="Content" value="Добавление абонента ${sInvited} невозможно, он из другого региона" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/MTSGROUP/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}" call="AddToGroup3_MTSGROUP">
         <set conditionEx="0@{store(sTryCount,1)}" />
         <set item="Content" value="AddToGroup3(0*${sInvited})" />
         <set item="Sender" value="${sInviter}" />
         <set item="Recipient" value="_MTSGROUP_SERVICE_NUMBER" />
      </deliveryTemplate>
   </template>
   <template procedureName="AddToGroup3_MTSGROUP" sessionStorage="Memory" sessionLifetime="86400">
      <condition>
         <test matches="1" item="0" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" session_id="${SessionId}" type="customergroup" id="@{newGuid}">
            <Item action="2" customer="${sInviter}">
               <Attribute value="0" name="groupmember" />
               <Attribute value="645" name="index" />
            </Item>
         </Message>
      </receiveTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and string-length('${grouplisting}') &gt;= 89}">
         <set item="Content" value="Превышен лимит абонентов в группе" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate call="AddToGroup6_MTSGROUP">
         <set item="Content" value="AddToGroup6(0*${sInvited})" />
         <set item="Sender" value="${sInviter}" />
         <set item="Recipient" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
   </template>
   <template procedureName="AddToGroup6_MTSGROUP" sessionStorage="Memory" sessionLifetime="86400">
      <condition>
         <test matches="1" item="0" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" session_id="${SessionId}" type="customergroup" id="@{newGuid}">
            <Item action="2" customer="${sInvited}">
               <Attribute value="0" name="groupmember" />
               <Attribute value="645" name="index" />
            </Item>
         </Message>
      </receiveTemplate>
      <deliveryTemplate conditionEx="#{'${grouplisting}'!='' and not (contains('${grouplisting}','${sInviter}'))}">
         <set item="Content" value="Абонент ${sInvited} входит в состав другой группы" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{'${grouplisting}'!='' and contains('${grouplisting}','${sInviter}')}">
         <set item="Content" value="Абонент ${sInvited} уже входит в состав вашей группы" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" conditionEx="#{${dbresult}=0}">
         <set item="Content" value="Абоненту ${sInvited} отправлено ваше приглашение в группу" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0}">
         <set item="Content" value="Приглашение в группу 'MTS Group' от ${sInviter}.Ответьте ДА или НЕТ на _MTSGROUP_SERVICE_NUMBER" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate>
         <set item="Content" value="Ошибка при проверке состава группы" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
   </template>
   <template procedureName="ListOfGroup_MTSGROUP">
      <condition>
         <test matches="^_MTSGROUP_SERVICE_NUMBER$" item="${Recipient}" />
         <test item="${Content}" matches="^\s*([IiИи][NnНн][FfФф][OoОо])\s*$" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" session_id="@{newGuid}" type="customergroup" id="${guid}">
            <Item action="2" customer="${Sender}">
               <Attribute value="0" name="groupmember" />
               <Attribute value="645" name="index" />
            </Item>
         </Message>
      </receiveTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0}">
         <set item="Content" value="#{if('${grouplisting}'='','Вы не состоите ни в одной группе','Состав группы: ${grouplisting}')}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate>
         <set item="Content" value="Ошибка получения списка группы" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
   </template>
   <template procedureName="DelFromGroup_MTSGROUP">
      <condition>
         <test matches="^_MTSGROUP_SERVICE_NUMBER$" item="${Recipient}" />
         <test item="${Content}" matches="^\s*([DdДд][EeЕе][LlЛл])\s*$" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" session_id="@{newGuid}" type="customergroup" id="${guid}">
            <Item action="1" customer="${Sender}">
               <Attribute value="0" name="groupmember" />
               <Attribute value="645" name="index" />
            </Item>
         </Message>
      </receiveTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0}">
         <set item="Content" value="Заявка на удаление из группы зарегистрирована" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate condition="//Item/@dbresult=320708">
         <set item="Content" value="Вы не состоите в группе" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate>
         <set item="Content" value="Ошибка удаления из группы" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
   </template>
   <template procedureName="DelInvitation_MTSGROUP" sessionStorage="Memory" sessionLifetime="86400">
      <condition>
         <test matches="^_MTSGROUP_SERVICE_NUMBER$" item="${Recipient}" />
         <test matches="(^\s*[NnНн][OoОо]\s*$)|(^\s*[NnНн][EeЕе][TtТт]\s*$)" item="${Content}" />
      </condition>
      <receiveTemplate>
         <Message session_id="@{setSessionId(MTSGROUP${Sender})}" id="@{newGuid}">
            <Item customer="${Sender}" />
         </Message>
      </receiveTemplate>
      <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'=''}">
         <set item="Content" value="У вас нет активных приглашений" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" direction="input">
         <set item="Content" value="Абонент ${sInvited} не подтвердил участие в группе. Ваше приглашение аннулировано." />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate direction="input">
         <set item="Content" value="Вы не подтвердили участие в группе. Приглашение аннулировано." />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
   </template>
   <template procedureName="AddToGroup_onResponse_MTSGROUP" sessionStorage="Memory" sessionLifetime="86400">
      <condition>
         <test matches="^_MTSGROUP_SERVICE_NUMBER$" item="${Recipient}" />
         <test matches="^\s*(([DdДд][AaАа])|([YyУу][EeЕе][SsСс]))\s*$" item="${Content}" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" session_id="@{setSessionId(MTSGROUP${Sender})}" type="verificationrequest" id="@{newGuid}">
            <Item customer="${Sender}">
               <Attribute value="0" name="checkivrservice" />
               <Attribute value="0" name="checkblocks" />
            </Item>
            @{store(sGroupType,'MTSGROUP')}
         </Message>
      </receiveTemplate>
      <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'=''}@{store(sAlreadyInvited,)}">
         <set item="Content" value="У вас нет активных приглашений" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup_onResponse_MTSGROUP">
         <set conditionEx="0@{store(sTryCount,#{number(${sTryCount})+1})}" />
         <set conditionEx="0@{store(sAlreadyInvited,1)" />
         <set item="Content" value="AddToGroup_onResponse(Da*${sTryCount})" />
         <set item="Sender" value="${sInvited}" />
         <set item="Recipient" value="_MTSGROUP_SERVICE_NUMBER" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" conditionEx="#{${dbresult}!=0}">
         <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна." />
         <set item="Recipient" value="${sInvited}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}!=0}">
         <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна." />
         <set item="Recipient" value="${sInviter}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/MTSGROUP/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
         <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна." />
         <set item="Recipient" value="${sInvited}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/MTSGROUP/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
         <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна." />
         <set item="Recipient" value="${sInviter}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/MTSGROUP/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}" call="AddToGroup_onResponse2_MTSGROUP">
         <set conditionEx="0@{store(sTryCount,1)}" />
         <set conditionEx="0@{store(sInvitedRegion,${regioncode})}" />
         <set item="Content" value="AddToGroup_onResponse2(Da)" />
         <set item="Sender" value="${sInvited}" />
         <set item="Recipient" value="_MTSGROUP_SERVICE_NUMBER" />
      </deliveryTemplate>
   </template>
   <template procedureName="AddToGroup_onResponse2_MTSGROUP" sessionStorage="Memory" sessionLifetime="86400">
      <condition>
         <test matches="1" item="0" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" session_id="${SessionId}" type="verificationrequest" id="WHITEEGG#{substring('@{newGuid}',1,28)}">
            <Item customer="${sInviter}">
               <Attribute value="0" name="checkivrservice" />
               <Attribute value="0" name="checkblocks" />
            </Item>
         </Message>
      </receiveTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{'${dbresult}'='320203'}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup_onResponse2_MTSGROUP">
         <set conditionEx="0@{store(sTryCount,#{number(${sTryCount})+1})}" />
         <set item="Content" value="AddToGroup_onResponse2(Da*${sTryCount})" />
         <set item="Sender" value="${sInvited}" />
         <set item="Recipient" value="_MTSGROUP_SERVICE_NUMBER" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" conditionEx="#{${dbresult}!=0}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Content" value="На тарифном плане абонента ${sInviter} услуга недоступна." />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}!=0}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Content" value="На тарифном плане абонента ${sInviter} услуга недоступна." />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/MTSGROUP/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Content" value="На тарифном плане абонента ${sInviter} услуга недоступна." />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/MTSGROUP/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Content" value="На тарифном плане абонента ${sInviter} услуга недоступна." />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" conditionEx="#{${dbresult}=0 and '${regioncode}'!='${sInvitedRegion}'}">
         <set item="Content" value="Добавление абонента ${sInvited} невозможно, он из другого региона" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and '${regioncode}'!='${sInvitedRegion}'}">
         <set item="Content" value="Добавление абонента ${sInvited} невозможно, он из другого региона" />
         <set item="Encoding" value="_ENCODING" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/MTSGROUP/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}" call="AddToGroup_onResponse3_MTSGROUP">
         <set conditionEx="0@{store(sInviterRegion,${regioncode})}" />
         <set conditionEx="0@{store(sTryCount,1)}" />
         <set item="Sender" value="${sInvited}" />
         <set item="Recipient" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Content" value="AddToGroup_onResponse3_MTSGROUP(Da)" />
      </deliveryTemplate>
   </template>
   <template procedureName="AddToGroup_onResponse3_MTSGROUP" sessionStorage="Memory" sessionLifetime="86400">
      <condition>
         <test matches="1" item="0" />
      </condition>
      <receiveTemplate>
         <Message initiator="smscon" session_id="${SessionId}" type="customergroup" id="@{newGuid}">
            <Item action="0" customer="${Sender}">
               <Attribute value="${sInviter}" name="groupmember" />
               <Attribute value="645" name="index" />
            </Item>
         </Message>
      </receiveTemplate>
      <deliveryTemplate terminating="false" condition="//Item/@dbresult=320204">
         <set item="Content" value="Группа МТС на тарифном плане абонента ${sInvited} недоступна." />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate condition="//Item/@dbresult=320204">
         <set item="Content" value="Группа МТС на вашем тарифном плане недоступна." />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" condition="//Item/@dbresult=320191">
         <set item="Content" value="Недостаточно средств на лицевом счете для выполнения операции" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate condition="//Item/@dbresult=320191">
         <set item="Content" value="Недостаточно средств на лицевом счете для выполнения операции" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" condition="//Item/@dbresult=-1">
         <set item="Content" value="Есть открытые заявки на обработку. Повторите запрос позже" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate condition="//Item/@dbresult=-1">
         <set item="Content" value="Есть открытые заявки на обработку. Повторите запрос позже" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" condition="//Item/@dbresult=320705">
         <set item="Content" value="Превышен лимит абонентов в группе." />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate condition="//Item/@dbresult=320705">
         <set item="Content" value="Превышен лимит абонентов в группе" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" condition="//Item/@dbresult=320706">
         <set item="Content" value="Абонент ${sInvited} входит в состав другой группы" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate condition="//Item/@dbresult=320706">
         <set item="Content" value="Абонент ${sInvited} входит в состав другой группы" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate terminating="false" condition="//Item/@dbresult=0">
         <set item="Content" value="Заявка на добавление абонента ${sInvited} в группу зарегистрирована" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInviter}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate condition="//Item/@dbresult=0">
         <set item="Content" value="Заявка на добавление в группу зарегистрирована." />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${sInvited}" />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
      <deliveryTemplate>
         <set item="Recipient" value="${sInvited}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Content" value="Операция недоступна. Обратитесь в службу поддержки МТС." />
         <set item="Encoding" value="_ENCODING" />
         <set conditionEx="0@{freeSession}" />
      </deliveryTemplate>
   </template>
   <template procedureName="ListOfGroup_MTSGROUP_USSD">
      <condition>
         <test matches="1" item="0" />
      </condition>
      <receiveTemplate>
         <Message />
      </receiveTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0}">
         <set item="Content" value="#{if('${grouplisting}'='','Вы не состоите ни в одной группе','Состав группы: ${grouplisting}')}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate>
         <set item="Content" value="Ошибка получения списка группы" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
   </template>
   <template procedureName="DelFromGroup_MTSGROUP_USSD">
      <condition>
         <test matches="1" item="0" />
      </condition>
      <receiveTemplate>
         <Message />
      </receiveTemplate>
      <deliveryTemplate conditionEx="#{${dbresult}=0}">
         <set item="Content" value="Заявка на удаление из группы зарегистрирована" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate condition="//Item/@dbresult=320708">
         <set item="Content" value="Вы не состоите в группе" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate>
         <set item="Content" value="Ошибка удаления из группы" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Recipient" value="${Customer}" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
   </template>
   <template procedureName="AddToGroup_MTSGROUP" sessionStorage="Memory">
      <condition>
         <test matches="1" item="0" />
      </condition>
      <deliveryTemplate terminating="false">
         <set item="Content" value="Абонент ${sInvited}  не подтвердил участие в группе. Ваше приглашение аннулировано." />
         <set item="Recipient" value="${sInviter}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate>
         <set item="Content" value="Вы не подтвердили участие в группе. Приглашение аннулировано." />
         <set item="Recipient" value="${sInvited}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
   </template>
   <template procedureName="AddToGroup_onClean" sessionStorage="Memory">
      <condition>
         <test item="0" matches="1" />
      </condition>
      <deliveryTemplate terminating="false">
         <set item="Content" value="Абонент ${sInvited} не подтвердил участие в группе. Ваше приглашение аннулировано." />
         <set item="Recipient" value="${sInviter}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
      <deliveryTemplate>
         <set item="Content" value="Вы не подтвердили участие в группе. Приглашение аннулировано." />
         <set item="Recipient" value="${sInvited}" />
         <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
         <set item="Encoding" value="_ENCODING" />
      </deliveryTemplate>
   </template>
</templateGroup>