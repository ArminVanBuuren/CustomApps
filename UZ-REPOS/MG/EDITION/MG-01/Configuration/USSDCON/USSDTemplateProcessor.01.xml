<templates connector="USSD">
  <macros>
    <!-- ==========================  REDIRECT CONNECTORS   ========================= -->
    <define name="_SMSCON_1" value="SMSCON_01_01" />
    <define name="_SMSCON_ISSA" value="SMSCON_01_ISSA" />
    <define name="_DBCON" value="DBCON_01_01" />
    <!-- ==========================  REDIRECT CONNECTORS   ========================= -->
    <!-- ==========================  USSD SPECIAL   ========================= -->
    <define name="_USSD_SRV_COMM" value="#{replace('_PARCE_CONTENT','_USSD_SRV_RGPATT','$1')}" />
    <define name="_USSD_SRV_ACT" value="@{switch(#{replace('_PARCE_CONTENT','_USSD_SRV_RGPATT','$3')}|,_CONFIRM_VALUE|_CONFIRM_VALUE,0|0,2|0,1|1)}" />
    <define name="_USSD_SRV_DEAL" value="#{replace('_PARCE_CONTENT','_USSD_SRV_RGPATT','$5')}" />
    <define name="_USSD_SRV_RGPATT" value="^(\*.{3,}?(\*|)(_CONFIRM_VALUE|[0-9]|))(\*(\d{9})|)$|^.*$" />
    <define name="_USSD_PTP_SRV" value="#{replace('_PARCE_CONTENT','_USSD_PTP_RGPATT','$1$7')}" />
    <define name="_USSD_PTP_RECEIVER" value="#{replace('_PARCE_CONTENT','_USSD_PTP_RGPATT','$4$5')}" />
    <define name="_USSD_PTP_AMOUNT" value="#{replace('_PARCE_CONTENT','_USSD_PTP_RGPATT','$6')}" />
    <define name="_USSD_PTP_RGPATT" value="^(.*?)(\*\+|\*)((\d{12}|)|(\d{12})\*([1-5])|)$|^(.*)$" />
    <define name="_PARCE_LANG" value="#{replace('${Content}','^(.*)\|(.*)$|^.*$','$1')}" />
    <define name="_PARCE_CONTENT" value="#{replace('${Content}','^(.*)\|(.*)$|^.*$','$2')}" />
    <define name="_DEALER_NUM" value="\*\d{9}" />
    <define name="_PORTAL_ASSIGN_TOKENS" value="#{if('${sTokens}'!='' and '${Content}'='0','_PORTAL_STEP_BACK','#{if('${sTokens}'!='' and '${Content}'='*','_PORTAL_STEP_BCKTOTOP','#{if(matches('${Content}','_RGPATT_NTFREQ'),_PORTAL_STEP_NEXT,'_USSD_CONTENT')}')}')}" />
    <define name="_PORTAL_STEP_NEXT" value="concat('${sTokens}','*','${Content}')" />
    <define name="_PORTAL_STEP_BACK" value="#{replace('${sTokens}','\*\d+$|\*[_RGPATT_SPEC_SYMB]$','')}" />
    <define name="_PORTAL_STEP_BCKTOTOP" value="#{replace('${sTokens}','(\*00)+$','')}" />
    <define name="_GET_PORTAL_ANSWER" value="#{document('_DEALERPORTAL_PATH')/Portal/Item[code/@value='${sTokens}']/@info__GET_LANG}" />
    <define name="_GET_PORTAL_LENGTH_ANSWER" value="#{string-length(document('_DEALERPORTAL_PATH')/Portal/Item[code/@value='${sTokens}']/@info__GET_LANG)}" />
    <define name="_USSD_CHECK_NUMBER" value="#{replace('${Content}','^\*_DEF_USSDNUM\*\d{4}\*(\d{7})\#$','$1')}" />
    <define name="_USSD_CHECK_MASK" value="#{replace('${Content}','^\*_DEF_USSDNUM\*\d{3}\*(\d{4})\#$','$1')}" />
    <define name="_NUMBER_STATUS" value="#{replace('${result}','STATUS:(\d)_CATEGORY:(\w*)_REGION:(\d{6})','$1')}" />
    <define name="_NUMBER_CATEGORY" value="#{document('_SERIES_PATH')/InfoList/Category[code/@value='#{replace('${result}','STATUS:(\d)_CATEGORY:(\w*)_REGION:(\d{6})','$2')}']/@info}" />
    <define name="_NUMBER_REGION" value="#{document('_SERIES_PATH')/InfoList/Region[code/@value='#{replace('${result}','STATUS:(\d)_CATEGORY:(\w*)_REGION:(\d{6})','$3')}']/@info}" />
    <define name="_SLUJEB_TP_NUMBER" value="#{replace('${Content}','^\*_DEF_USSDNUM\*4444\*(99897\d{7})\*(\d{5})\#$','$1')}" />
    <define name="_SLUJEB_TP_CODE" value="#{replace('${Content}','^\*_DEF_USSDNUM\*4444\*(99897\d{7})\*(\d{5})\#$','$2')}" />
    <define name="_USSD_CONTENT" value="#{replace('_USSD_RGPATT','^_USSD_NUMBER','')}" />
    <define name="_USSD_NUMBER" value="#{replace('_USSD_RGPATT','\*.*','')}" />
    <define name="_USSD_RGPATT" value="#{replace('${Content}','^\*(.+)\#.*$|^.*$','$1')}" />
    <define name="_SBSCR_LANGUAGE" value="#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[_CURRENT_MODULE/@value='${sTokens}']/@param}" />
    <define name="_COUNTERS_NOTPCOUNTERS" value="#{document('_COUNTERS_PATH')/Counters/Group[_CURRENT_MODULE/@value='${sCountertype}']/@checktpcounters_nocounters__GET_LANG}" />
    <define name="_COUNTERS_NOONETIMECOUNTERS" value="#{document('_COUNTERS_PATH')/Counters/Group[_CURRENT_MODULE/@value='${sCountertype}']/@checkonetimecounters_nocounters__GET_LANG}" />
    <define name="_IS_NTFREQ_COMMAND" value="matches('${sContent}','_RGPATT_NTFREQ')" />
    <define name="_RGPATT_NTFREQ" value="^\d+(\*\d+|)+$|^[_RGPATT_SPEC_SYMB]$" />
    <define name="_RGPATT_SPEC_SYMB" value="?" />
    <define name="_DEF_USSDNUM" value="171" />
    <!-- ==========================  USSD SPECIAL   ========================= -->
    <!-- ==========================  SERVICE PROVISIONING  ========================= -->
    <define name="_GET_SERVICE_RESULT" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_${sDbresult}__GET_LANG}'='','#{if('#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@info_${sDbresult}__GET_LANG}'='','_GET_DBRESULT','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@info_${sDbresult}__GET_LANG}')}','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_${sDbresult}__GET_LANG}')}" />
    <define name="_GET_CONFIRM_SERVICE_RESULT" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='_SERVICE_CODE']/@info_${sDbresult}__GET_LANG}'='','#{if('#{document('_SERVICE_PATH')/ServiceList/Group[@name='#{document('_SERVICE_PATH')/ServiceList/GroupList/Item[@id='#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='_SERVICE_CODE']/@group}']/@name}']/@info_${sDbresult}__GET_LANG}'='','_GET_DBRESULT','#{document('_SERVICE_PATH')/ServiceList/Group[@name='#{document('_SERVICE_PATH')/ServiceList/GroupList/Item[@id='#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='_SERVICE_CODE']/@group}']/@name}']/@info_${sDbresult}__GET_LANG}')}','#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='_SERVICE_CODE']/@info_${sDbresult}__GET_LANG}')}" />
    <define name="_SERVICE_CONFIRM_NAME" value="#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='_SERVICE_CODE']/@service_name__GET_LANG}" />
    <define name="_SERVICE_TP_CNT" value="#{if(count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}']/ivrcode)&gt;0,count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}']/ivrcode),count(document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}']/ivrcode))}" />
    <define name="_SERVICE_TP_ISAVAIL" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@available}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@available}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/tplist[1]/@available}')}" />
    <define name="_SERVICE_TP_NOTAVALINFO" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@info_notaval__GET_LANG}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@info_notaval__GET_LANG}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/tplist[1]/@info_notaval__GET_LANG}')}" />
    <define name="_SERVICE_CUSTLST_CNT" value="#{if(count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/customer[@value='${customer}']/@value)&gt;0,count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/customer[@value='${customer}']/@value),count(document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/customerlist[1]/customer[@value='${customer}']/@value))}" />
    <define name="_SERVICE_CUSTLST_ISAVAIL" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@available}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@available}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/customerlist[1]/@available}')}" />
    <define name="_SERVICE_CUSTLST_NOTAVAILINFO" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@info_notaval__GET_LANG}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@info_notaval__GET_LANG}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/customerlist[1]/@info_notaval__GET_LANG}')}" />
    <define name="_SERVICE_SRVBIND_CNT" value="#{if(count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service)&gt;0,count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service),count(document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/servicebindinglist[1]/service))}" />
    <define name="_SERVICE_SRVBIND_SRVCODE" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@service_code}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@service_code}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@service_code}')}" />
    <define name="_SERVICE_SRVBIND_SUBSR" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@subscription}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@subscription}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@subscription}')}" />
    <define name="_SERVICE_SRVBIND_STORE" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@store}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@store}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@store}')}" />
    <define name="_SERVICE_SRVBIND_INFO" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}')}" />
    <define name="_SERVICE_SUCCESSFUL_RESPONSE" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@successful_response}'='','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@successful_response}','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@successful_response}')}" />
    <define name="_SERVICE_CHECKBLOCK" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@check_block}'='','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@check_block}','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@check_block}')}" />
    <define name="_SERVICE_REDIRECT" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@redirect}'='','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@redirect}','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@redirect}')}" />
    <define name="_SERVICE_AVAIL_BAL" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@availbalance}'='','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@availbalance}','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@availbalance}')}" />
    <define name="_SERVICE_TIMETOPROGRESS" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='#{if('${sServiceCode}'='','_SERVICE_CODE','${sServiceCode}')}']/@timetoprogress}'='','#{document('_SERVICE_PATH')/ServiceList/Group[@name='#{if('${sGroupName}'='','_SERVICE_GROUPNAME','${sGroupName}')}']/@timetoprogress}','#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='#{if('${sServiceCode}'='','_SERVICE_CODE','${sServiceCode}')}']/@timetoprogress}')}" />
    <define name="_SERVICE_DATEFROM" value="#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@datefrom}" />
    <define name="_SERVICE_DATETO" value="#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@dateto}" />
    <define name="_SERVICE_NAME" value="#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@service_name__GET_LANG}" />
    <define name="_SERVICE_GROUPNAME" value="#{document('_SERVICE_PATH')/ServiceList/GroupList/Item[@id='#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@group}']/@name}" />
    <define name="_SERVICE_COMM_ACTION" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[_CURRENT_MODULE/@value='${sAction}']/@action}" />
    <define name="_SERVICE_COMM_STATUS" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[_CURRENT_MODULE/@value='${sAction}']/@status}" />
    <define name="_SERVICE_COMM_CODE" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[_CURRENT_MODULE/@value='${sAction}']/@code}" />
    <define name="_SERVICE_COMM_ACTPARCE" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[_CURRENT_MODULE/@value='${sAction}']/@parce}" />
    <define name="_SERVICE_CRMSTATUS" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[@status='${subscription}']/@parce}" />
    <define name="_SERVICE_CRMACTION_ADD" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[@action='2']/@parce}" />
    <define name="_SERVICE_CRMACTION_DEL" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[@action='3']/@parce}" />
    <define name="_SERVICE_CODE" value="#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@service_code}" />
    <!-- ==========================  SERVICE PROVISIONING  ========================= -->
    <!-- ==========================  CHANGE TP   ========================= -->
    <define name="_GET_TARIFF_RESULT" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@info_${sDbresult}__GET_LANG}'='','#{if('#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@info_${sDbresult}__GET_LANG}'='','_GET_DBRESULT','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@info_${sDbresult}__GET_LANG}')}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@info_${sDbresult}__GET_LANG}')}" />
    <define name="_GET_CONFIRM_TARIFF_RESULT" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@info_${sDbresult}__GET_LANG}'='','#{if('#{document('_TARIF_PATH')/TariffPlans/Group[@name='#{document('_TARIF_PATH')/TariffPlans/GroupList/Item[@id='#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@group}']/@name}']/@info_${sDbresult}__GET_LANG}'='','_GET_DBRESULT','#{document('_TARIF_PATH')/TariffPlans/Group[@name='#{document('_TARIF_PATH')/TariffPlans/GroupList/Item[@id='#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@group}']/@name}']/@info_${sDbresult}__GET_LANG}')}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@info_${sDbresult}__GET_LANG}')}" />
    <define name="_TARIFF_TP_CNT" value="#{if(count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}'])&gt;0,count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}']),count(document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}']))}" />
    <define name="_TARIFF_TP_ISAVAIL" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@available}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@available}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@available}')}" />
    <define name="_TARIFF_TP_NOTAVAILINFO" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@info_notaval__GET_LANG}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@info_notaval__GET_LANG}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@info_notaval__GET_LANG}')}" />
    <define name="_TARIFF_CUSTLST_CNT" value="#{if(count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/customer[@value='${customer}'])&gt;0,count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/customer[@value='${customer}']),count(document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/customerlist[1]/customer[@value='${customer}']))}" />
    <define name="_TARIFF_CUSTLST_ISAVAIL" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/@available}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/@available}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/customerlist[1]/@available}')}" />
    <define name="_TARIFF_CUSTLST_NOTAVAILINFO" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/@info_notaval__GET_LANG}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/@info_notaval__GET_LANG}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/customerlist[1]/@info_notaval__GET_LANG}')}" />
    <define name="_TARIFF_SRVBIND_CNT" value="#{if(count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service)&gt;0,count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service),count(document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/servicebindinglist[1]/service))}" />
    <define name="_TARIFF_SRVBIND_SRVCODE" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@service_code}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@service_code}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@service_code}')}" />
    <define name="_TARIFF_SRVBIND_SUBSR" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@subscription}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@subscription}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@subscription}')}" />
    <define name="_TARIFF_SRVBIND_STORE" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@store}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@store}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@store}')}" />
    <define name="_TARIFF_SRVBIND_INFO" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}')}" />
    <define name="_TARIFF_SUCCESSFUL_RESPONSE" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@successful_response}'='','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@successful_response}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@successful_response}')}" />
    <define name="_TARIFF_CHECKBLOCK" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@check_block}'='','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@check_block}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@check_block}')}" />
    <define name="_TARIFF_REDIRECT" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@redirect}'='','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@redirect}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@redirect}')}" />
    <define name="_TARIFF_TIMETOPROGRESS" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='#{if('${sTariffIvrCode}'='','_TARIFF_IVRCODE','${sTariffIvrCode}')}']/@timetoprogress}'='','#{document('_TARIF_PATH')/TariffPlans/Group[@name='#{if('${sGroupName}'='','_TARIFF_GROUPNAME','${sGroupName}')}']/@timetoprogress}','#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='#{if('${sTariffIvrCode}'='','_TARIFF_IVRCODE','${sTariffIvrCode}')}']/@timetoprogress}')}" />
    <define name="_TARIFF_AVAIL_BAL" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@availbalance}'='','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@availbalance}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@availbalance}')}" />
    <define name="_TARIFF_DATEFROM" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@datefrom}" />
    <define name="_TARIFF_DATETO" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@dateto}" />
    <define name="_TARIFF_NAME" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@tariffname__GET_LANG}" />
    <define name="_TARIFF_GROUPNAME" value="#{document('_TARIF_PATH')/TariffPlans/GroupList/Item[@id='#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@group}']/@name}" />
    <define name="_TARIFF_CURRENT_NAME" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='#{//Message/Item/@tariffplan}']/@tariffname__GET_LANG}" />
    <define name="_TARIFF_IVRCODE" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@ivrcode}" />
    <define name="_TARIFF_BALANCE_NAME" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='${sTariffIvrCode}']/@tariffname__GET_LANG}" />
    <!-- ==========================  CHANGE TP  ========================= -->
    <!-- ==========================  ALL SERVICE   ========================= -->
    <define name="_COUNTERS_TYPE" value="#{document('_COUNTERS_PATH')/Counters/Group[_CURRENT_MODULE/@value='${sCountertype}']/@name}" />
    <define name="_GET_ALL_SRV_RESULT" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_${sDbresult}__GET_LANG}" />
    <define name="_ALLSERVICE_TP_CNT" value="count(document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}'])" />
    <define name="_ALLSERVICE_TP_ISAVAIL" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@available}" />
    <define name="_ALLSERVICE_TP_NOTAVAILINFO" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@info_notaval__GET_LANG}" />
    <define name="_ALLSERVICE_CUSTLST_CNT" value="count(document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/customer[@value='${customer}'])" />
    <define name="_ALLSERVICE_CUSTLST_ISAVAIL" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@available}" />
    <define name="_ALLSERVICE_CUSTLST_NOTAVAILINFO" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@info_notaval__GET_LANG}" />
    <define name="_ALLSERVICE_SRVBIND_CNT" value="count(document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service)" />
    <define name="_ALLSERVICE_SRVBIND_SRVCODE" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@service_code}" />
    <define name="_ALLSERVICE_SRVBIND_SUBSR" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@subscription}" />
    <define name="_ALLSERVICE_SRVBIND_STORE" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@store}" />
    <define name="_ALLSERVICE_SRVBIND_INFO" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}" />
    <define name="_ALLSERVICE_SUCCESSFUL_RESPONSE" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@successful_response}" />
    <define name="_ALLSERVICE_CHECKBLOCK" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@check_block}" />
    <define name="_ALLSERVICE_REDIRECT" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@redirect}" />
    <define name="_ALLSERVICE_TIMETOPROGRESS" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@timetoprogress}" />
    <define name="_ALLSERVICE_AVAIL_BAL" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@availbalance}" />
    <define name="_ALLSERVICE_NAME" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@name}" />
    <!-- ==========================  ALL SERVICE   ========================= -->
    <!-- ==========================  SETTINGS   ========================= -->
    <define name="_WAIT_IFASYNC_INPROCESS" value="#{if('${sDbresult}'='redirect','#{if(not(matches('${sInProgress}','_IF_TRUE')),'true','')}','')}" />
    <define name="_GET_TODAY" value="#{concat(substring('@{now}',7,4),substring('@{now}',4,2),substring('@{now}',1,2))}" />
    <define name="_GET_SECONDS" value="#{(number(substring('@{now}',12,2)) * 60 * 60) + (number(substring('@{now}',15,2)) * 60) + number(substring('@{now}',18,2))}" />
    <define name="_GET_DBRESULT" value="#{document('_DICTIONARY_PATH')/Dictionary/Item[code/@value='${sDbresult}']/@info__GET_LANG}" />
    <define name="_GET_LENGTH_DBRESULT" value="#{string-length(document('_DICTIONARY_PATH')/Dictionary/Item[code/@value='${sDbresult}']/@info__GET_LANG)}" />
    <define name="_GET_AFTER_VERIFY_DBRESULT" value="#{if('#{document('_DICTIONARY_PATH')/Dictionary/Item[code/@value='${customerblocks}']/@info__GET_LANG}'!='','${customerblocks}','${dbresult}')}" />
    <define name="_ENCODING" value="#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@param='_GET_LANG']/@encoding}" />
    <define name="_INLANGUAGE" value="#{if('#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@language_id='${language_id}']/@param}'='','#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@language_id='']/@param}','#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@language_id='${language_id}']/@param}')}" />
    <define name="_GET_LANG" value="#{if('${sLang}'='','#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@language_id='']/@param}','${sLang}')}" />
    <define name="_GET_USD_COURCE" value="#{document('_DICTIONARY_PATH')/Dictionary/Converter/Currency[@from='840' and @to='860']/@value}" />
    <define name="_DEFAULT_ERR" value="#{if('${dbresult}'='-1','err001','${dbresult}')}" />
    <define name="_REDIRECT_TO_SMS" value="^[Ss][Mm][Ss]$" />
    <define name="_REDIRECT_TO_CURRENT" value="^[Nn][Oo][Tt][Rr][Ee][Dd][Ii][Rr][Ee][Cc][Tt]$" />
    <define name="_IF_TRUE" value="^([Tt][Rr][Uu][Ee]|1)$" />
    <define name="_BYCRM" value="[Bb][Yy][Cc][Rr][Mm]" />
    <define name="_CURRENT_MODULE" value="#{if('${sModule}'!='','${sModule}','dealerussd')}" />
    <define name="_SERVICE_PATH" value="..\..\Config\Service\SERVICE.xml" />
    <define name="_ALLSERVICE_PATH" value="..\..\Config\Service\All_SERVICE.xml" />
    <define name="_TARIF_PATH" value="..\..\Config\Tariff\TARIFF_PLANS.xml" />
    <define name="_COUNTERS_PATH" value="..\..\Config\Service\COUNTERS.xml" />
    <define name="_DICTIONARY_PATH" value="..\..\Config\DICTIONARY.xml" />
    <define name="_DEALERPORTAL_PATH" value="..\..\Config\Portal\DealerUSSDPortal_01.xml" />
    <define name="_SERIES_PATH" value="..\..\Config\Service\SERIES.xml" />
    <define name="_CONFIRM_VALUE" value="confirm" />
    <define name="_CURRENT_INITIATOR" value="ussd" />
    <!-- ==========================  SETTINGS   ========================= -->
  </macros>
  <template procedureName="RequestCheckCounters" sessionStorage="Memory" sessionLifetime="30" persistent="false">
    <condition>
      <test item="_USSD_NUMBER" matches="^(102|103)$" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(ReqCheckCounters_${Sender})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
        @{store(sTokens,_USSD_NUMBER)}
        @{store(sRecipient,${Recipient})}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sLang,_INLANGUAGE)}" />
    <deliveryTemplate call="CheckCounters102">
      <set item="Content" value="_GET_LANG|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
  </template>
  <template procedureName="SlujebNumberCodeCheck" handler="_DBCON" sessionStorage="Memory" sessionLifetime="30" persistent="false">
    <condition>
      <test item="${Content}" matches="^\*_DEF_USSDNUM\*4444\*1\#$" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(SlujebNumberCodeCheck_${Sender})}">
        <Item procedureName="other_spikes.slujeb_number_code_check">
          <Attribute name="p_msisdn" type="STRING" value="${Sender}" />
          <Attribute name="result" type="out:STRING" />
        </Item>
        @{store(sCustomer,{$Sender})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate terminating="false">
      <set item="Content" value="Vasha zayavka prinyata. Jdite SMS s rezultatom." />
      <set item="Sender" value="${Sender}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set item="UssdServiceOp" value="1" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate connector="_SMSCON_1" />
  </template>
  <template procedureName="SlujebNumberTpChange" handler="_DBCON" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="${Content}" matches="^\*_DEF_USSDNUM\*4444\*99897\d{7}\*\d{5}\#$" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(SlujebNumberTpChange_${Sender})}">
        <Item procedureName="other_spikes.slujeb_number_tp_change_check">
          <Attribute name="p_msisdn" type="STRING" value="_SLUJEB_TP_NUMBER" />
          <Attribute name="p_code" type="STRING" value="_SLUJEB_TP_CODE" />
          <Attribute name="result" type="out:STRING" />
        </Item>
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,rut)}
        @{store(sTariffIvrCode,126)}
        @{store(sSlujebNumber,_SLUJEB_TP_NUMBER)}
        @{store(sSlujebCode,_SLUJEB_TP_CODE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${result}'='666'}">
      <set item="Content" value="Smena TP ne vozmojna. Ne verniy kod." />
      <set item="Sender" value="${Sender}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set item="UssdServiceOp" value="1" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate terminating="false">
      <set item="Content" value="Vasha zayavka prinyata. Jdite SMS s rezultatom." />
      <set item="Sender" value="${Sender}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set item="UssdServiceOp" value="1" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${result}'='0'}" call="SlujebNumberTpChange_Step2">
      <set item="Content" value="" />
      <set item="Sender" value="${sCustomer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
  </template>
  <template procedureName="AuthorisationDealer" sessionStorage="Memory" sessionLifetime="600" persistent="false">
    <condition>
      <test item="_USSD_CONTENT" matches="^_DEALER_NUM$" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(USSDPortal_${Sender})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
        @{store(sDealer,_USSD_CONTENT)}
        @{store(sRecipient,${Recipient})}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sLang,_INLANGUAGE)}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="_GET_DBRESULT" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set item="UssdServiceOp" value="1" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set conditionEx="0@{store(sDbresult,AuthorisationDealer)}" />
      <set item="Content" value="_GET_DBRESULT" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set item="UssdServiceOp" value="1" />
    </deliveryTemplate>
  </template>
  <template procedureName="USSDPortal" sessionStorage="Memory" sessionLifetime="600" persistent="false">
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(USSDPortal_${Sender})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sContent,${Content})}
        @{store(sTokens,_PORTAL_ASSIGN_TOKENS)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sLang,_INLANGUAGE)}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="_GET_DBRESULT" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{_GET_PORTAL_LENGTH_ANSWER&gt;0}">
      <set item="Content" value="_GET_PORTAL_ANSWER" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sService,#{concat('#{replace('${sTokens}','_DEALER_NUM','')}','*','_CONFIRM_VALUE')})}" />
    <deliveryTemplate conditionEx="#{'_SERVICE_CODE'!=''}" call="ServiceProvisioning">
      <set item="Content" value="_GET_LANG|#{if(matches('${sTokens}','_DEALER_NUM'),concat('#{replace('${sTokens}','_DEALER_NUM','')}','*','_CONFIRM_VALUE','#{replace('${sTokens}','.*(_DEALER_NUM).*','$1')}'),concat('${sTokens}','*','_CONFIRM_VALUE','${sDealer}'))}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sService,#{replace('${sTokens}','_DEALER_NUM','')})}" />
    <deliveryTemplate conditionEx="#{'_SERVICE_CODE'!=''}" call="ServiceProvisioning">
      <set item="Content" value="_GET_LANG|#{if(matches('${sTokens}','_DEALER_NUM'),concat('#{replace('${sTokens}','_DEALER_NUM','')}','#{replace('${sTokens}','.*(_DEALER_NUM).*','$1')}'),concat('${sTokens}','${sDealer}'))}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sNewTariffPlan,#{concat('#{replace('${sTokens}','_DEALER_NUM','')}','*','_CONFIRM_VALUE')})}" />
    <deliveryTemplate conditionEx="#{'_TARIFF_IVRCODE'!=''}" call="ChangeTariffPlan">
      <set item="Content" value="_GET_LANG|#{if(matches('${sTokens}','_DEALER_NUM'),concat('#{replace('${sTokens}','_DEALER_NUM','')}','*','_CONFIRM_VALUE','#{replace('${sTokens}','.*(_DEALER_NUM).*','$1')}'),concat('${sTokens}','*','_CONFIRM_VALUE','${sDealer}'))}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sNewTariffPlan,#{replace('${sTokens}','_DEALER_NUM','')})}" />
    <deliveryTemplate conditionEx="#{'_TARIFF_IVRCODE'!=''}" call="ChangeTariffPlan">
      <set item="Content" value="_GET_LANG|#{if(matches('${sTokens}','_DEALER_NUM'),concat('#{replace('${sTokens}','_DEALER_NUM','')}','#{replace('${sTokens}','.*(_DEALER_NUM).*','$1')}'),concat('${sTokens}','${sDealer}'))}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sService,#{replace('${sTokens}','_USSD_PTP_RGPATT','$1$7')})}" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_PTPMONEYTR' and _IS_NTFREQ_COMMAND}" call="PtPMoneyTransfer">
      <set item="Content" value="_GET_LANG|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sService,#{replace('#{replace('${sContent}','^\*(.+)\#.*$|^.*$','$1')}','_USSD_PTP_RGPATT','$1$7')})}" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_PTPMONEYTR' and not(_IS_NTFREQ_COMMAND)}" call="PtPMoneyTransfer">
      <set item="Content" value="_GET_LANG|#{replace('${sContent}','^\*(.+)\#.*$|^.*$','$1')}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sService,${sTokens})}" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_LANGUAGE'}" call="ChangeLanguageINPlatform">
      <set item="Content" value="_SBSCR_LANGUAGE|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_GETBALANCE'}" call="DB_BalanceRetriev">
      <set item="Content" value="#{if('_SBSCR_LANGUAGE'!='','_SBSCR_LANGUAGE','_GET_LANG')}|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_GETCOUNTERS'}" call="CheckCounters">
      <set item="Content" value="_GET_LANG|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_GRNTPAY_CHECK'}" call="CheckGuaranteedPayment">
      <set item="Content" value="_GET_LANG|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_GRNTPAY'}" call="GuaranteedPayment">
      <set item="Content" value="_GET_LANG|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_MYNUMBER'}" call="GetMyNumber">
      <set item="Content" value="_GET_LANG|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_MYSTATICIP'}" call="GetMyStaticIP">
      <set item="Content" value="_GET_LANG|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_GETOUTLASTPAY'}" call="LastOutstandingPayment">
      <set item="Content" value="_GET_LANG|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(_IS_NTFREQ_COMMAND)}" call="USSDIncomingContent">
      <set item="Content" value="_GET_LANG|${sTokens}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set conditionEx="0@{store(sTokens,)}" />
      <set item="Content" value="_GET_PORTAL_ANSWER" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
  </template>
  <template procedureName="ServiceProvisioning" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(DLSrvProv_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_USSD_SRV_COMM)}
        @{store(sAction,_USSD_SRV_ACT)}
        @{store(sDealer,_USSD_SRV_DEAL)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_SERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="false@{store(sServiceCode,#{if(matches('${sInProgress}','_IF_TRUE'),'${sServiceCode}','_SERVICE_CODE')})}" />
    <deliveryTemplate conditionEx="false@{store(sGroupName,#{if(matches('${sInProgress}','_IF_TRUE'),'${sGroupName}','_SERVICE_GROUPNAME')})}" />
    <deliveryTemplate conditionEx="false@{store(sParams,_SERVICE_NAME)}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sServiceCode}'='' or '${sService}'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sAction}'=''}" call="ServiceInterrogation">
      <set item="Content" value="_GET_LANG|${sService}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sAction}'='_CONFIRM_VALUE'}" call="ServiceProvisioning_Cnfrm_Step2" />
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE') and '${sServiceCode}'='_SERVICE_CODE' and '${sActParce}'='_SERVICE_COMM_ACTPARCE' and '${sActParce}'!=''}" call="ServiceStringFormat">
      <set item="Content" value="@{store(sDbresult,alrprogress_${sActParce})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ServiceStringFormat">
      <set item="Content" value="@{store(sDbresult,inprogress_${sActParce})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_SERVICE_CUSTLST_CNT&gt;0 and not(matches('_SERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_SERVICE_CUSTLST_CNT=0 and matches('_SERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_SERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ServiceStringFormat">
      <set item="Content" value="_SERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_GET_TODAY' &gt; '_SERVICE_DATETO'}" call="ServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,service_notavailable)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_GET_TODAY' &lt; '_SERVICE_DATEFROM'}" call="ServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,service_unavailable)}" />
      <set conditionEx="0@{store(sParams,_SERVICE_NAME;#{concat(substring('_SERVICE_DATEFROM',7,2),'.',substring('_SERVICE_DATEFROM',5,2),'.',substring('_SERVICE_DATEFROM',1,4))})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate call="ServiceProvisioning_Inter_Step3" />
  </template>
  <template procedureName="ServiceProvisioning_Cnfrm_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="_SERVICE_CODE" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '_SERVICE_CONFIRM_NAME'!=''}" call="ServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,_CONFIRM_VALUE__SERVICE_CRMSTATUS)}" />
      <set conditionEx="0@{store(sParams,_SERVICE_CONFIRM_NAME)}" />
      <set item="Content" value="_GET_CONFIRM_SERVICE_RESULT" />
    </deliveryTemplate>
    <deliveryTemplate call="ServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ServiceProvisioning_Inter_Step3" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="${sServiceCode}" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sActParce,_SERVICE_COMM_ACTPARCE)}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0' or '${sActParce}'='' or '${dbresult}'!='0' or '_SERVICE_COMM_STATUS'='' or '_SERVICE_COMM_ACTION'=''}" call="ServiceStringFormat">
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,329990)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_SERVICE_COMM_STATUS'='${subscription}'}" call="ServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,_SERVICE_COMM_CODE)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_SERVICE_REDIRECT','_REDIRECT_TO_CURRENT'))  and '_SERVICE_REDIRECT'!=''}" call="ServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_SERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ServiceProvisioningChckBndBal" />
    <deliveryTemplate conditionEx="#{_SERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ServiceProvisioningChckBndSrv" />
    <deliveryTemplate call="ServiceProvisioning_Vrf_Step4" />
  </template>
  <template procedureName="ServiceProvisioningChckBndBal" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="balance">
          <Attribute name="unpayment" value="6" />
          <Attribute name="requestcountertype" value="0" />
        </Item>
        @{store(sIsBindBalAval,true)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set conditionEx="0@{store(sIsBindBalAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and number(${balanceintpartdotpart} div 100) &lt; _SERVICE_AVAIL_BAL}" call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,notavailbalance)}" />
      <set conditionEx="0@{store(sIsBindBalAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and number(${balanceintpartdotpart} div 100)&gt;_SERVICE_AVAIL_BAL and _SERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ServiceProvisioningChckBndSrv" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and number(${balanceintpartdotpart} div 100)&gt;_SERVICE_AVAIL_BAL}" call="ServiceProvisioning_Vrf_Step4" />
    <deliveryTemplate call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set conditionEx="0@{store(sIsBindBalAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ServiceProvisioningChckBndSrv" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        @{store(sCnt,#{if('${sCnt}'='',1,number('${sCnt}')+1)})}
        <Item customer="${sCustomer}">
          <Service id="_SERVICE_SRVBIND_SRVCODE" action="interrogation" />
        </Item>
        @{store(sIsBindSrvAval,true)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set conditionEx="0@{store(sIsBindSrvAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${subscription}'='_SERVICE_SRVBIND_SUBSR' and '_SERVICE_SRVBIND_INFO'!=''}" call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sIsBindSrvAval,false)}" />
      <set item="Content" value="_SERVICE_SRVBIND_INFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_SERVICE_SRVBIND_CNT and ${subscription}=_SERVICE_SRVBIND_SUBSR}" call="ServiceProvisioning_Vrf_Step4">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_SERVICE_SRVBIND_STORE','${sRequi};_SERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_SERVICE_SRVBIND_CNT and ${subscription}!=_SERVICE_SRVBIND_SUBSR}" call="ServiceProvisioning_Vrf_Step4" />
    <deliveryTemplate conditionEx="#{'${subscription}'!='_SERVICE_SRVBIND_SUBSR'}" call="ServiceProvisioningChckBndSrv" />
    <deliveryTemplate conditionEx="#{'${subscription}'='_SERVICE_SRVBIND_SUBSR'}" call="ServiceProvisioningChckBndSrv">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_SERVICE_SRVBIND_STORE','${sRequi};_SERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set conditionEx="0@{store(sIsBindSrvAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ServiceProvisioning_Vrf_Step4" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{('${customerblocks}'!='' or '${dbresult}'='320347') and matches('_SERVICE_CHECKBLOCK','_IF_TRUE')}" call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,_GET_AFTER_VERIFY_DBRESULT)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0' and '${dbresult}'!='320347'}" call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_SERVICE_TP_CNT&gt;0 and not(matches('_SERVICE_TP_ISAVAIL','_IF_TRUE'))) or (_SERVICE_TP_CNT=0 and matches('_SERVICE_TP_ISAVAIL','_IF_TRUE'))) and '_SERVICE_TP_NOTAVALINFO'!=''}" call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sParams,_SERVICE_NAME;_TARIFF_CURRENT_NAME)}" />
      <set item="Content" value="_SERVICE_TP_NOTAVALINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sGroupName}'='BMS'}" call="ServiceProvisioning_BMS_Step7" />
    <deliveryTemplate conditionEx="#{'${sGroupName}'='BLOCKS'}" call="ServiceProvisioning_Block_Step6" />
    <deliveryTemplate call="ServiceProvisioning_Order_Step5">
      <set item="Sender" value="${sServiceCode};_SERVICE_COMM_ACTION#{if('${sDealer}'!='',';${sDealer}','')}" />
      <set item="Recipient" value="${sCustomer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ServiceProvisioning_Order_Step5" sessionStorage="Memory" sessionLifetime="300" persistent="true">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="${sServiceCode}" action="_SERVICE_COMM_ACTION" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success_${sActParce})}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ServiceProvisioning_Block_Step6" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="blockphone" action="4">
            <Attribute name="state" value="_SERVICE_COMM_STATUS" />
            <Attribute name="start" value="#{substring('@{now}',1,10)}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success_${sActParce})}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ServiceProvisioning_BMS_Step7" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="orderbonusgiftrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="giftcode" value="${sServiceCode}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success_${sActParce})}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ServiceInterrogation" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches="^.+$" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(DLSrvInter_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_USSD_SRV_COMM)}
        @{store(sServiceCode,_SERVICE_CODE)}
        @{store(sGroupName,_SERVICE_GROUPNAME)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sParams,_SERVICE_NAME)}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sServiceCode}'='' or '${sService}'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_SERVICE_CUSTLST_CNT&gt;0 and not(matches('_SERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_SERVICE_CUSTLST_CNT=0 and matches('_SERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_SERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ServiceStringFormat">
      <set item="Content" value="_SERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate call="ServiceInterrogation_Step2" />
  </template>
  <template procedureName="ServiceInterrogation_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="${sServiceCode}" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ServiceStringFormat">
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,service__SERVICE_CRMSTATUS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ServiceStringFormat" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="stringformat" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="stringformat">
            <![CDATA[#{if('${Content}'='','_GET_SERVICE_RESULT','${Content}')}@{store(SlowAsync,)}]]>
          </Attribute>
          <Attribute name="params">
            <![CDATA[${sParams}]]>
          </Attribute>
          <Attribute name="split" value=";" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{not(matches('${sInProgress}','_IF_TRUE')) and ('${sDbresult}'='redirect' or matches('${SlowAsync}','_IF_TRUE'))}">
      <set conditionEx="0@{store(sInProgress,true)}" />
      <set conditionEx="0@{store(sStartSecond,_GET_SECONDS)}" />
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="UssdServiceOp" value="1" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sIsFreeSession,#{if(number(_SERVICE_TIMETOPROGRESS)&gt;0,'false','true')})}" />
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE') and matches('_SERVICE_REDIRECT','_REDIRECT_TO_SMS') and not(matches('${sDbresult}','inprogress_|alrprogress_|_CONFIRM_VALUE|inprogress'))}" connector="_SMSCON_1" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and matches('${sDbresult}','inprogress_|alrprogress_|_CONFIRM_VALUE|inprogress')}">
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and (not(matches('${sDbresult}','success')) or matches('${sIsFreeSession}','_IF_TRUE'))}">
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and not(matches('${sIsFreeSession}','_IF_TRUE'))}">
      <set conditionEx="0@{store(sStartSecond,_GET_SECONDS)}" />
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${customer}'!='' and matches('@{SessionExists(${session_id})}','_IF_TRUE')}">
      <set conditionEx="0@{store(sDbresult,_DEFAULT_ERR)}" />
      <set item="Content" value="_GET_DBRESULT" />
      <set item="Recipient" value="${customer}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Encoding" value="_ENCODING" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="true@{freeSession}" dropReply="true" />
  </template>
  <template procedureName="ChangeTariffPlan" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(DLChangeTP_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sNewTariffPlan,_USSD_SRV_COMM)}
        @{store(sDealer,_USSD_SRV_DEAL)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_TARIFF_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="false@{store(sTariffIvrCode,#{if(matches('${sInProgress}','_IF_TRUE'),'${sTariffIvrCode}','_TARIFF_IVRCODE')})}" />
    <deliveryTemplate conditionEx="false@{store(sGroupName,#{if(matches('${sInProgress}','_IF_TRUE'),'${sGroupName}','_TARIFF_GROUPNAME')})}" />
    <deliveryTemplate conditionEx="false@{store(sParams,_TARIFF_NAME)}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sTariffIvrCode}'='' or '${sNewTariffPlan}'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sNewTariffPlan}','_CONFIRM_VALUE')}" call="ChangeTariffPlan_Cnfrm_Step2" />
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE') and '${sTariffIvrCode}'='_TARIFF_IVRCODE'}" call="TariffPlanStringFormat">
      <set item="Content" value="@{store(sDbresult,alrprogress)}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_TARIFF_CUSTLST_CNT&gt;0 and not(matches('_TARIFF_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_TARIFF_CUSTLST_CNT=0 and matches('_TARIFF_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_TARIFF_CUSTLST_NOTAVAILINFO'!=''}" call="TariffPlanStringFormat">
      <set item="Content" value="_TARIFF_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_GET_TODAY' &gt; '_TARIFF_DATETO'}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,notavailable)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_GET_TODAY' &lt; '_TARIFF_DATEFROM'}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,unavailable)}" />
      <set conditionEx="0@{store(sParams,_TARIFF_NAME;#{concat(substring('_TARIFF_DATEFROM',7,2),'.',substring('_TARIFF_DATEFROM',5,2),'.',substring('_TARIFF_DATEFROM',1,4))})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate call="ChangeTariffPlan_Step3" />
  </template>
  <template procedureName="ChangeTariffPlan_Cnfrm_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="checkivrservice" value="1" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${sTariffIvrCode}'='#{//Message/Item/@tariffplan}'}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,alreadyex)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '_TARIFF_CURRENT_NAME'!=''}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,_CONFIRM_VALUE)}" />
      <set conditionEx="0@{store(sParams,_TARIFF_NAME;_TARIFF_CURRENT_NAME)}" />
      <set item="Content" value="_GET_CONFIRM_TARIFF_RESULT" />
    </deliveryTemplate>
    <deliveryTemplate call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ChangeTariffPlan_Step3" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="checkivrservice" value="1" />
          <Attribute name="checkblocks" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${sTariffIvrCode}'='#{//Message/Item/@tariffplan}'}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,alreadyex)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('${customerblocks}'!='' or '${dbresult}'='320347') and matches('_TARIFF_CHECKBLOCK','_IF_TRUE')}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,_GET_AFTER_VERIFY_DBRESULT)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0' and '${dbresult}'!='320347'}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_TARIFF_TP_CNT&gt;0 and not(matches('_TARIFF_TP_ISAVAIL','_IF_TRUE'))) or (_TARIFF_TP_CNT=0 and matches('_TARIFF_TP_ISAVAIL','_IF_TRUE'))) and '_TARIFF_TP_NOTAVAILINFO'!=''}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sParams,_TARIFF_NAME;_TARIFF_CURRENT_NAME)}" />
      <set item="Content" value="_TARIFF_TP_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_TARIFF_REDIRECT','_REDIRECT_TO_CURRENT')) and '_TARIFF_REDIRECT'!=''}" call="TariffPlanStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_TARIFF_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ChangeTariffPlanCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_TARIFF_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ChangeTariffPlanCheckSrvBinding" />
    <deliveryTemplate call="ChangeTariffPlan_Step4">
      <set item="Sender" value="_TARIFF_NAME;0#{if('${sDealer}'!='',';${sDealer}','')}" />
      <set item="Recipient" value="${sCustomer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ChangeTariffPlanCheckBindingBal" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="balance">
          <Attribute name="unpayment" value="6" />
          <Attribute name="requestcountertype" value="0" />
        </Item>
        @{store(sIsBindBalAval,true)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set conditionEx="0@{store(sIsBindBalAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100) &lt; _TARIFF_AVAIL_BAL}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,notavailbalance)}" />
      <set conditionEx="0@{store(sIsBindBalAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_TARIFF_AVAIL_BAL and _TARIFF_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ChangeTariffPlanCheckSrvBinding" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_TARIFF_AVAIL_BAL}" call="ChangeTariffPlan_Step4">
      <set item="Sender" value="_TARIFF_NAME;0#{if('${sDealer}'!='',';${sDealer}','')}" />
      <set item="Recipient" value="${sCustomer}" />
    </deliveryTemplate>
    <deliveryTemplate call="TariffPlanStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set conditionEx="0@{store(sIsBindBalAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ChangeTariffPlanCheckSrvBinding" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        @{store(sCnt,#{if('${sCnt}'='',1,number('${sCnt}')+1)})}
        <Item customer="${sCustomer}">
          <Service id="_TARIFF_SRVBIND_SRVCODE" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${subscription}'='_TARIFF_SRVBIND_SUBSR' and '_TARIFF_SRVBIND_INFO'!=''}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" value="_TARIFF_SRVBIND_INFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_TARIFF_SRVBIND_CNT and ${subscription}=_TARIFF_SRVBIND_SUBSR}" call="ChangeTariffPlan_Step4">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_TARIFF_SRVBIND_STORE','${sRequi};_TARIFF_SRVBIND_STORE')})}" />
      <set item="Sender" value="_TARIFF_NAME;0#{if('${sDealer}'!='',';${sDealer}','')}" />
      <set item="Recipient" value="${sCustomer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_TARIFF_SRVBIND_CNT and ${subscription}!=_TARIFF_SRVBIND_SUBSR}" call="ChangeTariffPlan_Step4">
      <set item="Sender" value="_TARIFF_NAME;0#{if('${sDealer}'!='',';${sDealer}','')}" />
      <set item="Recipient" value="${sCustomer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${subscription}'!='_TARIFF_SRVBIND_SUBSR'}" call="ChangeTariffPlanCheckSrvBinding" />
    <deliveryTemplate conditionEx="#{'${subscription}'='_TARIFF_SRVBIND_SUBSR'}" call="ChangeTariffPlanCheckSrvBinding">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_TARIFF_SRVBIND_STORE','${sRequi};_TARIFF_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate call="TariffPlanStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ChangeTariffPlan_Step4" sessionStorage="Memory" sessionLifetime="300" persistent="true">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="changetariffplan" action="0" class="${sTariffIvrCode}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="TariffPlanStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="CheckTariffPlan" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(DLChckTP_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sCustomer}'='' or '${sRecipient}'=''}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_TARIFF_CUSTLST_CNT&gt;0 and not(matches('_TARIFF_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_TARIFF_CUSTLST_CNT=0 and matches('_TARIFF_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_TARIFF_CUSTLST_NOTAVAILINFO'!=''}" call="TariffPlanStringFormat">
      <set item="Content" value="_TARIFF_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate call="CheckTariffPlan_Step2" />
  </template>
  <template procedureName="CheckTariffPlan_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="TariffPlanStringFormat">
      <set conditionEx="0@{store(sTariffIvrCode,${tariffplan})}" />
      <set conditionEx="0@{store(sGroupName,_TARIFF_GROUPNAME)}" />
      <set conditionEx="0@{store(sParams,_TARIFF_NAME)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,checktp)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="TariffPlanStringFormat" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="stringformat" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="stringformat">
            <![CDATA[#{if('${Content}'='','_GET_TARIFF_RESULT','${Content}')}@{store(SlowAsync,)}]]>
          </Attribute>
          <Attribute name="params">
            <![CDATA[${sParams}]]>
          </Attribute>
          <Attribute name="split" value=";" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{not(matches('${sInProgress}','_IF_TRUE')) and ('${sDbresult}'='redirect' or matches('${SlowAsync}','_IF_TRUE'))}">
      <set conditionEx="0@{store(sInProgress,true)}" />
      <set conditionEx="0@{store(sStartSecond,_GET_SECONDS)}" />
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sIsFreeSession,#{if(number(_TARIFF_TIMETOPROGRESS)&gt;0,'false','true')})}" />
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE') and matches('_TARIFF_REDIRECT','_REDIRECT_TO_SMS') and not(matches('${sDbresult}','inprogress|alrprogress|_CONFIRM_VALUE'))}" connector="_SMSCON_1" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and matches('${sDbresult}','inprogress|alrprogress|_CONFIRM_VALUE')}">
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and (not(matches('${sDbresult}','success')) or matches('${sIsFreeSession}','_IF_TRUE'))}">
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and not(matches('${sIsFreeSession}','_IF_TRUE'))}">
      <set conditionEx="0@{store(sStartSecond,_GET_SECONDS)}" />
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${customer}'!='' and matches('@{SessionExists(${session_id})}','_IF_TRUE')}">
      <set conditionEx="0@{store(sDbresult,_DEFAULT_ERR)}" />
      <set item="Content" value="_GET_DBRESULT" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="true@{freeSession}" dropReply="true" />
  </template>
  <template procedureName="PtPMoneyTransfer" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(PTP_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_USSD_PTP_SRV)}
        @{store(sReceiver,_USSD_PTP_RECEIVER)}
        @{store(sAmount,_USSD_PTP_AMOUNT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <!--deliveryTemplate call="ALLServiceStringFormat">
			<set conditionEx="0@{store(sDbresult,329992)}" />
			<set item="Content" value=""/>
		</deliveryTemplate-->
    <deliveryTemplate conditionEx="#{'${sReceiver}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,getacceptor)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sAmount}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,getamount)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="PtPMoneyTransfer_Step3" />
  </template>
  <template procedureName="PtPMoneyTransfer_Step3" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="movepaymentrequest" action="5">
            <Attribute name="receiver" value="${sReceiver}" />
            <Attribute name="amount" value="${sAmount}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0'}" call="PtPMoneyTransfer_Step4">
      <set conditionEx="0@{store(sOutCode,${code})}" />
    </deliveryTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,320968)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="PtPMoneyTransfer_Step4" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="movepaymentacceptance" action="5">
            <Attribute name="code" value="#{normalize-space('${sOutCode}')}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sParams,${sAmount};${sReceiver})}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ChangePasswordISSA" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(ChngISSAPass_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sNewpassword,${newpassword})}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sNewpassword}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,getpassword)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sNewpassword}'='' or '_ALLSERVICE_NAME'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="ChangePasswordISSA_Step2" />
  </template>
  <template procedureName="ChangePasswordISSA_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{//Item/@dbresult=0}" call="ChangePasswordISSA_Step3">
      <set conditionEx="0@{store(sOldPass,${password})}" />
    </deliveryTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ChangePasswordISSA_Step3" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="oldpassword" value="${sOldPass}" />
          <Attribute name="newpassword" value="${sNewpassword}" />
          <Attribute name="confirmpassword" value="${sNewpassword}" />
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="FavouriteNumberCheck" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(ChkFav_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="iparam:customer" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="FavouriteNumberCheck_Step2" />
  </template>
  <template procedureName="FavouriteNumberCheck_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" action="8">
          <Attribute name="favouritenumber" value="" />
          <Attribute name="index" value="1" />
          <Attribute name="favouritenumbertypeid" value="5" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${favouritenumber}'='' and '${dbresult}'='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,301010)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sParams,${favouritenumber})}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="FavouriteNumberUpdate" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(UpdFav_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sFavNum,${favnum})}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sFavNum}'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="FavouriteNumberUpdate_Step2" />
  </template>
  <template procedureName="FavouriteNumberUpdate_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" action="10">
          <Attribute name="favouritenumber" value="${sFavNum}" />
          <Attribute name="index" value="0" />
          <Attribute name="favouritenumbertypeid" value="5" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sParams,${favouritenumber})}" />
      <set item="Content" condition="(//Item/@dbresult=320194 or //Item/@dbresult=320142) and //Item/Attribute[@name='count']/@value&gt;0" value="@{store(sDbresult,310204)}" />
      <set item="Content" condition="(//Item/@dbresult=320194 or //Item/@dbresult=320142) and //Item/Attribute[@name='count']/@value=0" value="@{store(sDbresult,320204)}" />
      <set item="Content" condition="//Item/@dbresult=0" value="@{store(sDbresult,success)}" />
      <set item="Content" condition="//Item/@dbresult!=0" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="FavouriteNumberDelete" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(DelFav_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sFavNum,${favnum})}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sFavNum}'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="FavouriteNumberDelete_Step2" />
  </template>
  <template procedureName="FavouriteNumberDelete_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" action="11">
          <Attribute name="favouritenumber" value="${sFavNum}" />
          <Attribute name="index" value="0" />
          <Attribute name="favouritenumbertypeid" value="5" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sParams,${favouritenumber})}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ChangeLanguageINPlatform" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(ChngINLang_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="ChangeLanguageINPlatform_Step2" />
  </template>
  <template procedureName="ChangeLanguageINPlatform_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}" reply="">
        <Item customer="${sCustomer}">
          <Attribute name="communicationlanguage" value="#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@param='_GET_LANG']/@language_id}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="LatestPayments" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(LastPayment_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="iparam:customer" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="LatestPayments_Step2" />
  </template>
  <template procedureName="LatestPayments_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="payments">
          <Attribute name="index" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,success)}" />
      <set item="Content" conditionEx="#{'${currency}'='840'}" value="@{store(sParams,#{replace('#{round(#{round(${intpartfracpart} * _GET_USD_COURCE)} div 100)}',',','.')};#{replace('#{${intpartfracpart} div 100}',',','.')};${day})}"/>
      <set item="Content" conditionEx="#{'${currency}'='860'}" value="@{store(sParams,#{replace('#{round(${intpartfracpart} div 100)}',',','.')};#{replace('#{#{round(${intpartfracpart} div _GET_USD_COURCE)} div 100}',',','.')};${day})}"/>
    </deliveryTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="LastOutstandingPayment" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(LastOutPayment_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="LastOutstandingPayment_Step2" />
  </template>
  <template procedureName="LastOutstandingPayment_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="payments">
          <Attribute name="index" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,success)}" />
      <set item="Content" conditionEx="#{'${currency}'='840'}" value="@{store(sParams,#{replace('#{round(#{round(${intpartfracpart} * _GET_USD_COURCE)} div 100)}',',','.')};#{replace('#{${intpartfracpart} div 100}',',','.')};${day})}"/>
      <set item="Content" conditionEx="#{'${currency}'='860'}" value="@{store(sParams,#{replace('#{round(${intpartfracpart} div 100)}',',','.')};#{replace('#{#{round(${intpartfracpart} div _GET_USD_COURCE)} div 100}',',','.')};${day})}"/>
    </deliveryTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="GuaranteedPayment" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(GrntPay_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="GuaranteedPayment_Step2" />
  </template>
  <template procedureName="GuaranteedPayment_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service action="6" id="guaranteedpayment" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}" call="GuaranteedPayment_Step3" />
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="GuaranteedPayment_Step3" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="guaranteedpayment" action="7">
            <Attribute name="amount" value="300" />
            <Attribute name="currency" value="840" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="CheckGuaranteedPayment" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(GrntPay_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="CheckGuaranteedPayment_Step2" />
  </template>
  <template procedureName="CheckGuaranteedPayment_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service action="6" id="guaranteedpayment" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,320206)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="DB_BalanceRetriev" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(${Sender}_GetBalance__PARCE_LANG)}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="DB_BalanceRetriev_Step2" />
  </template>
  <template procedureName="DB_BalanceRetriev_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="balance">
          <Attribute name="unpayment" value="0" />
          <Attribute name="requestcountertype" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="_GET_DBRESULT" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sBalance,${balanceintpartdotpart})}" />
    <deliveryTemplate conditionEx="false@{store(sCalccurr,${balanceintpartdotpart} * _GET_USD_COURCE)}" />
    <deliveryTemplate conditionEx="false@{store(sCurrency,${currency})}" />
    <deliveryTemplate conditionEx="false@{store(sCounters,#{//Item/Attribute[@name='full']/@value})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '${sTariffIvrCode}'=''}" call="DB_BalanceRetriev_Step5" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '${sTariffIvrCode}'!=''}" call="DB_BalanceRetriev_Step6" />
  </template>
  <template procedureName="DB_BalanceRetriev_Step5" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="checkivrservice" value="1" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="DB_BalanceRetriev_Step6">
      <set conditionEx="0@{store(sTariffIvrCode,${tariffplan})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="DB_BalanceRetriev_Step6" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="openbills">
          <Attribute name="includeunbilleddata" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
    <deliveryTemplate conditionEx="false@{store(sDbresult,success)}" />
    <deliveryTemplate conditionEx="#{'${sBalance}'='' and '${sCalccurr}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,320967)}" />
      <set item="Content" value="_GET_DBRESULT" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${summintdotpart}'='' and '${sTariffIvrCode}'='' and '${sCounters}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sParams,#{replace('#{${sBalance} div 100}',',','.')};#{replace('#{round(${sCalccurr} div 100)}',',','.')})}" />
      <set item="Content" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_#{if(${sBalance}&gt;=0,'bal','debt')}__GET_LANG}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${summintdotpart}'='' and '${sTariffIvrCode}'='' and '${sCounters}'!=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sParams,#{replace('#{${sBalance} div 100}',',','.')};#{replace('#{round(${sCalccurr} div 100)}',',','.')};${sCounters})}" />
      <set item="Content" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_#{if(${sBalance}&gt;=0,'bal','debt')}_cntr__GET_LANG}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${summintdotpart}'='' and '${sTariffIvrCode}'!='' and '${sCounters}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sParams,#{replace('#{${sBalance} div 100}',',','.')};#{replace('#{round(${sCalccurr} div 100)}',',','.')};_TARIFF_BALANCE_NAME)}" />
      <set item="Content" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_#{if(${sBalance}&gt;=0,'bal','debt')}_plan__GET_LANG}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${summintdotpart}'='' and '${sTariffIvrCode}'!='' and '${sCounters}'!=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sParams,#{replace('#{${sBalance} div 100}',',','.')};#{replace('#{round(${sCalccurr} div 100)}',',','.')};_TARIFF_BALANCE_NAME;${sCounters})}" />
      <set item="Content" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_#{if(${sBalance}&gt;=0,'bal','debt')}_plan_cntr__GET_LANG}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${summintdotpart}'!='' and '${sTariffIvrCode}'='' and '${sCounters}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sParams,#{replace('#{${sBalance} div 100}',',','.')};#{replace('#{round(${sCalccurr} div 100)}',',','.')};${lastminibillingdate};#{replace('#{${summintdotpart} div 100}',',','.')}#{if('${currency}'='840',' y.e',' sum')})}" />
      <set item="Content" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_#{if(${sBalance}&gt;=0,'bal','debt')}_bill__GET_LANG}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${summintdotpart}'!='' and '${sTariffIvrCode}'='' and '${sCounters}'!=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sParams,#{replace('#{${sBalance} div 100}',',','.')};#{replace('#{round(${sCalccurr} div 100)}',',','.')};${lastminibillingdate};#{replace('#{${summintdotpart} div 100}',',','.')}#{if('${currency}'='840',' y.e',' sum')};${sCounters})}" />
      <set item="Content" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_#{if(${sBalance}&gt;=0,'bal','debt')}_bill_cntr__GET_LANG}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${summintdotpart}'!='' and '${sTariffIvrCode}'!='' and '${sCounters}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sParams,#{replace('#{${sBalance} div 100}',',','.')};#{replace('#{round(${sCalccurr} div 100)}',',','.')};${lastminibillingdate};#{replace('#{${summintdotpart} div 100}',',','.')}#{if('${currency}'='840',' y.e',' sum')};_TARIFF_BALANCE_NAME)}" />
      <set item="Content" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_#{if(${sBalance}&gt;=0,'bal','debt')}_full__GET_LANG}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${summintdotpart}'!='' and '${sTariffIvrCode}'!='' and '${sCounters}'!=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sParams,#{replace('#{${sBalance} div 100}',',','.')};#{replace('#{round(${sCalccurr} div 100)}',',','.')};${lastminibillingdate};#{replace('#{${summintdotpart} div 100}',',','.')}#{if('${currency}'='840',' y.e',' sum')};_TARIFF_BALANCE_NAME;${sCounters})}" />
      <set item="Content" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_#{if(${sBalance}&gt;=0,'bal','debt')}_full_cntr__GET_LANG}" />
    </deliveryTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,320967)}" />
      <set item="Content" value="_GET_DBRESULT" />
    </deliveryTemplate>
  </template>
  <template procedureName="CheckCounters" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(${customer}_GetCounters__PARCE_LANG)}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sCountertype,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCountertype}'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="CheckCounters_Step2" />
  </template>
  <template procedureName="CheckCounters_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="balance">
          <Attribute name="unpayment" value="0" />
          <Attribute name="requestcountertype" value="3" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '#{//Item/Attribute[@name='accumulator']/@value}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,success)}" />
      <set item="Content" value="#{document('_COUNTERS_PATH')/Counters/Group[_CURRENT_MODULE/@value='${sCountertype}']/@getcounters_nocounters__GET_LANG}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '#{//Item/Attribute[@name='_COUNTERS_TYPE']/@value}'!=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,success)}" />
      <set item="Content" value="#{//Item/Attribute[@name='_COUNTERS_TYPE']/@value}" />
    </deliveryTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,320990)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="GetMyNumber" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(GetMyNum_${Sender})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{not(matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_CURRENT')) and '_ALLSERVICE_REDIRECT'!=''}" call="ALLServiceStringFormat" terminating="false">
      <set conditionEx="0@{store(sDbresult,redirect)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,success)}" />
      <set conditionEx="0@{store(sParams,${sCustomer})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="GetMyStaticIP" handler="_DBCON" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(GetMyIP_${Sender})}">
        <Item procedureName="other_spikes.check_static_ip">
          <Attribute name="p_msisdn" type="STRING" value="${Sender}" />
          <Attribute name="result" type="out:STRING" />
        </Item>
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${result}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,notavail)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,success)}" />
      <set conditionEx="0@{store(sParams,${result})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ALLServiceCheckVerify" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="1" />
        </Item>
        @{store(sIsBindVerfAval,true)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{('${customerblocks}'!='' or '${dbresult}'='320347') and matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,_GET_AFTER_VERIFY_DBRESULT)}" />
      <set conditionEx="0@{store(sIsBindVerfAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0' and '${dbresult}'!='320347'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set conditionEx="0@{store(sIsBindVerfAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_TP_CNT&gt;0 and not(matches('_ALLSERVICE_TP_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_TP_CNT=0 and matches('_ALLSERVICE_TP_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_TP_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sIsBindVerfAval,false)}" />
      <set conditionEx="0@{store(sParams,_TARIFF_CURRENT_NAME)}" />
      <set item="Content" value="_ALLSERVICE_TP_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sTariffIvrCode,${tariffplan})}" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_PTPMONEYTR'}" call="PtPMoneyTransfer_Step3" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_ISSAPASS'}" call="ChangePasswordISSA_Step2" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_CHKFAVNUM'}" call="FavouriteNumberCheck_Step2" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_UPDFAVNUM'}" call="FavouriteNumberUpdate_Step2" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_DELFAVNUM'}" call="FavouriteNumberDelete_Step2" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_LANGUAGE'}" call="ChangeLanguageINPlatform_Step2" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_GETLASTPAY'}" call="LatestPayments_Step2" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_GETOUTLASTPAY'}" call="LastOutstandingPayment_Step2" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_GRNTPAY'}" call="GuaranteedPayment_Step2" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_GETBALANCE'}" call="DB_BalanceRetriev_Step2" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='_GETCOUNTERS'}" call="CheckCounters_Step2" />
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set conditionEx="0@{store(sIsBindVerfAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ALLServiceCheckBindingBal" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="balance">
          <Attribute name="unpayment" value="6" />
          <Attribute name="requestcountertype" value="0" />
        </Item>
        @{store(sIsBindBalAval,true)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set conditionEx="0@{store(sIsBindBalAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100) &lt; _ALLSERVICE_AVAIL_BAL}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,notavailbalance)}" />
      <set conditionEx="0@{store(sIsBindBalAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sBalance,${balanceintpartdotpart})}" />
    <deliveryTemplate conditionEx="false@{store(sCurrency,${currency})}" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and _ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_PTPMONEYTR'}" call="PtPMoneyTransfer_Step3" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_ISSAPASS'}" call="ChangePasswordISSA_Step2" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_CHKFAVNUM'}" call="FavouriteNumberCheck_Step2" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_UPDFAVNUM'}" call="FavouriteNumberUpdate_Step2" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_DELFAVNUM'}" call="FavouriteNumberDelete_Step2" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_LANGUAGE'}" call="ChangeLanguageINPlatform_Step2" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_GETLASTPAY'}" call="LatestPayments_Step2" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_GETOUTLASTPAY'}" call="LastOutstandingPayment_Step2" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_GRNTPAY'}" call="GuaranteedPayment_Step2" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_GETBALANCE'}" call="DB_BalanceRetriev_Step2" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_GETCOUNTERS'}" call="CheckCounters_Step2" />
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set conditionEx="0@{store(sIsBindBalAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ALLServiceCheckBindingSrv" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        @{store(sCnt,#{if('${sCnt}'='',1,number('${sCnt}')+1)})}
        <Item customer="${sCustomer}">
          <Service id="_ALLSERVICE_SRVBIND_SRVCODE" action="interrogation" />
        </Item>
        @{store(sIsBindSrvAval,true)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set conditionEx="0@{store(sIsBindSrvAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${subscription}'='_ALLSERVICE_SRVBIND_SUBSR' and '_ALLSERVICE_SRVBIND_INFO'!=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sIsBindSrvAval,false)}" />
      <set item="Content" value="_ALLSERVICE_SRVBIND_INFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt} &lt; _ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate conditionEx="#{${sCnt} &lt; _ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR}" call="ALLServiceCheckBindingSrv">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_PTPMONEYTR'}" call="PtPMoneyTransfer_Step3">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_PTPMONEYTR'}" call="PtPMoneyTransfer_Step3" />
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_ISSAPASS'}" call="ChangePasswordISSA_Step2">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_ISSAPASS'}" call="ChangePasswordISSA_Step2" />
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_CHKFAVNUM'}" call="FavouriteNumberCheck_Step2">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_CHKFAVNUM'}" call="FavouriteNumberCheck_Step2" />
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_UPDFAVNUM'}" call="FavouriteNumberUpdate_Step2">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_UPDFAVNUM'}" call="FavouriteNumberUpdate_Step2" />
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_DELFAVNUM'}" call="FavouriteNumberDelete_Step2">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_DELFAVNUM'}" call="FavouriteNumberDelete_Step2" />
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_LANGUAGE'}" call="ChangeLanguageINPlatform_Step2">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_LANGUAGE'}" call="ChangeLanguageINPlatform_Step2" />
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_GETLASTPAY'}" call="LatestPayments_Step2">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_GETLASTPAY'}" call="LatestPayments_Step2" />
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_GETOUTLASTPAY'}" call="LastOutstandingPayment_Step2">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_GETOUTLASTPAY'}" call="LastOutstandingPayment_Step2" />
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_GRNTPAY'}" call="GuaranteedPayment_Step2">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_GRNTPAY'}" call="GuaranteedPayment_Step2" />
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_GETBALANCE'}" call="DB_BalanceRetriev_Step2">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_GETBALANCE'}" call="DB_BalanceRetriev_Step2" />
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_GETCOUNTERS'}" call="CheckCounters_Step2">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_ALLSERVICE_SRVBIND_STORE','${sRequi};_ALLSERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${sCnt}=_ALLSERVICE_SRVBIND_CNT and ${subscription}!=_ALLSERVICE_SRVBIND_SUBSR and '_ALLSERVICE_NAME'='_GETCOUNTERS'}" call="CheckCounters_Step2" />
    <deliveryTemplate call="ALLServiceStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set conditionEx="0@{store(sIsBindSrvAval,false)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
  </template>
  <template procedureName="ALLServiceStringFormat" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="stringformat" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="stringformat">
            <![CDATA[#{if('${Content}'='','#{if('_GET_ALL_SRV_RESULT'='','_GET_DBRESULT','_GET_ALL_SRV_RESULT')}','${Content}')}@{store(SlowAsync,)}]]>
          </Attribute>
          <Attribute name="params">
            <![CDATA[${sParams}]]>
          </Attribute>
          <Attribute name="split" value=";" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{not(matches('${sInProgress}','_IF_TRUE')) and ('${sDbresult}'='redirect' or matches('${SlowAsync}','_IF_TRUE'))}">
      <set conditionEx="0@{store(sInProgress,true)}" />
      <set conditionEx="0@{store(sStartSecond,_GET_SECONDS)}" />
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="false@{store(sIsFreeSession,#{if(number(_ALLSERVICE_TIMETOPROGRESS)&gt;0,'false','true')})}" />
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE') and matches('_ALLSERVICE_REDIRECT','_REDIRECT_TO_SMS') and not(matches('${sDbresult}','inprogress|alrprogress|_CONFIRM_VALUE'))}" connector="_SMSCON_1" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and matches('${sDbresult}','inprogress|alrprogress|_CONFIRM_VALUE')}">
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and (not(matches('${sDbresult}','success')) or matches('${sIsFreeSession}','_IF_TRUE'))}">
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and not(matches('${sIsFreeSession}','_IF_TRUE'))}">
      <set conditionEx="0@{store(sStartSecond,_GET_SECONDS)}" />
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${customer}'!='' and matches('@{SessionExists(${session_id})}','_IF_TRUE')}">
      <set conditionEx="0@{store(sDbresult,_DEFAULT_ERR)}" />
      <set item="Content" value="_GET_DBRESULT" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="true@{freeSession}" dropReply="true" />
  </template>
  <template procedureName="CheckCounters102" sessionStorage="Memory" sessionLifetime="30">
    <condition>
      <test item="_PARCE_CONTENT" matches=".+" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${Sender}" />
        @{store(sCustomer,${Sender})}
        @{store(sRecipient,${Recipient})}
        @{store(sLang,_PARCE_LANG)}
        @{store(sService,_PARCE_CONTENT)}
        @{store(sCountertype,_PARCE_CONTENT)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,${dbresult})}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_NAME'='' or '${sCountertype}'='' or '${sCustomer}'='' or '${sRecipient}'=''}" call="ALLServiceStringFormat">
      <set conditionEx="0@{store(sDbresult,329990)}" />
      <set item="Content" value="" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="_ALLSERVICE_CUSTLST_NOTAVAILINFO" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('_ALLSERVICE_TP_NOTAVAILINFO'!='' or matches('_ALLSERVICE_CHECKBLOCK','_IF_TRUE')) and not(matches('${sIsBindVerfAval}','_IF_TRUE'))}" call="ALLServiceCheckVerify" />
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_ALLSERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ALLServiceCheckBindingSrv" />
    <deliveryTemplate call="CheckCounters102_Step2">
      <set item="Content" value="_GET_LANG|${sCountertype}" />
      <set item="Sender" value="${sCustomer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="CheckCounters102_Step2" sessionStorage="Memory" sessionLifetime="30" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(${Sender}_checktpcounters__PARCE_LANG)}">
        <Item customer="${Sender}" subject="balance">
          <Attribute name="unpayment" value="0" />
          <Attribute name="requestcountertype" value="1" />
          @{store(sCustomer,${Sender})}
          @{store(sRecipient,${Recipient})}
          @{store(sLang,_PARCE_LANG)}
          @{store(sCountertype,_PARCE_CONTENT)}
          @{store(sModule,_CURRENT_MODULE)}
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '#{//Item/Attribute[@name='accumulator']/@value}'=''}" call="CheckCounters102_Step3">
      <set item="Content" value="_GET_LANG|${sCountertype}__COUNTERS_NOTPCOUNTERS" />
      <set item="Sender" value="${sCustomer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '#{//Item/Attribute[@name='_COUNTERS_TYPE']/@value}'!=''}" call="CheckCounters102_Step3">
      <set item="Content" value="_GET_LANG|${sCountertype}_#{//Item/Attribute[@name='_COUNTERS_TYPE']/@value}" />
      <set item="Sender" value="${sCustomer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,320990)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="CheckCounters102_Step3" sessionStorage="Memory" sessionLifetime="30" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(${Sender}_checkonetimecounters__PARCE_LANG)}">
        <Item customer="${Sender}" subject="balance">
          <Attribute name="unpayment" value="0" />
          <Attribute name="requestcountertype" value="2" />
          @{store(sCustomer,${Sender})}
          @{store(sRecipient,${Recipient})}
          @{store(sLang,_PARCE_LANG)}
          @{store(sCountertype,#{replace('_PARCE_CONTENT','(.*)_(.*)','$1')})}
          @{store(sCounterTP,#{replace('_PARCE_CONTENT','(.*)_(.*)','$2')})}
          @{store(sModule,_CURRENT_MODULE)}
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '#{//Item/Attribute[@name='accumulator']/@value}'=''}" call="ALLServiceStringFormat">
      <set item="Content" value="${sCounterTP}_COUNTERS_NOONETIMECOUNTERS" />
      <set item="Sender" value="${sCustomer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '#{//Item/Attribute[@name='_COUNTERS_TYPE']/@value}'!=''}" call="ALLServiceStringFormat">
      <set item="Content" value="${sCounterTP}#{//Item/Attribute[@name='_COUNTERS_TYPE']/@value}" />
      <set item="Sender" value="${sCustomer}" />
      <set item="Recipient" value="${sRecipient}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="ALLServiceStringFormat">
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,320990)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SlujebNumberTpChange_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="true">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="changetariffplan" action="0" class="${sTariffIvrCode}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}" call="TariffPlanStringFormat">
      <set conditionEx="0@{store(SlowAsync,_WAIT_IFASYNC_INPROCESS)}" />
      <set item="Content" conditionEx="#{'${dbresult}'='0'}" value="@{store(sDbresult,success)}" />
      <set item="Content" conditionEx="#{'${dbresult}'!='0'}" value="@{store(sDbresult,${dbresult})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0'}" call="SlujebNumberTpChange_Step3" />
  </template>
  <template procedureName="SlujebNumberTpChange_Step3" handler="_DBCON" sessionStorage="Memory" sessionLifetime="300" persistent="true">
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item procedureName="other_spikes.slujeb_number_tp_change">
          <Attribute name="p_msisdn" type="STRING" value="${sSlujebNumber}" />
          <Attribute name="p_code" type="STRING" value="${sSlujebCode}" />
          <Attribute name="p_customer" type="STRING" value="${sCustomer}" />
          <Attribute name="result" type="out:STRING" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${result}'='666'}">
      <set item="Content" value="Smena TP ne vozmojna. Ne verniy kod." />
      <set item="Sender" value="${Sender}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set item="UssdServiceOp" value="1" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SendSMS" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate />
    <deliveryTemplate>
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="_DEF_USSDNUM" />
      <set item="Recipient" value="${Recipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
  </template>
  <template procedureName="GetInfo" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate />
    <deliveryTemplate>
      <set item="Content" value="${no-escape:Content}" />
      <set item="Sender" value="_DEF_USSDNUM" />
      <set item="Recipient" value="${Recipient}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
  </template>
  <template procedureName="USSDIncomingContent" sessionStorage="Memory" sessionLifetime="30" persistent="false">
    <condition>
      <test item="1" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${Sender}" />
        @{store(sRecipient,${Recipient})}
        @{store(sContent,_PARCE_CONTENT)}
        @{store(sLang,_PARCE_LANG)}
        @{store(sModule,_CURRENT_MODULE)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sDbresult,ussd_err${sContent})}" />
    <deliveryTemplate conditionEx="#{_GET_LENGTH_DBRESULT&gt;155}" terminating="false">
      <set item="Content" value="#{document('_DICTIONARY_PATH')/Dictionary/Item[code/@value='ussd_ExcessLength']/@info__GET_LANG}" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set item="UssdServiceOp" value="1" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{_GET_LENGTH_DBRESULT&gt;155}" connector="_SMSCON_1" />
    <deliveryTemplate>
      <set conditionEx="0@{store(sDbresult,#{if(_GET_LENGTH_DBRESULT&gt;0,'${sDbresult}','ussd_err')})}" />
      <set item="Content" value="_GET_DBRESULT" />
      <set item="Sender" value="${sRecipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="_ENCODING" />
      <set item="UssdServiceOp" value="1" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
</templates>