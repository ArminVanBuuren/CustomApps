<templates connector="IVR">
  <macros>
    <!-- ==========================  REDIRECT CONNECTORS   ========================= -->
    <define name="_SMSCON_1" value="SMSCON_03_01" />
    <!-- ==========================  REDIRECT CONNECTORS   ========================= -->
    <!-- ==========================  SERVICE PROVISIONING  ========================= -->
    <define name="_GET_SERVICE_RESULT" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_${sDbresult}__GET_LANG}'='','#{if('#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@info_${sDbresult}__GET_LANG}'='','_GET_DBRESULT','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@info_${sDbresult}__GET_LANG}')}','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_${sDbresult}__GET_LANG}')}" />
    <define name="_GET_CONFIRM_SERVICE_RESULT" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='_SERVICE_CODE']/@info_${sDbresult}__GET_LANG}'='','#{if('#{document('_SERVICE_PATH')/ServiceList/Group[@name='#{document('_SERVICE_PATH')/ServiceList/GroupList/Item[@id='#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='_SERVICE_CODE']/@group}']/@name}']/@info_${sDbresult}__GET_LANG}'='','_GET_DBRESULT','#{document('_SERVICE_PATH')/ServiceList/Group[@name='#{document('_SERVICE_PATH')/ServiceList/GroupList/Item[@id='#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='_SERVICE_CODE']/@group}']/@name}']/@info_${sDbresult}__GET_LANG}')}','#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='_SERVICE_CODE']/@info_${sDbresult}__GET_LANG}')}" />
    <define name="_SERVICE_CONFIRM_NAME" value="#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='_SERVICE_CODE']/@service_name__GET_LANG}" />
    <define name="_SERVICE_TP_CNT" value="#{if(count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}']/ivrcode)&gt;0,count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}']/ivrcode),count(document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}']/ivrcode))}" />
    <define name="_SERVICE_TP_ISAVAIL" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@available}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@available}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/tplist[1]/@available}')}" />
    <define name="_SERVICE_TP_NOTAVALINFO" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@info_notaval__GET_LANG}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@info_notaval__GET_LANG}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/tplist[1]/@info_notaval__GET_LANG}')}" />
    <define name="_SERVICE_CUSTLST_CNT" value="#{if(count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/customer[@value='${customer}']/@value)&gt;0,count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/customer[@value='${customer}']/@value),count(document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/customerlist[1]/customer[@value='${customer}']/@value))}" />
    <define name="_SERVICE_CUSTLST_ISAVAIL" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@available}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@available}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/customerlist[1]/@available}')}" />
    <define name="_SERVICE_CUSTLST_NOTAVAILINFO" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@info_notaval__GET_LANG}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@info_notaval__GET_LANG}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/customerlist[1]/@info_notaval__GET_LANG}')}" />
    <define name="_SERVICE_SRVBIND_CNT" value="#{if(count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service)&gt;0,count(document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service),count(document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/servicebindinglist[1]/service))}" />
    <define name="_SERVICE_SRVBIND_SRVCODE" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@service_code}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@service_code}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@service_code}')}" />
    <define name="_SERVICE_SRVBIND_SUBSR" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@subscription}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@subscription}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@subscription}')}" />
    <define name="_SERVICE_SRVBIND_STORE" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@store}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@store}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@store}')}" />
    <define name="_SERVICE_SRVBIND_INFO" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}'!='','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}')}" />
    <define name="_SERVICE_SUCCESSFUL_RESPONSE" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@successful_response}'='','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@successful_response}','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@successful_response}')}" />
    <define name="_SERVICE_CHECKBLOCK" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@check_block}'='','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@check_block}','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@check_block}')}" />
    <define name="_SERVICE_REDIRECT" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@redirect}'='','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@redirect}','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@redirect}')}" />
    <define name="_SERVICE_AVAIL_BAL" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@availbalance}'='','#{document('_SERVICE_PATH')/ServiceList/Group[@name='${sGroupName}']/@availbalance}','#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@availbalance}')}" />
    <define name="_SERVICE_TIMETOPROGRESS" value="#{if('#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='#{if('${sServiceCode}'='','_SERVICE_CODE','${sServiceCode}')}']/@timetoprogress}'='','#{document('_SERVICE_PATH')/ServiceList/Group[@name='#{if('${sGroupName}'='','_SERVICE_GROUPNAME','${sGroupName}')}']/@timetoprogress}','#{document('_SERVICE_PATH')/ServiceList/Service[@service_code='#{if('${sServiceCode}'='','_SERVICE_CODE','${sServiceCode}')}']/@timetoprogress}')}" />
    <define name="_SERVICE_DATEFROM" value="#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@datefrom}" />
    <define name="_SERVICE_DATETO" value="#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@dateto}" />
    <define name="_SERVICE_NAME" value="#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@service_name__GET_LANG}" />
    <define name="_SERVICE_GROUPNAME" value="#{document('_SERVICE_PATH')/ServiceList/GroupList/Item[@id='#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@group}']/@name}" />
    <define name="_SERVICE_COMM_ACTION" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[_CURRENT_MODULE/@value='${sAction}']/@action}" />
    <define name="_SERVICE_COMM_STATUS" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[_CURRENT_MODULE/@value='${sAction}']/@status}" />
    <define name="_SERVICE_COMM_CODE" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[_CURRENT_MODULE/@value='${sAction}']/@code}" />
    <define name="_SERVICE_COMM_ACTPARCE" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[_CURRENT_MODULE/@value='${sAction}']/@parce}" />
    <define name="_SERVICE_CRMSTATUS" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[@status='${subscription}']/@parce}" />
    <define name="_SERVICE_CRMACTION_ADD" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[@action='2']/@parce}" />
    <define name="_SERVICE_CRMACTION_DEL" value="#{document('_SERVICE_PATH')/ServiceList/CommandList/Command[@action='3']/@parce}" />
    <define name="_SERVICE_CODE" value="#{document('_SERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@service_code}" />
    <!-- ==========================  SERVICE PROVISIONING  ========================= -->
    <!-- ==========================  CHANGE TP   ========================= -->
    <define name="_GET_TARIFF_RESULT" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@info_${sDbresult}__GET_LANG}'='','#{if('#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@info_${sDbresult}__GET_LANG}'='','_GET_DBRESULT','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@info_${sDbresult}__GET_LANG}')}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@info_${sDbresult}__GET_LANG}')}" />
    <define name="_GET_CONFIRM_TARIFF_RESULT" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='#{//Message/Item/@tariffplan}']/@info_${sDbresult}__GET_LANG}'='','#{if('#{document('_TARIF_PATH')/TariffPlans/Group[@name='#{document('_TARIF_PATH')/TariffPlans/GroupList/Item[@id='#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='#{//Message/Item/@tariffplan}']/@group}']/@name}']/@info_${sDbresult}__GET_LANG}'='','_GET_DBRESULT','#{document('_TARIF_PATH')/TariffPlans/Group[@name='#{document('_TARIF_PATH')/TariffPlans/GroupList/Item[@id='#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='#{//Message/Item/@tariffplan}']/@group}']/@name}']/@info_${sDbresult}__GET_LANG}')}','#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='#{//Message/Item/@tariffplan}']/@info_${sDbresult}__GET_LANG}')}" />
    <define name="_TARIFF_TP_CNT" value="#{if(count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}'])&gt;0,count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}']),count(document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}']))}" />
    <define name="_TARIFF_TP_ISAVAIL" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@available}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@available}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@available}')}" />
    <define name="_TARIFF_TP_NOTAVAILINFO" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@info_notaval__GET_LANG}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@info_notaval__GET_LANG}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/tplist[1]/@info_notaval__GET_LANG}')}" />
    <define name="_TARIFF_CUSTLST_CNT" value="#{if(count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/customer[@value='${customer}'])&gt;0,count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/customer[@value='${customer}']),count(document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/customerlist[1]/customer[@value='${customer}']))}" />
    <define name="_TARIFF_CUSTLST_ISAVAIL" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/@available}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/@available}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/customerlist[1]/@available}')}" />
    <define name="_TARIFF_CUSTLST_NOTAVAILINFO" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/@info_notaval__GET_LANG}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/customerlist[1]/@info_notaval__GET_LANG}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/customerlist[1]/@info_notaval__GET_LANG}')}" />
    <define name="_TARIFF_SRVBIND_CNT" value="#{if(count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service)&gt;0,count(document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service),count(document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/servicebindinglist[1]/service))}" />
    <define name="_TARIFF_SRVBIND_SRVCODE" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@service_code}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@service_code}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@service_code}')}" />
    <define name="_TARIFF_SRVBIND_SUBSR" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@subscription}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@subscription}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@subscription}')}" />
    <define name="_TARIFF_SRVBIND_STORE" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@store}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@store}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@store}')}" />
    <define name="_TARIFF_SRVBIND_INFO" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}'!='','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}')}" />
    <define name="_TARIFF_SUCCESSFUL_RESPONSE" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@successful_response}'='','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@successful_response}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@successful_response}')}" />
    <define name="_TARIFF_CHECKBLOCK" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@check_block}'='','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@check_block}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@check_block}')}" />
    <define name="_TARIFF_REDIRECT" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@redirect}'='','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@redirect}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@redirect}')}" />
    <define name="_TARIFF_TIMETOPROGRESS" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='#{if('${sTariffIvrCode}'='','_TARIFF_IVRCODE','${sTariffIvrCode}')}']/@timetoprogress}'='','#{document('_TARIF_PATH')/TariffPlans/Group[@name='#{if('${sGroupName}'='','_TARIFF_GROUPNAME','${sGroupName}')}']/@timetoprogress}','#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='#{if('${sTariffIvrCode}'='','_TARIFF_IVRCODE','${sTariffIvrCode}')}']/@timetoprogress}')}" />
    <define name="_TARIFF_AVAIL_BAL" value="#{if('#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@availbalance}'='','#{document('_TARIF_PATH')/TariffPlans/Group[@name='${sGroupName}']/@availbalance}','#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@availbalance}')}" />
    <define name="_TARIFF_DATEFROM" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@datefrom}" />
    <define name="_TARIFF_DATETO" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@dateto}" />
    <define name="_TARIFF_NAME" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@tariffname__GET_LANG}" />
    <define name="_TARIFF_GROUPNAME" value="#{document('_TARIF_PATH')/TariffPlans/GroupList/Item[@id='#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@group}']/@name}" />
    <define name="_TARIFF_CURRENT_NAME" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[@ivrcode='#{//Message/Item/@tariffplan}']/@tariffname__GET_LANG}" />
    <define name="_TARIFF_IVRCODE" value="#{document('_TARIF_PATH')/TariffPlans/Tariff[_CURRENT_MODULE/@value='${sNewTariffPlan}']/@ivrcode}" />
    <!-- ==========================  CHANGE TP  ========================= -->
    <!-- ==========================  ALL SERVICE   ========================= -->
    <define name="_COUNTERS_TYPE" value="#{document('_COUNTERS_PATH')/Counters/Group[_CURRENT_MODULE/@value='${sCountertype}']/@name}" />
    <define name="_GET_ALL_SRV_RESULT" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@info_${sDbresult}__GET_LANG}" />
    <define name="_ALLSERVICE_TP_CNT" value="count(document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1][ivrcode/@value='#{//Message/Item/@tariffplan}'])" />
    <define name="_ALLSERVICE_TP_ISAVAIL" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@available}" />
    <define name="_ALLSERVICE_TP_NOTAVAILINFO" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/tplist[1]/@info_notaval__GET_LANG}" />
    <define name="_ALLSERVICE_CUSTLST_CNT" value="count(document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/customer[@value='${customer}'])" />
    <define name="_ALLSERVICE_CUSTLST_ISAVAIL" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@available}" />
    <define name="_ALLSERVICE_CUSTLST_NOTAVAILINFO" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/customerlist[1]/@info_notaval__GET_LANG}" />
    <define name="_ALLSERVICE_SRVBIND_CNT" value="count(document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service)" />
    <define name="_ALLSERVICE_SRVBIND_SRVCODE" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@service_code}" />
    <define name="_ALLSERVICE_SRVBIND_SUBSR" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@subscription}" />
    <define name="_ALLSERVICE_SRVBIND_STORE" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@store}" />
    <define name="_ALLSERVICE_SRVBIND_INFO" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/servicebindinglist[1]/service[${sCnt}]/@info_notaval__GET_LANG}" />
    <define name="_ALLSERVICE_SUCCESSFUL_RESPONSE" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@successful_response}" />
    <define name="_ALLSERVICE_CHECKBLOCK" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@check_block}" />
    <define name="_ALLSERVICE_REDIRECT" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@redirect}" />
    <define name="_ALLSERVICE_TIMETOPROGRESS" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@timetoprogress}" />
    <define name="_ALLSERVICE_AVAIL_BAL" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@availbalance}" />
    <define name="_ALLSERVICE_NAME" value="#{document('_ALLSERVICE_PATH')/ServiceList/Service[_CURRENT_MODULE/@value='${sService}']/@name}" />
    <!-- ==========================  ALL SERVICE   ========================= -->
    <!-- ==========================  SETTINGS   ========================= -->
    <define name="_WAIT_IFASYNC_INPROCESS" value="#{if('${sDbresult}'='redirect','#{if(not(matches('${sInProgress}','_IF_TRUE')),'true','')}','')}" />
    <define name="_GET_TODAY" value="#{concat(substring('@{now}',7,4),substring('@{now}',4,2),substring('@{now}',1,2))}" />
    <define name="_GET_SECONDS" value="#{(number(substring('@{now}',12,2)) * 60 * 60) + (number(substring('@{now}',15,2)) * 60) + number(substring('@{now}',18,2))}" />
    <define name="_GET_DBRESULT" value="#{document('_DICTIONARY_PATH')/Dictionary/Item[code/@value='${sDbresult}']/@info__GET_LANG}" />
    <define name="_GET_LENGTH_DBRESULT" value="#{string-length(document('_DICTIONARY_PATH')/Dictionary/Item[code/@value='${sDbresult}']/@info__GET_LANG)}" />
    <define name="_GET_AFTER_VERIFY_DBRESULT" value="#{if('#{document('_DICTIONARY_PATH')/Dictionary/Item[code/@value='${customerblocks}']/@info__GET_LANG}'!='','${customerblocks}','${dbresult}')}" />
    <define name="_ENCODING" value="#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@param='_GET_LANG']/@encoding}" />
    <define name="_INLANGUAGE" value="#{if('#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@language_id='${language_id}']/@param}'='','#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@language_id='']/@param}','#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@language_id='${language_id}']/@param}')}" />
    <define name="_GET_LANG" value="#{if('${sLang}'='','#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[@language_id='']/@param}','${sLang}')}" />
    <define name="_DEFAULT_ERR" value="#{if('${dbresult}'='-1','err001','${dbresult}')}" />
    <define name="_REDIRECT_TO_SMS" value="^[Ss][Mm][Ss]$" />
    <define name="_REDIRECT_TO_CURRENT" value="^[Nn][Oo][Tt][Rr][Ee][Dd][Ii][Rr][Ee][Cc][Tt]$" />
    <define name="_IF_TRUE" value="^([Tt][Rr][Uu][Ee]|1)$" />
    <define name="_BYCRM" value="[Bb][Yy][Cc][Rr][Mm]" />
    <define name="_SERVICE_PATH" value="..\..\Config\Service\SERVICE.xml" />
    <define name="_ALLSERVICE_PATH" value="..\..\Config\Service\All_SERVICE.xml" />
    <define name="_TARIF_PATH" value="..\..\Config\Tariff\TARIFF_PLANS.xml" />
    <define name="_COUNTERS_PATH" value="..\..\Config\Service\COUNTERS.xml" />
    <define name="_DICTIONARY_PATH" value="..\..\Config\DICTIONARY.xml" />
    <define name="_DEALERPORTAL_PATH" value="..\..\Config\Portal\DealerUSSDPortal_01.xml" />
    <define name="_SERIES_PATH" value="..\..\Config\Service\SERIES.xml" />
    <define name="_CURRENT_MODULE" value="ivrcon" />
    <define name="_CONFIRM_VALUE" value="confirm" />
    <define name="_CURRENT_INITIATOR" value="ivrcon" />
    <!-- ==========================  SETTINGS   ========================= -->
  </macros>
  <template procedureName="DB_CValidation" handler="DBCON_03_01" sessionStorage="Memory" sessionLifetime="30">
    <condition />
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(IVR_CVal_${customer})}">
        <Item procedureName="other_spikes.ivr_customer_rating">
          <Attribute name="p_msisdn" type="STRING" value="${customer}" />
          <Attribute name="result" type="out:STRING" />
        </Item>
        @{store(sCustomer,${customer})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="DB_CValidation_Step2">
      <set item="param:MarkCat" value="${result}" />
    </deliveryTemplate>
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="TariffPlan" type="3" value="0" />
      <param name="State" type="2" value="0" />
      <param name="Password" type="1" value="" />
      <param name="regioncode" type="3" value="0" />
      <param name="MarkCat" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_CValidation_Step2">
    <condition />
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="checkivrservice" value="1" />
          <Attribute name="checkblocks" value="0" />
        </Item>
        @{store(sMarkCat,${MarkCat})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="param:DBResult" value="${dbresult}" />
      <set item="param:TariffPlan" value="${tariffplan}" />
      <set item="param:State" value="${state}" />
      <set item="param:Password" value="${password}" />
      <set item="param:regioncode" value="${regioncode}" />
      <set item="param:MarkCat" value="${sMarkCat}" />
    </deliveryTemplate>
    <input>
      <param name="dbresult" />
      <param name="TariffPlan" />
      <param name="State" />
      <param name="Password" />
      <param name="regioncode" />
      <param name="MarkCat" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="TariffPlan" type="3" value="0" />
      <param name="State" type="2" value="0" />
      <param name="Password" type="1" value="" />
      <param name="regioncode" type="3" value="0" />
      <param name="MarkCat" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_SInterrogation" sessionStorage="Memory" sessionLifetime="30">
    <condition />
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(IVR_SrvInter_${customer})}">
        @{store(sService,${service})}
        <Item customer="${customer}">
          <Service id="_SERVICE_CODE" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="param:DBResult" value="${dbresult}" />
      <set item="param:Allowed" value="${allowed}" />
      <set item="param:Subscription" value="${subscription}" />
      <set item="param:Status" value="${status}" />
      <set item="param:Class" value="${class}" />
      <set item="param:ChargedAmount" value="${chargedamount}" />
    </deliveryTemplate>
    <input>
      <param name="customer" />
      <param name="service" />
    </input>
    <output>
      <param name="DBResult" type="3" value="0" />
      <param name="Allowed" type="2" value="0" />
      <param name="Subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="Class" type="3" value="0" />
      <param name="ChargedAmount" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_SProcessing" sessionStorage="Memory" sessionLifetime="300">
    <condition />
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="@{setSessionId(@{switch(${service}|SrvProv,11111|ChangeTP,changetariffplan|ChangeTP)}_${customer})}">
        <Item customer="${customer}" />
        @{store(sCustomer,${customer})}
        @{store(sService,${service})}
        @{store(sAction,${action})}
        @{store(sNewTariffPlan,${class})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sService}'='11111' or '${sService}'='changetariffplan'}" call="ChangeTariffPlan_Step2" />
    <deliveryTemplate call="ServiceProvisioning" />
    <input>
      <param name="customer" />
      <param name="service" />
      <param name="class" />
      <param name="action" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ServiceProvisioning" sessionStorage="Memory" sessionLifetime="300">
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${customer}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_SERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="false@{store(sServiceCode,#{if(matches('${sInProgress}','_IF_TRUE'),'${sServiceCode}','_SERVICE_CODE')})}" />
    <deliveryTemplate conditionEx="false@{store(sGroupName,#{if(matches('${sInProgress}','_IF_TRUE'),'${sGroupName}','_SERVICE_GROUPNAME')})}" />
    <deliveryTemplate conditionEx="false@{store(sParams,_SERVICE_NAME)}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sServiceCode}'='' or '${sService}'='' or '${sCustomer}'=''}">
      <set item="param:dbresult" value="329990" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}">
      <set item="param:dbresult" value="320174" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_SERVICE_CUSTLST_CNT&gt;0 and not(matches('_SERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_SERVICE_CUSTLST_CNT=0 and matches('_SERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_SERVICE_CUSTLST_NOTAVAILINFO'!=''}">
      <set item="param:dbresult" value="320004" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_GET_TODAY' &gt; '_SERVICE_DATETO'}">
      <set item="param:dbresult" value="320004" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_GET_TODAY' &lt; '_SERVICE_DATEFROM'}">
      <set item="param:dbresult" value="320004" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="ServiceProvisioning_Inter_Step3" />
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ServiceProvisioning_Inter_Step3" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="${sServiceCode}" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sActParce,_SERVICE_COMM_ACTPARCE)}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0' or '${sActParce}'='' or '_SERVICE_COMM_STATUS'='' or '_SERVICE_COMM_ACTION'=''}">
      <set item="param:dbresult" value="329990" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_SERVICE_COMM_STATUS'='${subscription}'}">
      <set item="param:dbresult" value="320207" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_SERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ServiceProvisioningChckBndBal" />
    <deliveryTemplate conditionEx="#{_SERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ServiceProvisioningChckBndSrv" />
    <deliveryTemplate call="ServiceProvisioning_Vrf_Step4" />
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ServiceProvisioningChckBndBal" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="balance">
          <Attribute name="unpayment" value="6" />
          <Attribute name="requestcountertype" value="0" />
        </Item>
        @{store(sIsBindBalAval,true)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100) &lt; _SERVICE_AVAIL_BAL}">
      <set item="param:dbresult" value="320191" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and number(${balanceintpartdotpart} div 100)&gt;_SERVICE_AVAIL_BAL and _SERVICE_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ServiceProvisioningChckBndSrv" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and number(${balanceintpartdotpart} div 100)&gt;_SERVICE_AVAIL_BAL}" call="ServiceProvisioning_Vrf_Step4" />
    <deliveryTemplate>
      <set item="param:dbresult" value="329990" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ServiceProvisioningChckBndSrv" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        @{store(sCnt,#{if('${sCnt}'='',1,number('${sCnt}')+1)})}
        <Item customer="${sCustomer}">
          <Service id="_SERVICE_SRVBIND_SRVCODE" action="interrogation" />
        </Item>
        @{store(sIsBindSrvAval,true)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '${subscription}'='_SERVICE_SRVBIND_SUBSR' and '_SERVICE_SRVBIND_INFO'!=''}">
      <set item="param:dbresult" value="320010" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and ${sCnt}=_SERVICE_SRVBIND_CNT and ${subscription}=_SERVICE_SRVBIND_SUBSR}" call="ServiceProvisioning_Vrf_Step4">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_SERVICE_SRVBIND_STORE','${sRequi};_SERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and ${sCnt}=_SERVICE_SRVBIND_CNT and ${subscription}!=_SERVICE_SRVBIND_SUBSR}" call="ServiceProvisioning_Vrf_Step4" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '${subscription}'!='_SERVICE_SRVBIND_SUBSR'}" call="ServiceProvisioningChckBndSrv" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '${subscription}'='_SERVICE_SRVBIND_SUBSR'}" call="ServiceProvisioningChckBndSrv">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_SERVICE_SRVBIND_STORE','${sRequi};_SERVICE_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="param:dbresult" value="329990" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ServiceProvisioning_Vrf_Step4" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{('${customerblocks}'!='' or '${dbresult}'='320347') and matches('_SERVICE_CHECKBLOCK','_IF_TRUE')}">
      <set item="param:dbresult" value="320002" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0' and '${dbresult}'!='320347'}">
      <set item="param:dbresult" value="320003" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_SERVICE_TP_CNT&gt;0 and not(matches('_SERVICE_TP_ISAVAIL','_IF_TRUE'))) or (_SERVICE_TP_CNT=0 and matches('_SERVICE_TP_ISAVAIL','_IF_TRUE'))) and '_SERVICE_TP_NOTAVALINFO'!=''}">
      <set item="param:dbresult" value="320004" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sGroupName}'='BMS'}" call="ServiceProvisioning_BMS_Step6" />
    <deliveryTemplate conditionEx="#{'${sGroupName}'='BLOCKS'}" call="ServiceProvisioning_Block_Step6" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0'}" call="ServiceProvisioning_Order_Step5" />
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ServiceProvisioning_Order_Step5" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="${sServiceCode}" action="_SERVICE_COMM_ACTION" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0'}">
      <set conditionEx="0@{store(sStartSecond,_GET_SECONDS)}" />
      <set conditionEx="0@{store(sDbresult,success_${sActParce})}" />
      <set item="param:dbresult" value="0" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ServiceProvisioning_Block_Step6" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="blockphone" action="4">
            <Attribute name="state" value="_SERVICE_COMM_STATUS" />
            <Attribute name="start" value="#{substring('@{now}',1,10)}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0'}">
      <set conditionEx="0@{store(sStartSecond,_GET_SECONDS)}" />
      <set conditionEx="0@{store(sDbresult,success_${sActParce})}" />
      <set item="param:dbresult" value="0" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ServiceProvisioning_BMS_Step6" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="orderbonusgiftrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="giftcode" value="${sServiceCode}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0'}">
      <set conditionEx="0@{store(sStartSecond,_GET_SECONDS)}" />
      <set conditionEx="0@{store(sDbresult,success_${sActParce})}" />
      <set item="param:dbresult" value="0" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input />
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ChangeTariffPlan_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition />
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Attribute name="checkivrservice" value="1" />
          <Attribute name="checkblocks" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_TARIFF_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="false@{store(sTariffIvrCode,#{if(matches('${sInProgress}','_IF_TRUE'),'${sTariffIvrCode}','_TARIFF_IVRCODE')})}" />
    <deliveryTemplate conditionEx="false@{store(sGroupName,#{if(matches('${sInProgress}','_IF_TRUE'),'${sGroupName}','_TARIFF_GROUPNAME')})}" />
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}">
      <set conditionEx="0@{store(sDbresult,inprogress)}" />
      <set item="param:dbresult" value="320174" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_GET_TODAY' &gt; '_TARIFF_DATETO' or '_GET_TODAY' &lt; '_TARIFF_DATEFROM'}">
      <set item="param:dbresult" value="320015" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_TARIFF_CUSTLST_CNT&gt;0 and not(matches('_TARIFF_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_TARIFF_CUSTLST_CNT=0 and matches('_TARIFF_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_TARIFF_CUSTLST_NOTAVAILINFO'!=''}">
      <set item="param:dbresult" value="320000" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sTariffIvrCode}'='#{//Message/Item/@tariffplan}'}">
      <set item="param:dbresult" value="320001" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{('${customerblocks}'!='' or '${dbresult}'='320347') and matches('_TARIFF_CHECKBLOCK','_IF_TRUE')  and '${customerblocks}'!='FRPARTBL'}">
      <set item="param:dbresult" value="320002" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0' and '${dbresult}'!='320347'}">
      <set item="param:dbresult" value="320003" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_TARIFF_TP_CNT&gt;0 and not(matches('_TARIFF_TP_ISAVAIL','_IF_TRUE'))) or (_TARIFF_TP_CNT=0 and matches('_TARIFF_TP_ISAVAIL','_IF_TRUE'))) and '_TARIFF_TP_NOTAVAILINFO'!=''}">
      <set item="param:dbresult" value="320004" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_TARIFF_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="ChangeTariffPlanCheckBindingBal" />
    <deliveryTemplate conditionEx="#{_TARIFF_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ChangeTariffPlanCheckSrvBinding" />
    <deliveryTemplate call="ChangeTariffPlan_Step4" />
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ChangeTariffPlanCheckBindingBal" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="balance">
          <Attribute name="unpayment" value="6" />
          <Attribute name="requestcountertype" value="0" />
        </Item>
        @{store(sIsBindBalAval,true)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100) &lt; _TARIFF_AVAIL_BAL}">
      <set item="param:dbresult" value="320191" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_TARIFF_AVAIL_BAL and _TARIFF_SRVBIND_CNT&gt;0 and not(matches('${sIsBindSrvAval}','_IF_TRUE'))}" call="ChangeTariffPlanCheckSrvBinding" />
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_TARIFF_AVAIL_BAL}" call="ChangeTariffPlan_Step4" />
    <deliveryTemplate>
      <set item="param:dbresult" value="329990" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ChangeTariffPlanCheckSrvBinding" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        @{store(sCnt,#{if('${sCnt}'='',1,number('${sCnt}')+1)})}
        <Item customer="${sCustomer}">
          <Service id="_TARIFF_SRVBIND_SRVCODE" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and ${sCnt}=_TARIFF_SRVBIND_CNT and ${subscription}=_TARIFF_SRVBIND_SUBSR}" call="ChangeTariffPlan_Step4">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_TARIFF_SRVBIND_STORE','${sRequi};_TARIFF_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and ${sCnt}=_TARIFF_SRVBIND_CNT and ${subscription}!=_TARIFF_SRVBIND_SUBSR}" call="ChangeTariffPlan_Step4" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '${subscription}'!='_TARIFF_SRVBIND_SUBSR'}" call="ChangeTariffPlanCheckSrvBinding" />
    <deliveryTemplate conditionEx="#{'${dbresult}'='0' and '${subscription}'='_TARIFF_SRVBIND_SUBSR'}" call="ChangeTariffPlanCheckSrvBinding">
      <set conditionEx="0@{store(sRequi,#{if('${sRequi}'='','_TARIFF_SRVBIND_STORE','${sRequi};_TARIFF_SRVBIND_STORE')})}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="param:dbresult" value="329990" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="ChangeTariffPlan_Step4" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="changetariffplan" action="0" class="${sTariffIvrCode}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='0'}">
      <set conditionEx="0@{store(sStartSecond,_GET_SECONDS)}" />
      <set conditionEx="0@{store(sDbresult,success)}" />
      <set item="param:dbresult" value="0" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="dbresult" />
      <param name="subscription" />
      <param name="Status" />
      <param name="ISCharged" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="subscription" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="ISCharged" type="2" value="0" />
    </output>
  </template>
  <template procedureName="DB_SProcessing2" sessionStorage="Memory" sessionLifetime="300">
    <receiveTemplate>
      <Message type="verificationrequest" initiator="ivrcon" id="@{newGuid}" session_id="@{setSessionId(IVR_GrntPay_${customer})}">
        <Item customer="${customer}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
        @{store(sCustomer,${customer})}
        @{store(sService,_GRNTPAY)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="false@{store(sInProgress,#{if(number(_GET_SECONDS)-number(${sStartSecond})&lt;number(_ALLSERVICE_TIMETOPROGRESS) and number(_GET_SECONDS)-number(${sStartSecond})&gt;0,'true','false')})}" />
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sCustomer}'=''}">
      <set item="param:dbresult" value="329990" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{matches('${sInProgress}','_IF_TRUE')}">
      <set item="param:dbresult" value="320174" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{((_ALLSERVICE_CUSTLST_CNT&gt;0 and not(matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) or (_ALLSERVICE_CUSTLST_CNT=0 and matches('_ALLSERVICE_CUSTLST_ISAVAIL','_IF_TRUE'))) and '_ALLSERVICE_CUSTLST_NOTAVAILINFO'!=''}">
      <set item="param:dbresult" value="320004" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'_ALLSERVICE_AVAIL_BAL'!='' and not(matches('${sIsBindBalAval}','_IF_TRUE'))}" call="DB_SProcessing2_Step2" />
    <deliveryTemplate call="DB_GrntPay_Validation" />
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_SProcessing2_Step2" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}" subject="balance">
          <Attribute name="unpayment" value="6" />
          <Attribute name="requestcountertype" value="0" />
        </Item>
        @{store(sIsBindBalAval,true)}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
      <set item="param:dbresult" value="${dbresult}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100) &lt; _ALLSERVICE_AVAIL_BAL}">
      <set item="param:dbresult" value="320191" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{number(${balanceintpartdotpart} div 100)&gt;_ALLSERVICE_AVAIL_BAL and '_ALLSERVICE_NAME'='_GRNTPAY'}" call="DB_GrntPay_Validation" />
    <deliveryTemplate>
      <set item="param:dbresult" value="329990" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_GrntPay_Validation" handler="DBCON_03_01" sessionStorage="Memory" sessionLifetime="300" persistent="false">
    <condition />
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${SessionId}">
        <Item procedureName="other_spikes.customer_type">
          <Attribute name="p_msisdn" type="STRING" value="${sCustomer}" />
          <Attribute name="result" type="out:STRING" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${result}'!='1'}"> <!--1-->
      <set item="param:dbresult" value="320194" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="DB_SProcessing2_Step3" />
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_SProcessing2_Step3" sessionStorage="Memory" sessionLifetime="300">
    <condition />
    <receiveTemplate>
      <Message type="serviceorder" initiator="ivrcon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sCustomer}">
          <Service id="guaranteedpayment" action="7">
            <Attribute name="amount" value="300" />
            <Attribute name="currency" value="840" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_BalanceRetriev" sessionStorage="Memory" sessionLifetime="20">
    <condition />
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_BalRetr_${customer}">
        <Item customer="${customer}" subject="balance">
          <Attribute name="unpayment" value="0" />
          <Attribute name="requestcountertype" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate terminating="false" connector="_SMSCON_1">
      <set item="Content" value="Balans Vashego scheta: #{#{/Message/Item/Attribute[@name='balanceintpartdotpart']/@value} div 100} USD" />
      <set item="Sender" value="111" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="param:balanceintpartdotpart" value="${balanceintpartdotpart}" />
      <set item="param:DisconnectionTime" value="${DisconnectionTime}" />
      <set item="param:recommendedprepayment" value="${recommendedprepayment}" />
      <set item="param:accumulator" value="${accumulator}" />
      <set item="param:currency" value="${currency}" />
    </deliveryTemplate>
    <input>
      <param name="Customer" />
    </input>
    <output>
      <param name="balanceintpartdotpart" type="1" value="0" />
      <param name="DisconnectionTime" type="1" value="0" />
      <param name="recommendedprepayment" type="1" value="0" />
      <param name="accumulator" type="1" value="0" />
      <param name="currency" type="1" value="0" />
    </output>
  </template>
  <template procedureName="DB_BalanceRetriev2">
    <condition />
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${Customer}_GetIVRBalance_#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[_CURRENT_MODULE/@value='rut']/@param}">
        <Item customer="${Customer}" subject="balance">
          <Attribute name="unpayment" value="0" />
          <Attribute name="requestcountertype" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="param:DBResult" value="${dbresult}" />
      <set item="param:AccBalance" value="${balanceintpartdotpart}" />
      <set item="param:AccGPRS" value="#{if('${accumulator}'='','-1','#{replace('#{//Item/Attribute[@name='gprs']/@value}','(.+)\.(.+)','$1')}')}" />
      <set item="param:AccMIN" value="#{if('${accumulator}'='','-1','#{replace('#{//Item/Attribute[@name='voice']/@value}','(\d+)(\.(.*))?','$1')}')}" />
      <set item="param:AccSMS" value="#{if('${accumulator}'='','-1','#{//Item/Attribute[@name='sms']/@value}')}" />
    </deliveryTemplate>
    <input>
      <param name="Customer" />
    </input>
    <output>
      <param name="DBResult" type="3" value="-1" />
      <param name="AccBalance" type="3" value="-1" />
      <param name="AccGPRS" type="3" value="-1" />
      <param name="AccMIN" type="3" value="-1" />
      <param name="AccSMS" type="3" value="-1" />
    </output>
  </template>
  <template procedureName="DB_BalanceRetriev3">
    <condition />
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="${Customer}_GetIVRBalance_#{document('_DICTIONARY_PATH')/Dictionary/Language/Item[_CURRENT_MODULE/@value='rut']/@param}">
        <Item customer="${Customer}" subject="balance">
          <Attribute name="unpayment" value="0" />
          <Attribute name="requestcountertype" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="param:DBResult" value="${dbresult}" />
      <set item="param:AccBalance" value="${balanceintpartdotpart}" />
      <set item="param:AccGPRS" value="#{if('${accumulator}'='','-1','#{replace('#{//Item/Attribute[@name='gprs']/@value}','(.+)\.(.+)','$1')}')}" />
      <set item="param:AccMIN" value="-1" />
      <set item="param:AccMIN_1" value="#{if('${accumulator}'='','-1','#{replace('#{//Item/Attribute[@name='voice']/@value}','(\d{0,9})\\.(\d{0,9})','$2')}')}" />
      <set item="param:AccMIN_2" value="#{if('${accumulator}'='','-1','#{replace('#{//Item/Attribute[@name='voice']/@value}','(\d{0,9})\\.(\d{0,9})','$1')}')}" />
      <set item="param:AccSMS" value="#{if('${accumulator}'='','-1','#{//Item/Attribute[@name='sms']/@value}')}" />
    </deliveryTemplate>
    <input>
      <param name="Customer" />
    </input>
    <output>
      <param name="DBResult" type="3" value="-1" />
      <param name="AccBalance" type="3" value="-1" />
      <param name="AccGPRS" type="3" value="-1" />
      <param name="AccMIN" type="3" value="-1" />
      <param name="AccMIN_1" type="3" value="-1" />
      <param name="AccMIN_2" type="3" value="-1" />
      <param name="AccSMS" type="3" value="-1" />
    </output>
  </template>
  <template procedureName="SendPriceSMS">
    <condition />
    <receiveTemplate>
      <Message type="dummyrequest" process="dispatcher" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_SndPrice_${sender}">
        <Item customer="${anumber}">
          <Sender value="${sender}" />
          <Recipient value="${recipient}" />
          <Content value="${content}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="param:dbresult" value="0" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" connector="_SMSCON_1" />
    <input>
      <param name="anumber" />
      <param name="sender" />
      <param name="content" />
      <param name="recipient" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_FaxUpdating">
    <condition />
    <receiveTemplate>
      <Message type="setprofile" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_FAX_${customer}_${faxnumber}">
        <Item customer="${customer}">
          <Attribute name="faxnumber" value="${faxnumber}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="faxnumber" />
    </input>
    <output />
  </template>
  <template procedureName="DB_FavUpdate">
    <condition />
    <receiveTemplate>
      <Message type="setprofile" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_FavUp_${customer}">
        <Item customer="${customer}" action="${action}">
          <Attribute name="favouritenumber" value="${favouritenumber}" />
          <Attribute name="index" value="${index}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="index" />
      <param name="action" />
      <param name="favouritenumber" />
    </input>
    <output>
      <param name="favouritenumber" type="1" value="" />
      <param name="count" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_CAuthentication">
    <condition />
    <receiveTemplate>
      <Message type="authenticationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_CAut_${customer}">
        <Item customer="${customer}" pin="${password}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="password" />
    </input>
    <output>
      <param name="TariffPlan" type="3" value="0" />
      <param name="State" type="2" value="0" />
      <param name="regioncode" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_GrInterrogation">
    <condition />
    <receiveTemplate>
      <Message type="groupinterrogation" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_GrInt_${customer}">
        <Item customer="${customer}">
          <Service id="${groupcode}" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="groupcode" />
    </input>
    <output>
      <param name="service_id" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_ProcessDate">
    <condition />
    <receiveTemplate>
      <Message type="internal" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_PrDate_${customer}">
        <Item customer="${customer}" action="${action}">
          <Attribute name="startdate" value="${startdate}" />
          <Attribute name="enddate" value="${enddate}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="action" />
      <param name="startdate" />
      <param name="enddate" />
    </input>
    <output>
      <param name="startdate" type="1" value="" />
      <param name="enddate" type="1" value="" />
    </output>
  </template>
  <template procedureName="DB_KEOAuthorisation">
    <condition />
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_KeoAuth_${customer}">
        <Item customer="${customer}">
          <Service id="keoactivation" action="5">
            <Attribute name="keonumber" value="${keonumber}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="keonumber" />
    </input>
    <output>
      <param name="allowed" type="2" value="0" />
      <param name="amount" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_SInterrogation_Guaranted_Pay">
    <condition />
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_SInterGuaran_${customer}">
        <Item customer="${customer}" subject="get_guaranteedpayment" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="Allowed" type="2" value="0" />
      <param name="count" type="2" value="0" />
      <param name="Status" type="2" value="0" />
      <param name="Class" type="3" value="0" />
      <param name="ChargedAmount" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_PassChange">
    <condition />
    <receiveTemplate>
      <Message type="setprofile" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_PassChan_${customer}">
        <Item customer="${customer}">
          <Attribute name="oldpassword" value="${password}" />
          <Attribute name="newpassword" value="${newpassword}" />
          <Attribute name="confirmpassword" value="${confirmpassword}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="password" />
      <param name="newpassword" />
      <param name="confirmpassword" />
    </input>
    <output>
      <param name="newpassword" type="1" value="" />
    </output>
  </template>
  <template procedureName="DB_CCPayments">
    <condition />
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_CCPay_${customer}">
        <Item customer="${customer}">
          <Service id="creditcardpayment" action="5">
            <Attribute name="amount" value="${amount}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="amount" />
    </input>
    <output>
      <param name="allowed" type="2" value="0" />
      <param name="amount" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_FaxRetriev">
    <condition />
    <receiveTemplate>
      <Message type="retrieveinfo" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_FaxRetr_${customer}">
        <Item customer="${customer}" subject="faxnumber" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="assigned" type="2" value="0" />
      <param name="faxnumber" type="1" value="" />
    </output>
  </template>
  <template procedureName="dbAdd">
    <condition />
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_dbAdd_${Customer}">
        <Item customer="${customer}" subject="balance" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="Customer" />
      <param name="Param2" />
    </input>
    <output />
  </template>
  <template procedureName="DB_BillsRetriev">
    <condition />
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_BillsRetr_${customer}">
        <Item customer="${customer}" subject="bills">
          <Attribute name="index" value="${index}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="index" />
    </input>
    <output>
      <param name="count" type="3" value="0" />
      <param name="begindate" type="1" value="" />
      <param name="enddate" type="1" value="" />
    </output>
  </template>
  <template procedureName="DB_PaymentRetriev">
    <condition />
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_PayRet_${customer}">
        <Item customer="${customer}" subject="payments">
          <Attribute name="index" value="${index}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="index" />
    </input>
    <output>
      <param name="count" type="3" value="0" />
      <param name="day" type="4" value="" />
      <param name="currency" type="3" value="0" />
      <param name="intpartfracpart" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_CustomerBlock">
    <condition />
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_CustBlk_${customer}">
        <Item customer="${customer}">
          <Service id="blockphone" action="4">
            <Attribute name="state" value="${action}" />
            <Attribute name="start" value="${start}" />
            <Attribute name="end" value="${end}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="start" />
      <param name="end" />
      <param name="action" />
    </input>
    <output>
      <param name="state" type="2" value="0" />
    </output>
  </template>
  <template procedureName="DB_ExchangeRate">
    <condition />
    <receiveTemplate>
      <Message type="verificationrequest" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_ExRate_${customer}">
        <Item customer="${customer}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="param:calccurr" value="4210.35" />
    </deliveryTemplate>
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
      <param name="calccurr" type="3" value="0" />
    </output>
  </template>
  <template procedureName="VM_CRM_SETLANGUAGE">
    <condition />
    <receiveTemplate>
      <Message type="InvokeResult" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_SetLang_${ResultCode}">
        <Item request_id="${requestId}">
          <Result paremeter1="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="ResultCode" />
    </input>
    <output>
      <param name="Subscriber" type="1" value="" />
      <param name="Language" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_PrepaymentBill">
    <condition />
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_PrepBll_${customer}">
        <Item customer="${customer}">
          <Service id="otprepaymentbill" action="${otprepaymentbill}">
            <Attribute name="faxnumber" value="${faxnumber}" />
            <Attribute name="amountintpartdotpart" value="${amountintpartdotpart}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="amountintpartdotpart" />
      <param name="faxnumber" />
    </input>
    <output />
  </template>
  <template procedureName="DB_PayVerification">
    <condition />
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_PayVerif_${customer}">
        <Item customer="${customer}">
          <Service id="guaranteedpayment" action="6" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="allowed" type="2" value="0" />
      <param name="pending" type="2" value="0" />
      <param name="maximumusd" type="3" value="0" />
      <param name="maximumrur" type="3" value="0" />
    </output>
  </template>
  <template procedureName="DB_PayAcceptance">
    <condition />
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_PayAcc_${customer}">
        <Item customer="${customer}">
          <Service id="guaranteedpayment" action="7">
            <Attribute name="amount" value="${amount}" />
            <Attribute name="currency" value="${currency}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="currency" />
      <param name="amount" />
    </input>
    <output />
  </template>
  <template procedureName="DB_PRequest">
    <condition />
    <receiveTemplate>
      <Message type="serviceorder" initiator="_CURRENT_INITIATOR" id="@{newGuid}" session_id="IVR_PReq_${customer}">
        <Item customer="${customer}">
          <Service action="4" id="otdetailedbalance">
            <Attribute name="start" value="${start}" />
            <Attribute name="end" value="${end}" />
            <Attribute name="faxnumber" value="${faxnumber}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate />
    <input>
      <param name="Customer" />
      <param name="Service" />
      <param name="Start" />
      <param name="End" />
      <param name="FaxNumber" />
      <param name="Action" />
    </input>
    <output />
  </template>
</templates>