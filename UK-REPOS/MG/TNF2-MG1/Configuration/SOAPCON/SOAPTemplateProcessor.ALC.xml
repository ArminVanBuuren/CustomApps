<templates connector="SOAP">
	<macros>
		<define name="_SMSCON" value="SMSCON_01" />
		<define name="PRP_REGISTERED" value="3" />
	</macros>
	#include "C:\FORIS\Messaging Gateway\config\PoPTemplates\soap_alc.xml"
       	#include "C:\FORIS\Messaging Gateway\config\PoPTemplates\soap_alc_new.xml"
	#include "C:\FORIS\Messaging Gateway\config\IVRPassword\soap.xml"
	#include "C:\FORIS\Messaging Gateway\config\PoPTemplates\IvrSubTemplates.xml"
  	#include "C:\FORIS\Messaging Gateway\config\BundleEvents\ivr.xml"
  	#include "C:\FORIS\Messaging Gateway\config\GetCountersFromStateIn\soap.xml"
	#include "C:\FORIS\Messaging Gateway\config\GuaranteedPayment\SOAP_USSD.xml"
	#include "C:\FORIS\Messaging Gateway\config\ServiceHandler\SOAP_USSD.xml"
	#include "C:\FORIS\Messaging Gateway\config\CallCentreNCC\NCC_CommonService.xml"
	#include "C:\FORIS\Messaging Gateway\config\CallCentreNCC\NCC_BMSService.xml"

	<template procedureName="DB_SProcessing" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="${service}" action="${action}" class="${class}" createrequest="1"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate >
			<set item="oparam:dbresult" value="${dbresult}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="service" />
			<param name="class" />
			<param name="action" />
		</input>
		<output>
			<param name="dbresult" /> 
		</output>
	</template>

	<template procedureName="DB_GetLocno">
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="${guid}">
				<Item customer="${customer}" subject="getlocnoattribute" />
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:loc_no" value="${locnoattribute}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
		</input>
		<output>
			<param name="dbresult" />
			<param name="loc_no" />
		</output>
	</template>   

	<template procedureName="DB_SProcessing_TP_old" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="${service}" action="${action}" needtariffication="${needtariffication}" class="${class}" createrequest="1"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate >
			<set item="oparam:dbresult" value="${dbresult}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="service" />
			<param name="class" />
			<param name="action" />
			<param name="needtariffication" />
		</input>
		<output>
			<param name="dbresult" /> 
		</output>
	</template>


	<template procedureName="DB_SProcessing_TP" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="serviceorder" initiator="jrm" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="${service}" action="${action}" needtariffication="${needtariffication}" class="${class}" createrequest="1"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate >
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:ISCharged" value="${ischarged}" />
			<set item="oparam:Price" value="${price}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="service" />
			<param name="class" />
			<param name="action" />
			<param name="needtariffication" />
		</input>
		<output>
			<param name="dbresult" type="3" value="0" /> 
			<param name="ISCharged" type="2" value="0" />
			<param name="price" type="2" value="0" />
		</output>
	</template>

	<template procedureName="DB_SProcessing_TP_IVR" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="${service}" action="${action}" needtariffication="${needtariffication}" class="${class}" createrequest="1"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate >
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:ISCharged" value="${ischarged}" />
			<set item="oparam:Price" value="${price}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="service" />
			<param name="class" />
			<param name="action" />
			<param name="needtariffication" />
		</input>
		<output>
			<param name="dbresult" type="3" value="0" /> 
			<param name="ISCharged" type="2" value="0" />
			<param name="price" type="2" value="0" />
		</output>
	</template>
	
	<template procedureName="TestMethod">
		<receiveTemplate>
			<Message type="verificationrequest" initiator="soapcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Attribute name="checkivrservice" value="0" />
					<Attribute name="checkblocks" value="0" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate direction="input">
			<set item="oparam:dbresult" value="0" />
			<set item="oparam:tariffplan" value="100" />
			<set item="oparam:aparam" value="200" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
		</input>
		<output>
			<param name="dbresult" />
			<param name="tariffplan" />
			<param name="aparam" />
		</output>
	</template>
	<template procedureName="DB_PrP2PoPMigrationPossibility">
		<receiveTemplate>
			<Message type="prp2popmigrationpossibility" initiator="jrm" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" />
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<!--set item="oparam:ICCID" conditionEx!="#{${dbresult}=0}" value="" /-->
			<set item="oparam:ResultCode" value="UnknownError" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=0}" value="OK" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=320341}" value="InvalidNumber" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=320347}" value="PhoneBlocked" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=320191}" value="NotEnoughMoney" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=321003}" value="MigratedFromPoP" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=321004}" value="AlreadyMigrated" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=321005}" value="ProhibitedTariff" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
		</input>
		<output>
			<param name="ResultCode" value=""/>
			<param name="ICCID" value=""  />
			<param name="IMSI" value=""  />
		</output>
	</template>  
	<template procedureName="DB_PrP2PoPMigrationProcess" sessionStorage="Memory" sessionLifetime="60" persistent="true">
		<receiveTemplate>
			<Message type="prp2popmigrationprocess" initiator="jrm" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
				<Item customer="${Customer}" imsi="${IMSI}" startmigration="${StartMigration}"/>
				@{store(sStartMigration,${StartMigration})}
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:ResultCode" value="UnknownError" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=0}" value="OK" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=321002}" value="InvalidStatus" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=320341}" value="InvalidNumber" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=321001}" value="MSISDN_IMSI_mismatch" />
			<set item="oparam:RequestId" conditionEx="#{'${sStartMigration}'='0' or ${dbresult}!=0}" value="" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="Customer" />
			<param name="IMSI" />
			<param name="StartMigration" />
		</input>
		<output>
			<param name="Status" value=""  />
			<param name="ResultCode" value=""/>
			<param name="RequestId" value=""  />
		</output>
	</template>

	<template procedureName="GET_INFO_TP" handler="DBCON_01" persistent="false">
		<receiveTemplate>
			<Message initiator="ussd" id="${guid}" session_id="@{newGuid}">
				<Item procedureName="MG.GET_INFO_TP">
					<Attribute name="p_msisdn" type="STRING" value="${customer}" />
					<Attribute name="p_dbresult" type="STRING" />
					<Attribute name="p_result" type="STRING" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="#{if('${p_dbresult}'='',-1,number('${p_dbresult}'))}" />
			<set item="oparam:tariffplan" value="${p_result}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
		</input>
		<output>
			<param name="dbresult"  type="3" value="" />
			<param name="tariffplan"   type="1" value="" />
		</output>	
	</template>

	<template procedureName="CRM_MoneyTransfer_MmatoAma" sessionLifetime="15" sessionStorage="Memory">
		<receiveTemplate>
			<Message type="crmmoney" initiator="soapcon"  id="${guid}" session_id="@{setSessionId(@{newGuid})}"> 
				<Item customer="${customer}" />				                  
				@{store(sCustomer,${customer})}         
			</Message>
		</receiveTemplate>  
		<deliveryTemplate conditionEx="#{${dbresult}=0}" call="CRM_MoneyTransfer_MmatoAmaOK">
			<set item="iparam:customer" value="${customer}" />
			<set conditionEx="0@{freeSession}" /> 
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{${dbresult}=320205}">
			<set item="oparam:dbresult" value="320205" />
			<set conditionEx="0@{freeSession}" />            
		</deliveryTemplate>
		<!--deliveryTemplate conditionEx="#{${dbresult}=320205}" call="SendPriceSMS">
            <set item="iparam:customer" value="${customer}" />
            <set item="iparam:content" value="test_320205 Kollegi, usluga 105 uzhe zakazana!" />
            <set item="oparam:dbresult" value="320205" />
            <set conditionEx="0@{freeSession}" />            
    </deliveryTemplate-->     
		<input>
			<param name="customer" />
		</input>
		<output>
			<!--param name="dbresult" type="1"  value="" /--> 
			<!--param name="customer" type="1"  value="" /-->
			<param name="dbresult" type="3"  value="" />  
		</output>
	</template>

	<template procedureName="CRM_activation_ivr" sessionLifetime="15" sessionStorage="Memory">
		<receiveTemplate>
			<Message type="ivrtest${CRM_activation_id}" initiator="soapcon" id="${guid}" session_id="@{setSessionId(@{newGuid})}"> 
				<Item customer="${Customer}" />				                  
				@{store(sCustomer,${Customer})}         
			</Message>
		</receiveTemplate>
		<!--dlia uslug po service_code-->  
		<!--deliveryTemplate>
      <set item="param:dbresult" value="#{if('${p_dbresult}'='',10,number('${p_dbresult}'))}" />
    </deliveryTemplate-->
		<!--deliveryTemplate conditionEx="#{${CRM_action_id}!='001'}">
      <set item="param:dbresult" value="#{if('${p_dbresult}'='',-1,number('${p_dbresult}'))}" />
      <set conditionEx="0@{freeSession}" /> 
    </deliveryTemplate-->
		<input>
			<param name="Customer" />
			<param name="CRM_activation_id" />
		</input>
		<output>
			<param name="dbresult" type="1"  value="-1" /> 
		</output>
	</template>

	<template procedureName="SendPriceSMS">
		<receiveTemplate>
			<Message type="sendsms" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Content>${content}</Content>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate direction="input" connector="SMSCON_02" >
			<set item="oparam:dbresult" value="320205" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="content" />
		</input>
		<output>
			<param name="dbresult" type="3"  value="" />  
		</output>
	</template>


	<template procedureName="CRM_MoneyTransfer_MmatoAmaOK">
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" subject="balance" >
					<Attribute name="unpayment" value="0" />
					<Attribute name="requestcountertype" value="0" />
				</Item>   
			</Message>
		</receiveTemplate>

		<deliveryTemplate conditionEx="#{If(${balanceintpartdotpart}>3500,1,0)}" call="CRM_MoneyTransfer_MmatoAmaGIFT">
			<set item="iparam:customer" value="${customer}" />
		</deliveryTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="320191" />
		</deliveryTemplate>
		<input>
			<param name="customer"/>  
		</input>
		<output>
			<param name="dbresult"   value="320191" />
		</output> 
	</template>
	<template procedureName="CRM_MoneyTransfer_MmatoAmaGIFT" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>    
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="AMA105" action="2" class="1" createrequest="1"/>
				</Item>
			</Message>
		</receiveTemplate>
		<input>
			<param name="customer" />
		</input>
		<output>
			<param name="dbresult" type="3" value="-1" /> 
		</output>
	</template>

	<template procedureName="DB_PrP2PoPGetServiceStatus">
		<receiveTemplate>
			<Message type="prp2popgetservicestatus" initiator="jrm" id="${guid}" session_id="@{newGuid}">
				<Item customer="${Customer}" serviceid="${ServiceID}"/>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:ResultCode" value="UnknownError" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=0}" value="OK" />
			<set item="oparam:ResultCode" conditionEx="#{${dbresult}=320341}" value="InvalidNumber" />
			<set item="oparam:ServiceStatus" conditionEx="#{${dbresult}!=0}" value="" />
		</deliveryTemplate>
		<input>
			<param name="Customer" />
			<param name="ServiceID" />
		</input>
		<output>
			<param name="ResultCode" value=""/>
			<param name="ServiceStatus" value="" />
		</output>
	</template>


	<!--template procedureName="DB_AddRemoveService">
    <receiveTemplate>
      <Message type="yustas" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${customer}">
          <Service enddate="#{substring('${enddate}',1,11)} 23.59.59" />
        </Item>
      </Message>
    </receiveTemplate>
    <input>
      <param name="enddate" value="00.00.01 01.01.2099" />
    </input>
    <output>
      <param name="RESULT" value="-1" />
    </output>
  </template-->

	<template procedureName="DB_AddRemoveService"  persistent="true">
		<receiveTemplate>
			<Message type="bundleprovision" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="${servicecode}" action="#{if('${serviceaction}'='2','add',if('${serviceaction}'='3','remove',-1))}" needtariffication="1" enddate="${enddate}" informOnImpossibility="${informOnImpossibility}" sourcetypeid ="${sourcetypeid}" userid="${userid}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{${dbresult} = document('config/SelfDescriptiveCodes.xml')/dbresults/dbresult}" connector="_SMSCON" call="ServiceOrderErrorHandler.SendCRMErrorMessage" terminating="false" />
		<deliveryTemplate conditionEx="#{count(document('config/SelfDescriptiveCodes.xml')/dbresults/dbresult[text()=${dbresult}])=0}" connector="_SMSCON" call="DB_ServiceActivation" terminating="false" />		

		<deliveryTemplate conditionEx="#{'${dbresult}'='320191' and //Service/@id='ULTRA'}" call="ULTRA">
			<set item="iparam:customer" value="${customer}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${dbresult}'='0' and //Service/@id='ULTRA'}" call="Send1">
			<set item="iparam:customer" value="${customer}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${message}'=''}">
			<set item="oparam:RESULT" value="${dbresult}" />
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${message}'!=''}" terminating="false">
			<set item="oparam:RESULT" value="${dbresult}" />
		</deliveryTemplate>
		<deliveryTemplate connector="_SMSCON">
			<set item="Content" value="${message}" />
			<set item="Recipient" value="${customer}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="servicecode" value="" />
			<param name="serviceaction" value="-1" />
			<param name="needtariffication" value="-1" />
			<param name="enddate" value="00.00.01 01.01.2099"/>
			<param name="informOnImpossibility" value="-1" />
			<param name="sourcetypeid" value="1" />
			<param name="userid" value="1" />
		</input>
		<output>
			<param name="RESULT" value="-1" />
		</output>
	</template>

	<template procedureName="Send1" persistent="false">
		<receiveTemplate>
			<Message type="deliveryrequest" initiator="smscon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" sender="MTC">
					<Content encoding="7bit" charset="iso-8859-2">Poslugu &quot;ULTRA&quot; bude pidklyucheno vprodovzh doby za najavnosti na balansi neobhidnoji dlya oplaty sumy (95.63grn z PDV ta PF).</Content>
				</Item>
			</Message>
		</receiveTemplate>  
		<deliveryTemplate direction="input" terminating="false">
			<set item="param:dbresult" value="0" />
		</deliveryTemplate> 
		<deliveryTemplate direction="input" connector="SMSCON_01">
		</deliveryTemplate> 
		<input>
			<param name="customer" />
		</input>
		<output>
			<param name="RESULT" value="0" />
		</output>
	</template>


	<template procedureName="BMS_GetCounter" handler="DBCON_01" sessionStorage="Memory" sessionLifetime="15" onClean="GetCounter_onClean">
		<receiveTemplate>
			<Message initiator="ivrcon" id="@{setMessageId(@{newGuid})}" session_id="@{setSessionId(@{newGuid})}">
				<Item procedureName="MG.UMC_GET_BONUS">
					<Attribute name="p_msisdn" type="STRING" value="${customer}" />
					<Attribute name="p_dbresult" type="STRING" />
					<Attribute name="p_bonus_result" type="STRING" />
					<Attribute name="p_tariffplan_type" type="STRING" />
				</Item>
				@{store(SOAPRequest,@{GetSOAPRequest()})}
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${SOAPRequest}'=''}" connector="_SMSCON" /> <!-- session expired -->
		<deliveryTemplate>    <!-- in case of any error we send -1 -->
			<set item="oparam:dbresult" value="#{if('${p_dbresult}'!='0',-1,number('${p_dbresult}'))}" />
			<set item="oparam:bonus_result" value="${p_bonus_result}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
		</input>
		<output>
			<param name="dbresult" />
			<param name="bonus_result" />
		</output>
	</template>
	<template procedureName="GetCounter_onClean" sessionStorage="Memory">
		<deliveryTemplate>
			<set conditionEx="0@{BuildSOAPResponse(${SOAPRequest})}" />
			<set item="oparam:dbresult" value="-5" />
			<set item="oparam:bonus_result" value="" />
		</deliveryTemplate>
		<output>
			<param name="dbresult" />
			<param name="bonus_result" />
		</output>
	</template>



	<template procedureName="BMS_OrderGift" sessionStorage="Memory" sessionLifetime="20" onClean="OrderGift_onClean">
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="@{setMessageId(@{newGuid})}" session_id="@{setSessionId(@{newGuid})}">
				<Item customer="${customer}"  subject="category" />
				@{store(sGiftcode,${giftcode})} 				                  
				@{store(sCustomer,${customer})}         
				@{store(SOAPRequest,@{GetSOAPRequest()})}
			</Message>
		</receiveTemplate>      
		<deliveryTemplate direction="input" conditionEx="#{count(document('config\Common\bmsgifts.xml')/gifts/gift[@code='${sGiftcode}'])=0}">
			<set item="oparam:dbresult" value="-3" /> <!-- giftcode is not found in config\Common\bmsgifts.xml -->
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${SOAPRequest}'=''}" connector="_SMSCON" /> <!-- session expired -->
		<deliveryTemplate conditionEx="#{${dbresult}=0 and document('config\Common\bmsgifts.xml')/gifts/gift[@needPrpReg='false']/@code='${sGiftcode}' and ${clientstatus}>1}" call="BMS_OrderGift_Step2">
			<set item="iparam:customer" value="${sCustomer}" /> <!-- there is no need of PrP registration -->
			<set item="iparam:giftcode" value="${sGiftcode}" />
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{${dbresult}=0 and document('config\Common\bmsgifts.xml')/gifts/gift[@needPrpReg='true']/@code='${sGiftcode}' and ${clientstatus}=PRP_REGISTERED}" call="BMS_OrderGift_Step2">
			<set item="iparam:customer" value="${sCustomer}" /> <!-- there is need of PrP registration -->
			<set item="iparam:giftcode" value="${sGiftcode}" />
		</deliveryTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="-2" /> <!-- customer has no proper status (not registered) to get gift -->
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="giftcode" />
		</input>
		<output>
			<param name="dbresult" />
			<param name="ordercost" />
			<param name="newbalance" />
			<param name="giftprovisionid" />
		</output>
	</template>
	<template procedureName="BMS_OrderGift_Step2" sessionStorage="Memory" sessionLifetime="20" onClean="OrderGift_onClean">
		<receiveTemplate>
			<Message type="orderbonusgiftrequest" initiator="ivrcon" id="${guid}" session_id="${SessionId}">
				<Item customer="${customer}">
					<Attribute name="giftcode" value="${giftcode}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${SOAPRequest}'=''}" connector="_SMSCON" /> <!-- session expired -->
		<deliveryTemplate conditionEx="#{'${dbresult}'='-1'}">
			<set item="oparam:dbresult" value="-4" /> <!-- some error -->
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${dbresult}'='320301'}">
			<set item="oparam:dbresult" value="-1" /> <!-- some error -->
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<deliveryTemplate />
		<input>
			<param name="customer" />
			<param name="giftcode" />
		</input>
		<output>
			<param name="dbresult" />
			<param name="ordercost" />
			<param name="newbalance" />
			<param name="giftprovisionid" />
		</output>
	</template>
	<template procedureName="OrderGift_onClean" sessionStorage="Memory">
		<deliveryTemplate>
			<set conditionEx="0@{BuildSOAPResponse(${SOAPRequest})}" />
			<set item="oparam:dbresult" value="-5" />
		</deliveryTemplate>
		<output>
			<param name="dbresult" />
			<param name="ordercost" />
			<param name="newbalance" />
			<param name="giftprovisionid" />
		</output>
	</template>



	<template procedureName="BMS_StartingDate">
		<receiveTemplate>
			<Message type="getstartingdataformsisdnrequest" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}"></Item>
			</Message>
		</receiveTemplate>
		<input>
			<param name="customer" />
		</input>
		<output>
			<param name="startingdate"    value="-1" />
			<param name="dbresult"        value="-1" />
		</output>
	</template>
	<template procedureName="BMS_GetCampaignParticipationsRequest">
		<receiveTemplate>
			<Message type="getbonuscampaignparticipationsrequest" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Attribute name="campaignid" value="${campaignid}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:startdate" value="#{if(#{count(/Message/Item/Campaign)}>0,/Message/Item/Campaign/@startdate ,'')}" />
			<set item="oparam:enddate" value="#{if(#{count(/Message/Item/Campaign)}>0,/Message/Item/Campaign/@enddate ,'')}" />
			<set item="oparam:additionalinfo" value="#{if(#{count(/Message/Item/Campaign)}>0,/Message/Item/Campaign/@additionalinfo ,'')}" />
			<set item="oparam:campaignname" value="#{if(#{count(/Message/Item/Campaign)}>0,/Message/Item/Campaign/@campaignname ,'')}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="campaignid" />
		</input>
		<output>
			<param name="additionalinfo" />
			<param name="enddate"  />
			<param name="startdate" />
			<param name="campaignname" />
			<param name="dbresult"  />
		</output>
	</template>


	<template procedureName="BMS_ChangeTP" handler="DBCON_01" sessionStorage="Memory" sessionLifetime="25" onClean="ChangeTP_onClean">
		<receiveTemplate>
			<Message initiator="ussd" id="@{setMessageId(@{newGuid})}" session_id="@{setSessionId(@{newGuid})}">
				<Item procedureName="MG.UMC_GET_BONUS">
					<Attribute name="p_msisdn" type="STRING" value="${customer}" />
					<Attribute name="p_dbresult" type="STRING" />
					<Attribute name="p_bonus_result" type="STRING" />
					<Attribute name="p_tariffplan_type" type="STRING" />
					@{store(sTariffplan,${tariffplan})}
					@{store(SOAPRequest,@{GetSOAPRequest()})}
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate direction="input" conditionEx="#{count(document('config\Common\bmschangetp.xml')/tps/tp[@code='${sTariffplan}'])=0}">
			<set item="oparam:dbresult" value="-3" /> <!-- tariffplan is not found in config\Common\bmsgifts.xml -->
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${SOAPRequest}'=''}" connector="_SMSCON" /> <!-- session expired -->
		<deliveryTemplate conditionEx="#{${p_dbresult}=0 and number(document('config\Common\bmschangetp.xml')/tps/tp[@code='${sTariffplan}']/@cost) > number('${p_bonus_result}')}">
			<set item="oparam:dbresult" value="-1" /> <!-- bonus balance is less than cost of gift -->
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{${p_dbresult}=0 and number('${p_bonus_result}') >= number(document('config\Common\bmschangetp.xml')/tps/tp[@code='${sTariffplan}']/@cost)}" call="BMS_ChangeTP2">
			<set item="iparam:customer" value="${p_msisdn}" />
			<set item="iparam:tariffplan" value="${sTariffplan}" />
		</deliveryTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="-4" /> <!-- balance retrieve error -->
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="tariffplan" />
		</input>
		<output>
			<param name="dbresult" />
		</output>
	</template>

	<template procedureName="BMS_ChangeTP2" sessionStorage="Memory" sessionLifetime="20" onClean="ChangeTP_onClean">
		<receiveTemplate>
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="${SessionId}">
				<Item customer="${customer}" >
					<Service id="changetariffplan" action="0" class="#{document('config\Common\bmschangetp.xml')/tps/tp[@code='${sTariffplan}']/@id}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{${dbresult}=0}" call="BMS_ChangeTP3">
			<set item="iparam:customer" value="${customer}" />
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${SOAPRequest}'=''}" connector="_SMSCON" /> <!-- session expired -->
		<deliveryTemplate>
			<set item="oparam:dbresult" value="-6" /> <!-- error of changing TP  -->
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="tariffplan" />
		</input>
		<output>
			<param name="dbresult" />
		</output>
	</template>

	<template procedureName="BMS_ChangeTP3" handler="DBCON_02" sessionStorage="Memory" sessionLifetime="20" onClean="ChangeTP_onClean">
		<receiveTemplate>
			<Message initiator="ivrcon" id="${guid}" session_id="${SessionId}">
				<Item procedureName="accounts.balance_correction">
					<Attribute name="p_msisdn" type="STRING" value="${customer}" />
					<Attribute name="p_correction_amount" type="STRING" value="-#{document('config\Common\bmschangetp.xml')/tps/tp[@code='${sTariffplan}']/@cost}" />
					<Attribute name="p_request_date" type="DATETIME" value="@{now}" />
					<Attribute name="p_request_reason" type="STRING" />
					<Attribute name="p_channel_code" type="STRING" />
					<Attribute name="p_external_code" type="STRING" />
					<Attribute name="p_user_id_of_change" type="STRING" />
					<Attribute name="p_new_balance" type="STRING" />
					<Attribute name="p_handle_tran" type="STRING" />
					<Attribute name="p_result" type="STRING" />
					<Attribute name="p_err_msg" type="STRING" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${SOAPRequest}'=''}" connector="_SMSCON" /> <!-- session expired -->
		<deliveryTemplate>
			<set item="oparam:dbresult" value="0" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
		</input>
		<output>
			<param name="dbresult" />
		</output>
	</template>
	<template procedureName="ChangeTP_onClean" sessionStorage="Memory">
		<deliveryTemplate>
			<set conditionEx="0@{BuildSOAPResponse(${SOAPRequest})}" />
			<set item="oparam:dbresult" value="-5" />
		</deliveryTemplate>
		<output>
			<param name="dbresult" />
		</output>
	</template>


	<!--  1.2.28 Latest payments request  -->
	<template procedureName="DB_PaymentRetriev">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" subject="payments">
					<Attribute name="index" value="${index}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult"        value="${dbresult}"/>
			<set item="oparam:count"           value="${count}" />
			<set item="oparam:day"             value="${day}" />
			<set item="oparam:currency"        value="${currency}" />
			<set item="oparam:intpartfracpart" value="${intpartfracpart}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="index" />
		</input>
		<output>
			<param name="dbresult"        value="-1"/>
			<param name="count"           value=""/>
			<param name="day"             value=""/>
			<param name="currency"        value=""/>
			<param name="intpartfracpart" value=""/>
		</output>
	</template>

	<!--  DB_LastPayment_Alcatel  WRK-286340  -->
	<template procedureName="DB_LastPayment_Alcatel">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" subject="payments">
					<Attribute name="index" value="${index}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult"        value="${dbresult}"/>
			<set item="oparam:count"           value="${count}" />
			<set item="oparam:day"             value="${day}" />
			<set item="oparam:intpartfracpart" value="${intpartfracpart}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="index" />
		</input>
		<output>
			<param name="dbresult"        value="-1"/>
			<param name="count"           value=""/>
			<param name="day"             value=""/>
			<param name="intpartfracpart" value=""/>
		</output>
	</template>

	<!--  1.2.8 Account balance (retrieve customer data)  -->  
	<template procedureName="DB_BalanceRetriev">
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" subject="balance" >
					<Attribute name="unpayment" value="0" />
					<Attribute name="requestcountertype" value="0" />
				</Item>   
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:balanceintpartdotpart" value="${balanceintpartdotpart}" />
		</deliveryTemplate>
		<input>
			<param name="Customer"/>  
		</input>
		<output>
			<param name="dbresult"                   value="-1" />
			<param name="balanceintpartdotpart"      value=""/>
		</output> 
	</template>

	<template procedureName="DB_BalanceRetriev2">
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" subject="balance" >
					<Attribute name="unpayment" value="0" />
					<Attribute name="requestcountertype" value="0" />
				</Item>   
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:xbalancex" value="${balanceintpartdotpart}" />
		</deliveryTemplate>
		<input>
			<param name="Customer"/>  
		</input>
		<output>
			<param name="dbresult"                   value="-1" />
			<param name="xbalancex"      value=""/>
		</output> 
	</template>



	<!--  DB_Counters_Alcatel  WRK-286340  -->  
	<template procedureName="DB_Counters_Alcatel">
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" subject="balance" >
					<Attribute name="unpayment" value="0" />
					<Attribute name="requestcountertype" value="0" />
				</Item>   
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult"              value="${dbresult}" />
			<set item="oparam:accumulator"           value="${accumulator}" />
		</deliveryTemplate>
		<input>
			<param name="Customer"/>  
		</input>
		<output>
			<param name="dbresult"                   value="-1" />
			<param name="accumulator"                value="0" />  
		</output> 
	</template> 

	<!--  DB_Counters_Alcatel2  WRK-286340  -->  
	<template procedureName="DB_Counters_Alcatel2">
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" subject="balance" >
					<Attribute name="unpayment" value="0" />
					<Attribute name="requestcountertype" value="3" />
				</Item>   
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult"              value="${dbresult}" />
			<set item="oparam:xaccumulatorx"           value="#{replace('${accumulator}',' [^;]*[:\d{2}]?|,','')}" />
		</deliveryTemplate>
		<input>
			<param name="Customer"/>  
		</input>
		<output>
			<param name="dbresult"                   value="-1" />
			<param name="xaccumulatorx"                value="0" />  
		</output> 
	</template> 

	<!--  WRK-286339  2011_08_10 -->
	<template procedureName="DB_SInterrogation" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="serviceinterrogation" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="${service}" action="interrogation" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult"              value="${dbresult}" />
			<set item="oparam:Allowed"               value="${Allowed}" />
			<set item="oparam:Subscription"          value="${Subscription}" />
			<set item="oparam:Status"                value="${Status}" />
			<set item="oparam:Class"                 value="${Class}" />
			<set item="oparam:ChargedAmount"         value="${ChargedAmount}" />
		</deliveryTemplate>    
		<input>
			<param name="customer" />
			<param name="service" />
		</input>
		<output>
			<param name="dbresult"          value="0" /> 
			<param name="Allowed"           value="0" />
			<param name="Subscription"      value="0" />
			<param name="Status"            value="0" />
			<param name="Class"             value="0" />
			<param name="ChargedAmount"     value="0" />
		</output>
	</template>


	<!--  дата последненго пополнения  -->
	<template procedureName="DB_BillsRetriev" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" subject="bills">
					<Attribute name="index" value="${index}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:begindate"             value="${begindate}" />
			<set item="oparam:enddate"               value="${enddate}" />
			<set item="oparam:count"                 value="${count}" />
			<set item="oparam:day"                   value="${day}" />
		</deliveryTemplate>    
		<input>
			<param name="customer" />
			<param name="index" />
		</input>
		<output>
			<param name="count"               value="0" />
			<param name="begindate"           value="" />
			<param name="enddate"             value="" />
			<param name="day"                 value="" />
		</output>
	</template>  


	<!--  1.2.31 Validation request  -->
	<template procedureName='GetCustomerTP'>
		<receiveTemplate>
			<Message type='verificationrequest' initiator='ivrcon' id='${guid}' session_id='@{newGuid}'>
				<Item customer='${customer}'>
					<Attribute name='checkivrservice' value='0' />
					<Attribute name='checkblocks'     value='0' />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item='oparam:dbresult' value='${dbresult}' />
			<set item='oparam:tariffplan' value='${tariffplan}' />
			<set item='oparam:language_id' value='${language_id}' />
		</deliveryTemplate>
		<input>
			<param name='customer' />
		</input>
		<output>
			<param name='dbresult'     value="-1"/>
			<param name='tariffplan'   value=""/>
			<param name='language_id'  value=""/>
		</output>
	</template>



	<template procedureName="CRM_Activation_FRWLD" sessionLifetime="15" sessionStorage="Memory">
		<receiveTemplate>
			<Message type="crmfrwld" initiator="soapcon"  id="${guid}" session_id="@{setSessionId(@{newGuid})}"> 
				<Item customer="${customer}" />				                  
				@{store(sCustomer,${customer})}         
			</Message>
		</receiveTemplate>  
		<deliveryTemplate conditionEx="#{${dbresult}=0}" call="CRM_Activation_FRWLDOK">
			<set item="iparam:customer" value="${customer}" />
			<set conditionEx="0@{freeSession}" /> 
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{${dbresult}=320205}">
			<set item="oparam:dbresult" value="320205" />
			<set conditionEx="0@{freeSession}" />            
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{${dbresult}=3202051}">
			<set item="oparam:dbresult" value="3202051" />
			<set conditionEx="0@{freeSession}" />            
		</deliveryTemplate>
		<!--deliveryTemplate conditionEx="#{${dbresult}=320205}" call="SendPriceSMS">
            <set item="iparam:customer" value="${customer}" />
            <set item="iparam:content" value="test_320205 Kollegi, usluga 105 uzhe zakazana!" />
            <set item="oparam:dbresult" value="320205" />
            <set conditionEx="0@{freeSession}" />            
    </deliveryTemplate-->     
		<input>
			<param name="customer" />
		</input>
		<output>
			<!--param name="dbresult" type="1"  value="" /--> 
			<!--param name="customer" type="1"  value="" /-->
			<param name="dbresult" type="3"  value="" />  
		</output>
	</template> 



	<template procedureName="CRM_Activation_FRWLDOK" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>    
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="FRWLD" action="2" class="1" createrequest="1"/>
				</Item>
			</Message>
		</receiveTemplate>
		<input>
			<param name="customer" />
		</input>
		<output>
			<param name="dbresult" type="3" value="-1" /> 
		</output>
	</template>

<!-- FORIS.MessagingGateway.Templates 10.10.18 --> 
<template procedureName="GetCBCountersAcync">
  <receiveTemplate>
	  <Message type="retrievecustomerdata" initiator="smscon" id="${guid}" session_id="UNIBALANCE">
		  <Item customer="${customer}" subject="balance">
			  <Attribute name="requestcountertype" value="3"/>
		  </Item>
	  </Message>
	</receiveTemplate>
	<deliveryTemplate direction="input" terminating="false">
		<set item="oparam:dbresult" value="0" /> 
	</deliveryTemplate>
	<deliveryTemplate connector="_SMSCON" /> 
	<input>
		<param name="customer" /> 
	</input>
	<output>
		<param name="dbresult" /> 
	</output>
</template>
<!-- FORIS.MessagingGateway.Templates 10.10.18 --> 

</templates>