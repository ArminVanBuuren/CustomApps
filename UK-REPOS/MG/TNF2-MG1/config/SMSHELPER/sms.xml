<!--TFS#708800-->
<templateGroup name="SMSHELPER">
	<macros>
		<define name="_RIHND" value="WCFHND_02"/>
		<define name="_DBCON" value="DBCON_BSCS"/>
		<define name="_PROC" value="WEBAPP.FRS_CUSTOMER_REQUEST.WRAPPER_REQUEST_INSERT"/>
		<!--define name="_ADD_SERVICE_NUMBER" value="401"/-->
		<define name="_DEL_SERVICE_NUMBER" value="430"/>
	</macros>
	<template procedureName="GetPlatform" handler="_RIHND" sessionStorage="Memory" sessionLifetime="300">
		<condition>
			<test item="${Recipient}" matches="^_ADD_SERVICE_NUMBER|_DEL_SERVICE_NUMBER$"/>
		</condition>
		<receiveTemplate>
			<Message type="gethost" initiator="smscon" id="${guid}" session_id="@{setSessionId(${guid})}">
        @{store(sContent,${Content})}
        @{store(sSender,${Sender})}
        @{store(sRecipient,${Recipient})}
				<Item procedureName="GetHost">
					<Attribute name="Customer" type="String" value="${Sender}"/>
					<Attribute name="HostType" type="String" value="SC"/>
					<Attribute name="HostCode"/>
					<Attribute name="HostName"/>
					<Attribute name="HostAddress"/>
					<Attribute name="Result"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${Result}'='0' and '${HostCode}'=''}" call="CallExternalDB">
			<set item="Content" value="${sContent}"/>
			<set item="Sender" value="${sSender}"/>
			<set item="Recipient" value="${sRecipient}"/>
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${Result}' = '0'}" call="GetCustomerType">
			<set item="Content" value="${sContent}"/>
			<set item="Sender" value="${sSender}"/>
			<set item="Recipient" value="${sRecipient}"/>
		</deliveryTemplate>
		<deliveryTemplate>
			<set item="Content" value="Servis tymchasovo nedostupnyy"/>
			<set item="Sender" value="${sRecipient}"/>
			<set item="Recipient" value="${sSender}"/>
			<set item="Encoding" value="unicodefffe"/>
		</deliveryTemplate>
	</template>
	<template procedureName="GetCustomerType">
		<condition>
			<test item="0" matches="1"/>
		</condition>
		<receiveTemplate>
			<Message type="serviceinterrogation" initiator="smscon" id="${guid}" session_id="${session_id}">
				<Item customer="${sSender}">
					<Service id="FRPOPMAP" action="interrogation"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{${dbresult} = 0}" call="ServiceManage">
			<set item="Content" value="${subscription}"/>
			<set item="Sender" value="${sSender}"/>
			<set item="Recipient" value="${sRecipient}"/>
		</deliveryTemplate>
		<deliveryTemplate>
			<set item="Sender" value="${sRecipient}"/>
			<set item="Recipient" value="${sSender}"/>
			<set item="Encoding" value="unicodefffe"/>
			<set item="Content" value="Servis tymchasovo nedostupnyy"/>
		</deliveryTemplate>
	</template>
	<template procedureName="ServiceManage">
		<condition>
			<test item="0" matches="1"/>
		</condition>
		<receiveTemplate>
			<Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${sSender}">
					<Service id="@{switch(${Content}|,0|SMS4,1|POPSMSP1)}" class="1" action="@{switch(${sRecipient}|,_ADD_SERVICE_NUMBER|2,_DEL_SERVICE_NUMBER|3)}"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="Content" value="Servis tymchasovo nedostupnyy"/>
			<set item="Content" condition="//Item/@dbresult=0" value="Zapyt na poslugy SMS-Pomichnik prijnjato" /> 
			<set item="Content" condition="//Item/@dbresult=320205" value="Posluga SMS-Pomichnik aktyvovana" /> 
			<set item="Content" condition="//Item/@dbresult=320206" value="Posluga SMS-Pomichnik deaktyvovana" /> 
			<set item="Content" condition="//Item/@dbresult=320191" value="Na zhal na Vashomu rahunku nedîstatnjo koshtiv dlja aktyvatsii poslugi. Bud' laska, povtorit' zapyt pislja popovnennja rakhunku."/>
			<set item="Sender" value="${Sender}"/>
			<set item="Recipient" value="${Recipient}"/>
			<set item="Encoding" value="unicodefffe"/>
		</deliveryTemplate>
	</template>
	<template procedureName="CallExternalDB" sessionStorage="Memory" handler="_DBCON">
		<condition>
			<test item="0" matches="1"/>
		</condition>
		<receiveTemplate>
			<Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
				<Item procedureName="_PROC">
					<Attribute name="phonenumb" type="STRING" value="#{substring('${sSender}',4,9)}"/>
					<Attribute name="service_id" type="INT" value="185"/>
					<Attribute name="req_type" type="INT" value="@{switch(${sRecipient}|,_ADD_SERVICE_NUMBER|1,_DEL_SERVICE_NUMBER|2)}"/>
					<Attribute name="req_comment" type="STRING" value=""/>
					<Attribute name="req_param" type="STRING" value=""/>
					<Attribute name="req_priority" type="INT" value="0"/>
					<Attribute name="req_user" type="STRING" value="smsc"/>
					<Attribute name="i_market" type="INT" value="0"/>
					<Attribute name="i_salesman_id" type="INT" value=""/>
					<Attribute name="i_outlet_id" type="INT" value=""/>
					<Attribute name="result" type="out:STRING"/>
				</Item>
			</Message>
		</receiveTemplate>
		<!--deliveryTemplate conditionEx="#{'${dbresult}'='0'}">
			<set item="Content" value="Zapyt na poslugy SMS-Pomichnik prijnjato"/>
			<set item="Sender" value="${sRecipient}"/>
			<set item="Recipient" value="${sSender}"/>
			<set item="Encoding" value="${Encoding}"/>
		</deliveryTemplate-->
		<deliveryTemplate conditionEx="#{'${dbresult}'!='0'}">
			<set item="Content" value="Zapyt za poslugoyu SMS-Pomischnik ne vykonano, zvernitsa do centru obslugovuvannya"/>
			<set item="Sender" value="${sRecipient}"/>
			<set item="Recipient" value="${sSender}"/>
			<set item="Encoding" value="${Encoding}"/>
		</deliveryTemplate>
		<deliveryTemplate dropReply="true"/>
	</template>
</templateGroup>
