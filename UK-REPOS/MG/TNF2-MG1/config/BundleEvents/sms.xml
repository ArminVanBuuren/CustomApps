<templateGroup name="BundleEvents">
	<macros>
		<define name="_ADD_SERVICE_TO_OTHER" value="205" />
		<define name="_NEED_CONFIRMATION" value="false" />
	</macros>

	<template procedureName="AddServiceToOtherSubscriber" contentSeparator="*#" sessionStorage="Memory" sessionLifetime="30">
		<condition>
			<test item="${Recipient}"	matches="^_ADD_SERVICE_TO_OTHER$" />
			<test item="${Content}"		matches="^\s*\w+\s*[\*#]{1}\s*[0-9]{11,12}\s*$" />
		</condition>
    	<receiveTemplate >
			<Message type="possibilityaddsubbalanceanothercustomer" initiator="smscon" id="${guid}" session_id="@{setSessionId(${guid})}">
				@{store(sInputCode,#{normalize-space('${token0}')})}
				@{store(sSubbalanceCode,#{document('C:\Foris\Messaging Gateway\config\BundleEvents\subbalances.xml')/subbalances/subbalance[@sms_code='${sInputCode}']/@crm_code})}
				<Item customer="${sender}" >
					<Service id="${sSubbalanceCode}" action="1">
						<Attribute name="msisdnrecipient" value="#{normalize-space('${token1}')}" />
						<Attribute name="confirmation" value="_NEED_CONFIRMATION" />
					</Service>
				</Item>
			</Message>
    	</receiveTemplate>
		<deliveryTemplate direction="input" conditionEx="#{'${sSubbalanceCode}'=''}">
			<set item="Content"  value="Ne najdena yslyga s kodom '${sInputCode}'" /> 
			<set item="Sender" value="_ADD_SERVICE_TO_OTHER" />
			<set item="Recipient" value="${customer}" />
			<set item="Encoding" value="unicodefffe" />
			<set conditionEx="0@{freeSession}"  />
		</deliveryTemplate>
		<deliveryTemplate direction="input" terminating="false">
			<set item="Content"   value="Vasha zayavka prinjata. Gdite sms s resultatom." />
            <set item="Sender" value="_ADD_SERVICE_TO_OTHER" />
            <set item="Recipient" value="${customer}" />
            <set item="Encoding" value="unicodefffe" />
            <set conditionEx="0@{freeSession}"  />
        </deliveryTemplate>
		<deliveryTemplate dropReply="true" />
	</template>

	<template procedureName="AddServiceToOtherSubscriberInvalidFormat">
        <condition>
			<test item="${Recipient}"	matches="^_ADD_SERVICE_TO_OTHER$" />
        </condition>
        <receiveTemplate>
			<Message id="${guid}" session_id="${guid}">
				<Attribute name="customer" value="${sender}" />
			</Message>
        </receiveTemplate>
		<deliveryTemplate direction="input" >
			<set item="Content"		value="Format zaprosa: kod_yslygi*nomer_poluchatelja" />
			<set item="Encoding"	value="unicodefffe" />
			<set item="Sender"		value="_ADD_SERVICE_TO_OTHER" />
			<set item="Recipient"	value="${customer}" />
		</deliveryTemplate>
	</template>

	<template procedureName="NotifyAboutWrongServiceCode">
        <condition>
			<test item="0"	matches="1" />
        </condition>
		<deliveryTemplate>
			<set item="Content"		value="Ne najdena yslyga s kodom '${inputcode}'" />
			<set item="Encoding"	value="unicodefffe" />
			<set item="Sender"		value="_ADD_SERVICE_TO_OTHER" />
			<set item="Recipient"	value="${customer}" />
		</deliveryTemplate>
	</template>

</templateGroup>
