<templateGroup name="BundleEvents">
	<macros>
		<define name="_ADD_SERVICE_TO_OTHER" value="205" />
		<define name="_NEED_CONFIRMATION" value="false" /> <!-- для Минска =true, Для UMC=false -->
	</macros>

	<template procedureName="AddServiceToOtherSubscriber" sessionStorage="Memory" sessionLifetime="30">
		<condition>
			<test item="${Recipient}"	matches="^_ADD_SERVICE_TO_OTHER$" />
			<test item="${Content}"		matches="^[0-9]{1,}\*[0-9]{11}$" />
		</condition>
    	<receiveTemplate>
			<Message type="possibilityaddsubbalanceanothercustomer" initiator="ussd" id="${guid}" session_id="@{setSessionId(${guid})}">
				@{store(sInputCode,${token0})}
				@{store(sSubbalanceCode,#{document('C:\Foris\Messaging Gateway\config\BundleEvents\subbalances.xml')/subbalances/subbalance[@ussd_code='${token0}']/@crm_code})}
				<Item customer="${sender}" >
					<Service id="${sSubbalanceCode}" action="1">
						<Attribute name="msisdnrecipient" value="${token1}" />
						<Attribute name="confirmation" value="_NEED_CONFIRMATION" />
					</Service>
				</Item>
			</Message>
    	</receiveTemplate>
		<deliveryTemplate direction="input" conditionEx="#{'${sSubbalanceCode}'=''}">
			<set item="Content"  value="Не найдена услуга с кодом '${sInputCode}'" />
			<set item="Sender" value="_ADD_SERVICE_TO_OTHER" />
			<set item="Recipient" value="${customer}" />
			<set item="Encoding" value="unicodefffe" />
			<set conditionEx="0@{freeSession}"  />
		</deliveryTemplate>
		<deliveryTemplate direction="input" terminating="false">
			<set item="Content"   value="Ваша заявка принята. Ждите SMS с результатом." />
            <set item="Sender" value="_ADD_SERVICE_TO_OTHER" />
            <set item="Recipient" value="${customer}" />
            <set item="Encoding" value="unicodefffe" />
            <set conditionEx="0@{freeSession}"  />
        </deliveryTemplate>
		<deliveryTemplate dropReply="true" />
	</template>

	<template procedureName="AddServiceToOtherSubscriberInvalidFormat">
        <condition>
			<test item="${Recipient}"	matches="^_ADD_SERVICE_TO_OTHER$" />
        </condition>
        <receiveTemplate>
			<Message id="${guid}" session_id="${guid}" >
				<Attribute name="Customer" value="${Sender}" />
			</Message>
        </receiveTemplate>
		<deliveryTemplate direction="input" >
			<set item="Content"		value="Формат запроса: *_ADD_SERVICE_TO_OTHER*код_услуги*номер_получателя#" />
			<set item="Encoding"	value="unicodefffe" />
			<set item="Sender"		value="_ADD_SERVICE_TO_OTHER" />
			<set item="Recipient"	value="${customer}" />
		</deliveryTemplate>
	</template>

</templateGroup>
