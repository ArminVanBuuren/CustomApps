<templateGroup name="PoPTemplate">
	<macros>
		<define name="_SMSCON" value="SMSCON_02" />
		<define name="_BMSCON" value="WCFHND_01"/>
		<define name="_MSCPHND" value="WCFHND_03" />
	</macros>

	<template procedureName="DB_SInterrogation" persistent="false"> <!-- Service status check -->
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="serviceinterrogation" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="${service}" action="interrogation" />
				</Item>
			</Message>
		</receiveTemplate>

		<input>
			<param name="customer" />
			<param name="service" />
		</input>
		<output>
			<param name="dbresult" type="3" value="0" /> 
			<param name="Allowed" type="2" value="0" />
			<param name="Subscription" type="2" value="0" />
			<param name="Status" type="2" value="0" />
			<param name="Class" type="3" value="0" />
			<param name="ChargedAmount" type="3" value="0" />
		</output>
	</template>




	<template procedureName="DB_CustData" handler="_MSCPHND" sessionStorage="Memory" sessionLifetime="30">
		<receiveTemplate>
			<Message type="scnauthenticate" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(${guid})}">
				<Item procedureName="SCN_AUTHENTICATE">
					<Attribute name="CLIENT_ID" type="String" value="911" />
					<Attribute name="REQUEST_ID" type="String" value="#{substring('${guid}',1,10)}" />
					<Attribute name="SUBSCR_NUMBER" value="+${Customer}"/>
					<Attribute name="AUTH_TYPE" type="Int32" value="0" />
					<Attribute name="PASSWORD" type="String" value="" />

					<Attribute name="RESULT_CODE" />
					<Attribute name="REQUEST_ID" />
					<Attribute name="RESULT_MESSAGE" />

					<Attribute name="MSISDN" />
					<Attribute name="TARIFF_PLAN_ID" />
					<Attribute name="LANGUAGE_ID" />
					<Attribute name="CUST_STATUS" />
					<Attribute name="CUST_ADM_STATUSES" />
					<Attribute name="ACTIVATION_COUNT" />
					<Attribute name="ACTIVATION_COUNTDOWN" />
					<Attribute name="LAST_ACTIVITY" />
					<Attribute name="Loc_No" />
					<Attribute name="SERVICE_PROVIDER_CODE" />
					<Attribute name="PA_ID" />
					<Attribute name="TDC_ID" /> 
					<!-- <Attribute name="ADDITIONAL_DATA" /> -->
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:RESULT_CODE" value="${RESULT_CODE}"/>
		</deliveryTemplate>
		<input>
			<param name="Customer" />
		</input>
		<output>
			<param name="RESULT_CODE" type="3" value="0" />
			<param name="TARIFF_PLAN_ID" type="3" value="0" />
			<param name="TDC_ID" type="3" value="0" />
			<param name="PA_ID" type="3" value="0" />
			<param name="LANGUAGE_ID" type="3" value="0" /> 
		</output>
	</template>

	<template procedureName="DB_BalanceRetriev" handler="_MSCPHND" sessionStorage="Memory" sessionLifetime="300">
		<receiveTemplate>
			<Message type="scnsbcgetbalance" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(${guid})}">
				<Item procedureName="SCN_SBC_GET_BALANCE">
					<Attribute name="CLIENT_ID" type="String" value="911"/>
					<Attribute name="REQUEST_ID" type="String" value="#{substring('${guid}',1,10)}"/>
					<Attribute name="MSISDN" value="+${Customer}"/>

					<Attribute name="RESULT_CODE"/>
					<Attribute name="REQUEST_ID"/>
					<Attribute name="BALANCE"/>
					<Attribute name="CURRENCY"/>
					<Attribute name="CUST_STATUS"/>
					<Attribute name="EXPIRE_DATE"/>
					<Attribute name="BLOCKED_END_DATE"/>
					<Attribute name="REQUEST_DATE"/>
					<Attribute name="SYSTEM_TIME_ZONE"/>
					<Attribute name="ADDITIONAL_DATA" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${BALANCE}'!=''}">
			<set item="oparam:dbresult" value="${RESULT_CODE}"/>
			<set item="oparam:zbalanceintpartdotpart" value="#{round(${BALANCE} div 10000)}"/>
		</deliveryTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${RESULT_CODE}"/>
			<set item="oparam:zbalanceintpartdotpart" value="${BALANCE}"/>
		</deliveryTemplate>
		<!--deliveryTemplate>
			<set item="oparam:dbresult" value="${RESULT_CODE}"/>
			<set item="oparam:zbalanceintpartdotpart" value="#{if(${BALANCE}>=0,'#{round(${BALANCE} div 10000)}','-#{number(#{substring('${BALANCE}',2,string-length('${BALANCE}'))}) div 10000}')}"/>
		</deliveryTemplate-->
		<input>
			<param name="Customer"/>
		</input>
		<output>
			<param name="dbresult" value="-1"/>
			<param name="zbalanceintpartdotpart" value=""/>
		</output>
	</template>  

	<!--template procedureName="DB_BalanceRetriev">
    <receiveTemplate>
   <Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
    <Item customer="${customer}" subject="balance" >
       <Attribute name="unpayment" value="0" />
       <Attribute name="requestcountertype" value="0" />
    </Item>   
   </Message>
  </receiveTemplate>
  <deliveryTemplate>
    <set item="oparam:dbresult" value="${dbresult}" />
    <set item="oparam:zbalanceintpartdotpart" value="${balanceintpartdotpart}" />
  </deliveryTemplate>
  <input>
    <param name="Customer"/>  
  </input>
  <output>
    <param name="dbresult"                   value="-1" />
    <param name="zbalanceintpartdotpart"      value=""/>
  </output> 
  </template-->

	<template procedureName="DB_PaymentRetriev" sessionStorage="Memory" sessionLifetime="29">
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
				<Item customer="${customer}" subject="payments">
					<Attribute name="index" value="${index}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}"/>
			<set item="oparam:zcount" value="${count}"/>
			<set item="oparam:zday" value="${day}"/>
			<set item="oparam:zcurrency" value="${currency}"/>
			<set item="oparam:zintpartfracpart" value="${intpartfracpart}"/>
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="index" />
		</input>
		<output>
			<param name="dbresult" value=""/>
			<param name="zcount" value="0" />
			<param name="zday" value="" />
			<param name="zcurrency" value="0" />
			<param name="zintpartfracpart" value="0" />
		</output>
	</template>




	<template procedureName="DB_LastPeriodBill" sessionStorage="Memory" sessionLifetime="20" persistent="true" >
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="emailcon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
				<Item customer="${customer}" subject="lastperiodbill" />
				<Attribute name="startdate" value="${startdate}" />
				<Attribute name="enddate" value="${enddate}" />@{store(stest,111)}</Message>
		</receiveTemplate>
		<!--deliveryTemplate direction="input" conditionEx="#{${customer}=79163515044}" terminating="true">
      <set item="oparam:dbresult" value="320341" />
      <set item="oparam:beginday" value="31.12.2007" />
      <set item="oparam:endday" value="@{GetSessionsContaining(stest,111)}" />
      <set item="oparam:" conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${customer}=79163515045}" connector="SMSCON_01">
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate-->
		<!--deliveryTemplate conditionEx="#{${dbresult}=0}" call="DB_LastPeriodBill2">
      <set item="iparam:customer" value="${customer}" />
      <set item="iparam:beginday" value="${beginday}" />
      <set item="iparam:endday"   value="${endday}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate-->
		<deliveryTemplate conditionEx="#{${dbresult}=0}">
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:zdraftintdotpart" value="${draftintdotpart}" />
			<set item="oparam:zbeginday" value="${beginday}" />
			<set item="oparam:zendday"   value="${endday}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="startdate" />
			<param name="enddate" />
		</input>
		<output>
			<param name="dbresult" value="" />
			<param name="zbeginday" value="" />
			<param name="zendday" value="" />
			<param name="zdraftintdotpart" value="" />
		</output>
	</template>



	<!--
  <template procedureName="DB_LastPeriodBill" sessionStorage="Memory" sessionLifetime="20" persistent="true" >
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="emailcon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${customer}" subject="lastperiodbill" />
        <Attribute name="startdate" value="${startdate}" />
        <Attribute name="enddate" value="${enddate}" />@{store(stest,111)}</Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{${customer}=79163515044}" terminating="true">
      <set item="oparam:dbresult" value="320341" />
      <set item="oparam:beginday" value="31.12.2007" />
      <set item="oparam:endday" value="@{GetSessionsContaining(stest,111)}" />
      <set item="oparam:" conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${customer}=79163515045}" connector="SMSCON_01">
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}" call="DB_LastPeriodBill2">
      <set item="iparam:customer" value="${customer}" />
      <set item="iparam:beginday" value="${beginday}" />
      <set item="iparam:endday"   value="${endday}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="dbresult" value="" />
      <param name="beginday" value="" />
      <param name="endday" value="" />
    </output>
  </template>

  <template procedureName="DB_LastPeriodBill2" sessionStorage="Memory" sessionLifetime="20" persistent="true" >
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="soapcon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${customer}" subject="knownperiodbill" />
        <Attribute name="startdate" value="${beginday}" />
        <Attribute name="enddate" value="${endday}" />@{store(stest,01.06.2008)}</Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="oparam:dbresult" value="${dbresult}" />
      <set item="oparam:zdraftintdotpart" value="${draftintdotpart}" />
      <set item="oparam:zbeginday" value="${endday}" />
      <set item="oparam:zendday"   value="${stest}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="customer" />
      <param name="beginday" />
      <param name="endday" />
    </input>
    <output>
      <param name="dbresult" value="" />
      <param name="zdraftintdotpart" value="" />
      <param name="zbeginday" value="" />
      <param name="zendday" value="" />
    </output>
  </template>
-->
	<!--template procedureName="GetBMSBalanceSync" handler="_BMSHND" sessionLifetime="300">
    <receiveTemplate>
      <Message type="getcounters" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(${guid})}">
        <Item procedureName="GetBalance">
          <Attribute name="Customer" type="String" value="${Msisdn}"/>
          <Attribute name="Balance"/>
          <Attribute name="Counters"/>
          <Attribute name="CreateDate"/>
          <Attribute name="Result"/>
        </Item>
        @{store(sMsisdn,${Msisdn})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'='0'}" call="GetBMSCounter">
      <set item="iparam:zMsisdn" value="${sMsisdn}"/>
      <set item="iparam:zBalance" value="${Balance}"/>
      <set item="iparam:zCreateDate" value="${CreateDate}"/>
    </deliveryTemplate>
    <input>
      <param name="Msisdn"/>
      <param name="LanguageId"/>
    </input>
    <output>
      <param name="dbresult" value="-1"/>
      <param name="zBalance" value=""/>
      <param name="zCreateDate" value=""/>
      <param name="zCampaignId" value=""/>
      <param name="zCampaignName" value=""/>
      <param name="zCounterId" value=""/>
      <param name="zCounterName" value=""/>
      <param name="zCounterValue" value=""/>
      <param name="zEndDate" value=""/>
      <param name="zStartDate" value=""/>
    </output>
  </template-->

	<template procedureName="GetBMSBalanceSync" handler="_BMSCON" sessionLifetime="300">
		<receiveTemplate>
			<Message type="getcounters" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(${guid})}">
				<Item procedureName="GetBalance">
					<Attribute name="Customer" type="String" value="${Msisdn}"/>
					<Attribute name="Balance"/>
					<Attribute name="Counters"/>
					<Attribute name="CreateDate"/>
					<Attribute name="Result"/>
				</Item>
				@{store(sMsisdn,${Msisdn})}
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${Result}'='0'}" call="GetBMSCounter">
			<set item="iparam:Msisdn" value="${sMsisdn}"/>
			<set item="iparam:Balance" value="${Balance}"/>
			<set item="iparam:CreateDate" value="${CreateDate}"/>
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${Result}'!='0'}">
			<set item="oparam:dbresult" value="${Result}"/>
		</deliveryTemplate>
		<input>
			<param name="Msisdn"/>
			<param name="LanguageId"/>
		</input>
		<output>
			<param name="dbresult" value="-1"/>
			<!--			<param name="zBalance" value=""/>
			<param name="zCreateDate" value=""/>
			<param name="zCampaignId" value=""/>
			<param name="zCampaignName" value=""/>
			<param name="zCounterId" value=""/>
			<param name="zCounterName" value=""/>
			<param name="zCounterValue" value=""/>
			<param name="zEndDate" value=""/>
			<param name="zStartDate" value=""/> -->
		</output>
	</template>

	<template procedureName="DB_ServiceActivation" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="${service}" action="2" class="1" createrequest="1"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{${dbresult} != 0}" connector="SMSCON_01" call="ServiceOrderErrorHandler.SendProvisionErrorMessage" terminating="false" />
                <deliveryTemplate conditionEx="#{${dbresult} = document('C:\Foris\Messaging Gateway\config\SelfDescriptiveCodes.xml')/dbresults/dbresult}" connector="SMSCON_01" call="ServiceOrderErrorHandler.SendCRMErrorMessage" terminating="false" />
		<deliveryTemplate>
			<set item="oparam:dbresult"   value="${dbresult}"/>
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="service" />
		</input>
		<output>
			<param name="dbresult" type="3" value="" /> 
		</output>
	</template>

	<template procedureName="DB_ServiceActivation2" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" action="9.2">
					<Product code="${service}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{${dbresult} != 0}" connector="SMSCON_01" call="ServiceOrderErrorHandler.SendProvisionErrorMessage" terminating="false" /><deliveryTemplate conditionEx="#{${dbresult} = document('C:\Foris\Messaging Gateway\config\SelfDescriptiveCodes.xml')/dbresults/dbresult}" connector="SMSCON_01" call="ServiceOrderErrorHandler.SendCRMErrorMessage" terminating="false" />
		<deliveryTemplate>
			<set item="oparam:dbresult"   value="${dbresult}"/>
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="service" />
		</input>
		<output>
			<param name="dbresult" type="3" value="" /> 
		</output>
	</template>

	<template procedureName="DB_ServiceDeactivation" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}">
					<Service id="${service}" action="3" class="1" createrequest="1"/>
				</Item>
			</Message>
		</receiveTemplate>
		<input>
			<param name="customer" />
			<param name="service" />
		</input>
		<output>
			<param name="dbresult" type="3" value="" /> 
		</output>
	</template>

	<template procedureName="DB_ServiceDeactivation2" persistent="false">
		<condition>
		</condition>
		<receiveTemplate>
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" action="10.2">
					<Product code="${service}" />
				</Item>
			</Message>
		</receiveTemplate>
		<input>
			<param name="customer" />
			<param name="service" />
		</input>
		<output>
			<param name="dbresult" type="3" value="" /> 
		</output>
	</template>

	<!--template procedureName="DB_OrderBonusVoucher" handler="DBCON_01">
		<receiveTemplate>
			<Message initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item procedureName="DB_OrderBonusVoucher">
					<Attribute name="p_MSISDN" type="STRING" value="${Customer}" />
					<Attribute name="p_TYPE" type="STRING" value="${VouchType}" />
					<Attribute name="p_NAME" type="STRING" value="${VouchDescription}" />
					<Attribute name="p_BonusPrice" type="STRING" value="${BonusPrice}" /> 
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="param:dbresult" value="#{if('${p_dbresult}'='',-1,number('${p_dbresult}'))}" />
		</deliveryTemplate>
		<input>
			<param name="Customer" />
			<param name="name" />
			<param name="cmd" />
			<param name="type" />
		</input>
		<output>
			<param name="dbresult"  type="3" value="-1" />
		</output>
	</template>
	<template procedureName="DB_OrderBonusGift" handler="DBCON_01">
		<receiveTemplate>
			<Message initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item procedureName="DB_OrderBonusGift">
					<Attribute name="p_MSISDN" type="STRING" value="${Customer}" />
					<Attribute name="p_Code" type="STRING" value="${CustServiceID}" />
					<Attribute name="p_BonusPrice" type="STRING" value="${BonusPrice}" /> 
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="param:dbresult" value="#{if('${p_dbresult}'='',-1,number('${p_dbresult}'))}" />
		</deliveryTemplate>
		<input>
			<param name="Customer" />
			<param name="code" />
		</input>
		<output>
			<param name="dbresult"  type="3" value="-1" />
		</output>
	</template-->
	<template procedureName="DB_OrderBonusVoucher" sessionLifetime="300">
		<receiveTemplate>
			<Message type="CustomerBonusRequest" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(${guid})}">
				<Item customer="${customer}">
					<Attribute name="BonusCode" value="${bonuscode}"/>
					<Attribute name="language_id" value="1"/>
				</Item>
				@{store(Msisdn,${customer})}
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${dbresult}'='0'}" call="OrderBonusVoucher">
			<set item="iparam:Msisdn" value="${Msisdn}"/>
			<set item="iparam:FirstName" value="${FirstName}"/>
			<set item="iparam:LastName" value="${LastName}"/>
			<set item="iparam:OrganizationName" value="${OrganizationName}"/>
			<set item="iparam:PANumber" value="${PANumber}"/>
			<set item="iparam:TerminalDeviceID" value="${TerminalDeviceID}"/>
			<set item="iparam:ResponsiblePerson" value="${ResponsiblePerson}"/>
			<set item="iparam:ContactPhone" value="${ContactPhone}"/>
			<set item="iparam:ZIP" value="${ZIP}"/>
			<set item="iparam:City" value="${City}"/>
			<set item="iparam:Street" value="${Street}"/>
			<set item="iparam:House" value="${House}"/>
			<set item="iparam:Flat" value="${Flat}"/>
			<set item="iparam:District" value="${District}"/>
			<set item="iparam:Region" value="${Region}"/>
			<set item="iparam:Description" value="${Description}"/>
			<set item="iparam:Code" value="${Code}"/>
			<set item="iparam:Name" value="${Name}"/>
		</deliveryTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}"/>
		</deliveryTemplate>
		<input>
			<param name="customer"/>
			<param name="bonuscode"/>
		</input>
		<output>
			<param name="dbresult" type="3" value="-1"/>
		</output>
	</template>
	<template procedureName="OrderBonusVoucher" handler="DBCON_05">
		<receiveTemplate>
			<Message initiator="ivrcon" id="${guid}" session_id="@{setSessionId(${guid})}">
				<Item procedureName="WEBAPP.INSERT_ORDER_VOUCHER">
					<Attribute name="i_addr_first_name" type="STRING" value="${FirstName}"/>
					<Attribute name="i_addr_last_name" type="STRING" value="${LastName}"/>
					<Attribute name="i_msisdn" type="STRING" value="${Msisdn}"/>
					<Attribute name="i_acc_number" value="${PANumber}"/>
					<Attribute name="i_phys_res_id" type="INT" value="${TerminalDeviceID}"/>
					<Attribute name="i_vouch_desc" type="STRING" value="${Name}"/>
					<Attribute name="i_vouch_type" type="STRING" value="${Code}"/>
					<Attribute name="i_user_name" type="STRING" value="USSD"/>
					<Attribute name="i_create_date" type="DATETIME" value="@{now}"/>
					<Attribute name="i_date_process" type="DATETIME" value=""/>
					<Attribute name="i_zip" type="STRING" value="${ZIP}"/>
					<Attribute name="i_city" type="STRING" value="${City}"/>
					<Attribute name="i_street" type="STRING" value="${Street}"/>
					<Attribute name="i_house" type="STRING" value="${House}"/>
					<Attribute name="i_float_addr" type="STRING" value="${Flat}"/>
					<Attribute name="i_name_addr" type="STRING" value="${FirstName}"/>
					<Attribute name="i_phone_addr" type="STRING" value="${Msisdn}"/>
					<Attribute name="i_note_addr" type="STRING" value=""/>
					<Attribute name="i_is_mail" type="INT" value="0"/>
					<Attribute name="i_region" type="STRING" value="${Region}"/>
					<Attribute name="i_district" type="STRING" value="${District}"/>
					<Attribute name="i_user_proc" type="STRING" value=""/>
					<Attribute name="i_amount" type="INT" value="1"/>
					<Attribute name="i_cust_type" type="INT" value="0"/>
					<Attribute name="i_request_id" type="INT" value=""/>
					<Attribute name="reqnumber" type="out:INT"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}"/>
			<set item="oparam:reqnumber" value="${reqnumber}"/>
		</deliveryTemplate>
		<input>
			<param name="Msisdn"/>
			<param name="FirstName"/>
			<param name="LastName"/>
			<param name="OrganizationName"/>
			<param name="PANumber"/>
			<param name="TerminalDeviceID"/>
			<param name="ResponsiblePerson"/>
			<param name="ContactPhone"/>
			<param name="ZIP"/>
			<param name="City"/>
			<param name="Street"/>
			<param name="House"/>
			<param name="Flat"/>
			<param name="District"/>
			<param name="Region"/>
			<param name="Description"/>
			<param name="Code"/>
			<param name="Name"/>
		</input>
		<output>
			<param name="dbresult" type="3" value="-1"/>
			<param name="reqnumber" type="3" value="-1"/>
		</output>
	</template>
	<template procedureName="DB_OrderBonusGift" handler="DBCON_05">
		<receiveTemplate>
			<Message initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item procedureName="WEBAPP.FRS_CUSTOMER_REQUEST.INSERT_REQUEST_BY_MSISDN">
					<Attribute name="I_MSISDN" type="STRING" value="${Customer}"/>
					<Attribute name="I_SERVICE_ID" type="INT" value="${Code}"/>
					<Attribute name="I_REQ_TYPE" type="INT" value="1"/>
					<Attribute name="I_REQ_COMMENT" type="STRING" value=""/>
					<Attribute name="I_REQ_PRIORITY" type="INT" value="0"/>
					<Attribute name="I_REQ_PARAM" type="STRING" value=""/>
					<Attribute name="I_REQ_USER" type="STRING" value="USSD"/>
					<Attribute name="I_MARKET" type="INT" value="0"/>
					<Attribute name="I_SALESMAN_ID" type="INT" value=""/>
					<Attribute name="I_SALE_POINT_CODE" type="STRING" value=""/>
					<Attribute name="RAISE_ERRORS_FLAG" type="STRING" value="False"/>
					<Attribute name="reqnumber" type="out:INT"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}"/>
			<set item="oparam:reqnumber" value="${reqnumber}"/>
		</deliveryTemplate>
		<input>
			<param name="Customer"/>
			<param name="Code"/>
		</input>
		<output>
			<param name="dbresult" type="3" value="-1"/>
			<param name="reqnumber" type="3" value="-1"/>
		</output>
	</template>
	<template procedureName="DB_LangSetting" > 
		<receiveTemplate>
			<Message type="setprofile" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${customer}" >
					<Attribute name="communicationlanguage" value="${communicationlanguage}"/>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="communicationlanguage" />	  
		</input>
		<output>
			<param name="dbresult" type="3" value="0" /> 
		</output>
	</template>  

	<template procedureName="GetBMSCounter" handler="_BMSCON" sessionLifetime="300">
		<receiveTemplate>
			<Message type="getcounters" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(${guid})}">
				<Item procedureName="GetMsisdnCurrentCounterInstances">
					<Attribute name="Customer" type="String" value="${Msisdn}"/>
					<Attribute name="LanguageId" type="String" value="3"/>
					<Attribute name="CounterInstances"/>
					<Attribute name="Result"/>
				</Item>
				@{store(sBalance,${Balance})}
				@{store(sCreateDate,${CreateDate})}
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${Result}'='0'}">
			<set item="oparam:dbresult" value="0"/>
			<set item="oparam:zBalance" value="${sBalance}"/>
			<set item="oparam:zCreateDate" value="${sCreateDate}"/>

			<set item="oparam:zCampaignId" value="#{nodeset('${CounterInstances}')/CounterInstances/CounterInstance/CampaignId/text()}"/>
			<set item="oparam:zCampaignName" value="#{nodeset('${CounterInstances}')/CounterInstances/CounterInstance/CampaignName/text()}"/>
			<set item="oparam:zCounterId" value="#{nodeset('${CounterInstances}')/CounterInstances/CounterInstance/CounterId/text()}"/>
			<set item="oparam:zCounterName" value="#{nodeset('${CounterInstances}')/CounterInstances/CounterInstance/CounterName/text()}"/>
			<set item="oparam:zCounterValue" value="#{nodeset('${CounterInstances}')/CounterInstances/CounterInstance/CounterValue/text()}"/>
			<set item="oparam:zEndDate" value="#{nodeset('${CounterInstances}')/CounterInstances/CounterInstance/EndDate/text()}"/>
			<set item="oparam:zStartDate" value="#{nodeset('${CounterInstances}')/CounterInstances/CounterInstance/StartDate/text()}"/>

			<!--set item="oparam:zCounters" value="${CounterInstances}"/-->
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${Result}'='-1'}">
			<set item="oparam:dbresult" value="-1"/>
			<set item="oparam:zCounters" value="0"/>
		</deliveryTemplate>
		<input>
			<param name="Msisdn"/>
			<param name="Balance"/>
			<param name="CreateDate"/>
		</input>
		<output>
			<param name="dbresult" value="-1"/>
			<param name="zBalance" value=""/>
			<param name="zCreateDate" value=""/>

			<param name="zCampaignId" value=""/>
			<param name="zCampaignName" value=""/>
			<param name="zCounterId" value=""/>
			<param name="zCounterName" value=""/>
			<param name="zCounterValue" value=""/>
			<param name="zEndDate" value=""/>
			<param name="zStartDate" value=""/>

			<!--param name="zCounters" value="0"/-->

		</output>
	</template>


	<!-- 29.09.2013 Task 709266 -->

	<template procedureName="DB_FavUpdate" sessionStorage="Memory" sessionLifetime="120">
		<receiveTemplate>
			<Message type="setprofile" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
				<Item customer="${customer}" action="10">
					<Attribute name="favouritenumber" value="${favouritenumber}" />
					<Attribute name="index" value="0" />
					<Attribute name="favouritenumbertypeid" value="${fntype}" />
				</Item>
				@{store(sFavouriteNumber,${favouritenumber})}  
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:favouritenumber" value="${sFavouriteNumber}" />
			<set item="oparam:count" value="${count}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="favouritenumber" />
			<param name="fntype" />
		</input>
		<output>
			<param name="dbresult" />
			<param name="favouritenumber" />
			<param name="count" value="0" />
		</output>
	</template>


	<template procedureName="DB_FavDeleteIndex" sessionStorage="Memory" sessionLifetime="120">
		<receiveTemplate>
			<Message type="setprofile" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
				<Item customer="${customer}" action="8">
					<Attribute name="favouritenumber" value="" />
					<Attribute name="index" value="${index}" />
					<Attribute name="favouritenumbertypeid" value="${fntype}" />
				</Item>
				@{store(sIndex,${index})}
				@{store(sFavouritenumbertypeid,${fntype})}
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${dbresult}'='0' and '${favouritenumber}'!=''}" call="DB_FavDeleteIndex_s2">
			<set item="iparam:customer"  value="${customer}"/>
			<set item="iparam:favouritenumber"  value="${favouritenumber}"/>
			<set item="iparam:index"  value="${sIndex}"/>
			<set item="iparam:fntype"  value="${sFavouritenumbertypeid}"/>
			<set item="iparam:count"  value="${count}"/>
		</deliveryTemplate>
		<deliveryTemplate conditionEx="#{'${favouritenumber}'='' and '${dbresult}'='0'}">
			<set item="oparam:dbresult" value="320009" />
			<set item="oparam:favouritenumber" value="${favouritenumber}" />
			<set item="oparam:count" value="${count}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>		
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:favouritenumber" value="${favouritenumber}" />
			<set item="oparam:count" value="${count}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>	
		<input>
			<param name="customer" />
			<param name="index" />
			<param name="fntype" />
		</input>
		<output>
			<param name="dbresult" />
			<param name="favouritenumber" />
			<param name="count" />
		</output>
	</template>

	<template procedureName="DB_FavDeleteIndex_s2" sessionStorage="Memory" sessionLifetime="120">
		<receiveTemplate>
			<Message type="setprofile" initiator="ivrcon" id="${guid}" session_id="${session_id}">
				<Item customer="${customer}" action="11">
					<Attribute name="favouritenumber" value="${favouritenumber}" />
					<Attribute name="index" value="${index}" />
					<Attribute name="favouritenumbertypeid" value="${fntype}" />
				</Item>
				@{store(sCount,${count})}
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:favouritenumber" value="${favouritenumber}" />
			<set item="oparam:count" value="${sCount}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="favouritenumber" />
			<param name="index" />
			<param name="fntype" />
			<param name="count" />
		</input>
		<output>
			<param name="dbresult" />
			<param name="favouritenumber" />
			<param name="count" />
		</output>
	</template>


	<template procedureName="DB_FavDelete" sessionStorage="Memory" sessionLifetime="120">
		<receiveTemplate>
			<Message type="setprofile" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
				<Item customer="${customer}" action="11">
					<Attribute name="favouritenumber" value="${favouritenumber}" />
					<Attribute name="index" value="0" />
					<Attribute name="favouritenumbertypeid" value="${fntype}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:favouritenumber" value="${favouritenumber}" />
			<set item="oparam:count" value="${count}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="favouritenumber" />
			<param name="fntype" />
		</input>
		<output>
			<param name="dbresult" />
			<param name="favouritenumber" />
			<param name="count" />
		</output>
	</template>  

	<template procedureName="DB_FavBrowse" sessionStorage="Memory" sessionLifetime="120">
		<receiveTemplate>
			<Message type="setprofile" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
				<Item customer="${customer}" action="8">
					<Attribute name="favouritenumber" value="" />
					<Attribute name="index" value="${index}" />
					<Attribute name="favouritenumbertypeid" value="${fntype}" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${favouritenumber}'='' and '${dbresult}'='0'}">
			<set item="oparam:dbresult" value="320009" />
			<set item="oparam:favouritenumber" value="${favouritenumber}" />
			<set item="oparam:count" value="${count}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>		
		<deliveryTemplate>
			<set item="oparam:dbresult" value="${dbresult}" />
			<set item="oparam:favouritenumber" value="${favouritenumber}" />
			<set item="oparam:count" value="${count}" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="index" />
			<param name="fntype" />
		</input>
		<output>
			<param name="dbresult" />
			<param name="favouritenumber" />
			<param name="count" value="0" />
		</output>
	</template>

	<template procedureName="DB_ACCOUNT_ENDDATE_SRV" handler="DBCON_01" persistent="false">
		<receiveTemplate>
			<Message initiator="ussd" id="${guid}" session_id="@{newGuid}">
				<Item procedureName="MG.UMC_GET_ENDDATE_SRV">
					<Attribute name="p_msisdn" type="STRING" value="${customer}" />
					<Attribute name="p_service" type="STRING" value="${service}" />
					<Attribute name="p_dbresult" type="STRING" />
					<Attribute name="p_date_result" type="STRING" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="oparam:dbresult" value="#{if('${p_dbresult}'='',-1,number('${p_dbresult}'))}" />
			<set item="oparam:date_result" value="#{/Message/Item/Attribute[@name='p_date_result']/@value}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="service" />
		</input>
		<output>
			<param name="dbresult"  type="3" value="-1" />
			<param name="date_result"   type="1" value="-1" />
		</output> 		
	</template>

	<template procedureName="GetRetrieveTdLimit" sessionStorage="Memory" sessionLifetime="300">
		<condition>
			<test item="${Recipient}" matches="_SMS_SERVICE_NUMBER" />
			<test item="${Content}" matches="^_SMS_LIMIT_CONTENT_VALUE$" />
		</condition>
		<receiveTemplate>
			<Message type="retrievetdlimit" initiator="ussd" id="${guid}" session_id="@{setSessionId(${guid})}">
				<Item customer="${Sender}"/>
			</Message>
		</receiveTemplate>
		<!-- Result message 
<Message type="retrievetdlimitresult" id="***" session_id="***" request_id="***" language_id="***">
	<Item customer="***MSISDN***">
		<Attribute name="has_td_limit" value="0|1" />
		<Attribute name="blocked_by_limit" value="0|1" />
		<Attribute name="block_threshold" value="" />
		<Attribute name="notify_threshold" value="" />
    <Attribute name="current_expenses" value="" />
	</Item>
</Message>

-->
		<deliveryTemplate conditionEx="#{${dbresult} = 0 and ${has_td_limit} = 0}">
			<set item="Content" value="Pomilka zaputy. Za detalnoju informatsijeju telefonujte 111." />
			<set item="Content" conditionEx="#{'${language_id}' = '3'}" value="Oshibka zaprosa. Za detalnoj informatsiej zvonite 111." />
			<set item="Content" conditionEx="#{'${language_id}' = '1'}" value="Error request. For detailed information call 111." />
			<set item="Sender" value="_SMS_SERVICE_NUMBER" />
			<set item="Recipient" value="${customer}" />
			<set item="Encoding" value="${Encoding}"/>
		</deliveryTemplate>

		<deliveryTemplate conditionEx="#{${dbresult} = 0 and ${has_td_limit} = 1 and ${blocked_by_limit} = 0}">
			<set item="Content" value="Do perevyschennja limitu u Vas zalyshylos #{floor((${block_threshold} - ${current_expenses}) * 100) div 100} hrn." />
			<set item="Content" conditionEx="#{'${language_id}' = '3'}" value="Do prevyshenija limita u Vas ostalos #{floor((${block_threshold} - ${current_expenses}) * 100) div 100} grn." />
			<set item="Content" conditionEx="#{'${language_id}' = '1'}" value="You have #{floor((${block_threshold} - ${current_expenses}) * 100) div 100} UAH left before exceeding your limit." />
			<set item="Sender" value="_SMS_SERVICE_NUMBER" />
			<set item="Recipient" value="${customer}" />
			<set item="Encoding" value="${Encoding}"/>
		</deliveryTemplate>

		<deliveryTemplate conditionEx="#{${dbresult} = 0 and ${has_td_limit} = 1 and ${blocked_by_limit} = 1}">
			<set item="Content" value="Nadannja poslug po vashomu nomeru tymchasovo obmezheno. Za detalnoju informatsijeju telefonujte + 38 044  240 0001" />
			<set item="Content" conditionEx="#{'${language_id}' = '3'}" value="Predostavlenie uslug po Vashemu nomeru vremenno ogranicheno. Za detalnoj informatsiej zvonite + 38 044  240 0001" />
			<set item="Content" conditionEx="#{'${language_id}' = '1'}" value="Provision of services for your number is temporarily suspended. For detailed information call + 38 044  240 0001" />      
			<set item="Sender" value="_SMS_SERVICE_NUMBER" />
			<set item="Recipient" value="${customer}" />
			<set item="Encoding" value="${Encoding}"/>
		</deliveryTemplate>

		<deliveryTemplate>
			<set item="Content" value="Servis tymchasovo nedostupnyy" />
			<set item="Content" conditionEx="#{'${language_id}' = '3'}" value="Servis vremenno nedostupen" />
			<set item="Content" conditionEx="#{'${language_id}' = '1'}" value="Service temporarily unavailable" />      
			<set item="Sender" value="_SMS_SERVICE_NUMBER" />
			<set item="Recipient" value="${customer}" />
			<set item="Encoding" value="${Encoding}"/>
		</deliveryTemplate>
	</template>

</templateGroup>