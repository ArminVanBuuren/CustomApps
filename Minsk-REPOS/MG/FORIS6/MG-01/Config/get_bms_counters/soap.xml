
  <template procedureName="BMS.GetBMSBalance" handler="WCFHND_01">
    <receiveTemplate>
      <Message type="getcounters" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
        <Item procedureName="GetBalance">
          <Attribute name="Customer" type="String" value="${customer}" />
          <Attribute name="Balance" />
          <Attribute name="Counters" />
          <Attribute name="CreateDate" />
          <Attribute name="Result" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate terminating="false">
      <set item="param:dbresult" value="${Result}" />
    </deliveryTemplate>
    <deliveryTemplate connector="SMSCON_01" />
    <input>
      <param name="customer" />
    </input>
    <output>
      <param name="dbresult" type="3" value="0" />
    </output>
  </template>
  <template procedureName="BMS_OrderGift" sessionStorage="Memory" sessionLifetime="50" onClean="OrderGift_onClean">
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="ivrcon" id="@{setMessageId(@{newGuid})}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${customer}" subject="category" />
        @{store(sGiftcode,${giftcode})}
        @{store(sCustomer,${customer})}
        @{store(SOAPRequest,@{GetSOAPRequest()})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{count(document('..\..\config\get_bms_counters\bmsgifts.xml')/gifts/gift[@code='${sGiftcode}'])=0}">
      <set item="oparam:dbresult" value="-3" />
      <!-- giftcode is not found in bmsgifts.xml -->
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${SOAPRequest}'=''}" connector="SMSCON_01" />
    <!-- session expired -->
    <deliveryTemplate conditionEx="#{${dbresult}=0 and document('..\..\config\get_bms_counters\bmsgifts.xml')/gifts/gift[@needPrpReg='false']/@code='${sGiftcode}' and ${clientstatus}&gt;1}" call="BMS_OrderGift_Step2">
      <set item="iparam:customer" value="${sCustomer}" />
      <!-- there is no need of PrP registration -->
      <set item="iparam:giftcode" value="${sGiftcode}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and document('..\..\config\get_bms_counters\bmsgifts.xml')/gifts/gift[@needPrpReg='true']/@code='${sGiftcode}' and ${clientstatus}=PRP_REGISTERED}" call="BMS_OrderGift_Step2">
      <set item="iparam:customer" value="${sCustomer}" />
      <!-- there is need of PrP registration -->
      <set item="iparam:giftcode" value="${sGiftcode}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="oparam:dbresult" value="-2" />
      <!-- customer has no proper status (not registered) to get gift -->
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <input>
      <param name="customer" />
      <param name="giftcode" />
    </input>
    <output>
      <param name="dbresult" />
      <param name="ordercost" />
      <param name="newbalance" />
      <param name="giftprovisionid" />
    </output>
  </template>
  <template procedureName="BMS_OrderGift_Step2" sessionStorage="Memory" sessionLifetime="50" onClean="OrderGift_onClean">
    <receiveTemplate>
      <Message type="orderbonusgiftrequest" initiator="ivrcon" id="${guid}" session_id="${SessionId}">
        <Item customer="${customer}">
          <Attribute name="giftcode" value="${giftcode}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${SOAPRequest}'=''}" connector="SMSCON_01" />
    <!-- session expired -->
    <deliveryTemplate conditionEx="#{'${dbresult}'='-1'}">
      <set item="oparam:dbresult" value="-4" />
      <!-- some error -->
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${dbresult}'='320301'}">
      <set item="oparam:dbresult" value="-1" />
      <!-- some error -->
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate />
    <input>
      <param name="customer" />
      <param name="giftcode" />
    </input>
    <output>
      <param name="dbresult" />
      <param name="ordercost" />
      <param name="newbalance" />
      <param name="giftprovisionid" />
    </output>
  </template>
  <template procedureName="OrderGift_onClean" sessionStorage="Memory">
    <deliveryTemplate>
      <set conditionEx="0@{BuildSOAPResponse(${SOAPRequest})}" />
      <set item="oparam:dbresult" value="-5" />
    </deliveryTemplate>
    <output>
      <param name="dbresult" />
      <param name="ordercost" />
      <param name="newbalance" />
      <param name="giftprovisionid" />
    </output>
  </template>
