<templateGroup name="BMS">
  <macros>
    <define name="_GET_BMS_COUNTER" value="1234" />
    <define name="_MSCPCON" value="WCFHND_01" />
  </macros>
  <template procedureName="ProcGetBMSCounter" handler="_MSCPCON" sessionStorage="Remoting" sessionLifetime="300">
    <condition>
      <test item="${Recipient}" matches="^_GET_BMS_COUNTER$" />
      <test item="${Content}" matches="^[0-9]{1,}$" />
    </condition>
    <receiveTemplate>
      <Message type="getcounters" initiator="ussd" id="${guid}" session_id="@{setSessionId(${guid})}">
        <Item procedureName="GetMsisdnCurrentCounterInstances">
          <Attribute name="Customer" type="String" value="${sender}" />
          <Attribute name="CounterInstances" />
          <Attribute name="Result" />
        </Item>
        @{store(sBMScode,#{document('config\get_bms_counters\counters.xml')/counters/counter[@ussd_code='${content}']/@bms_code})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sBMScode}'=''}">
      <set item="Content" value="Не найден счетчик с таким кодом." />
      <set item="Sender" value="_GET_BMS_COUNTER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'='0'}">
      <set item="Content" value="Значение счетчика: #{nodeset('${CounterInstances}')/CounterInstances/CounterInstance[CounterName='${sBMScode}']/CounterValue/text()}" />
      <set item="Sender" value="_GET_BMS_COUNTER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="ScheduleDeliveryTime" value="#{getTimeInRange('08:00','21:00')}" />
      <!-- 000000HHMMSS000R -->
      <set item="ValidityPeriod" value="#{getTimeInRange('11:00','23:59')}" />
      <!-- 000000HHMMSS000R -->
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка получения счетчика с кодом '${sBMScode}' (${Result})" />
      <set item="Sender" value="_GET_BMS_COUNTER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="ScheduleDeliveryTime" value="#{getTimeInRange('08:00','21:00')}" />
      <!-- 000000HHMMSS000R -->
      <set item="ValidityPeriod" value="#{getTimeInRange('11:00','23:59')}" />
      <!-- 000000HHMMSS000R -->
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="GetBMSCounterInvalidFormat">
    <condition>
      <test item="${Recipient}" matches="^_GET_BMS_COUNTER$" />
    </condition>
    <receiveTemplate>
      <Message id="${guid}" session_id="${guid}">
        <Attribute name="Customer" value="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Для запроса счетчика вышлите его числовой код на номер 123." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_GET_BMS_COUNTER" />
      <set item="Recipient" value="${Customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="GetBMSCounter" sessionStorage="Remoting">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'='0'}">
      <set item="Content" value="Значение счетчика: #{nodeset('${CounterInstances}')/CounterInstances/CounterInstance[CounterName='${sBMScode}']/CounterValue/text()}" />
      <set item="Sender" value="_GET_BMS_COUNTER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="ScheduleDeliveryTime" value="#{getTimeInRange('08:00','21:00')}" />
      <!-- 000000HHMMSS000R -->
      <set item="ValidityPeriod" value="#{getTimeInRange('11:00','23:59')}" />
      <!-- 000000HHMMSS000R -->
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка получения счетчика с кодом '${sBMScode}' (${Result})" />
      <set item="Sender" value="_GET_BMS_COUNTER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="ScheduleDeliveryTime" value="#{getTimeInRange('08:00','21:00')}" />
      <!-- 000000HHMMSS000R -->
      <set item="ValidityPeriod" value="#{getTimeInRange('11:00','23:59')}" />
      <!-- 000000HHMMSS000R -->
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="GetBMSBalance">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'='0'}">
      <set item="Content" value="Ваш бонус-баланс на ${CreateDate} равен ${Balance} руб." />
      <set item="Sender" value="_GET_BMS_COUNTER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="ScheduleDeliveryTime" value="#{getTimeInRange('08:00','21:00')}" />
      <!-- 000000HHMMSS000R -->
      <set item="ValidityPeriod" value="#{getTimeInRange('11:00','23:59')}" />
      <!-- 000000HHMMSS000R -->
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при получении бонус-баланса." />
      <set item="Sender" value="_GET_BMS_COUNTER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="ScheduleDeliveryTime" value="#{getTimeInRange('08:00','21:00')}" />
      <!-- 000000HHMMSS000R -->
      <set item="ValidityPeriod" value="#{getTimeInRange('11:00','23:59')}" />
      <!-- 000000HHMMSS000R -->
    </deliveryTemplate>
  </template>
</templateGroup>