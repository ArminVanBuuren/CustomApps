<templateGroup name="MTSGROUP">
  <macros>
    <define name="_ENCODING" value="unicodefffe" />
    <define value="839" name="_MTSGROUP_SERVICE_NUMBER" />
    <define name="_USSDCON" value="USSDCON_04" />
    <define name="_SMSCON" value="SMSCON_04" />
    <define name="_SMS_SERVICE_NUMBER" value="839" />
  </macros>
  <template onClean="AddToGroup_onClean" sessionStorage="Database" procedureName="AddToGroup_onClean_MTSGROUP1" sessionLifetime="86400">
    <!-- Отправка приглашения -->
    <condition>
      <test item="${Recipient}" matches="^_SMS_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\d{12}$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" session_id="@{setSessionId(MTSGROUP#{substring('${token0}',string-length('${token0}')-12)})}" type="verificationrequest" id="@{newGuid}">
        <Item customer="${Sender}">
          <Attribute value="0" name="checkivrservice" />
          <Attribute value="0" name="checkblocks" />
          <Attribute value="CUGCH" name="grouptype" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'='${Customer}'}">
      <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="У абонента ${sInvited} есть ваше активное приглашение." />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'!='${Customer}'}">
      <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="У абонента ${sInvited} есть активное приглашение в другую группу. Повторите запрос позже" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${Customer}'='#{substring('${session_id}',string-length('${session_id}')-11)}'}">
      <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="Номер приглашенного абонента ${Customer} совпадает с вашим. Заявка не принята" />
      <set item="Encoding" value="_ENCODING" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="Ваша заявка принята." />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate connector="SMSCON_04" />
  </template>
  <template procedureName="ListOfGroup_MTSGROUP">
    <!-- Получение списка *570*4 -->
    <condition>
      <test matches="^_MTSGROUP_SERVICE_NUMBER$" item="${Recipient}" />
      <test item="${Content}" matches="^4$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" session_id="@{newGuid}" type="customergroup" id="${guid}">
        <Item action="2" customer="${Sender}">
          <Attribute value="0" name="groupmember" />
          <Attribute value="5002" name="index" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="#{if('${grouplisting}'='','Вы не состоите ни в одной группе','Состав группы: ${grouplisting}')}" />
      <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка получения списка группы" />
      <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
  </template>
  <template procedureName="DelFromGroup_MTSGROUP">
    <!-- Удаление группы *570*0 -->
    <condition>
      <test matches="^_MTSGROUP_SERVICE_NUMBER$" item="${Recipient}" />
      <test item="${Content}" matches="^0$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" session_id="@{newGuid}" type="customergroup" id="${guid}">
        <Item action="1" customer="${Sender}">
          <Attribute value="0" name="groupmember" />
          <Attribute value="5002" name="index" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Заявка на удаление из группы зарегистрирована" />
      <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320708">
      <set item="Content" value="Вы не состоите в группе" />
      <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка удаления из группы" />
      <set item="Sender" value="_MTSGROUP_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="_ENCODING" />
    </deliveryTemplate>
  </template>
</templateGroup>