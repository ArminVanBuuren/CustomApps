<templates connector="SMS">
  <template procedureName="gift_mts_user" sessionStorage="Database" sessionLifetime="60" handler="DBCON_01">
    <condition>
      <test item="${Recipient}" matches="^839$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        <Item procedureName="billing.mg_validateservice">
          <Attribute name="p_msisdn" type="STRING" value="${Sender}" />
          <Attribute name="p_service_code" type="STRING" value="FR16447" />
          <Attribute name="rez" type="STRING" />
        </Item>
        @{store(storedSender,${Sender})}
        @{store(storedRecipient,${Recipient})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate terminating="false">
      <set item="Content" value="K sozhaleniyu, proizoshla oshibka. Poprobuyte eshe raz." />
      <set item="Content" conditionEx="#{${rez}=0}" value="Извините, Вам недоступно участие в акции." />
      <set item="Content" conditionEx="#{${rez}=1}" value="Запрос принят, Вам будет отправлено SMS с информацией." />
      <set item="Sender" value="${storedRecipient}" />
      <set item="Recipient" value="${storedSender}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${rez}=1}" connector="SMSCON_02">
      <!--<set item="Content" value="Вам доступно участие в акции! Заходите в приложение «Мой МТС» и выбирайте Ваш подарок: безлимитные звонки на МТС или безлимитный интернет. Узнать больше: https://m.mts.by/new-user С заботой, Ваш МТС" />  -->
      <set item="Sender" value="0884" />
      <set item="Recipient" value="${storedSender}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${rez}=0}" dropReply="true" />
  </template>
  <template procedureName="Bad_request">
    <condition>
      <test item="${Recipient}" matches="^(839)$" />
    </condition>
    <receiveTemplate>
      <Message>
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Ошибка. Введите корректный запрос" />
      <set item="Sender" value="839" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
</templates>