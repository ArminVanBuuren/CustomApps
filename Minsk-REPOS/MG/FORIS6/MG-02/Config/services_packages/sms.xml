<templateGroup name="ServicePackages">
  <macros>
    <define name="_PKG_ADD_NUMBER" value="11112" />
    <define name="_PKG_REMOVE_NUMBER" value="22223" />
    <define name="_PKG_GETLIST_NUMBER" value="45456" />
  </macros>
  <template procedureName="SMSGetServicePackages">
    <condition>
      <test item="${Recipient}" matches="^_PKG_GETLIST_NUMBER$" />
      <test item="${Content}" matches="^SM-VIEW$" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" subject="product" languageCode="1" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <!--set item="Content"		value="Сообщение об успешном создании заявки, согласованное с МТС" />
			<set item="Content"		conditionEx="#{${dbresult}!=0}" value="Сообщение об ошибке, согласованное с МТС" /-->
      <set item="Content" conditionEx="#{${dbresult}=0 and '${pkgnamelist}'!=''}" value="Ваши пакеты услуг: ${pkgnamelist}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${pkgnamelist}'=''}" value="У Вас нет подключенных пакетов услуг" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PKG_GETLIST_NUMBER" />
      <set item="Recipient" value="${Сustomer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMSAddServicePackage">
    <condition>
      <test item="${Recipient}" matches="^_PKG_ADD_NUMBER$" />
      <test item="#{count(document('..\..\config\services_packages\servicepackage.xml')/packages/package[@smscode='${token0}'])}" matches="^1|true$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="9.2">
          <Product code="#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@smscode='${token0}']/@crmcode}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сообщение об успешном создании заявки, согласованное с МТС" />
      <set item="Content" conditionEx="#{${dbresult}!=0}" value="#{/Message/Item/Product/Error[1]/Attribute[@name='message']/text()}" />
      <set item="Content" value="Ошибка добавления пакета" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Заявка на добавление пакета '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' успешно создана" />
      <set item="Content" conditionEx="#{${dbresult}=320154}" value="Невозможно подключить пакет '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}'.Есть взаимоисключающие пакеты." />
      <set item="Content" conditionEx="#{${dbresult}=320203}" value="Добавление пакета услуг '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" conditionEx="#{${dbresult}=320204}" value="Пакет услуг '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' не предоставляется для Вашего тарифного плана" />
      <set item="Content" conditionEx="#{${dbresult}=320205}" value="Пакет услуг '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' был добавлен ранее" />
      <set item="Content" conditionEx="#{${dbresult}=330116}" value="Пакет услуг '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' был добавлен ранее" />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Недостаточно средств для проведения операции. Проверить баланс: *100# и вызов." />
      <set item="Content" conditionEx="#{${dbresult}=330112}" value="Данное действие с продуктом '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' не возможно. Действие с продуктом не разрешено правилами" />
      <set item="Content" conditionEx="#{${dbresult}=330115}" value="#{/Message/Item/Product/Error[1]/Attribute[@name='message']/text()}" />
      <set item="Content" conditionEx="#{${dbresult}=330117}" value="ПУ не доступен для Вашего ТП" />
      <set item="Content" conditionEx="#{${dbresult}=330119}" value="Действие с продуктом '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' не возможно. Для продукта существуют разрешающие продукты, которые не подключены." />
      <set item="Content" conditionEx="#{${dbresult}=-1}" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PKG_ADD_NUMBER" />
      <set item="Recipient" value="${Сustomer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMSRemoveServicePackage">
    <condition>
      <test item="${Recipient}" matches="^_PKG_REMOVE_NUMBER$" />
      <test item="#{count(document('..\..\config\services_packages\servicepackage.xml')/packages/package[@smscode='${token0}'])}" matches="^1|true$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="10.2">
          <Product code="#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@smscode='${token0}']/@crmcode}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сообщение об успешном создании заявки, согласованное с МТС" />
      <set item="Content" conditionEx="#{${dbresult}!=0}" value="#{/Message/Item/Service/Error[1]/Attribute[@name='Message']/text()}" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Заявка на удаление пакета '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' успешно создана" />
      <set item="Content" conditionEx="#{${dbresult}=320203}" value="Удаление пакета услуг '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" conditionEx="#{${dbresult}=320204}" value="Пакет услуг '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' не предоставляется для Вашего тарифного плана" />
      <set item="Content" conditionEx="#{${dbresult}=320206}" value="Пакет услуг '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' был удален ранее" />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Недостаточно средств для проведения операции. Проверить баланс: *100# и вызов." />
      <set item="Content" conditionEx="#{${dbresult}=330112}" value="Данное действие с продуктом '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' не возможно. Действие с продуктом не разрешено правилами" />
      <set item="Content" conditionEx="#{${dbresult}=330115}" value="#{/Message/Item/Product/Error[1]/Attribute[@name='message']/text()}" />
      <set item="Content" conditionEx="#{${dbresult}=330117}" value="ПУ не доступен для Вашего ТП" />
      <set item="Content" conditionEx="#{${dbresult}=330119}" value="Действие с продуктом '#{document('..\..\config\services_packages\servicepackage.xml')/packages/package[@crmcode='#{/Message/Item/Product/@code}']/@name}' не возможно. Для продукта существуют разрешающие продукты, которые не подключены." />
      <set item="Content" conditionEx="#{${dbresult}=-1}" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PKG_REMOVE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMSManageServicePackage_Error">
    <condition>
      <test item="${Recipient}" matches="^(_PKG_REMOVE_NUMBER|_PKG_ADD_NUMBER)$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${sender}" sender="${Recipient}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Сообщение о неверном формате сообщения, согласованное с МТС" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="${sender}" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
</templateGroup>