<templateGroup name="GroupManager">
	<macros>
		<define name="_SMSCON"					value="SMSCON_01_01" />
		<define name="_INVITE_MEMBER_CODE"		value="1" />
		<define name="_DEL_MEMBER_CODE"			value="0" />
		<define name="_GET_MEMBER_LIST_CODE"	value="2" />

		<define name="_SERVICE_NUMBER"	value="768" />

		<define name="_PRODUCT_TYPE_ID"			value="#{document('config\closed_user_group\product_id.xml')/groups/group[@ussdcode='${Recipient}']/@product_id}" />
		<define name="_GROUP_TYPE_NAME"			value="#{document('config\closed_user_group\product_id.xml')/groups/group[@ussdcode='${Recipient}']/@smscode}" />
		<define name="_GROUP_TO_PRODUCT_TYPE"	value="#{document('config\closed_user_group\product_id.xml')/groups/group[@smscode='${sGroupType}']/@product_id}" />
		<define name="_CHECK_RECIPIENT_NUMBER"	value="#{count(document('config\closed_user_group\product_id.xml')/groups/group[@ussdcode='${Recipient}'])}" />
	</macros>
	
	<template procedureName="InviteMember_Error" sessionStorage="Database" sessionLifetime="86400" onClean="GroupManager.AddToGroup_onClean">
		<condition>
			<test item="${Content}"		matches="^_INVITE_MEMBER_CODE\*\d{11}$" />
			<test item="_CHECK_RECIPIENT_NUMBER"	matches="^1$" />
			<test item="@{SessionExists(InviteMember(${token1}))}"		matches="^[Tt][Rr][Uu][Ee]$"/>
		</condition>
		
		<receiveTemplate>
			<Message type="transfer_data" id="${guid}" session_id="@{newGuid}" >
				<Attribute name="Customer"		value="${Sender}" />
			</Message>
		</receiveTemplate>

		<deliveryTemplate direction="input" >
			<set item="Content"		value="В один момент времени может быть активно только одно приглашение в группу." />
			<set item="Encoding"	value="unicodefffe" />
			<set item="Sender"		value="_SERVICE_NUMBER" />
			<set item="Recipient"	value="${Customer}" />
		</deliveryTemplate>
	</template>
	
	<template procedureName="InviteMember" sessionStorage="Database" sessionLifetime="86400" onClean="GroupManager.AddToGroup_onClean">
		<condition>
			<test item="${Content}"		matches="^_INVITE_MEMBER_CODE\*\d{11}$" />
			<test item="_CHECK_RECIPIENT_NUMBER"	matches="^1$" />
			<test item="@{SessionExists(InviteMember(${token1}))}"		matches="^[Ff][Aa][Ll][Ss][Ee]$" />
		</condition>
		<receiveTemplate>
			<Message type="customergroup" initiator="smscon" id="${guid}" session_id="@{setSessionId(InviteMember(${token1}))}">
				@{store(sInviter,${sender})}
				@{store(sInvited,${token1})}
				@{store(sGroupType,_GROUP_TYPE_NAME)}
				<Item customer="${sInviter}" action="3">
					<Attribute name="groupmember" value="${sInvited}" />
					<Attribute name="index" value="_GROUP_TO_PRODUCT_TYPE" />
				</Item>
			</Message>
		</receiveTemplate>

		<deliveryTemplate direction="input" terminating="false" >
			<set item="Content"		value="Ваша заявка принята." />
			<set item="Encoding"	value="unicodefffe" />
			<set item="Sender"		value="_SERVICE_NUMBER" />
			<set item="Recipient"	value="${sInviter}" />
		</deliveryTemplate>
		
        <deliveryTemplate connector="_SMSCON" />
		
	</template>
	
	<template procedureName="RemoveMemeber">
		<condition>
			<test item="${Content}"		matches="^_DEL_MEMBER_CODE$" />
			<test item="_CHECK_RECIPIENT_NUMBER"	matches="^1$" />
		</condition>
		
		<receiveTemplate>
			<Message type="customergroup" initiator="smscon" id="${guid}" session_id="${guid}">
				<Item customer="${Sender}" action="1">
					<Attribute name="index" value="_PRODUCT_TYPE_ID" />
				</Item>
			</Message>
		</receiveTemplate>

		<deliveryTemplate direction="input" terminating="false" >
			<set item="Content"		value="Ваша заявка принята." />
			<set item="Encoding"	value="unicodefffe" />
			<set item="Sender"		value="_SERVICE_NUMBER" />
			<set item="Recipient"	value="${Customer}" />
		</deliveryTemplate>
		
		<deliveryTemplate connector="_SMSCON" />
	</template>
	
	<template procedureName="GetMemberList">
		<condition>
			<test item="${Content}"		matches="^_GET_MEMBER_LIST_CODE$" />
			<test item="_CHECK_RECIPIENT_NUMBER"	matches="^1$" />
		</condition>
		
		<receiveTemplate>
			<Message type="customergroup" initiator="smscon" id="${guid}" session_id="@{newguid}">
				<Item customer="${Sender}" action="2">
					<Attribute name="index" value="_PRODUCT_TYPE_ID" />
					<Attribute name="groupmember" value="0" />
				</Item>
			</Message>
		</receiveTemplate>
	
		<deliveryTemplate direction="input" terminating="false" >
			<set item="Content"		value="Ваша заявка принята." />
			<set item="Encoding"	value="unicodefffe" />
			<set item="Sender"		value="_SERVICE_NUMBER" />
			<set item="Recipient"	value="${Customer}" />
		</deliveryTemplate>
	
		<deliveryTemplate connector="_SMSCON" />
	</template>

	<template procedureName="InavlidFormat">
		<condition>
			<test item="_CHECK_RECIPIENT_NUMBER"	matches="^1$" />
		</condition>
		
		<receiveTemplate>
			<Message type="transfer_data" id="${guid}" session_id="@{newGuid}" >
				<Attribute name="Customer"		value="${Sender}" />
				<Attribute name="Initiator"		value="${Recipient}" />
			</Message>
		</receiveTemplate>
	
		<deliveryTemplate direction="input" >
			<set item="Content"		value="Неправильный запрос." />
			<set item="Encoding"	value="unicodefffe" />
			<set item="Sender"		value="_SERVICE_NUMBER" />
			<set item="Recipient"	value="${Customer}" />
		</deliveryTemplate>
	</template>
	
</templateGroup>