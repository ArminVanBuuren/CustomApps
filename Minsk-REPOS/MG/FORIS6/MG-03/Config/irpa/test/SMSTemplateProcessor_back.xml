<templates connector="SMS">
  <macros>
    <define name="_SMS_SERVICE_NUMBER" value="111" />
    <define name="_MI_SERVICE_NUMBER" value="5800" />
    <define name="_FND_SERVICE_NUMBER" value="1777" />
    <!-- DIALOG-->
    <define name="_MI_MAXIDUET_SERVICE_NUMBER" value="1388" />
    <!--Udalit' eto DIALOG	
	<define name="_MAX_MAXIDUET_LIST_LENGTH" value="16" />
-->
    <define name="_MAXIDUET_ISSA_NUMBER" value="ISSA_MAXIDUET" />
    <define name="_MAX_LIST_LENGTH" value="89" />
    <define name="_MAX_FAVOURITE_NUM" value="7" />
    <define name="_CREDIT_SERVICE_NUMBER" value="2828" />
    <define name="_4MONITORING" value="79163515044" />
    <define name="_PTP_SERVICE_NUMBER" value="112" />
    <define name="_SPONSOR_SERVICE_NUMBER" value="1114" />
    <define name="_MAX_DUET_LIST_LENGTH" value="16" />
    <define name="_USSD_SPONSOR_NUMBER" value="114" />
    <define name="_INVITE_OPERATION_CODE" value="0" />
    <define name="_DUET_INVITE_CODE" value="001" />
    <define name="_MI_ISSA_NUMBER" value="ISSA_MI" />
    <define name="_DUET_ISSA_NUMBER" value="ISSA_DUET" />
    <define name="_MACR_CRMACT_SMSNUM_TO_SERVICE_CODE" value="@{switch(${Recipient}|-1,6275|FR7MMS)}" />
    <define name="_MACR_CRMACT_SERVICE_CODE_TO_MESSAGE" value="@{switch(${service_id}|,FR50SMS|50 SMS,FR7MMS|7 MMS)}" />
    <define name="_CHILDTP" value="789" />
    <define name="_CHILDS_BALANCE_SERVICE" value="140" />
    <define name="_TRANSPORT" value="SMS" />
    <define name="_FINDMASKFORADDSRV" value="@number='${Recipient}' and @source='SMS' and ((@addtextsms='${Content}') or (@addtextsms='allchars*'))" />
    <define name="_FINDMASKFORDELSRV" value="@number='${Recipient}' and @source='SMS' and ((@deltextsms='${Content}') or (@deltextsms='allchars*'))" />
    <define name="_FINDMASKFORWRONGSRV" value="@number='${Recipient}' and @source='SMS'" />
    <define name="_CHILTP_ALLSMS" value="@{switch(${tariffplan}|-1,789|789,648|648,655|655|720)}" />
    <define name="_PKG_SERVICE_NUMBER" value="5191" />
  </macros>
  <template procedureName="Service_activate">
    <condition>
      <test item="${Recipient}" matches="^1120$" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate conditionEx="#{'${service_id}'='411009'}">
      <set item="Content" condition="//Item/@dbresult=0" value="С баланса вашего лицевого счета списана плата за подключение услуги. Кредитная линия по Вашему лицевому счету будет доступна через 24 часа" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги Кредит невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга не подключена. Подробности по номеру 05902" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга активна. Повторное подключение услуги не требуется" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Услуга не подключена. Подробности по номеру 05902" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_CREDIT_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${service_id}'='CB414525'}">
      <set item="Content" value="Ошибка при добавлении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Внимание! Услуга действует с 22.12.08 по 28.02.09. Узнайте все о роуминге *111*33# (бесплатно)" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга «'#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'» не подключена. Предварительно бесплатно подключите услуги роуминга в салоне МТС." />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга'#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Content" conditionEx="#{${dbresult}=320956}" value="Услуга не подключена. Подробности по номеру 0590XX" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${service_id}'='FRTRBONUS' or '${service_id}'='FRTRBONUSKORP'}">
      <set item="Content" value="Ошибка при добавлении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Вы зарегистрированы в акции Тройной бонус.Первые 50 мин, 50 SMS будут начислены Вам не позднее завтрашнего дня.Подробнее 059035" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <!-- Родные страны -->
    <deliveryTemplate conditionEx="#{'${service_id}'='FRRMTSSNG'}">
      <set item="Content" value="Ошибка при добавлении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка принята. Проверьте наличие услуг межд. доступа и роуминга" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  не подключена. Предварительно бесплатно подключите услуги роуминга в салоне МТС." />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <!-- GPRS -->
    <deliveryTemplate conditionEx="#{'${service_id}'='CB404447'}">
      <set item="Content" value="Ошибка при добавлении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  не подключена. Предварительно бесплатно подключите услуги роуминга в салоне МТС." />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была добавлена ранее.Настройки 0876 или СМС на 1234" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <!-- Evraziya -->
    <deliveryTemplate conditionEx="#{'${service_id}'='FRPEVRAZ7' and //Item/@dbresult=0}">
      <set item="Content" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована.Услуга действует в течение 7 дней. Проверьте наличие услуг межд. доступа и роуминга. Инфо 059053 или *111*33#" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${service_id}'='FRPEVRAZ14' and //Item/@dbresult=0}">
      <set item="Content" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована.Услуга действует в течение 14 дней. Проверьте наличие услуг межд. доступа и роуминга. Инфо 059053 или *111*33#" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${service_id}'='FRBEVRAZ7' and //Item/@dbresult=0}">
      <set item="Content" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована.Услуга действует в течение 7 дней. Проверьте наличие услуг межд. доступа и роуминга. Инфо 059053 или *111*33#" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${service_id}'='FRBEVRAZ14' and //Item/@dbresult=0}">
      <set item="Content" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована.Услуга действует в течение 14 дней. Проверьте наличие услуг межд. доступа и роуминга. Инфо 059053 или *111*33#" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <!-- Индивидуальный кредиT-->
    <deliveryTemplate conditionEx="#{'${service_id}'='FRINDKREDIT'}">
      <set item="Content" value="Данная услуга для Вас недоступна. Подробности по номеру 05902." />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на подключение услуги Индивидуальный кредит принята. Метод расчётов будет изменён на кредитный. Подробности по номеру 05902" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была добавлена ранее." />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <!-- всегда как дома -->
    <deliveryTemplate conditionEx="#{'${service_id}'='FRVEZDKD'}">
      <set item="Content" value="Данная услуга для Вас недоступна. Подробности по номеру 05902." />
      <set item="Content" condition="//Item/@dbresult=0" value="Запрос принят.Услуга Везде как дома действует до 30.09.2009.Инфо 0590512/www.mts.ru" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была добавлена ранее." />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <!-- турист -->
    <deliveryTemplate conditionEx="#{'${service_id}'='FRTUR'}">
      <set item="Content" value="Данная услуга для Вас недоступна. Подробности по номеру 05902." />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка принята. Услуга действует в течение 14 дней. Проверьте наличие услуг межд. доступа и роуминга. Инфо 059053 или *111*33# вызов" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была добавлена ранее." />
      <set item="Content" condition="//Item/@dbresult=320194" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' Вам недоступна." />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' не предоставляется для Вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=320194" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' Вам недоступна." />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  #include "config\get_bms_counters\sms.xml"
  #include "config\GuaranteedPayment\sms.xml"
  #include "c:\FORIS\Messaging Gateway\config\ZGP\sms_macros.xml"
  #include "SMS\VoicePortal.xml"
  #include "config\ServiceOrderErrorHandler.xml"
  #include "config\closed_user_group\sms.xml"
  #include "c:\FORIS\Messaging Gateway\config\ZGP\sms.xml"
  #include "SMS\SMSParametricDiscount.xml"
  #include "config\services_packages\sms.xml"
  <!-- Voice mail to e-mail start -->
  <!-- Send "90 email@domain" to 111 -->
  <template procedureName="VM2EMAIL_INFO_1">
    <condition>
      <test item="${Recipient}" matches="^111$" />
      <test item="${Content}" matches="^90 0$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Услуга 'Голосовая почта' позволяет прослушивать голосовые сообщения от звонящих вам абонентов в момент когда Вы не ответили на звонок или Ваш телефон был выключен. Ежедневная плата 2,3 руб/сутки с НДС. " />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="111" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="VM2EMAIL_INFO_2">
    <condition>
      <test item="${Recipient}" matches="^111$" />
      <test item="${Content}" matches="^90 01$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Voicemail -  the service which allows callers to leave a voice message if your phone is not available now or you don't answer." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="111" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="VM2EMAIL_ServiceControl" sessionStorage="Memory" sessionLifetime="600" onClean="Action_onClean">
    <condition>
      <test item="${Recipient}" matches="^111$" />
      <test item="${Content}" matches="^90\s+\S*$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="smscon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${Sender}">
          <Service id="VOICEMAIL2" action="interrogation" />
        </Item>
        @{store(sEmail,#{substring-after('${Content}', ' ')})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}" call="ActivateService_VM2EMAIL">
      <set item="Content" value="${sEmail}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="111" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{store(ssEmail,${sEmail})}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при проверке услуги" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Проверка наличия услуг невозможна пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' не предоставляется на Вашем тарифе. Подробнее об услуге и условиях:  www.pda.mts.ru  (бесплатно)." />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была добавлена ранее. Проверить подключенные  опции: *152# и вызов" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств для проведения операции. Проверить баланс: *100# и вызов." />
      <set item="Content" condition="//Item/@dbresult=-1" value="Ошибка при добавлении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'. При повторении ошибки: Справка МТС: 0890 (бесплатно по России)" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="ActivateService_VM2EMAIL" sessionStorage="Memory" sessionLifetime="600" onClean="Action_onClean">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${Sender}">
          <Service id="VM2EMAIL" action="2">
            <Attribute name="email" value="${ssEmail}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=320205}" call="ReactivationService_VM2EMAIL">
      <set item="Content" value="${sEmail}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="111" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'. При повторении ошибки: Справка МТС: 0890 (бесплатно по России)" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована. Дождитесь SMS с результатом." />
      <set item="Content" conditionEx="#{${dbresult}=320157}" value="Для подключения услуги 'Голосовая почта на e-mail' требуется наличие услуги 'Голосовая почта'." />
      <set item="Content" conditionEx="#{${dbresult}=320162}" value="Неверный формат e-mail адреса" />
      <set item="Content" conditionEx="#{${dbresult}=320411}" value="Неверный формат e-mail адреса" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Recipient" value="${customer}" />
      <set item="Sender" value="111" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ReactivationService_VM2EMAIL">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${Sender}">
          <Service id="VM2EMAIL" action="8">
            <Attribute name="email" value="${ssEmail}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при изменении услуги" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована. Дождитесь SMS с результатом." />
      <set item="Content" conditionEx="#{${dbresult}=320157}" value="Для подключения услуги 'Голосовая почта на e-mail' требуется наличие услуги 'Голосовая почта'." />
      <set item="Content" conditionEx="#{${dbresult}=320162}" value="Неверный формат e-mail адреса" />
      <set item="Content" conditionEx="#{${dbresult}=320411}" value="Неверный формат e-mail адреса" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Recipient" value="${customer}" />
      <set item="Sender" value="111" />
    </deliveryTemplate>
  </template>
  <!-- Voice mail to email end. -->
  <template procedureName="DeliveryRequestRestricted">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <deliveryTemplate>
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="0022" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="ascii" />
      <set item="ScheduleDeliveryTime" value="#{getTimeInRange('08:00','16:30')}" />
      <!-- 000000HHMMSS000R -->
      <set item="ValidityPeriod" value="#{getTimeInRange('09:00','23:30')}" />
      <!-- 000000HHMMSS000R -->
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
  </template>
  <template procedureName="DB_BalanceRetriev">
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен" />
      <set item="Content" condition="//Item/@dbresult=0" value="#{if(${balanceintpartdotpart}&gt;=0,'Ваш баланс:','Ваша задолженность:')}#{/Message/Item/Attribute[@name='balanceintpartdotpart']/@value div 100}руб." />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${iscredit}'='1'}" value="Ваш кредитный баланс:#{${balanceintpartdotpart} div 100}руб.; кредитный лимит: #{${creditlimitintpartdotpart}  div 100}руб." />
      <set item="Content" conditionEx="#{${dbresult}=0 and count(/Message/Item/accumulators/accumulator)&gt;=1}" value="${Content}. #{/Message/Item/accumulators/@sms}" />
      <set item="Content" condition="//Item/@dbresult=320343" value="Данная услуга не предоставляется" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!-- Начало шаблона добавления группы DIALOG i MY через ISSA  -->
  <template procedureName="AddToGroup_MAXIDUET" sessionStorage="Database" sessionLifetime="86400" onClean="AddToGroup_onClean">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="@{setSessionId(MAXIDUET7#{(0*${sInvited})}">
        <Item customer="${sInviter}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
          <Attribute name="grouptype" value="${sGroupType}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${sGroupType}'='TEST_GROUP'}" call="AddToGroup1_TEST_GROUP">
      <set item="Content" value="AddToGroup1(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{store(sAlreadyInvited,1)}" />
      <set conditionEx="0@{store(sInviter,${sInviter})}" />
      <set conditionEx="0@{store(sInvited,${sInvited})}" />
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set conditionEx="0@{store(sGroupType,${sGroupType})}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sGroupType}'='MTSGROUP'}" call="AddToGroup1">
      <set item="Content" value="AddToGroup1(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{store(sAlreadyInvited,1)}" />
      <set conditionEx="0@{store(sInviter,${sInviter})}" />
      <set conditionEx="0@{store(sInvited,${sInvited})}" />
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set conditionEx="0@{store(sGroupType,${sGroupType})}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при проверкe типа группы." />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- Окончание шаблона добавления группы DIALOG i MY через ISSA  -->
  <!-- Begin group Duet SMS -->
  <template procedureName="AddToGroupDuet" sessionStorage="Database" sessionLifetime="86400" onClean="AddToGroup_onClean">
    <condition>
      <test item="${Recipient}" matches="^_MI_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^[0-9]{11}$" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="@{setSessionId(MTSGROUP7#{substring('${token0}',string-length('${token0}')-9)})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
          <Attribute name="grouptype" value="@{switch(${Recipient}|UNDEFINED,_MI_SERVICE_NUMBER|DUET,_MI_ISSA_NUMBER|MTSGROUP,_DUET_ISSA_NUMBER|DUET)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'='${Customer}'}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="У абонента ${sInvited} есть ваше активное приглашение. Чтобы принять его абонент ${sInvited} должен отправить СМС со словом DA на номер 5800" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'!='${Customer}'}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="У абонента ${sInvited} есть активное приглашение в другую группу. Повторите запрос позже" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${Customer}'='7#{substring('${session_id}',string-length('${session_id}')-9)}'}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="Номер приглашенного абонента ${Customer} совпадает с вашим. Заявка не принята" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" call="AddToGroup1_DUET">
      <set item="Content" value="AddToGroup1(7#{substring('${session_id}',string-length('${session_id}')-9)})" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{store(sAlreadyInvited,1)}" />
      <set conditionEx="0@{store(sInviter,${Customer})}" />
      <set conditionEx="0@{store(sInvited,7#{substring('${session_id}',string-length('${session_id}')-9)})}" />
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set conditionEx="0@{store(sGroupType,${grouptype})}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ListOfGroupDuet">
    <condition>
      <test item="${Recipient}" matches="^_MI_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*([IiИи][NnНн][FfФф][OoОо])\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="4" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="#{if('${grouplisting}'='','Вы не состоите ни в одной группе','Состав группы: ${grouplisting}')}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка получения списка группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="DelFromGroupDuet">
    <condition>
      <test item="${Recipient}" matches="^_MI_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*([DdДд][EeЕе][LlЛл])\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="1">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="4" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Заявка на удаление из группы зарегистрирована" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320708">
      <set item="Content" value="Вы не состоите в группе" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка удаления из группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- END group Duet SMS -->
  <!-- Begin Proverka i Udalenie DIALOG -->
  <template procedureName="ListOfGroupMAXIDuet">
    <condition>
      <test item="${Recipient}" matches="^_MI_MAXIDUET_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*([IiИи][NnНн][FfФф][OoОо])\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="5" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="#{if('${grouplisting}'='','Вы не состоите ни в одной группе','Состав группы: ${grouplisting}')}" />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка получения списка группы" />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="DelFromGroupMAXIDuet">
    <condition>
      <test item="${Recipient}" matches="^_MI_MAXIDUET_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*([DdДд][EeЕе][LlЛл])\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="1">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="5" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Заявка на удаление из группы зарегистрирована" />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320708">
      <set item="Content" value="Вы не состоите в группе" />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка удаления из группы" />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- END Proverka i Udalenie DIALOG -->
  <!-- только для DUET и МЫ -->
  <template procedureName="RULES_AddToGroup_onResponse_DUET_MTS_MAXIDUET" sessionStorage="Database" sessionLifetime="86400" persistent="true">
    <condition>
      <test item="${Recipient}" matches="^_MI_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*(([DdДд][AaАа])|([YyУу][EeЕе][SsСс]))\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="@{setSessionId(MTSGROUP${Sender})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
        @{store(sGroupType,#{if('${sGroupType}'='','MTSGROUP','${sGroupType}')})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="AddToGroup_onResponse_DUET" direction="input" conditionEx="#{'${sGroupType}'='DUET'}">
      <set item="Content" value="DUET" />
      <set item="Sender" value="${sInvited}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup_onResponse" direction="input">
      <set item="Content" value="MTSGROUP" />
      <set item="Sender" value="${sInvited}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- Begin Proverka, Udalenie i Ohibka DIALOG-->
  <template procedureName="ListOfGroup_MAXIDUET">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="#{if('${grouplisting}'='','Вы не состоите ни в одной группе','Состав группы: ${grouplisting}')}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка получения списка группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="DelFromGroup_MAXIDUET">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Заявка на удаление из группы зарегистрирована" />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320708">
      <set item="Content" value="Вы не состоите в группе" />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка удаления из группы" />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="MAXIDUETSyntaxErrorSMS">
    <condition>
      <test item="${Recipient}" matches="^_MI_MAXIDUET_SERVICE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Выйти из группы: *138*2#. Узнать состав: *138*1#" />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="MAXIDUETSyntaxError1">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Выйти из группы: *138*2#. Узнать состав: *138*1#" />
      <set item="Sender" value="_MI_MAXIDUET_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- END Proverka, Udalenie i Ohibka DIALOG-->
  <!--Begin group Duet-->
  <template procedureName="AddToGroup1_DUET" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInviter}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup1_DUET">
      <set conditionEx="0@{store(sTryCount,#{number('${sTryCount}')+1})}" />
      <set item="Content" value="AddToGroup1(0*${sInvited}*${sTryCount})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=320060}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Отсутствуют права на проведение операции." />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Отсутствуют права на проведение операции." />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Отправить приглашение может только абонент ТП 'МЫ'" />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="На тарифном плане абонента ${sInviter} услуга недоступна" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Отправить приглашение может только абонент ТП 'МЫ'" />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="На тарифном плане абонента ${sInviter} услуга недоступна" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup2_DUET" conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}">
      <set conditionEx="0@{store(sInviterRegion,${regioncode})}" />
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set item="Content" value="AddToGroup2(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup2_DUET" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInvited}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup2_DUET">
      <set conditionEx="0@{store(sTryCount,#{number('${sTryCount}')+1})}" />
      <set item="Content" value="AddToGroup2(0*${sInvited}*${sTryCount})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}">
      <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
      <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${regioncode}'!='${sInviterRegion}'}">
      <set item="Content" value="Добавление абонента ${sInvited} невозможно, он из другого региона" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup3_DUET" conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}">
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set item="Content" value="AddToGroup3(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup3_DUET" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInviter}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="@{switch(${sGroupType}|-1,MTSGROUP|44822,DUET|44824)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and string-length('${grouplisting}') &gt;= @{switch('${sGroupType}'|-1,'MTSGROUP'|_MAX_LIST_LENGTH,'DUET'|_MAX_DUET_LIST_LENGTH)} }">
      <set item="Content" value="Превышен лимит абонентов в группе" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup4_DUET">
      <set item="Content" value="AddToGroup4(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup4_DUET" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInvited}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="3" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${grouplisting}'!='' and not (contains('${grouplisting}','${sInviter}'))}">
      <set item="Content" value="Абонент ${sInvited} входит в состав другой группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup4B_DUET">
      <set item="Content" value="AddToGroup4B(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup4B_DUET" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInvited}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="2" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${grouplisting}'!='' and not (contains('${grouplisting}','${sInviter}'))}">
      <set item="Content" value="Абонент ${sInvited} входит в состав другой группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup5_DUET">
      <set item="Content" value="AddToGroup5(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup5_DUET" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInviter}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="3" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${grouplisting}'!=''}">
      <set item="Content" value="Абонент ${sInviter} входит в состав другой группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup6_DUET">
      <set item="Content" value="AddToGroup6(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup6_DUET" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInvited}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="@{switch(${sGroupType}|-1,MTSGROUP|44822,DUET|44824)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${grouplisting}'!='' and not (contains('${grouplisting}','${sInviter}'))}">
      <set item="Content" value="Абонент ${sInvited} входит в состав другой группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${grouplisting}'!='' and contains('${grouplisting}','${sInviter}')}">
      <set item="Content" value="Абонент ${sInvited} уже входит в состав вашей группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate terminating="false" conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Абоненту ${sInvited} отправлено ваше приглашение в группу" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Priglashenie v gruppu ot abonenta ${sInviter}. Otvet na nomer _MI_SERVICE_NUMBER s slovom DA - priniat, NET - otkazatsia" />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Приглашение в группу Дуэт от ${sInviter}.Ответьте ДА или НЕТ на  _MI_SERVICE_NUMBER" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при проверке состава группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="DelInvitation_DUET" sessionStorage="Database" sessionLifetime="86400" persistent="true">
    <condition>
      <test item="${Recipient}" matches="^_MI_SERVICE_NUMBER$" />
      <test item="${Content}" matches="(^\s*[NnНн][OoОо]\s*$)|(^\s*[NnНн][EeЕе][TtТт]\s*$)" />
    </condition>
    <receiveTemplate>
      <Message id="@{newGuid}" session_id="@{setSessionId(MTSGROUP${Sender})}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'=''}">
      <set item="Content" value="У вас нет активных приглашений" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Абонент ${sInvited} не подтвердил участие в группе. Ваше приглашение аннулировано." />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Вы не подтвердили участие в группе. Приглашение аннулировано." />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup_onResponse_DUET" sessionStorage="Database" sessionLifetime="86400" persistent="true">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="@{setSessionId(MTSGROUP${Sender})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
        <!--                @{store(sGroupType,#{if('${sGroupType}'='','MTSGROUP','${sGroupType}')})}  -->
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'=''}@{store(sAlreadyInvited,)}">
      <!-- to prevent sending more than 1 request to CRM if abon answer several times within 1-2 sec. -->
      <set item="Content" value="У вас нет активных приглашений" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup_onResponse_DUET">
      <set conditionEx="0@{store(sTryCount,#{number(${sTryCount})+1})}" />
      <set conditionEx="0@{store(sAlreadyInvited,1)" />
      <!-- because sAlreadyInvited has already cleared at this moment in first deliveryTemplate condition -->
      <set item="Content" value="AddToGroup_onResponse(Da*${sTryCount})" />
      <set item="Sender" value="${sInvited}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}" terminating="false">
      <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна." />
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}">
      <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна." />
      <set item="Recipient" value="${sInviter}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}" terminating="false">
      <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна." />
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
      <set item="Content" value="На тарифном плане абонента ${sInvited} услуга недоступна." />
      <set item="Recipient" value="${sInviter}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup_onResponse2_DUET" conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}">
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set conditionEx="0@{store(sInvitedRegion,${regioncode})}" />
      <set item="Content" value="AddToGroup_onResponse2_DUET(Da)" />
      <set item="Sender" value="${sInvited}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup_onResponse2_DUET" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInviter}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup_onResponse2_DUET">
      <set conditionEx="0@{store(sTryCount,#{number(${sTryCount})+1})}" />
      <set item="Content" value="AddToGroup_onResponse2(Da*${sTryCount})" />
      <set item="Sender" value="${sInvited}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}" terminating="false">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Otpravit priglashenie mozhet tolko abonent tarifa 'Mi'. Priglashenie annulirovano." />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="На тарифном плане абонента ${sInviter} услуга недоступна." />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Content" value="Otpravit priglashenie mozhet tolko abonent tarifa 'Mi'. Priglashenie annulirovano." />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="На тарифном плане абонента ${sInviter} услуга недоступна." />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}" terminating="false">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Otpravit priglashenie mozhet tolko abonent tarifa 'Mi'. Priglashenie annulirovano." />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="На тарифном плане абонента ${sInviter} услуга недоступна." />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Content" value="Otpravit priglashenie mozhet tolko abonent tarifa 'Mi'. Priglashenie annulirovano." />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="На тарифном плане абонента ${sInviter} услуга недоступна." />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${regioncode}'!='${sInvitedRegion}'}" terminating="false">
      <set item="Content" value="Добавление абонента ${sInvited} невозможно, он из другого региона" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${regioncode}'!='${sInvitedRegion}'}">
      <set item="Content" value="Добавление абонента ${sInvited} невозможно, он из другого региона" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup_onResponse3_DUET" conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}">
      <set conditionEx="0@{store(sInviterRegion,${regioncode})}" />
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set item="Sender" value="${sInvited}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
      <set item="Content" value="AddToGroup_onResponse3_DUET(Da)" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup_onResponse3_DUET" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${Sender}" action="0">
          <Attribute name="groupmember" value="${sInviter}" />
          <Attribute name="index" value="@{switch(${sGroupType}|-1,MTSGROUP|44822,DUET|44824)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320204" terminating="false">
      <set item="Content" value="Na tarifnom plane abonenta ${sInvited} usluga 'Gruppa MTS' ne dostupna. Priglashenie annulirovano" />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Услуга 'Дуэт' на тарифном плане абонента ${sInvited} недоступна." />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320204">
      <set item="Content" value="Na vashem tarifnom plane usluga 'Gruppa MTS' ne dostupna. Priglashenie annulirovano" />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Услуга 'Дуэт' на вашем тарифном плане недоступна." />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320191" terminating="false">
      <set item="Content" value="Недостаточно средств на лицевом счете для выполнения операции" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320191">
      <set item="Content" value="Недостаточно средств на лицевом счете для выполнения операции" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320704" terminating="false">
      <set item="Content" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320704">
      <set item="Content" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320705" terminating="false">
      <set item="Content" value="Превышен лимит абонентов в группе." />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320705">
      <set item="Content" value="Превышен лимит абонентов в группе" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320706" terminating="false">
      <set item="Content" value="Абонент ${sInvited} входит в состав другой группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320706">
      <set item="Content" value="Абонент ${sInvited} входит в состав другой группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=0" terminating="false">
      <set item="Content" value="Заявка на добавление абонента ${sInvited} в группу зарегистрирована" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=0">
      <set item="Content" value="Заявка на добавление в группу зарегистрирована." />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Content" value="Операция недоступна. Обратитесь в службу поддержки МТС." />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ListOfGroup_DUET">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="#{if('${grouplisting}'='','Вы не состоите ни в одной группе','Состав группы: ${grouplisting}')}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка получения списка группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="DelFromGroup_DUET">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Заявка на удаление из группы зарегистрирована" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320708">
      <set item="Content" value="Вы не состоите в группе" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка удаления из группы" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup_onClean" sessionStorage="Database">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <deliveryTemplate terminating="false">
      <set item="Content" value="Абонент ${sInvited}  не подтвердил участие в группе. Ваше приглашение аннулировано." />
      <set item="Recipient" value="${sInviter}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Вы не подтвердили участие в группе. Приглашение аннулировано." />
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!--End group Duet-->
  <!--Begin group MY-->
  <template procedureName="AddToGroup1" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInviter}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Dannyi zapros seychas ne moget byt vypolnen. Povtorite pozhalusta pozzhe" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup1">
      <set conditionEx="0@{store(sTryCount,#{number('${sTryCount}')+1})}" />
      <set item="Content" value="AddToGroup1(0*${sInvited}*${sTryCount})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=320060}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Отсутствуют права на проведение операции." />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Отсутствуют права на проведение операции." />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Отправить приглашение может только абонент ТП 'МЫ'" />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Na tarifnom plane abonenta ${sInviter} usluga ne dostupna" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Отправить приглашение может только абонент ТП 'МЫ'" />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Na tarifnom plane abonenta ${sInviter} usluga ne dostupna" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup2" conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}">
      <set conditionEx="0@{store(sInviterRegion,${regioncode})}" />
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set item="Content" value="AddToGroup2(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup2" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInvited}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Dannyi zapros seychas ne moget byt vypolnen. Povtorite pozhalusta pozzhe" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup2">
      <set conditionEx="0@{store(sTryCount,#{number('${sTryCount}')+1})}" />
      <set item="Content" value="AddToGroup2(0*${sInvited}*${sTryCount})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}">
      <set item="Content" value="Na tarifnom plane abonenta ${sInvited} usluga ne dostupna" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
      <set item="Content" value="Na tarifnom plane abonenta ${sInvited} usluga ne dostupna" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${regioncode}'!='${sInviterRegion}'}">
      <set item="Content" value="Dobavlenie abonenta ${sInvited} nevozmozhno, on obsluzhivaetsja v drugom regione" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup3" conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}">
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set item="Content" value="AddToGroup3(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup3" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInviter}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="@{switch(${sGroupType}|-1,MTSGROUP|44822,DUET|44824)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and string-length('${grouplisting}') &gt;= @{switch('${sGroupType}'|-1,'MTSGROUP'|_MAX_LIST_LENGTH,'DUET'|_MAX_DUET_LIST_LENGTH)} }">
      <set item="Content" value="Dobavlenie abonenta ${sInvited} nevozmozhno. Prevyshen limit abonentov v gruppe. Priglashenie annulirovano" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup4">
      <set item="Content" value="AddToGroup4(0*${sInvited})" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup4" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInvited}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="@{switch(${sGroupType}|-1,MTSGROUP|44822,DUET|44824)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${grouplisting}'!='' and not (contains('${grouplisting}','${sInviter}'))}">
      <set item="Content" value="Abonent ${sInvited}  vhodit v sostav drugoi gruppy" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${grouplisting}'!='' and contains('${grouplisting}','${sInviter}')}">
      <set item="Content" value="Abonent ${sInvited}  uge vhodit v sostav vashei gruppy" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate terminating="false" conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Abonentu ${sInvited} otpravleno vashe priglashenie v gruppu" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Priglashenie v gruppu ot abonenta ${sInviter}. Otvet na nomer _MI_SERVICE_NUMBER s slovom DA - priniat, NET - otkazatsia" />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Priglashenie v gruppu Duet ot abonenta ${sInviter}. Otvet na nomer _MI_SERVICE_NUMBER s slovom DA - priniat, NET - otkazatsia" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Oshibka pri proverke sostava gruppy" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
    </deliveryTemplate>
  </template>
  <template procedureName="DelInvitation" sessionStorage="Database" sessionLifetime="86400" persistent="true">
    <condition>
      <test item="${Recipient}" matches="^_MI_SERVICE_NUMBER$" />
      <test item="${Content}" matches="(^\s*[NnНн][OoОо]\s*$)|(^\s*[NnНн][EeЕе][TtТт]\s*$)" />
    </condition>
    <receiveTemplate>
      <Message id="@{newGuid}" session_id="@{setSessionId(MTSGROUP${Sender})}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'=''}">
      <set item="Content" value="U Vas net aktivnyh priglashenij" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Abonent ${sInvited}  ne podtverdil uchastie v gruppe. Vashe priglashenie annulirovano" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Priglashenie ot ${sInviter} annulirovano" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup_onResponse" sessionStorage="Database" sessionLifetime="86400" persistent="true">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="@{setSessionId(MTSGROUP${Sender})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
        <!--                @{store(sGroupType,#{if('${sGroupType}'='','MTSGROUP','${sGroupType}')})}  -->
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'=''}@{store(sAlreadyInvited,)}">
      <!-- to prevent sending more than 1 request to CRM if abon answer several times within 1-2 sec. -->
      <set item="Content" value="У Вас нет активных приглашений" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Content" value="Dannyi zapros seychas ne moget byt vypolnen. Povtorite pozhalusta pozzhe" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup_onResponse">
      <set conditionEx="0@{store(sTryCount,#{number(${sTryCount})+1})}" />
      <set conditionEx="0@{store(sAlreadyInvited,1)" />
      <!-- because sAlreadyInvited has already cleared at this moment in first deliveryTemplate condition -->
      <set item="Content" value="AddToGroup_onResponse(Da*${sTryCount})" />
      <set item="Sender" value="${sInvited}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}" terminating="false">
      <set item="Content" value="Na tarifnom plane abonenta ${sInvited} usluga ne dostupna. Priglashenie annulirovano." />
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}">
      <set item="Content" value="Na tarifnom plane abonenta ${sInvited} usluga ne dostupna. Priglashenie annulirovano." />
      <set item="Recipient" value="${sInviter}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}" terminating="false">
      <set item="Content" value="Na tarifnom plane abonenta ${sInvited} usluga ne dostupna. Priglashenie annulirovano." />
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
      <set item="Content" value="Na tarifnom plane abonenta ${sInvited} usluga ne dostupna. Priglashenie annulirovano." />
      <set item="Recipient" value="${sInviter}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup_onResponse2" conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/invited/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}">
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set conditionEx="0@{store(sInvitedRegion,${regioncode})}" />
      <set item="Content" value="AddToGroup_onResponse2(Da)" />
      <set item="Sender" value="${sInvited}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup_onResponse2" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sInviter}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1 and number(${sTryCount})&gt;5}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Content" value="Dannyi zapros seychas ne moget byt vypolnen. Povtorite pozhalusta pozzhe" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1}" call="AddToGroup_onResponse2">
      <set conditionEx="0@{store(sTryCount,#{number(${sTryCount})+1})}" />
      <set item="Content" value="AddToGroup_onResponse2(Da*${sTryCount})" />
      <set item="Sender" value="${sInvited}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}" terminating="false">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Otpravit priglashenie mozhet tolko abonent tarifa 'Mi'. Priglashenie annulirovano." />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Na tarifnom plane abonenta ${sInviter} usluga ne dostupna. Priglashenie annulirovano." />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Content" value="Otpravit priglashenie mozhet tolko abonent tarifa 'Mi'. Priglashenie annulirovano." />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Na tarifnom plane abonenta ${sInviter} usluga ne dostupna. Priglashenie annulirovano." />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}" terminating="false">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Content" value="Otpravit priglashenie mozhet tolko abonent tarifa 'Mi'. Priglashenie annulirovano." />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Na tarifnom plane abonenta ${sInviter} usluga ne dostupna. Priglashenie annulirovano." />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])=0}">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Content" value="Otpravit priglashenie mozhet tolko abonent tarifa 'Mi'. Priglashenie annulirovano." />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Na tarifnom plane abonenta ${sInviter} usluga ne dostupna. Priglashenie annulirovano." />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${regioncode}'!='${sInvitedRegion}'}" terminating="false">
      <set item="Content" value="Dobavlenie abonenta ${sInvited} nevozmozhno, abonenty obslugivayutsya v raznyh regionah. Priglashenie annulirovano." />
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${regioncode}'!='${sInvitedRegion}'}">
      <set item="Content" value="Dobavlenie abonenta ${sInvited} nevozmozhno, on obsluzhivaetsja v drugom regione. Priglashenie annulirovano." />
      <set item="Encoding" value="ascii" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="AddToGroup_onResponse3" conditionEx="#{${dbresult}=0 and count(document('mtsgroup.xml')//root/${sGroupType}/inviter/region[@id=${regioncode}]/tp[@id=${tariffplan}])&gt;0}">
      <set conditionEx="0@{store(sInviterRegion,${regioncode})}" />
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set item="Sender" value="${sInvited}" />
      <set item="Recipient" value="_MI_SERVICE_NUMBER" />
      <set item="Content" value="AddToGroup_onResponse3(Da)" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup_onResponse3" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${Sender}" action="0">
          <Attribute name="groupmember" value="${sInviter}" />
          <Attribute name="index" value="@{switch(${sGroupType}|-1,MTSGROUP|44822,DUET|44824)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320204" terminating="false">
      <set item="Content" value="Na tarifnom plane abonenta ${sInvited} usluga 'Gruppa MTS' ne dostupna. Priglashenie annulirovano" />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Usluga 'Duet' na tarifnom plane abonenta ${sInvited} ne dostupna. Priglashenie annulirovano." />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320204">
      <set item="Content" value="Na vashem tarifnom plane usluga 'Gruppa MTS' ne dostupna. Priglashenie annulirovano" />
      <set item="Content" conditionEx="#{'${sGroupType}'='DUET'}" value="Usluga 'Duet' na vashem tarifnom plane ne dostupna. Priglashenie annulirovano." />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320191" terminating="false">
      <set item="Content" value="Nedostatochno sredstv na litsevom schete dlja vypolnenija operatsii. Priglashenie annulirovano" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320191">
      <set item="Content" value="Nedostatochno sredstv na litsevom schete dlja vypolnenija operatsii. Priglashenie annulirovano" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320704" terminating="false">
      <set item="Content" value="Est' otkritie zayavki na obrabotku. Povtorite zapros pozge" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320704">
      <set item="Content" value="Est' otkritie zayavki na obrabotku. Povtorite zapros pozge" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320705" terminating="false">
      <set item="Content" value="Dobavlenie abonenta ${sInvited} ne vozmozhno. Prevyshen limit abonentov v gruppe. Priglashenie annulirovano" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320705">
      <set item="Content" value="Dobavlenie abonenta ${sInvited} ne vozmozhno. Prevyshen limit abonentov v gruppe. Priglashenie annulirovano" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320706" terminating="false">
      <set item="Content" value="Abonent ${sInvited} ne mojet vhodit bolee chem v odnu gruppu. Priglashenie annulirovano" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320706">
      <set item="Content" value="Abonent ${sInvited} ne mojet vhodit bolee chem v odnu gruppu. Priglashenie annulirovano" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=0" terminating="false">
      <set item="Content" value="Zayavka na dobavlenie abonenta ${sInvited} v gruppu zaregistrirovana" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=0">
      <set item="Content" value="Zayavka na dobavlenie v gruppu zaregistrirovana" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Content" value="Operaciya nedostupna. Obratites v slujbu podderjki MTS" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ListOfGroup">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="#{if('${grouplisting}'='','Vy ne sostoite ni v odnoy gruppe','Sostav gruppy: ${grouplisting}')}" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Oshibka poluchenia spiska gruppy" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
  </template>
  <template procedureName="DelFromGroup">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Zayavka na udalenie iz gruppy zaregistrirovana" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320708">
      <set item="Content" value="Vy ne sostoite v gruppe" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Oshibka udalenia iz gruppy" />
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
  </template>
  <template procedureName="MTSGroupSyntaxError">
    <condition>
      <test item="${Recipient}" matches="^_MI_SERVICE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Sender" value="_MI_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Ошибка в формате запроса" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!--End group MY-->
  <template procedureName="Payments">
    <condition>
      <test item="${Content}" matches="^\d{9}$" />
      <test item="${Recipient}" matches="^502$" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" subject="payments">
          <Attribute name="index" value="${Content}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Payments - count:${Count}, day:${day}, value: #{/Message/Item/Attribute[@name='intpartfracpart']/@value div 100}" />
      <set item="Sender" value="503" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="Balance">
    <condition>
      <test item="${Recipient}" matches="^503$" />
      <test item="${Content}" matches="^\d{9}$" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" subject="balance">
          <Attribute name="requestcountertype" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Your balance is #{/Message/Item/Attribute[@name='balanceintpartdotpart']/@value div 100}" />
      <set item="Sender" value="502" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!--  P-t-P -->
  <template procedureName="Notif_onClean" sessionStorage="Memory">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <deliveryTemplate>
      <set item="Content" value="Извините, сервис временно не доступен" />
      <set item="Sender" value="${sService}" />
      <set item="Recipient" value="${sCustomer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="CheckBlockBeforePTPsms">
    <condition>
      <test item="${Recipient}" matches="^_PTP_SERVICE_NUMBER$" />
      <test item="${Content}" matches="(^\+?[0-9]{10,11}\s[1-9]{1}[0-9]*\s*$)|(^\s*[0-9]{4}\s*$)" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="ussd" id="@{newGuid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="1" />
        </Item>
        @{store(sCustomer,${Sender})}
        @{store(sServiceNumber,${Recipient})}
        @{store(sContent,${Content})}
      </Message>
    </receiveTemplate>
    <!-- for ban TP Guest -->
    <deliveryTemplate conditionEx="#{${dbresult}=0 and ( '${tariffplan}'='633'    )  }">
      <set item="Sender" value="${sServiceNumber}" />
      <set item="Recipient" value="${sCustomer}" />
      <set item="Content" value="Данная услуга Вам недоступна." />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <!--deliveryTemplate call="SMSPtPStep1" conditionEx="#{${dbresult}=0 and '${sServiceNumber}'='_PTP_SERVICE_NUMBER' and matches('${sContent}','^[0-9]{10}\s[1-9]{1}[0-9]*\s*$')}"  \s[0-9]{1,10}-->
    <deliveryTemplate call="SMSPtPStep1" conditionEx="#{${dbresult}=0 and '${sServiceNumber}'='_PTP_SERVICE_NUMBER' and matches('${sContent}','^\+?[0-9]{10,11}\s[1-9]{1}[0-9]*\s*$')}">
      <set item="Sender" value="${sCustomer}" />
      <set item="Recipient" value="${sServiceNumber}" />
      <set item="Content" value="${sContent}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="SMSPtPStep2" conditionEx="#{${dbresult}=0 and '${sServiceNumber}'='_PTP_SERVICE_NUMBER' and matches('${sContent}','^\s*[0-9]{4}\s*$')}">
      <set item="Sender" value="${sCustomer}" />
      <set item="Recipient" value="${sServiceNumber}" />
      <set item="Content" value="${sContent}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sCustomer}'!='' and ${dbresult}=320347}">
      <set item="Content" value="Установлена блокировка. Операция недоступна" />
      <set item="Sender" value="${sServiceNumber}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sCustomer}'!='' and ${dbresult}!=0}">
      <set item="Content" value="Услуга по данному тарифному плану недоступна" />
      <set item="Sender" value="${sServiceNumber}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Операция недоступна" />
      <set item="Sender" value="${sServiceNumber}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMSPtPStep1">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="movepaymentrequest" action="5">
            <Attribute name="receiver" value="#{replace('${token0}','.*(\d{10})','7$1')}" />
            <Attribute name="amount" value="#{normalize-space('${token1}')}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Отправьте СМС ${code} на номер _PTP_SERVICE_NUMBER для пополнения баланса абонента ${receiver} на сумму #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')}" />
      <!--<set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода. Максимально доступная сумма перевода #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')}" />-->
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода." />
      <set item="Content" condition="//Item/@dbresult=320312" value="Услуга заблокирована. Обратитесь в службу поддержки" />
      <!--<set item="Content" condition="//Item/@dbresult=320701" value="Максимально доступная сумма перевода #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')} Создайте запрос снова в формате: *112*номер телефона получателя*сумма#" />-->
      <set item="Content" condition="//Item/@dbresult=320701" value="Сумма больше доступной. Создайте запрос снова в формате: *112*номер телефона получателя*сумма#" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга не доступна организациям" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Перевод невозможен, повторите позже" />
      <set item="Content" condition="//Item/@dbresult=320711" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для отправителя" />
      <set item="Content" condition="//Item/@dbresult=320712" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для получателя" />
      <set item="Content" condition="//Item/@dbresult=320013" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для отправителя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320014" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для получателя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Сервис заблокирован для отправителя перевода" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Сервис заблокирован для получателя перевода" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Content" condition="//Item/@dbresult=320347" value="Perevod nevozmozhen abonentu ${receiver}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PTP_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="SMSPtPStep2">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="movepaymentacceptance" action="5">
            <Attribute name="code" value="#{normalize-space('${token0}')}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Ваша заявка на перевод #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')} абоненту ${receiver} зарегистрирована" />
      <!--<set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода. Максимально доступная сумма перевода #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')}" />-->
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода." />
      <set item="Content" condition="//Item/@dbresult=320666" value="Введен неверный код. Для подтверждения отправьте СМС на номер _PTP_SERVICE_NUMBER, указав верный код" />
      <set item="Content" condition="//Item/@dbresult=320999" value="Истек период действия кода подтверждения. Создайте новый запрос" />
      <set item="Content" condition="//Item/@dbresult=320312" value="Услуга заблокирована. Обратитесь в службу поддержки" />
      <!--<set item="Content" condition="//Item/@dbresult=320701" value="Максимально доступная сумма перевода #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')} Создайте запрос снова в формате: *112*номер телефона получателя*сумма#" />-->
      <set item="Content" condition="//Item/@dbresult=320701" value="Сумма больше доступной. Создайте запрос снова в формате: *112*номер телефона получателя*сумма#" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга не доступна организациям" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Перевод невозможен, повторите позже" />
      <set item="Content" condition="//Item/@dbresult=320711" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для отправителя" />
      <set item="Content" condition="//Item/@dbresult=320712" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для получателя" />
      <set item="Content" condition="//Item/@dbresult=320013" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для отправителя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320014" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для получателя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Сервис заблокирован для отправителя перевода" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Сервис заблокирован для получателя перевода" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PTP_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="SMSPtPSyntaxError">
    <condition>
      <test item="${Recipient}" matches="^_PTP_SERVICE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Sender" value="_PTP_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Создайте запрос в формате *112*номер телефона получателя*сумма# и нажмите клавишу вызова, дождитесь ответа, отправьте код" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- ****SPONSOR BEGIN**** -->
  <template procedureName="SMSSponsorRequest">
    <condition>
      <test item="${Recipient}" matches="^_SPONSOR_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\+?[0-9]{10,11}\s(d|n|m|д|н|м|1|2|3)\s[1-9]{1}[0-9]*\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="sponsorrequest" action="5">
            <Attribute name="receiver" value="#{replace('${token0}','.*(\d{10})','7$1')}" />
            <Attribute name="amount" value="#{normalize-space('${token2}')}" />
            <Attribute name="period" value="1" />
            <Attribute name="metric" value="@{switch(${token1}|-1,d|DAY,д|DAY,1|DAY,n|WEEK,н|WEEK,2|WEEK,m|MONTH,м|MONTH,3|MONTH)}" />
            <Attribute name="operation" value="1" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при регистрации заявки на регулярный перевод средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Отправьте СМС ${code} на короткий номер _SPONSOR_SERVICE_NUMBER для регулярного пополнения баланса абонента ${receiver} на сумму #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')} с периодом @{switch(${metric}|-1,DAY|день,WEEK|неделя,MONTH|месяц)}" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга по данному тарифному плану недоступна" />
      <!--<set item="Content" condition="//Item/@dbresult=320701" value="Максимально допустимая для перевода сумма составляет #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')}, создайте запрос снова в формате: [Nтел] [период(d,n,m)] [сумма(в валюте счета)]" />-->
      <set item="Content" condition="//Item/@dbresult=320701" value="Сумма больше доступной. Создайте запрос снова в формате: [Nтел] [период(d,n,m)] [сумма(в валюте счета)]" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320710" value="Минимально допустимая для перевода сумма составляет 50 руб., создайте запрос снова в формате: [Nтел] [период(d,n,m)] [сумма(в валюте счета)]" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Услуга заблокирована для отправителя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Услуга заблокирована для получателя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Content" condition="//Item/@dbresult=320101" value="Такой же запрос на регулярное пополнение баланса абонента ${receiver} был уже Вами отправлен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SPONSOR_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="SMSSponsorAcceptance">
    <condition>
      <test item="${Recipient}" matches="^_SPONSOR_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*[0-9]{4}\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="sponsoracceptance" action="5">
            <Attribute name="code" value="#{normalize-space('${content}')}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при регистрации заявки на регулярный перевод средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Ваша заявка на перевод #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е')} абоненту ${receiver} зарегистрирована" />
      <set item="Content" conditionEx="#{//Item/@dbresult=0 and '${operation}'='2'}" value="Ваша заявка на удаление получателя ${receiver} зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга по данному тарифному плану недоступна" />
      <!--<set item="Content" condition="//Item/@dbresult=320701" value="Максимально допустимая для перевода сумма составляет #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')}, создайте запрос снова в формате: [Nтел] [период(d,n,m)] [сумма(в валюте счета)]" />-->
      <set item="Content" condition="//Item/@dbresult=320701" value="Сумма больше доступной. Создайте запрос снова в формате: [Nтел] [период(d,n,m)] [сумма(в валюте счета)]" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320710" value="Минимально допустимая для перевода сумма составляет 50 руб., создайте запрос снова в формате: [Nтел] [период(d,n,m)] [сумма(в валюте счета)]" />
      <set item="Content" condition="//Item/@dbresult=320666" value="Введен неверный код. Для подтверждения отправьте СМС на номер _SPONSOR_SERVICE_NUMBER, указав верный код" />
      <set item="Content" condition="//Item/@dbresult=320999" value="Истек период действия кода подтверждения. Создайте новый запрос" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Услуга заблокирована для отправителя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Услуга заблокирована для получателя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SPONSOR_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="SMSSponsorDelReceiver">
    <condition>
      <test item="${Recipient}" matches="^_SPONSOR_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\+?[0-9]{10,11}\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="sponsorrequest" action="5">
            <Attribute name="receiver" value="7#{normalize-space('${content}')}" />
            <Attribute name="amount" value="0" />
            <Attribute name="period" value="1" />
            <Attribute name="metric" value="DAY" />
            <Attribute name="operation" value="2" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении получателя" />
      <set item="Content" condition="//Item/@dbresult=0" value="Отправьте СМС ${code} на короткий номер _SPONSOR_SERVICE_NUMBER для удаления получателя ${receiver}" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Абонента ${receiver} нет в списке получателей" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SPONSOR_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="SMSSponsorSyntaxError">
    <condition>
      <test item="${Recipient}" matches="^_SPONSOR_SERVICE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Sender" value="_SPONSOR_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Создайте запрос снова  в формате: [Nтел] [период(d,n,m)] [сумма(в валюте счета)]" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- ****SPONSOR END**** -->
  <template procedureName="TariffPlan_Red" sessionStorage="Memory" sessionLifetime="120">
    <condition>
      <test item="${Recipient}" matches="^8555$" />
      <test item="${Content}" matches="^\s*(\+7|8|7){0,1}[0-9]{10}\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="7#{substring(normalize-space('${content}'),string-length(normalize-space('${content}'))-9)}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
        @{store(sSender,${Sender})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Recipient" value="${sSender}" />
      <set item="Content" value="Сервис для Вас недоступен" />
      <set item="Content" condition="//Item/@dbresult=0" value="#{if(document('tp_red.xml')/root/tps/tp/@id=${tariffplan}, concat('Это абонент ',document('tp_red.xml')/root/tps/tp[@id=${tariffplan}]/@name,' - ',document('tp_red.xml')/root/regions/region[@id=${regioncode}]/@name), 'Это не абонент RED')}" />
      <set item="Content" condition="//Item/@dbresult=320341" value="Это не абонент RED" />
      <set item="Content" condition="//Item/@dbresult=330000" value="Это не абонент RED" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="TariffPlan_Red_Error">
    <condition>
      <test item="${Recipient}" matches="^8555$" />
    </condition>
    <receiveTemplate>
      <Message id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Sender" value="8555" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Создайте запрос в формате:  791...." />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!--  templates for MTS-INFO -->
  <template procedureName="MTSINFO_Balance">
    <condition>
      <test item="${Recipient}" matches="^088011$" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="#{if(string-length('${Sender}')=11,${Sender},substring('${Sender}',string-length('${Sender}')-10,11))}" subject="balance">
          <Attribute name="requestcountertype" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate condition="//Item/@dbresult=666">
      <set item="Content" value="#{/Message/Item/Attribute[@name='str_cboss']/@value}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="088011" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен" />
      <set item="Content" condition="//Item/@dbresult=0" value="#{if(${balanceintpartdotpart}&gt;=0,'Ваш баланс:','Ваша задолженность:')}#{/Message/Item/Attribute[@name='balanceintpartdotpart']/@value div 100}руб." />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${iscredit}'='1'}" value="Ваш кредитный баланс:#{${balanceintpartdotpart} div 100} руб.; кредитный лимит: #{${creditlimitintpartdotpart}  div 100}руб." />
      <set item="Content" conditionEx="#{${dbresult}=0 and count(/Message/Item/accumulators/accumulator)&gt;=1}" value="${Content}. #{/Message/Item/accumulators/@sms}" />
      <set item="Content" condition="//Item/@dbresult=320343" value="Данная услуга не предоставляется" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="088011" />
      <set item="Recipient" value="${customer}" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
  </template>
  <template procedureName="MTSINFO_Payment">
    <condition>
      <test item="${Recipient}" matches="^088012$" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="#{if(string-length('${Sender}')=11,${Sender},substring('${Sender}',string-length('${Sender}')-10,11))}" subject="payments">
          <Attribute name="index" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate condition="//Item/@dbresult=666">
      <set item="Content" value="#{/Message/Item/Attribute[@name='str_cboss']/@value}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="088012" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="За последние 6 месяцев платежи не поступали." />
      <set item="Content" condition="//Item/@dbresult=0" value="Платеж на сумму #{/Message/Item/Attribute[@name='intpartfracpart']/@value div 100} руб. поступил ${day}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="088012" />
      <set item="Recipient" value="${customer}" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
  </template>
  <template procedureName="MTSINFO_ExchangeRate">
    <condition>
      <test item="${Recipient}" matches="^(0880313)|(088015)$" />
    </condition>
    <receiveTemplate>
      <Message type="retrieveinfo" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="#{if(string-length('${Sender}')=11,${Sender},substring('${Sender}',string-length('${Sender}')-10,11))}" subject="currencyrate" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Курс валюты не доступен" />
      <set item="Content" condition="//Item/@dbresult=0" value="Внутренний курс компании МТС на #{now()} - #{/Message/Item/Attribute[@name='rateintpartdotpart']/@value div 100} руб. за 1 у.е." />
      <set item="Sender" value="088015" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
  </template>
  <!--  end templates for MTS-INFO -->
  <!--  TEMPLATES FOR FAVOURITE NUMBERS -->
  <template procedureName="SMSFavNumberUpd">
    <condition>
      <test item="${Recipient}" matches="^1777$" />
      <test item="${Content}" matches="^((FN)|(fn)|(Fn)|(fN)|(лн)|(ЛН)|(Лн)|(лН))[0-9]{10}$" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="10">
          <Attribute name="favouritenumber" value="7#{substring('${Content}',string-length('${Content}')-9)}" />
          <Attribute name="index" value="0" />
          <Attribute name="favouritenumbertypeid" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга временно недоступна." />
      <set item="Content" condition="(//Item/@dbresult=320194 or //Item/@dbresult=320142) and //Item/Attribute[@name='count']/@value&gt;0" value="Все любимые номера добавлены ранее" />
      <set item="Content" condition="(//Item/@dbresult=320194 or //Item/@dbresult=320142) and //Item/Attribute[@name='count']/@value=0" value="Услуга Любимый номер не предоставляется для Вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320193" value="Услуга Любимый номер не предоставляется или введен неправильный номер телефона" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление любимого номера +${favouritenumber} зарегистрирована" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="1777" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMSFavNumberDel">
    <condition>
      <test item="${Recipient}" matches="^1777$" />
      <test item="${Content}" matches="^((DN)|(dn)|(Dn)|(dN))[0-9]{10}$" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="11">
          <Attribute name="favouritenumber" value="7#{substring('${Content}',string-length('${Content}')-9)}" />
          <Attribute name="index" value="0" />
          <Attribute name="favouritenumbertypeid" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга временно недоступна." />
      <set item="Content" condition="//Item/@dbresult=320193" value="Введен неправильный номер телефона, повторите запрос" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление любимого  номера +${favouritenumber} зарегистрирована" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="1777" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMSFavNumberOtherRegionUpd">
    <condition>
      <test item="${Recipient}" matches="^1777$" />
      <test item="${Content}" matches="^\s*[FfЛл][NnНн][OoОо][RrРр][0-9]{10}\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="10">
          <Attribute name="favouritenumber" value="7#{substring(normalize-space('${Content}'),string-length(normalize-space('${Content}'))-9)}" />
          <Attribute name="index" value="0" />
          <Attribute name="favouritenumbertypeid" value="3" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга временно недоступна." />
      <set item="Content" condition="(//Item/@dbresult=320194 or //Item/@dbresult=320142) and //Item/Attribute[@name='count']/@value&gt;0" value="Все любимые номера добавлены ранее" />
      <set item="Content" condition="(//Item/@dbresult=320194 or //Item/@dbresult=320142) and //Item/Attribute[@name='count']/@value=0" value="Услуга Любимый номер не предоставляется для Вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320193" value="Услуга Любимый номер не предоставляется или введен неправильный номер телефона" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление любимого номера +${favouritenumber} зарегистрирована" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="1777" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMSFavNumberOtherRegionDel">
    <condition>
      <test item="${Recipient}" matches="^1777$" />
      <test item="${Content}" matches="^\s*[DdДд][NnНн][OoОо][RrРр][0-9]{10}\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="11">
          <Attribute name="favouritenumber" value="7#{substring(normalize-space('${Content}'),string-length(normalize-space('${Content}'))-9)}" />
          <Attribute name="index" value="0" />
          <Attribute name="favouritenumbertypeid" value="3" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга временно недоступна." />
      <set item="Content" condition="//Item/@dbresult=320193" value="Введен неправильный номер телефона, повторите запрос" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление любимого  номера +${favouritenumber} зарегистрирована" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="1777" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMSFavNumberOtherRegionList">
    <condition>
      <test item="${Recipient}" matches="^1777$" />
      <test item="${Content}" matches="^\s*[BbБб][NnНн][OoОо][RrРр]\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="8">
          <Attribute name="favouritenumber" value="" />
          <Attribute name="index" value="0" />
          <Attribute name="favouritenumbertypeid" value="3" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга временно недоступна." />
      <set item="Content" condition="//Item/@dbresult=0" value="Любимый номер другого региона: +${favouritenumber}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="1777" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMSFavNumberWrongFormat">
    <condition>
      <test item="${Recipient}" matches="^1777$" />
    </condition>
    <receiveTemplate>
      <Message>
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Неверный формат.Правильный формат FNYYYXXXXXXX для добавления, DNYYYXXXXXXX для удаления.Длинна номера 10 символов! Справки по телефону 0890." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="1777" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!--  END TEMPLATES FOR FAVOURITE NUMBERS -->
  <template procedureName="SMSCreditServiceControl" sessionStorage="Memory" sessionLifetime="120" onClean="Notif_onClean">
    <condition>
      <test item="${Recipient}" matches="^_CREDIT_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*(0|1)\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="@{newGuid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${Sender}">
          <Service id="411009" action="@{switch(#{normalize-space('${Content}')}|-1,1|2,0|3)}" class="0" />
        </Item>
        @{store(sAction,#{normalize-space('${Content}')})}
        @{store(sService,${Recipient})}
        @{store(sCustomer,${Sender})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate conditionEx="#{'${sAction}'='1'}">
      <set item="Content" value="Услуга не подключена. Подробности по номеру 05902" />
      <set item="Content" condition="//Item/@dbresult=0" value="С баланса вашего лицевого счета списана плата за подключение услуги. Кредитная линия по Вашему лицевому счету будет доступна через 24 часа" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги Кредит невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга не подключена. Подробности по номеру 05902" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга активна. Повторное подключение услуги не требуется" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Услуга не подключена. Подробности по номеру 05902" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_CREDIT_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${sAction}'='0'}">
      <set item="Content" value="Ошибка при удалении услуги Кредит" />
      <set item="Content" condition="//Item/@dbresult=0" value="Услуга отключена. Кредитная линия по Вашему лицевому счету будет закрыта через 24 часа" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги Кредит невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга Кредит не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Услуга Кредит была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_CREDIT_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="${sAction}Сервис временно не доступен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_CREDIT_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="SMSCreditServiceControlWrongFormat">
    <condition>
      <test item="${Recipient}" matches="^_CREDIT_SERVICE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message>
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Для добавления услуги Кредит отправьте СМС 1 на номер _CREDIT_SERVICE_NUMBER, для удаления СМС 0 на номер _CREDIT_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_CREDIT_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Service_activate_CRMComp">
    <condition>
      <test item="${Recipient}" matches="^627[5]$" />
      <test item="${Content}" matches="^1$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{setSessionId(${Recipient}${Sender}__CONTENT)}">
        <Item customer="${Sender}" smenum="${Recipient}">
          <Service id="_MACR_CRMACT_SMSNUM_TO_SERVICE_CODE" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate direction="input">
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Данная услуга не доступна для подключения через СМС" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Oshibka activacii uslugi _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE. Poprobuite pozdnee." />
      <set item="Content" condition="//Item/@dbresult=320203" value="Sushestvuet nezavershennaya zajavka dlya uslugi _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Usluga _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE otsutstvuet na tarifnom plane" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Usluga _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE usze byla ranee dobavlena" />
      <set item="Content" condition="//Item/@dbresult=320172" value="Dobavlenije uslugi _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE nedostupno." />
      <set item="Content" condition="//Item/@dbresult=320191" value="Na schete nedostatochno denezhnih sredstv." />
      <set item="Content" condition="//Item/@dbresult=0" value="Vasha zajavka na dobavlenije uslugi _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE  postavlena v ochered' na obrabotku." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Recipient" value="${customer}" />
      <set item="Sender" value="${smenum}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Service_deactivate_CRMComp">
    <condition>
      <test item="${Recipient}" matches="^627[5]$" />
      <test item="${Content}" matches="^0$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{setSessionId(${Recipient}${Sender}__CONTENT)}">
        <Item customer="${Sender}" smenum="${Recipient}">
          <Service id="_MACR_CRMACT_SMSNUM_TO_SERVICE_CODE" action="3" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Oshibka activacii uslugi _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE. Poprobuite pozdnee." />
      <set item="Content" condition="//Item/@dbresult=320203" value="Sushestvuet nezavershennaya zajavka dlya uslugi _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Usluga _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE otsutstvuet na tarifnom plane" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Usluga _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE byla udalena ranee" />
      <set item="Content" condition="//Item/@dbresult=320172" value="Udavlenije uslugi _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE nedostupno." />
      <set item="Content" condition="//Item/@dbresult=320191" value="Na schete nedostatochno denezhnih sredstv." />
      <set item="Content" condition="//Item/@dbresult=0" value="Vasha zajavka na udalenie uslugi _MACR_CRMACT_SERVICE_CODE_TO_MESSAGE  postavlena v ochered' na obrabotku." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Recipient" value="${customer}" />
      <set item="Sender" value="${smenum}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="Service_activate_CRMComp_error">
    <condition>
      <test item="${Recipient}" matches="^_627[5]$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{setSessionId(${Recipient}${Sender}__CONTENT)}">
        <Item customer="${Sender}">
          <Service id="" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate direction="input">
      <set item="Content" value="Nepravilnij format soobshenija." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="98801" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <!-- Начало период с 15.07.2008г  по 31.08.2008г Общайся больше  -->
  <template procedureName="Service_Interrogation_CommunicateItIsMore">
    <condition>
      <test item="${Recipient}" matches="^1890$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="smscon" id="${guid}" session_id="@{setSessionId(${Sender})}">
        <Item customer="${Sender}">
          <Service id="FRDAYACCUM" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=320204 or ${dbresult}=320282}">
      <set item="Content" value="Услуга Общайся больше! не предоставляется для вашего тарифного плана" />
      <set item="Sender" value="1890" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${subscription}'='1'}" call="Service_activate_CommunicateItIsMore">
      <set item="Content" value="1" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="1890" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Услуга Общайся больше! не предоставляется для вашего тарифного плана" />
      <set item="Sender" value="1890" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Service_activate_CommunicateItIsMore">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{setSessionId(${Sender})}">
        <Item customer="${Sender}" smenum="${Recipient}">
          <Service id="FRREGAC" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка активации услуги Выходные дни. Попробуйте позднее" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги Общайся больше! зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги Общайся больше! невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга Общайся больше! не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга Общайся больше! была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="1890" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <!-- Окончание период с 15.07.2008г  по 31.08.2008г Общайся больше  -->
  <!-- Начало период с 25.08.2008г  по 01.10.2008г  "24 часа"  -->
  <template procedureName="Service_Interrogation_24hoursOfFfree">
    <condition>
      <test item="${Recipient}" matches="^3355$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="smscon" id="${guid}" session_id="@{setSessionId(${Sender})}">
        <Item customer="${Sender}">
          <Service id="FR24CHAS" action="interrogation" />
        </Item>
        @{store(vToday, #{concat(substring('@{now}',7,4),substring('@{now}',4,2),substring('@{now}',1,2))})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{ '${vToday}' &gt; '20081031'}">
      <set item="Sender" value="3355" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Услуга больше недоступна для подключения " />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{ '${vToday}' &lt; '20080825'}">
      <set item="Sender" value="3355" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Подключение услуги будет доступно с 25.08.2008" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=320204 or ${dbresult}=320282}">
      <set item="Content" value="Услуга 24 часа бесплатных разговоров не предоставляется для вашего тарифного плана" />
      <set item="Sender" value="3355" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${subscription}'='1'}" call="Service_activate_24hoursOfFfree">
      <set item="Content" value="1" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="3355" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Услуга 24 часа бесплатных разговоров не предоставляется для вашего тарифного плана" />
      <set item="Sender" value="3355" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Service_activate_24hoursOfFfree">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{setSessionId(${Sender})}">
        <Item customer="${Sender}" smenum="${Recipient}">
          <Service id="FRREG24" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка активации услуги 24 часа бесплатных разговоров. Попробуйте позднее" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 24 часа бесплатных разговоров зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 24 часа бесплатных разговоров невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 24 часа бесплатных разговоров не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 24 часа бесплатных разговоров была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="3355" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <!-- Окончание период с с 25.08.2008г  по 01.10.2008г  "24 часа"  -->
  <!-- Начало тестировани подключения услуги 1 при включенной услуге 2 -->
  <template procedureName="GPRS_ServiceControl">
    <condition>
      <test item="${Recipient}" matches="^4222$" />
      <test item="${Content}" matches="^112233$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="smscon" id="${guid}" session_id="@{setSessionId(${Sender})}">
        <Item customer="${Sender}">
          <Service id="FRTEMPSLAVA2" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${subscription}'='0'}">
      <set item="Content" value="Для регистрации Скидки в роуминге необходимо наличие Услуги для тестов" />
      <set item="Sender" value="112233" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and ${subscription}=1}" call="Service_activate_MV">
      <set item="Content" value="1" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="112233" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Service_activate_MV">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{setSessionId(${Sender})}">
        <Item customer="${Sender}" smenum="${Recipient}">
          <Service id="FRTEMPSLAVA" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка добавления Скидки в роуминге. Попробуйте позднее" />
      <set item="Content" condition="//Item/@dbresult=0" value="Скидка в роуминге действует с 1 мая по 31 августа" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление Скидки в роуминге невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Скидка в роуминге не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Заявка на Скидку в роуминге была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="112233" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <!-- Окончание естировани подключения услуги 1 при включенной услуге 2  -->
  <template procedureName="CRMComp_Answer4222">
    <condition>
      <test item="${Recipient}" matches="^4222$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${sender}" recipient="${recipient}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Спасибо за участие в опросе МТС! Ваше мнение очень важно для нас!" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="CRMComp_Answer8448">
    <condition>
      <test item="${Recipient}" matches="^8448$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${sender}" recipient="${recipient}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Sender" value="8448" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Спасибо за участие в опросе МТС! Ваше мнение очень важно для нас!" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="CRMCompTAR_A">
    <condition>
      <test item="${Recipient}" matches="^5868$" />
      <test item="${Content}" matches="^616$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="FRTARA" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'CRM_акция_МГиМН_тарифы_А'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'CRM_акция_МГиМН_тарифы_А' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'CRM_акция_МГиМН_тарифы_А' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="CRM_акция_МГиМН_тарифы_А' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="CRM_акция_МГиМН_тарифы_А' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="5868" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="CRMCompTAR_B">
    <condition>
      <test item="${Recipient}" matches="^5868$" />
      <test item="${Content}" matches="^717$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="FRTARB" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'CRM_акция_МГиМН_тарифы_Б'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'CRM_акция_МГиМН_тарифы_Б' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'CRM_акция_МГиМН_тарифы_Б' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="CRM_акция_МГиМН_тарифы_Б' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="CRM_акция_МГиМН_тарифы_Б' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="5868" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="RedZoneActivate">
    <condition>
      <test item="${Recipient}" matches="^1555$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="4095" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'RED Zone'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'RED Zone' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'RED Zone' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'RED Zone' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'RED Zone' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="1555" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="InterAccessActivate1">
    <condition>
      <test item="${Recipient}" matches="^9494$" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and document('md_inter_access_ban.xml')//tps/tp/@ivr='${tariffplan}'}">
      <set item="Sender" value="9494" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Извините, на вашем тарифе услуга не предоставляется, обратитесь в контактный центр" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}" call="InterAccessActivate2">
      <set item="Sender" value="${Customer}" />
      <set item="Recipient" value="9494" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="InterAccessActivate2">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="CB108" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Международный доступ'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Международный доступ' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Международный доступ'" />
      <set item="Content" condition="//Item/@dbresult=320204" value=" Услуга 'Международный доступ' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Международный доступ' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="9494" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="InterAccessDeactivate1">
    <condition>
      <test item="${Recipient}" matches="^9292$" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and document('md_inter_access_ban.xml')//tps/tp/@ivr='${tariffplan}'}">
      <set item="Sender" value="9292" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Извините, на вашем тарифе услуга не предоставляется, обратитесь в контактный центр" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}" call="InterAccessDeactivate2">
      <set item="Sender" value="${Customer}" />
      <set item="Recipient" value="9292" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="InterAccessDeactivate2">
    <condition>
      <test item="${Recipient}" matches="^9292" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" smenum="${Recipient}">
          <Service id="CB108" action="3" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении услуги 'Международный доступ'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги 'Международный доступ' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Международный доступ' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Услуга 'Международный доступ' была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление услуги 'Международный доступ' зарегистрирована" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Recipient" value="${customer}" />
      <set item="Sender" value="${smenum}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="GodBezZabotActivate">
    <condition>
      <test item="${Recipient}" matches="^707$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="FRGBZ" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Год без забот'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Год без забот' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Год без забот' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Год без забот' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Год без забот' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="707" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <!-- Mega Shablon ServiceAction ADD==================================================== -->
  <template procedureName="SMSActionActivate5" sessionStorage="Memory" sessionLifetime="300" onClean="Action_onClean">
    <condition>
      <test item="#{ if(document('SmsCrmComp.xml')/action/service[@source='_TRANSPORT' and (@addtextsms='${Content}' or @addtextsms='allchars*') and @deltextsms!='${Content}' and @deltextsms!='allchars*']/@number=${Recipient},1,0)}" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${Sender}">
          <Service id="#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORADDSRV]/@code}" action="2" class="0" />
        </Item>
        @{store(sNumber,${Recipient})}
        @{store(sServiceCode,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORADDSRV]/@code})}
        @{store(sServiceName,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORADDSRV]/@name})}
        @{store(sId,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORADDSRV]/@id})}
        @{store(vToday, #{concat(substring('@{now}',7,4),substring('@{now}',4,2),substring('@{now}',1,2))})}
        @{store(sDateFrom,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORADDSRV]/@datefrom})}
        @{store(sDateTo,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORADDSRV]/@dateto})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate direction="input" conditionEx="#{ '${vToday}' &gt; '${sDateTo}'}">
      <set item="Sender" value="${sNumber}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Услуга больше недоступна для подключения " />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{ '${vToday}' &lt; '${sDateFrom}'}">
      <set item="Sender" value="${sNumber}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Услуга будет доступна с #{concat(substring('${sDateFrom}',7,2),'.',substring('${sDateFrom}',5,2),'.',substring('${sDateFrom}',1,4))}  " />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="#{document('SmsCrmComp.xml')/action/dbresult[@id='${sId}' and @dbresult='${dbresult}' and @actadd='1']/@name}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='0','Заявка на добавление услуги «${sServiceName}» зарегистрирована','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='320203','Добавление услуги «${sServiceName}» невозможно пока не завершится предыдущая операция','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='320204','Услуга «${sServiceName}» не предоставляется для Вашего тарифного плана','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='320205','Услуга «${sServiceName}» была добавлена ранее','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='320191','Недостаточно средств на балансе для проведения операции','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='320194','Услуга «${sServiceName}» Вам недоступна','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='','Ошибка при добавлении услуги «${sServiceName}»','${content}')}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="${sNumber}" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <!-- Test ServiceAction DEL==================================================== -->
  <template procedureName="SMSActionDeactivate5" sessionStorage="Memory" sessionLifetime="300" onClean="Action_onClean">
    <condition>
      <test item="#{ if(document('SmsCrmComp.xml')/action/service[@source='_TRANSPORT' and ((@deltextsms='${Content}')  or (@deltextsms='allchars*')) and @deltextsms!='none*' and @addtextsms!='${Content}']/@number=${Recipient},1,0)}" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${Sender}">
          <Service id="#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORDELSRV]/@code}" action="3" class="0" />
        </Item>
        @{store(sNumber,${Recipient})}
        @{store(sServiceCode,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORDELSRV]/@code})}
        @{store(sServiceName,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORDELSRV]/@name})}
        @{store(sId,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORDELSRV]/@id})}
        @{store(vToday, #{concat(substring('@{now}',7,4),substring('@{now}',4,2),substring('@{now}',1,2))})}
        @{store(sDateFrom,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORDELSRV]/@datefrom})}
        @{store(sDateTo,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORDELSRV]/@dateto})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate direction="input" conditionEx="#{ '${vToday}' &gt; '${sDateTo}'}">
      <set item="Sender" value="${sNumber}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Услуга больше недоступна для отключения " />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{ '${vToday}' &lt; '${sDateFrom}' }">
      <set item="Sender" value="${sNumber}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Отключение услуги будет доступно с #{concat(substring('${sDateFrom}',7,2),'.',substring('${sDateFrom}',5,2),'.',substring('${sDateFrom}',1,4))}  " />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="#{document('SmsCrmComp.xml')/action/dbresult[@id='${sId}' and @dbresult='${dbresult}'  and @actdel='1']/@name}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='0','Заявка на удаление услуги «${sServiceName}» зарегистрирована','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='320203','Удаление услуги «${sServiceName}» невозможно пока не завершится предыдущая операция','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='320204','Услуга «${sServiceName}»  не предоставляется для Вашего тарифного плана','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='320206','Услуга «${sServiceName}» была удалена ранее','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='320191','Недостаточно средств на балансе для проведения операции','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='',if ('${dbresult}'='320194','Услуга «${sServiceName}» Вам недоступна','${content}'),'${content}')}" />
      <set item="Content" value="#{if('${content}'='','Ошибка при удалении услуги «${sServiceName}»','${content}')}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="${sNumber}" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <!-- Test ServiceAction Wrong==================================================== -->
  <template procedureName="SMSActionWrong5" sessionStorage="Memory" sessionLifetime="120" onClean="Action_onClean">
    <condition>
      <test item="#{ if(document('SmsCrmComp.xml')/action/service[@source='_TRANSPORT']/@number=${Recipient},1,0)}" matches="1" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${sender}" recipient="${recipient}" />
        @{store(sNumber,${Recipient})}
        @{store(sServiceCode,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORWRONGSRV]/@code})}
        @{store(sId,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORWRONGSRV]/@id})}
        @{store(vToday, #{concat(substring('@{now}',7,4),substring('@{now}',4,2),substring('@{now}',1,2))})}
        @{store(sDateFrom,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORWRONGSRV]/@datefrom})}
        @{store(sDateTo,#{document('SmsCrmComp.xml')/action/service[_FINDMASKFORWRONGSRV]/@dateto})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{ '${vToday}' &gt; '${sDateTo}'}">
      <set item="Sender" value="${sNumber}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Услуга больше не предоставляется." />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{ '${vToday}' &lt; '${sDateFrom}' }">
      <set item="Sender" value="${sNumber}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Услуга будет доступна с #{concat(substring('${sDateFrom}',7,2),'.',substring('${sDateFrom}',5,2),'.',substring('${sDateFrom}',1,4))}  " />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate direction="input">
      <set item="Sender" value="${sNumber}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="#{document('SmsCrmComp.xml')/action/service[@id='${sId}' and @code='${sServiceCode}' and @number='${sNumber}']/@wrongtext}  " />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <!-- END of MEGASHABLON   -->
  <!-- Begin Packages -->
  <template procedureName="SMSGetServicePackages">
    <condition>
      <test item="${Recipient}" matches="^_PKG_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^LIST$" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${sender}" subject="packages" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка обработки запроса" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${pkgnamelist}'!=''}" value="Ваши пакеты услуг: ${pkgnamelist}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${pkgnamelist}'=''}" value="У Вас нет подключенных пакетов услуг" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PKG_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMSAddServicePackage">
    <condition>
      <test item="${Recipient}" matches="^_PKG_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*([Aa][Dd][Dd]) \S+$" />
      <test item="#{if(document('servicepackage.xml')//packages/package/@smscode='${token1}',1,0)}" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${sender}">
          <Service id="#{document('servicepackage.xml')/packages/package[@smscode='${token1}']/@crmcode}" action="9" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка добавления пакета" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Пакет услуг успешно подключен" />
      <set item="Content" conditionEx="#{${dbresult}=320154}" value="Невозможно подключить пакет.Есть взаимоисключающие пакеты." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PKG_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="SMSRemoveServicePackage">
    <condition>
      <test item="${Recipient}" matches="^_PKG_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*([Dd][Ee][Ll]) \S+$" />
      <test item="#{if(document('servicepackage.xml')/packages/package/@smscode='${token1}',1,0)}" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${sender}">
          <Service id="#{document('servicepackage.xml')/packages/package[@smscode='${token1}']/@crmcode}" action="10" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка удаления пакета" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Пакет услуг успешно удален" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PKG_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="SMSServicePackageSyntaxError">
    <condition>
      <test item="${Recipient}" matches="^_PKG_SERVICE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Ошибка в формате" />
      <set item="Sender" value="_PKG_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- End Packages -->
  <!-- Begin Любимый номер/направление  -->
  <template procedureName="SMSFavouriteNumberOrDirectionManage" contentSeparator="0123456789" sessionStorage="Memory" sessionLifetime="120" onClean="SMSFavouriteNumberOrDirection_onClean">
    <condition>
      <test item="${Recipient}" matches="^_FND_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\D+[0-9]+$" />
      <test item="#{if(document('XML\fndtypes.xml')/fndtypes/fndtype/@smscode='${token0}',1,0)}" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="smscon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        @{store(sAction,#{document('XML\fndtypes.xml')/fndtypes/fndtype[@smscode='${token0}']/@action})}
        @{store(sFnd,#{substring-after('${content}','${token0}')})}
        @{store(sCustomer,${sender})}
        <Item customer="${sender}" action="${sAction}">
          <Attribute name="favouritenumber" value="#{${sFnd}}" />
          <Attribute name="favouritenumbertypeid" value="#{document('XML\fndtypes.xml')/fndtypes/fndtype[@smscode='${token0}']/@id}" />
          <Attribute name="index" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга Любимый номер/направление не предоставляется для Вашего тарифного плана" />
      <set item="Content" conditionEx="#{${dbresult}=320194 or ${dbresult}=320142}" value="Все любимые номера/направления данного типа добавлены ранее" />
      <set item="Content" conditionEx="#{${dbresult}=320193}" value="Услуга Любимый номер/направление не предоставляется или введен неправильный номер телефона/направление" />
      <set item="Content" conditionEx="#{${dbresult}=320997}" value="Уже добавлен как любимое направление" />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Недостаточно средств на лицевом счете для выполнения операции" />
      <set item="Content" conditionEx="#{${dbresult}=-1}" value="Данный запрос не может быть выполнен" />
      <set item="Content" conditionEx="#{${dbresult}=0 and ${sAction}=10}" value="Заявка на добавление ЛНиН ${sFnd} зарегистрирована" />
      <set item="Content" conditionEx="#{${dbresult}=0 and ${sAction}=11}" value="Заявка на удаление ЛНиН ${sFnd} зарегистрирована" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_FND_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <!--*******SMS*****************************************************************************************************************************************************************************************************************************-->
  <template procedureName="SMSFavouriteNumberOrDirectionBrowse" sessionStorage="Memory" sessionLifetime="120" onClean="SMSFavouriteNumberOrDirection_onClean">
    <condition>
      <test item="${Recipient}" matches="^_FND_SERVICE_NUMBER$" />
      <test item="#{if(document('XML\fndtypes.xml')/fndtypes/fndtype[@action='8']/@smscode='${content}',1,0)}" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="smscon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        @{store(sCustomer,${sender})}
        <Item customer="${sender}" action="8">
          <Attribute name="favouritenumber" value="" />
          <Attribute name="favouritenumbertypeid" value="#{document('XML\fndtypes.xml')/fndtypes/fndtype[@smscode='${content}' and @action='8']/@id}" />
          <Attribute name="index" value="" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга Любимый номер/направление не предоставляется для Вашего тарифного плана" />
      <set item="Content" conditionEx="#{${dbresult}=320193}" value="Услуга Любимый номер/направление не предоставляется" />
      <set item="Content" conditionEx="#{${dbresult}=-1}" value="Данный запрос не может быть выполнен" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Ваши любимые номера/направления: #{/Message/Item/@fndlist}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${fndlist}'=''}" value="У Вас нет любимых номеров/направлений" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_FND_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <!--*******SMS*****************************************************************************************************************************************************************************************************************************-->
  <template procedureName="SMSFavouriteNumberOrDirectionSyntaxError">
    <condition>
      <test item="${Recipient}" matches="^_FND_SERVICE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Ошибка в формате" />
      <set item="Sender" value="_FND_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!--*******SMS*****************************************************************************************************************************************************************************************************************************-->
  <template procedureName="SMSFavouriteNumberOrDirection_onClean" sessionStorage="Memory">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже" />
      <set item="Sender" value="_FND_SERVICE_NUMBER" />
      <set item="Recipient" value="${sCustomer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- End Любимый номер/направление  -->
  <template procedureName="SMSIncomingContent">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${sender}" recipient="${recipient}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Sender" value="${recipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="Ошибка в формате запроса" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- END of INCOMING SMS ======================================================================= -->
  <!-- Test ServiceAction OnClean==================================================== -->
  <template procedureName="Action_onClean" sessionStorage="Memory">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже" />
      <set item="Sender" value="${recipient}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="DeliveryRequest">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <retry delay="5" attempts="1" />
    <deliveryTemplate conditionEx="#{document('blacklist.xml')//list/item='${Customer}'}" call="DropDelivery">
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="111" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{(contains('#{//Content/text()}','рубл.'))}" dropReply="true">
      <set item="Content" value="#{//Content/text()}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{(number(substring-after(substring-before('@{now}',':'),' '))&gt;=20 or 3&gt;number(substring-after(substring-before('@{now}',':'),' '))) and (contains('#{//Content/text()}','избежание')  or contains('#{//Content/text()}','Перевод успешен') or contains('#{//Content/text()}','Иначе') or contains('#{//Content/text()}','израсходован') or contains('#{//Content/text()}','израсходовали') or contains('#{//Content/text()}','платеж по банковской карте') or contains('#{//Content/text()}','лицевому счету') or contains('#{//Content/text()}','лицевого счета') or contains('#{//Content/text()}','оплатить счет')     )}">
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="111" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="ValidityPeriod" value="000000160000000R" />
      <set item="ScheduleDeliveryTime" value="000000130000000R" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{(number(substring-after(substring-before('@{now}',':'),' '))&gt;=3 and 9&gt;number(substring-after(substring-before('@{now}',':'),' '))) and (contains('#{//Content/text()}','избежание') or contains('#{//Content/text()}','Перевод успешен') or contains('#{//Content/text()}','Иначе') or contains('#{//Content/text()}','израсходован') or contains('#{//Content/text()}','израсходовали') or contains('#{//Content/text()}','платеж по банковской карте') or contains('#{//Content/text()}','лицевому счету')  or contains('#{//Content/text()}','лицевого счета') or contains('#{//Content/text()}','оплатить счет')     )}">
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="111" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="ValidityPeriod" value="000000090000000R" />
      <set item="ScheduleDeliveryTime" value="000000130000000R" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{(contains('#{//Content/text()}','избежание') or contains('#{//Content/text()}','Перевод успешен') or contains('#{//Content/text()}','Иначе') or contains('#{//Content/text()}','израсходован') or contains('#{//Content/text()}','израсходовали') or contains('#{//Content/text()}','платеж по банковской карте') or contains('#{//Content/text()}','лицевого счета') or contains('#{//Content/text()}','лицевому счету')   or contains('#{//Content/text()}','оплатить счет')      )}">
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="111" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="ValidityPeriod" value="000000030000000R" />
      <set item="ScheduleDeliveryTime" value="000000130000000R" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="#{if(count(/Message/Package/Item/@sender)&gt;0,/Message/Package/Item/@sender,'111')}" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="#{if(count(/Message/Package/Item/Content/@charset)&gt;0,/Message/Package/Item/Content/@charset,'unicodefffe')}" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
  </template>
  <template procedureName="DropDelivery">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message id="${guid}" session_id="@{newGuid}">
        <Item customer="${Recipient}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" dropReply="true" />
  </template>
  <template procedureName="DeliveryRequestISSA">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <retry delay="5" attempts="0" />
    <!--  платные смс из ИССА -->
    <deliveryTemplate conditionEx="#{ '${sender}' != '' }">
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="#{if(count(/Message/Package/Item/@sender)&gt;0,/Message/Package/Item/@sender,'111')}" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="#{if(count(/Message/Package/Item/Content/@charset)&gt;0,/Message/Package/Item/Content/@charset,@{GetEncoding(#{translate(//Content/text(),',','.')},'unicodefffe','ascii')})}" />
      <set item="ValidityPeriod" value="#{if((substring('${scheduleTime}',1,2)='00' or '${scheduleTime}'='${validityPeriod}'),'','${validityPeriod}')}" />
      <set item="ScheduleDeliveryTime" value="#{if((substring('${scheduleTime}',1,2)='00' or '${scheduleTime}'='${validityPeriod}'),'','${scheduleTime}')}" />
    </deliveryTemplate>
    <!--  Оповещение по смс из ИССА -->
    <deliveryTemplate>
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="111" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="#{if(count(/Message/Package/Item/Content/@charset)&gt;0,/Message/Package/Item/Content/@charset,'unicodefffe')}" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
  </template>
  <template procedureName="DeliveryRequestSendSMS">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <retry delay="5" attempts="0" />
    <deliveryTemplate>
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="RegisteredDelivery" value="false" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="DeliveryRequest_09-20">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <retry delay="5" attempts="1" />
    <deliveryTemplate conditionEx="#{(number(substring-after(substring-before('@{now}',':'),' '))&gt;=20 or 3&gt;number(substring-after(substring-before('@{now}',':'),' ')))}">
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="ascii" />
      <set item="ValidityPeriod" value="000000160000000R" />
      <set item="ScheduleDeliveryTime" value="000000130000000R" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{(number(substring-after(substring-before('@{now}',':'),' '))&gt;=3 and 9&gt;number(substring-after(substring-before('@{now}',':'),' ')))}">
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="ascii" />
      <set item="ValidityPeriod" value="000000090000000R" />
      <set item="ScheduleDeliveryTime" value="000000060000000R" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="ascii" />
      <set item="ValidityPeriod" value="000000030000000R" />
      <set item="ScheduleDeliveryTime" value="" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
  </template>
  <template procedureName="FilterCheckBlock">
    <condition>
      <test item="${Recipient}" matches="^_SMS_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^[0-9]+\susd$" />
    </condition>
    <receiveTemplate>
      <Message customer="${Sender}" />
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Обещанные платежи принимаются только в рублях." />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="CheckBlock">
    <condition>
      <test item="${Recipient}" matches="^_SMS_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^[0-9]+\srub$" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="ussd" id="@{newGuid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="1" />
        </Item>
        @{store(sContent,${Content})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(document('op_ban.xml')//tps/tp[@ivr='${tariffplan}'] )&gt;0  }">
      <set item="Content" value="Услуга не предоставляется на вашем тарифном плане" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}" call="GuarantedPaymentRUR">
      <set item="Sender" value="${Customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Content" value="${sContent}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже." />
      <set item="Content" conditionEx="#{${dbresult}=320341}" value="Сообщение, согласованное с МТС о невалидном номере телефона." />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ErrorCheckBlock">
    <condition>
      <test item="${Recipient}" matches="^_SMS_SERVICE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message customer="${Sender}" />
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Сообщение, согласованное с МТС, о неверном формате сообщения." />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="GuarantedPaymentRUR">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${Sender}">
          <Service id="guaranteedpayment" action="6" />
          @{store(sContent,${Content})}
          @{store(sIsSms,1)}
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate conditionEx="#{'${sIsSms}'='1' and ${dbresult}=0}" call="GuarantedPaymentRUR2">
      <set item="Content" value="${sContent}" />
      <set item="Sender" value="${Customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${maximumrur}'!=''}" value="Разрешен обещанный платеж в размере #{${maximumrur} div 100} руб." />
      <set item="Content" conditionEx="#{${dbresult}=320341}" value="Номер Вашего телефона не зарегистрирован" />
      <set item="Content" conditionEx="#{${dbresult}=320347}" value="Услуга не может быть предоставлена, потому что номер заблокирован" />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Услуга не может быть предоставлена, недостаточно средств" />
      <set item="Content" conditionEx="#{${dbresult}=320203}" value="Услуга не может быть предоставлена, предыдущий обещанный платеж не погашен или в процессе регистрации" />
      <set item="Content" conditionEx="#{${dbresult}=320111}" value="Указывайте сумму не превышающую #{${maximumrur} div 100} руб." />
      <set item="Content" conditionEx="#{${dbresult}=320121}" value="Обещанный платеж не может быть предоставлен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="GuarantedPaymentRUR2">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="guaranteedpayment" action="7">
            <Attribute name="amount" value="#{${token0} * 100}" />
            <Attribute name="currency" value="810" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Обещанный платеж на сумму #{${amount} div 100} руб. принят" />
      <set item="Content" conditionEx="#{${dbresult}=320203}" value="Услуга не может быть предоставлена, предыдущий обещанный платеж не погашен или в процессе регистрации" />
      <set item="Content" conditionEx="#{${dbresult}=320347}" value="Услуга не может быть предоставлена, потому что номер заблокирован" />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Услуга не может быть предоставлена, недостаточно средств" />
      <set item="Content" conditionEx="#{${dbresult}=320111}" value="Превышена максимальная сумма обещанного платежа" />
      <set item="Content" conditionEx="#{${dbresult}=320121}" value="Обещанный платеж не может быть предоставлен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="PaymentRetrieve">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Latest payment is not avaliable  (error_code=${dbresult})" />
      <!-- better error message -->
      <set item="Content" condition="//Item/@dbresult=0" value="Платеж на сумму #{/Message/Item/Attribute[@name='intpartfracpart']/@value div 100} руб. поступил ${day}" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ExchangeRate">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Exchange rate list is not avaliable  (error_code=${dbresult})" />
      <set item="Content" condition="//Item/@dbresult=0" value="Внутренний курс компании МТС #{/Message/Item/Attribute[@name='rateintpartdotpart']/@value div 100} руб. за 1 у.е" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="GPRS_configure">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Усулуга GPRS не предоставляется для Вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=0" value="Спасибо! Отправка настроек завершена. Приглашаем посетить портал wap.mts.ru. Для использования WAP и MMS необходима услуга GPRS. Справка: 0890." />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  была добавлена ранее.Настройки 0876 или СМС на 1234" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Service_deactivate">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate conditionEx="#{'${service_id}'='411009'}">
      <set item="Content" value="Ошибка при удалении услуги Кредит" />
      <set item="Content" condition="//Item/@dbresult=0" value="Услуга отключена. Кредитная линия по Вашему лицевому счету будет закрыта через 24 часа" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги Кредит невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга Кредит не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Услуга Кредит была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_CREDIT_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  не предоставляется для Вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=320194" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' Вам недоступна." />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ISSA_Password">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка поиска абонента" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="ISSA_Password2">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка установки пароля" />
      <set item="Content" condition="//Item/@dbresult=320023" value="Формат пароля: 4-7 цифр. Пароль задан неправильно, повторите запрос" />
      <set item="Content" condition="//Item/@dbresult=0" value="Новый пароль установлен" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="Detailed_balance">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320610" value="Детализированный отчет по балансу был заказан в течение дня" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Detailed_bill">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Bill">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${token0}">
          <Service id="otbillviafax" action="4">
            <Attribute name="faxnumber" value="" />
            <Attribute name="start" value="#{substring('@{now}',1,10)}" />
            <Attribute name="end" value="#{substring('@{now}',1,10)}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Услуга не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="Prepayment_Bill">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${token0}">
          <Service id="otprepaymentbill" action="4">
            <Attribute name="faxnumber" value="" />
            <Attribute name="amountintpartdotpart" value="100" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Услуга не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="Fax_update">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${token0}">
          <Attribute name="faxnumber" value="7${token2}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="По указанному Вами номеру факса доставка невозможна" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="FavNumber_Upd">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${token0}" action="10">
          <Attribute name="favouritenumber" value="7#{substring('${token2}',string-length('${token2}')-9)}" />
          <Attribute name="index" value="1" />
          <Attribute name="favouritenumbertypeid" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга Любимый номер не предоставляется для Вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320194 or //Item/@dbresult=320142" value="Все любимые номера добавлены ранее" />
      <set item="Content" condition="//Item/@dbresult=320193" value="Услуга Любимый номер не предоставляется или введен неправильный номер телефона" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление любимого номера +${favouritenumber} зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="FavNumber_Del">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${token0}" action="11">
          <Attribute name="favouritenumber" value="7#{substring('${token2}',string-length('${token2}')-9)}" />
          <Attribute name="index" value="1" />
          <Attribute name="favouritenumbertypeid" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга Любимый номер не предоставляется для Вашего ТП" />
      <set item="Content" condition="//Item/@dbresult=320193" value="Введен неправильный номер телефона, повторите запрос" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление любимого  номера +${favouritenumber} зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="FavNumber_Del_empty">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${token0}" action="11">
          <Attribute name="favouritenumber" value="" />
          <Attribute name="index" value="1" />
          <Attribute name="favouritenumbertypeid" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга Любимый номер не предоставляется для Вашего ТП" />
      <set item="Content" condition="//Item/@dbresult=320193" value="Введен неправильный номер телефона, повторите запрос" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление любимого  номера +${favouritenumber} зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="FavNumbers_browse">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{//Item/@dbresult!=0}">
      <set item="Content" value="Услуга 'Любимый номер' не предоставляется для вашего тарифного плана" />
      <set item="Content" conditionEx="#{'${language_id}'='2'}" value="Service 'Favourite number' isn't accessible for your tariff plan" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{//Item/@dbresult=0 and //Item/Attribute[@name='count']/@value=0}">
      <set item="Content" condition="//Attribute[@name='favouritenumber']/@value=''" value="У вас нет любимых номеров" />
      <set item="Content" conditionEx="#{'${language_id}'='2'}" value="You have no favourite numbers" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{//Item/@dbresult=0 and //Item/Attribute[@name='count']/@value=1}">
      <set item="Content" value="Ваш любимый номер: ${favouritenumber}" />
      <set item="Content" conditionEx="#{'${language_id}'='2'}" value="Your favourite number: ${favouritenumber}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{//Item/@dbresult=0 and //Item/Attribute[@name='count']/@value&gt;1}" call="FavNumbersBrowseRecursive">
      <set item="Content" value="FavNumbersBrowseRecursive*${favouritenumber}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="FavNumbersBrowseRecursive" sessionStorage="Memory" sessionLifetime="120">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="smscon" id="${guid}" session_id="@{setSessionId(${SessionId})}">
        @{store(sCount,#{if('${sCount}'='',1,number(${sCount}))})}
        @{store(sList,#{if(${sCount}=1,'${token1}','${sList}')})}
        <Item customer="${sender}" action="8">
          <Attribute name="favouritenumber" value="" />
          <Attribute name="index" value="#{number(${sCount})+1}" />
          <Attribute name="favouritenumbertypeid" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0 or number('${sCount}')&gt;_MAX_FAVOURITE_NUM}">
      <!-- чтоб не зациклилось -->
      <set item="Content" value="Услуга 'Любимый номер' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and //Item/Attribute[@name='count']/@value=${sCount}+1}">
      <set conditionEx="0@{store(sList,${sList} ${favouritenumber})}" />
      <set item="Content" value="Ваши любимые номера: #{translate('${sList}',' ',',')}" />
      <set item="Content" conditionEx="#{'${language_id}'='2'}" value="Your favourite numbers: #{translate('${sList}',' ',',')}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and //Item/Attribute[@name='count']/@value&gt;${sCount}+1}" call="FavNumbersBrowseRecursive">
      <set conditionEx="0@{store(sCount,#{number(${sCount})+1})}" />
      <set conditionEx="0@{store(sList,${sList} ${favouritenumber})}" />
      <set item="Content" value="FavNumbersBrowseRecursive*#{translate('${sList}',' ','*')}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
  <template procedureName="Change_tarifplan">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${token0}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Данный запрос не может быть выполнен" />
      <set item="Content" condition="//Item/@dbresult=320341" value="Номер заблокирован, изменение тарифного плана невозможно" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Заявка на изменение тарифного плана уже обрабатывается" />
      <set item="Content" condition="//Item/@dbresult=320174" value="Смена Вашего тарифного плана на выбранный не предусмотрена." />
      <set item="Content" condition="//Item/@dbresult=320181" value="Для смены тарифного плана Вам необходимо обратиться к персональному менеджеру. Справки по номеру 0990" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на изменение тарифного плана зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="Change_tarifplan2">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${token0}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Данный запрос не может быть выполнен" />
      <set item="Content" condition="//Item/@dbresult=320341" value="Номер заблокирован, изменение тарифного плана невозможно" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Заявка на изменение тарифного плана уже обрабатывается" />
      <set item="Content" condition="//Item/@dbresult=320174" value="Смена Вашего тарифного плана на выбранный не предусмотрена." />
      <set item="Content" condition="//Item/@dbresult=320181" value="Для смены тарифного плана Вам необходимо обратиться к персональному менеджеру. Справки по номеру 0990" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на изменение тарифного плана зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="Check_tarifplan">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievetariffplan" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${token0}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Ваш тарифный план: ${tariffplan}" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка определения тарифного плана" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="PtPStep1">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Наберите *112*${code}# для пополнения баланса абонента ${receiver} на сумму #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')}" />
      <!--<set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода. Максимально доступная сумма перевода #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е')}" />-->
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода." />
      <set item="Content" condition="//Item/@dbresult=320312" value="Услуга заблокирована. Обратитесь в службу поддержки" />
      <!--<set item="Content" condition="//Item/@dbresult=320701" value="Максимально доступная сумма перевода #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')} Создайте запрос снова в формате: *112*номер телефона получателя*сумма#" />-->
      <set item="Content" condition="//Item/@dbresult=320701" value="Сумма больше доступной. Создайте запрос снова в формате: *112*номер телефона получателя*сумма#" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга не доступна организациям" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Перевод невозможен, повторите позже" />
      <set item="Content" condition="//Item/@dbresult=320711" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для отправителя" />
      <set item="Content" condition="//Item/@dbresult=320712" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для получателя" />
      <set item="Content" condition="//Item/@dbresult=320013" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для отправителя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320014" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для получателя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Сервис заблокирован для отправителя перевода" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Сервис заблокирован для получателя перевода" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PTP_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="PtPStep2">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Ваша заявка на перевод #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е')} абоненту ${receiver} зарегистрирована" />
      <!--<set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода. Максимально доступная сумма перевода #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')}" />-->
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода." />
      <set item="Content" condition="//Item/@dbresult=320666" value="Введен неверный код. Для подтверждения наберите команду *112*код подтверждения#, указав верный код, и нажмите клавишу вызова" />
      <set item="Content" condition="//Item/@dbresult=320999" value="Истек период действия кода подтверждения. Создайте новый запрос" />
      <set item="Content" condition="//Item/@dbresult=320312" value="Услуга заблокирована. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320701" value="Сумма больше доступной. Создайте  запрос снова в формате: *112*номер телефона получателя*сумма#" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга не доступна организациям" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Перевод невозможен, повторите позже" />
      <set item="Content" condition="//Item/@dbresult=320711" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для отправителя" />
      <set item="Content" condition="//Item/@dbresult=320712" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для получателя" />
      <set item="Content" condition="//Item/@dbresult=320013" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для отправителя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320014" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для получателя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Сервис заблокирован для отправителя перевода" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Сервис заблокирован для получателя перевода" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PTP_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SponsorRequest">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Наберите *_USSD_SPONSOR_NUMBER*${code}# для регулярного пополнения баланса абонента ${receiver} на сумму #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')} с периодом @{switch(${metric}|-1,DAY|день,WEEK|неделя,MONTH|месяц)}" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320701" value="Сумма больше доступной. Создайте запрос снова в формате: *_USSD_SPONSOR_NUMBER*[Nтел]*[период(1,2,3)]*[сумма(в валюте счета)]#" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320710" value="Минимально допустимая для перевода сумма составляет 50 руб., создайте запрос снова в формате: *_USSD_SPONSOR_NUMBER*[Nтел]*[период(1,2,3)]*[сумма(в валюте счета)]#" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Услуга заблокирована для отправителя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Услуга заблокирована для получателя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Content" condition="//Item/@dbresult=320101" value="Запрос на регулярное пополнение баланса абонента ${receiver} уже был Вами отправлен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SPONSOR_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SponsorAcceptance">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Ваша заявка на перевод #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е')} абоненту ${receiver} зарегистрирована" />
      <set item="Content" conditionEx="#{//Item/@dbresult=0 and '${operation}'='2'}" value="Ваша заявка на удаление получателя ${receiver} зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320701" value="Сумма больше доступной. Создайте запрос снова в формате: *_USSD_SPONSOR_NUMBER*[Nтел]*[период(1,2,3)]*[сумма(в валюте счета)]#" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320710" value="Минимально допустимая для перевода сумма составляет 50 руб., создайте запрос снова в формате: *_USSD_SPONSOR_NUMBER*[Nтел]*[период(1,2,3)]*[сумма(в валюте счета)]#" />
      <set item="Content" condition="//Item/@dbresult=320666" value="Введен неверный код. Для подтверждения наберите команду *_USSD_SPONSOR_NUMBER*код подтверждения#, указав верный код, и нажмите клавишу вызова" />
      <set item="Content" condition="//Item/@dbresult=320999" value="Истек период действия кода подтверждения. Создайте новый запрос" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Услуга заблокирована для отправителя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Услуга заблокирована для получателя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SPONSOR_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SponsorDelReceiver">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении получателя" />
      <set item="Content" condition="//Item/@dbresult=0" value="Наберите *_USSD_SPONSOR_NUMBER*${code}# для удаления получателя ${receiver}" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Абонента ${receiver} нет в списке получателей" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SPONSOR_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="SetCommunicationLang">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Attribute name="communicationlanguage" value="${token1}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при установке языка" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${communicationlanguage}'='1'}" value="Установлен русский язык" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${communicationlanguage}'='2'}" value="English language is set" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PTP_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!-- TEMPLATES FOR SERVICE 'BALANCE OF CHILD': BEGIN  -->
  <template procedureName="IsChild_AllSMS" sessionStorage="Memory" sessionLifetime="120" onClean="ChildsBalance_onClean_AllSMS">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${sParent}'=''}" call="DropDelivery">
      <set item="Content" value="DropDelivery(IsChild)" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${tariffplan}'='_CHILTP_ALLSMS'}" call="IsParent_AllSMS">
      <set item="Content" value="IsParent*${sParent}" />
      <set item="Sender" value="${sParent}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${tariffplan}'!='_CHILTP_ALLSMS'}">
      <set item="Content" value="Тарифный план абонента ${sChild} д.б. 'Классный'" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${sParent}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка авторизации. Операция недоступна" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${sParent}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="IsParent_AllSMS" sessionStorage="Memory" onClean="ChildsBalance_onClean_AllSMS">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="ussd" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sChild}" action="8">
          <Attribute name="favouritenumber" value="" />
          <Attribute name="index" value="1" />
          <Attribute name="favouritenumbertypeid" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${sParent}'=''}" call="DropDelivery">
      <set item="Content" value="DropDelivery*IsParent" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0 or (${dbresult}=0 and //Item/Attribute[@name='count']/@value=0) or (${dbresult}=0 and //Item/Attribute[@name='count']/@value=1 and '${favouritenumber}'!='${sParent}')}">
      <set item="Content" value="Ваш номер не найден среди любимых номеров абонента ${sChild}" />
      <set item="Content" conditionEx="#{${dbresult}=-1}" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${sParent}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${favouritenumber}'='${sParent}'}" call="BalanceOfChild_AllSMS">
      <set item="Content" value="BalanceOfChild*${sChild}" />
      <set item="Sender" value="${sParent}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and //Item/Attribute[@name='count']/@value&gt;1}" call="IsParentRecursive_AllSMS">
      <set item="Content" value="IsParentRecursive*${sChild}*${favouritenumber}" />
      <set item="Sender" value="${sParent}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="IsParentRecursive_AllSMS" sessionStorage="Memory" onClean="ChildsBalance_onClean_AllSMS">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="setprofile" initiator="ussd" id="@{newGuid}" session_id="${SessionId}">
        @{store(sCount,#{if('${sCount}'='',1,number(${sCount}))})}
        <Item customer="${sChild}" action="8">
          <Attribute name="favouritenumber" value="" />
          <Attribute name="index" value="#{number(${sCount})+1}" />
          <Attribute name="favouritenumbertypeid" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${sParent}'=''}" call="DropDelivery">
      <set item="Content" value="DropDelivery(IsParent)" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!=0 or number('${sCount}')&gt;_MAX_FAVOURITE_NUM or (${dbresult}=0 and //Item/Attribute[@name='count']/@value=${sCount}+1 and '${favouritenumber}'!='${sParent}')}">
      <!-- чтоб не зациклилось -->
      <set item="Content" value="Ваш номер не найден среди любимых номеров абонента ${sChild}" />
      <set item="Content" conditionEx="#{${dbresult}=-1}" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${sParent}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${favouritenumber}'='${sParent}'}" call="BalanceOfChild_AllSMS">
      <set item="Content" value="BalanceOfChild*${sChild}" />
      <set item="Sender" value="${sParent}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and //Item/Attribute[@name='count']/@value&gt;${sCount}+1}" call="IsParentRecursive_AllSMS">
      <set conditionEx="0@{store(sCount,#{number(${sCount})+1})}" />
      <set item="Content" value="IsParentRecursive*${sChild}*${favouritenumber}" />
      <set item="Sender" value="${sParent}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="BalanceOfChild_AllSMS" sessionStorage="Memory" onClean="ChildsBalance_onClean_AllSMS">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="ussd" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sChild}" subject="balance">
          <Attribute name="unpayment" value="0" />
          <Attribute name="requestcountertype" value="1" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${sParent}'=''}" call="DropDelivery">
      <set item="Content" value="DropDelivery(IsParent)" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно не доступен" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="#{if(${balanceintpartdotpart}&gt;=0,'Баланс абонента ${sChild}:','Задолженность абонента ${sChild}:')}#{/Message/Item/Attribute[@name='balanceintpartdotpart']/@value div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${iscredit}'='1'}" value="Кредитный баланс абонента ${sChild}: #{${balanceintpartdotpart} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')}, кредитный лимит: #{${creditlimitintpartdotpart} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е.')}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and count(/Message/Item/accumulators/accumulator)&gt;=1}" value="${Content}#{if(count(/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='voice']/@id])&gt;0,concat(', остаток минут ',/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='voice']/@id]/@val),'')}#{if(count(/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='voice2']/@id])&gt;0,concat(', использовано минут ', round(/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='voice2']/@id]/@val div 60)),'')}#{if(count(/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='sms']/@id])&gt;0,concat(', СМС ',/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='sms']/@id]/@val),'')}#{if(count(/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='gprs']/@id])&gt;0,concat(', GPRS ', round(/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='gprs']/@id]/@val div 1048576),' Mb'),'')}#{if(count(/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='voice_sec']/@id])&gt;0,concat(', остаток минут ',round(/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='voice_sec']/@id]/@val div 60)),'')}#{if(count(/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='mms']/@id])&gt;0,concat(', ММС ',/Message/Item/accumulators/accumulator[@id=document('counters.xml')//counters/counter[@type='mms']/@id]/@val),'')}" />
      <set item="Content" condition="//Item/@dbresult=320343" value="Абоненту ${sChild} услуга 'Запрос баланса' не предоставляется" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${sParent}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ChildsBalance_onClean_AllSMS" sessionStorage="Memory" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${sParent}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- TEMPLATES FOR SERVICE 'BALANCE OF CHILD': END  -->
  <template procedureName="Inter_Access_Activate">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги Международный доступ" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Международный доступ зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Международный доступ' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Международный доступ' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Международный доступ' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Inter_Access_Deactivate">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении услуги Международный доступ" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление услуги 'Международный доступ зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги 'Международный доступ' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Международный доступ' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Международный доступ' была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="OneFor_four1">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="OneFor_four2">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги'#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="OneFor_four3">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги'#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="OneFor_four4">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги'#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Activateim">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'ЧАТ'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка зарегистрирована.Для настроек ЧАТ наберите 0876.Бесплатно в домашней сети." />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'ЧАТ' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'ЧАТ' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'ЧАТ' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Deactivateim">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении услуги 'ЧАТ'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление услуги 'ЧАТ' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги 'ЧАТ' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'ЧАТ' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Услуга 'ЧАТ' была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Connect100">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{//Item/@dbresult=0}">
      <set item="Content" value="Заявка на добавление услуги 'Коннект 100' зарегистрирована'" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{//Item/@dbresult!=''}" call="Connect100_1">
      <set item="Content" value="${sContent}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="Connect100_1">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${Sender}">
          <Service id="FRTEST25" action="3" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate conditionEx="#{//Item/@dbresult=0}">
      <set item="Content" value="Заявка на добавление услуги 'Коннект 100' зарегистрирована'" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{//Item/@dbresult!=''}" call="Connect100_2">
      <set item="Content" value="${sContent}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <template procedureName="Connect100_2">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${Sender}">
          <Service id="FRTEST100" action="3" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Коннект 100'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Коннект 100' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Коннект 100' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Коннект 100' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Заявка на добавление услуги 'Коннект 100' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Connect250">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Коннект 250'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Коннект 250' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Коннект 250' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Коннект 250' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Коннект 250' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Connect400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Коннект 500'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Коннект 500' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Коннект 500' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Коннект 500' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Коннект 500' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Connect900">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Коннект 1000'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Коннект 1000' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Коннект 1000' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Коннект 1000' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Коннект 1000' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="MaxiPlus50Minutes">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Пакет +50 минут'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Пакет +50 минут' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Пакет +50 минут' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Пакет +50 минут' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Пакет +50 минут' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="MaxiPlus100minutes">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Пакет +100 минут'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Пакет +100 минут' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Пакет +100 минут' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Пакет +100 минут' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Пакет +100 минут' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="MaxiPlus200minutes">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Пакет +200 минут'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Пакет +200 минут' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Пакет +200 минут' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Пакет +200 минут' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Пакет +200 минут' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!--BEGIN Мобильная детализация USSD ================================= -->
  <template procedureName="CheckLastDetailCost">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка информирования о последних списаниях" />
      <set item="Content" condition="//Item/@dbresult=320343" value="Автоинформирование о списаниях для вашего номера не подключено" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Сервис временно недоступен. Попробуйте позже" />
      <set item="Content" value="${textlastdetail}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="111" />
      <set item="Recipient" value="${customer}" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
  </template>
  <template procedureName="CheckLastDetailAll">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка информирования о последних списаниях" />
      <set item="Content" condition="//Item/@dbresult=320343" value="Автоинформирование о списаниях для вашего номера не подключено" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Сервис временно недоступен. Попробуйте позже" />
      <set item="Content" value="${textlastdetail}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="111" />
      <set item="Recipient" value="${customer}" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
  </template>
  <!--BEGIN Мобильная детализация USSD =========================================== -->
  <template procedureName="MobBusiness">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Мобильный бизнес'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Мобильный бизнес' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Мобильный бизнес' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Мобильный бизнес' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Мобильный бизнес' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!-- ***  USSD BEGIN PtPRegular | SPONSOR *** -->
  <template procedureName="APPGW_PtPRegular">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="APPGW_PtPRegularStep2" conditionEx="#{${dbresult}=0}">
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="${code}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <!--<set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода. Максимально доступная сумма перевода #{${amount} div 100} руб." />-->
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода." />
      <set item="Content" condition="//Item/@dbresult=320312" value="Услуга заблокирована. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320701" value="Максимально доступная сумма перевода составляет 300 руб. Создайте запрос снова в формате: *112*номер телефона получателя*сумма#" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга не доступна организациям" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Перевод невозможен, повторите позже" />
      <set item="Content" condition="//Item/@dbresult=320711" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для отправителя" />
      <set item="Content" condition="//Item/@dbresult=320712" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для получателя" />
      <set item="Content" condition="//Item/@dbresult=320013" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для отправителя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320014" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для получателя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Сервис заблокирован для отправителя перевода" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Сервис заблокирован для получателя перевода" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PTP_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="APPGW_PtPRegularStep2">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="movepaymentacceptance" action="5">
            <Attribute name="code" value="#{normalize-space('${token0}')}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Ваша заявка на перевод #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е')} абоненту ${receiver} зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств, доступных для перевода" />
      <set item="Content" condition="//Item/@dbresult=320666" value="Введен неверный код. Для подтверждения наберите команду *112*код подтверждения#, указав верный код, и нажмите клавишу вызова" />
      <set item="Content" condition="//Item/@dbresult=320999" value="Истек период действия кода подтверждения. Создайте новый запрос" />
      <set item="Content" condition="//Item/@dbresult=320312" value="Услуга заблокирована. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320701" value="Максимально доступная сумма перевода составляет 300 руб. Создайте запрос снова в формате: *112*номер телефона получателя*сумма#" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга не доступна организациям" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Перевод невозможен, повторите позже" />
      <set item="Content" condition="//Item/@dbresult=320711" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для отправителя" />
      <set item="Content" condition="//Item/@dbresult=320712" value="Превышен лимит суммы на пополнение баланса другим абонентам за сутки для получателя" />
      <set item="Content" condition="//Item/@dbresult=320013" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для отправителя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320014" value="Заявка не выполнена. Превышение разрешенной суммы переводов за сутки для получателя. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Сервис заблокирован для отправителя перевода" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Сервис заблокирован для получателя перевода" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PTP_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="APPGW_SponsorRequest">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="APPGW_SponsorAcceptance" conditionEx="#{${dbresult}=0}">
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="${code}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320701" value="Сумма больше доступной. Создайте запрос снова в формате: *_USSD_SPONSOR_NUMBER*[Nтел]*[период(1,2,3)]*[сумма(в валюте счета)]#" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320710" value="Минимально допустимая для перевода сумма составляет 50 руб., создайте запрос снова в формате: *_USSD_SPONSOR_NUMBER*[Nтел]*[период(1,2,3)]*[сумма(в валюте счета)]#" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Услуга заблокирована для отправителя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Услуга заблокирована для получателя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Content" condition="//Item/@dbresult=320101" value="Такой же запрос на регулярное пополнение баланса абонента ${receiver} был уже Вами отправлен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SPONSOR_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="APPGW_SponsorAcceptance">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="sponsoracceptance" action="5">
            <Attribute name="code" value="#{normalize-space('${token0}')}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Ваша заявка на перевод #{${amount} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е')} абоненту ${receiver} зарегистрирована" />
      <set item="Content" conditionEx="#{//Item/@dbresult=0 and '${operation}'='2'}" value="Ваша заявка на удаление получателя ${receiver} зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320701" value="Сумма больше доступной. Создайте запрос снова в формате: *_USSD_SPONSOR_NUMBER*[Nтел]*[период(1,2,3)]*[сумма(в валюте счета)]#" />
      <set item="Content" condition="//Item/@dbresult=320702" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Перевод данному абоненту невозможен" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Content" condition="//Item/@dbresult=320710" value="Минимально допустимая для перевода сумма составляет 50 руб., создайте запрос снова в формате: *_USSD_SPONSOR_NUMBER*[Nтел]*[период(1,2,3)]*[сумма(в валюте счета)]#" />
      <set item="Content" condition="//Item/@dbresult=320666" value="Введен неверный код. Для подтверждения наберите команду *_USSD_SPONSOR_NUMBER*код подтверждения#, указав верный код, и нажмите клавишу вызова" />
      <set item="Content" condition="//Item/@dbresult=320999" value="Истек период действия кода подтверждения. Создайте новый запрос" />
      <set item="Content" condition="//Item/@dbresult=320361" value="Услуга заблокирована для отправителя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320362" value="Услуга заблокирована для получателя перевода. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320714" value="Превышено максимальное число получателей перевода" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SPONSOR_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="APPGW_SponsorDelReceiver">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate call="APPGW_SponsorDelReceiverAcceptance" conditionEx="#{${dbresult}=0}">
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="${customer}" />
      <set item="Content" value="${code}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении получателя" />
      <set item="Content" condition="//Item/@dbresult=320703" value="Абонента ${receiver} нет в списке получателей" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Есть открытые заявки на обработку. Повторите запрос позже" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SPONSOR_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="APPGW_SponsorDelReceiverAcceptance">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="sponsoracceptance" action="5">
            <Attribute name="code" value="#{normalize-space('${token0}')}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении получателя" />
      <set item="Content" condition="//Item/@dbresult=0" value="Ваша заявка на удаление получателя ${receiver} зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320312" value="Услуга заблокирована. Обратитесь в службу поддержки" />
      <set item="Content" condition="//Item/@dbresult=320704" value="Удаление получателя невозможено, повторите позже" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PTP_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <!-- *** USSD END PtPRegular | SPONSOR*** -->
  <!--  Начало  МТС ЧАТ новое. Есть еще в шаблонах Activateim старое  -->
  <template procedureName="Addim_MTSChat">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'ЧАТ'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка зарегистрирована.Для настроек ЧАТ наберите 0876.Бесплатно в домашней сети." />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги ЧАТ невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'ЧАТ' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'ЧАТ' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Deleteim_MTSChat">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении услуги 'ЧАТ'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление услуги ЧАТ зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги ЧАТ невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'ЧАТ' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Услуга 'ЧАТ' была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!-- Окончание МТС ЧАТ -->
  <!-- Услуга информирование о начислениях -->
  <template procedureName="USSD_PortalOpenBills">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка информирования о текущих начислениях" />
      <set item="Content" condition="//Item/@dbresult=320343" value="Автоинформирование о расходах для Вашего номера не подключено" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга по данному тарифному плану недоступна" />
      <set item="Content" condition="//Item/@dbresult=320060" value="Вам запрещено пользоваться данной услугой" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Сервис временно недоступен. Попробуйте позже" />
      <set item="Content" condition="//Item/@dbresult=0" value="С ${lastminibillingdate} израсходовано по Вашему номеру – #{${summintdotpart} div 100} #{if('${currency}'='810' or '${currency}'='RUB','руб.','у.е')}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="RegisteredDelivery" value="false" />
    </deliveryTemplate>
  </template>
  <!-- END Услуга информирование о начислениях -->
  <!-- Начало Почта Онлайн  -->
  <template procedureName="FolkMailDeactivateSMS" sessionStorage="Database" sessionLifetime="300">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}!='0'}" call="FolkMailDeactivateWap">
      <set item="Sender" value="${Customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Content" value="${Custom_Content}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="FolkMailDeactivateWap" sessionStorage="Database" sessionLifetime="240">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="FRMAILWAP" action="3" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении услуги" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330140}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
  </template>
  <!-- Конец Почта Онлайн  -->
  <!-- Begin USSD 10 Spisaniy -->
  <template procedureName="USSDLastCharges">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="issacon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${customer}" subject="balance_history" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and count(/Message/Item/row)&gt;0}">
      <set item="Content" value="#{/Message/Item/@charges}" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="У Вас не происходило изменений баланса в прошлом месяце" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- End USSD 10 Spisaniy -->
  <!-- Mobilnay pochta  -->
  <template procedureName="MobilnayPochtaAdd">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Мобильная почта SMS' зарегистрирована'" />
      <set item="Content" conditionEx="#{'${service_id}'='FRMT11'}" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Мобильная почта WAP' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Мобильная почта SMS' невозможно пока не завершится предыдущая операция" />
      <set item="Content" conditionEx="#{'${service_id}'='FRMT11'}" condition="//Item/@dbresult=320203" value="Добавление услуги 'Мобильная почта WAP' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Мобильная почта SMS' не предоставляется для вашего тарифного плана" />
      <set item="Content" conditionEx="#{'${service_id}'='FRMT11'}" condition="//Item/@dbresult=320204" value="Услуга 'Мобильная почта WAP' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Мобильная почта SMS' была добавлена ранее" />
      <set item="Content" conditionEx="#{'${service_id}'='FRMT11'}" condition="//Item/@dbresult=320205" value="Услуга 'Мобильная почта WAP' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="MobilnayPochtaDel">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении услуги" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление услуги 'Мобильная почта SMS' зарегистрирована" />
      <set item="Content" conditionEx="#{'${service_id}'='FRMT11'}" condition="//Item/@dbresult=0" value="Заявка на удаление услуги 'Мобильная почта WAP' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги 'Мобильная почта SMS' невозможно пока не завершится предыдущая операция" />
      <set item="Content" conditionEx="#{'${service_id}'='FRMT11'}" condition="//Item/@dbresult=320203" value="Удаление услуги 'Мобильная почта WAP' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Мобильная почта SMS' не предоставляется для вашего тарифного плана" />
      <set item="Content" conditionEx="#{'${service_id}'='FRMT11'}" condition="//Item/@dbresult=320204" value="Услуга 'Мобильная почта WAP' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Услуга 'Мобильная почта SMS' была удалена ранее" />
      <set item="Content" conditionEx="#{'${service_id}'='FRMT11'}" condition="//Item/@dbresult=320206" value="Услуга 'Мобильная почта WAP' была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!-- End Mobilnay pochta -->
  <!-- Begin Oplata Bankovskoy kartoy  -->
  <template procedureName="BankCardPayment">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при переводе средств" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на перевод средств зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320115" value="Оформите соглашение на оплату по кредитной карте в офисе МТС" />
      <set item="Content" condition="//Item/@dbresult=320114" value="Сумма начисления не может быть равна нулю" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <!--End Oplata Bankovskoy kartoy  -->
  <!-- TEMPLATES FOR SERVICE 'BALANCE OF CHILD': BEGIN -->
  <template procedureName="IsChild_LN" sessionStorage="Database" sessionLifetime="300" onClean="ChildsBalance_onClean_LN">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${sParentLN}'=''}" call="DropDelivery">
      <set item="Content" value="DropDelivery(IsChildLN)" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}" call="BalanceOfChild_LN">
      <set item="Content" value="IsParent*${sParentLN}" />
      <set item="Sender" value="${sParentLN}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка авторизации. Операция недоступна" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${sParentLN}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="BalanceOfChild_LN" sessionStorage="Database" sessionLifetime="300" onClean="ChildsBalance_onClean_LN">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="ussd" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${sParentLN}" subject="favouritenumberbalance">
          <Attribute name="favouritenumber" value="${sChildLN}" />
          <Attribute name="favouritenumbertypeid" value="1" />
          <Attribute name="requestcountertype" value="3" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${sParentLN}'=''}" call="DropDelivery">
      <set item="Content" value="DropDelivery(IsParentLN)" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_SMS_SERVICE_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно не доступен" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="#{if(${balanceintpartdotpart}&gt;=0,'Баланс ${sChildLN}:','Баланс ${sChildLN}:  ')} #{/Message/Item/Attribute[@name='balanceintpartdotpart']/@value div 100} руб.  #{translate('${cntdescription}','=',':')}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${iscredit}'='1'}" value="Кредитный баланс ${sChildLN}: #{${balanceintpartdotpart} div 100} руб., кредитный лимит: #{number(${creditlimitintpartdotpart}) div 100} руб. #{translate('${cntdescription}','=',':')}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and count(/Message/Item/accumulators/accumulator)&gt;=1}" value="${Content}#{/Message/Item/accumulators/@smsln} #{translate('${cntdescription}','=',':')}" />
      <set item="Content" conditionEx="#{${dbresult}=320343}" value="Абоненту ${sChild} услуга 'Запрос баланса' не предоставляется" />
      <set item="Content" conditionEx="#{${dbresult}=320060}" value="У Вас нет прав на проведение данной операции." />
      <set item="Content" conditionEx="#{${dbresult}=320956}" value="Информация о балансе номера ${sChildLN} недоступна" />
      <set item="Content" conditionEx="#{${dbresult}=320193}" value="Информация о балансе номера ${sChildLN} недоступна" />
      <set item="Sender" value="_CHILDS_BALANCE_SERVICE" />
      <set item="Recipient" value="${sParentLN}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ChildsBalance_onClean_LN" sessionStorage="Database" sessionLifetime="300" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${sParentLN}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- TEMPLATES FOR SERVICE 'BALANCE OF CHILD': END  -->
  <!-- Begin Packages -->
  <template procedureName="USSDGetServicePackages">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка обработки запроса" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${pkgnamelist}'!=''}" value="Ваши пакеты услуг: ${pkgnamelist}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${pkgnamelist}'=''}" value="У Вас нет подключенных пакетов услуг" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PKG_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="USSDAddServicePackage">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка добавления пакета" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Пакет услуг успешно подключен" />
      <set item="Content" conditionEx="#{${dbresult}=320154}" value="Невозможно подключить пакет.Есть взаимоисключающие пакеты." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PKG_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="USSDRemoveServicePackage">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка удаления пакета" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Пакет услуг успешно удален" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_PKG_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!-- End Packages -->
  <!-- Начало Тестирование разовых аккумуляторов ST/Comverse. -->
  <template procedureName="ActivateAccumulatorComverseST" sessionStorage="Database" sessionLifetime="240">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="DeactivateAccumulatorComverseST" sessionStorage="Database" sessionLifetime="240">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при удалении услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' " />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}'  не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <!-- Окончание Тестирование разовых аккумуляторов ST Comverse -->
  <!-- Скидка от платежа -->
  <template procedureName="Discount_from_payment">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги 'Скидка от платежа'" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Скидка от платежа' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Скидка от платежа' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Скидка от платежа' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Скидка от платежа' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!-- Скидка от платежа -->
  <!--  Begin активации/деактивации признака «Запрет перерасчета КД и КЛ»    -->
  <template procedureName="RecalculationProhibitionActivate">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно не доступен" />
      <set item="Content" condition="//Item/@dbresult=0" value="Статус перерасчета кредитного лимита изменен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="RecalculationProhibitionDeactivate">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно не доступен" />
      <set item="Content" condition="//Item/@dbresult=0" value="Статус перерасчета кредитного лимита изменен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!--  END активации/деактивации признака «Запрет перерасчета КД и КЛ»    -->
  <!--  Begin активации/деактивации Индивидуальный кредит    -->
  <template procedureName="ActivateService_IndividualCredit">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно не доступен" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на добавление услуги 'Индивидуальный кредит' зарегистрирована'" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги 'Индивидуальный кредит' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Индивидуальный кредит' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга 'Индивидуальный кредит' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="DeactivateService_IndividualCredit">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно не доступен" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на удаление услуги 'Индивидуальный кредит' зарегистрирована" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Удаление услуги 'Индивидуальный кредит' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга 'Индивидуальный кредит' не предоставляется для вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320206" value="Услуга 'Индивидуальный кредит' была удалена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!--  END активации/деактивации Индивидуальный кредит    -->
  <!-- *** Begin ASSA 111*** -->
  <template procedureName="DB_SProcessing">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=330154 or ${dbresult}=330155}" connector="SMSCON_01_02" call="ServiceOrderErrorHandler.SendCRMErrorMessage" terminating="false" />
    <!--<deliveryTemplate>-->
    <deliveryTemplate conditionEx="#{'${service_id}'='FRINDKREDIT'} ">
      <set item="Content" value="Данная услуга для Вас недоступна. Подробности по номеру 05902." />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка на подключение услуги Индивидуальный кредит принята. Метод расчётов будет изменён на кредитный. Подробности по номеру 05902" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=320174" value="Смена Вашего тарифного плана на выбранный не предусмотрена." />
      <set item="Content" condition="//Item/@dbresult=320181" value="Для смены тарифного плана Вам необходимо обратиться к персональному менеджеру. Справки по номеру 0990" />
      <!--	<set item="Content" condition="#{//Item/@dbresult=0 and '${service}'!='11111'}" value="Внимание! Вы подключаете услуги 3G на SIM-карту: услуги могут быть недоступны в роуминге. Рекомендуем Вам использовать USIM-карту" /> -->
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!-- ***END ASSA 111*** -->
  <template procedureName="Balance_tfsid_18145">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно не доступен" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="#{if(${balanceintpartdotpart}&gt;=0,'Баланс:','Задолженность:')}#{/Message/Item/Attribute[@name='balanceintpartdotpart']/@value div 100}руб" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${iscredit}'='1' and number(${balanceintpartdotpart})&gt;=0}" value="Баланс:#{${balanceintpartdotpart} div 100};Кредит:#{number(${creditlimitintpartdotpart}) div 100}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${iscredit}'='1' and number(${balanceintpartdotpart}) &lt; 0}" value="Минус #{number(${balanceintpartdotpart}) div (-100)};Кредит:#{number(${creditlimitintpartdotpart}) div 100}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and count(/Message/Item/accumulators/accumulator)&gt;=1}" value="${Content} #{/Message/Item/accumulators/@ussd}" />
      <set item="Content" conditionEx="#{${dbresult}=0 and count(/Message/Item/accumulators/accumulator)&gt;=1 and /Message/Item/accumulators/accumulator/@id='voicemin.AA'}" value="${Content} Осталось: #{ /Message/Item/accumulators/accumulator[@id='voicemin.AA']/@val} мин." />
      <set item="Content" condition="//Item/@dbresult=320343" value="Данная услуга не предоставляется" />
      <set item="Content" condition="//Item/@customer=document('persons.xml')//persons/person/@phone" value="#{document('persons.xml')//persons/person[@phone=${customer}]/@text} ${Content}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!--Дегустация услуг -->
  <template procedureName="ServiceDegustation">
    <condition>
      <test item="${Recipient}" matches="^5680$" />
      <test item="${Content}" matches="^[0-9]{1,6}\*[0-9]{4}$" />
    </condition>
    <receiveTemplate>
      <Message type="servicedegustation" initiator="smscon" id="${guid}" session_id="${session_id}">
        <Item customer="${Sender}">
          <Attribute name="number" value="${token0}" />
          <Attribute name="pin" value="${token1}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="${dbresult}" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="#{//Content/text()}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="5680" />
    </deliveryTemplate>
  </template>
  <!--***************************************************************************************************************************************************************************************************************************************-->
  <template procedureName="ServiceDegustationError">
    <condition>
      <test item="${Recipient}" matches="^5680$" />
    </condition>
    <receiveTemplate>
      <Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Создайте СМС в формате: номер буклета*PIN код на номер 5680" />
      <set item="Sender" value="5680" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="SMS_Paket_MG">
    <condition>
      <test item="${Recipient}" matches="^2200$" />
      <test item="${Content}" matches="^(1801)$|^(1802)$|^(1803)$|^(1804)$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="@{switch(${token0}|,1801|PAKETCIS100,1802|PAKETCIS300,1803|PAKETEU100,1804|PAKETEU300)}" action="2" class="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult} = document('SelfDescriptiveCodes.xml')/dbresults/dbresult}" forward="ServiceOrderErrorHandler.SendCRMErrorMessage" />
    <deliveryTemplate>
      <set item="Content" value="Ошибка при добавлении услуги" />
      <set item="Content" condition="//Item/@dbresult=0" value="Заявка принята. Проверьте наличие международного доступа" />
      <set item="Content" condition="//Item/@dbresult=320203" value="Добавление услуги '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' невозможно пока не завершится предыдущая операция" />
      <set item="Content" condition="//Item/@dbresult=320204" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' не предоставляется для Вашего тарифного плана" />
      <set item="Content" condition="//Item/@dbresult=320205" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' была добавлена ранее" />
      <set item="Content" condition="//Item/@dbresult=320191" value="Недостаточно средств на балансе  для проведения операции" />
      <set item="Content" condition="//Item/@dbresult=320194" value="Услуга '#{document('SMSServices1771.xml')/action/service[@code='${service_id}']/@name}' Вам недоступна." />
      <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
</templates>