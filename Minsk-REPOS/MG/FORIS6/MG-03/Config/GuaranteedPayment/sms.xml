<templateGroup name="GuaranteedPayment">
  <macros>
    <define name="_SMS_SERVICE_NUMBER" value="12345" />
  </macros>
  <template procedureName="Acceptance">
    <condition>
      <test item="${Recipient}" matches="^_SMS_SERVICE_NUMBER$" />
      <test item="${Content}" matches="(^[0-9]+\s+[rRрР][uUуУ][bBбБ]\s*$)|(^\s*1\s*$)" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="${guid}">
        <Item customer="${Sender}">
          <Service id="guaranteedpayment" action="7">
            <Attribute name="amount" value="#{if(matches('${content}','^\s*1\s*$'),'',number('${token0}') * 100)}" />
            <Attribute name="currency" value="810" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Вам предоставлен Обещанный платеж на сумму #{number('${amount}') div 100} руб. Срок действия до ${ExpiredDate}. Баланс увеличен на сумму платежа" />
      <set item="Content" conditionEx="#{${dbresult}=320341}" value="Номер Вашего телефона не зарегистрирован" />
      <set item="Content" conditionEx="#{${dbresult}=320347}" value="Данный сервис недоступен. Номер заблокирован" />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Данный сервис недоступен. Ваш баланс #{number('${balance}') div 100} руб." />
      <set item="Content" conditionEx="#{${dbresult}=320203 or ${dbresult}=330124}" value="Невозможно установить обещанный платеж. На лицевом счете уже действует обещанный платеж" />
      <set item="Content" conditionEx="#{${dbresult}=320111}" value="Укажите сумму не более #{number('${maximumrur}') div 100} руб." />
      <set item="Content" conditionEx="#{${dbresult}=320121}" value="Невозможно установить обещанный платеж" />
      <set item="Content" conditionEx="#{${dbresult}=320113}" value="Сумма обещанного платежа меньше минимально возможной" />
      <set item="Content" conditionEx="#{${dbresult}=330140}" value="Обратитесь к персональному менеджеру" />
      <set item="Content" conditionEx="#{${dbresult}=330141}" value="Превышено допустимое кол-во обещанных платежей" />
      <set item="Content" conditionEx="#{${dbresult}=330142}" value="Исчерпан лимит средств для ввода обещанного платежа" />
      <set item="Content" conditionEx="#{${dbresult}=330132}" value="Данный сервис недоступен. Ваш баланс #{number('${balance}') div 100} руб." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Verification">
    <condition>
      <test item="${Recipient}" matches="^_SMS_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*2\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="${guid}">
        <Item customer="${Sender}">
          <Service id="guaranteedpayment" action="6" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
      <set item="Content" conditionEx="#{${dbresult}=0 and '${maximumrur}'!=''}" value="Разрешен обещанный платеж в размере #{number('${maximumrur}') div 100} руб." />
      <set item="Content" conditionEx="#{${dbresult}=320341}" value="Номер Вашего телефона не зарегистрирован" />
      <set item="Content" conditionEx="#{${dbresult}=320347}" value="Данный сервис недоступен. Номер заблокирован" />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Данный сервис недоступен. Ваш баланс #{number('${balance}') div 100} руб." />
      <set item="Content" conditionEx="#{${dbresult}=320203 or ${dbresult}=330124}" value="Невозможно установить обещанный платеж. На лицевом счете уже действует обещанный платеж" />
      <set item="Content" conditionEx="#{${dbresult}=320111}" value="Укажите сумму не более #{number('${maximumrur}') div 100} руб." />
      <set item="Content" conditionEx="#{${dbresult}=320121}" value="Невозможно установить обещанный платеж" />
      <set item="Content" conditionEx="#{${dbresult}=320113}" value="Сумма обещанного платежа меньше минимально возможной" />
      <set item="Content" conditionEx="#{${dbresult}=330140}" value="Обратитесь к персональному менеджеру" />
      <set item="Content" conditionEx="#{${dbresult}=330141}" value="Превышено допустимое кол-во обещанных платежей" />
      <set item="Content" conditionEx="#{${dbresult}=330142}" value="Исчерпан лимит средств для ввода обещанного платежа" />
      <set item="Content" conditionEx="#{${dbresult}=330132}" value="Данный сервис недоступен. Ваш баланс #{number('${balance}') div 100} руб." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="List">
    <condition>
      <test item="${Recipient}" matches="^_SMS_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^\s*3\s*$" />
    </condition>
    <receiveTemplate>
      <Message type="retrievecustomerdata" initiator="smscon" id="${guid}" session_id="${guid}">
        <Item customer="${Sender}" subject="get_guaranteedpayment" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Нет информации об обещанных платежах" />
      <set item="Content" conditionEx="#{${dbresult}=0 and ${count}=0}" value="Обещанные платежи не установлены." />
      <set item="Content" conditionEx="#{${dbresult}=0 and ${count}!=0}" value="#{transform('..\..\config\GuaranteedPayment\parse.xsl')/Message/Item/@paymentslist}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="WrongRequest">
    <condition>
      <test item="${Recipient}" matches="^_SMS_SERVICE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message customer="${Sender}" />
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Ошибка в формате запроса." />
      <set item="Sender" value="_SMS_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
</templateGroup>