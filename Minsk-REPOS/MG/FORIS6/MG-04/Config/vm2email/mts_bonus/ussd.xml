<templateGroup name="MTS_BONUS">
  <macros>
    <define name="_USSD_SERVICE_NUMBER" value="111" />
    <define name="_MTS_BONUS_SERVICE_CODE" value="455" />
    <define name="_BMSHND" value="WCFHND_01" />
    <define name="_USER_ID_OF_CHANGE" value="-1" />
    <define name="_CHANNEL_CODE" value="USSD" />
    <define name="_CAMPAIGN_CODE" value="MTS_BONUS" />
    <define name="_LANGUAGE_CODE" value="1" />
  </macros>
  <!-- BUC_34: IAccount.GetBalance  -->
  <template procedureName="MTSBonusGetAccountCampaignParticipationStatusForBalance" handler="_BMSHND">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${token0}" matches="^_MTS_BONUS_SERVICE_CODE$" />
      <test item="${token1}" matches="^0$" />
    </condition>
    <receiveTemplate>
      <Message type="getaccountcampaignparticipationstatus" initiator="ussd" id="${guid}" session_id="${guid}">
        <Item procedureName="GetAccountCampaignParticipationStatus">
          <Attribute name="Account" value="${Sender}" />
          <Attribute name="CampaignCode" value="_CAMPAIGN_CODE" />
          <Attribute name="LanguageCode" value="_LANGUAGE_CODE" />
          <Attribute name="ParticipationStatus" />
          <Attribute name="Result" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'='0' and ('${ParticipationStatus}'='AWC' or '${ParticipationStatus}'='ACT')}" call="MTSBonusGetBonusBalance">
      <set item="Content" value="" />
      <set item="Sender" value="${Account}" />
      <set item="Recipient" value="_USSD_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate call="MTSBonusAssingToCampaing">
      <set item="Content" value="" />
      <set item="Sender" value="${Account}" />
      <set item="Recipient" value="_USSD_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="MTSBonusGetBonusBalance" handler="_BMSHND">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="getaccountbalance" initiator="ussd" id="${guid}" session_id="${guid}">
        <Item procedureName="GetAccountBalance">
          <Attribute name="Customer" type="String" value="${sender}" />
          <Attribute name="Balance" />
          <Attribute name="GiftPromotion" />
          <Attribute name="Result" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка получения баланса" />
      <set item="Content" conditionEx="#{'${Result}'='0'}" value="У Вас ${Balance} баллов! ${GiftPromotion}" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- BUC_03.: Регистрация в МТС Бонус через SMS\USSD  -->
  <template procedureName="MTSBonusGetAccountCampaignParticipationForAssign" handler="_BMSHND">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${token0}" matches="^_MTS_BONUS_SERVICE_CODE$" />
      <test item="${token1}" matches="^1$" />
    </condition>
    <receiveTemplate>
      <Message type="getaccountcampaignparticipationstatus" initiator="ussd" id="${guid}" session_id="${guid}">
        <Item procedureName="GetAccountCampaignParticipationStatus">
          <Attribute name="Account" value="${Sender}" />
          <Attribute name="CampaignCode" value="_CAMPAIGN_CODE" />
          <Attribute name="LanguageCode" value="_LANGUAGE_CODE" />
          <Attribute name="ParticipationStatus" />
          <Attribute name="Result" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'='0' and ('${ParticipationStatus}'='AWC' or '${ParticipationStatus}'='ACT')}">
      <set item="Content" value="Вы уже зарегистрированы в МТС Бонус. Правила участия на сайте www.bonus.mts.ru. Чтобы узнать доступные вознаграждения и как их заказать, отправьте Бонус на 4555" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Account}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'!='0'}">
      <set item="Content" value="Данный номер не может быть зарегестрирован в программе, попробуйте позднее." />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Account}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate call="MTSBonusAssingToCampaing">
      <set item="Content" value="" />
      <set item="Sender" value="${Account}" />
      <set item="Recipient" value="_USSD_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="MTSBonusAssingToCampaing" handler="_BMSHND">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="assignaccounttocampaign" initiator="ussd" id="${guid}" session_id="${guid}">
        <Item procedureName="AssignAccountToCampaign">
          <Attribute name="AssignAccount" value="${Sender}" />
          <Attribute name="CampaignCode" value="_CAMPAIGN_CODE" />
          <Attribute name="ChannelCode" value="_CHANNEL_CODE" />
          <Attribute name="UserIdOfChange" value="_USER_ID_OF_CHANGE" />
          <Attribute name="AssignResponse" />
          <Attribute name="Result" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Данный номер не может быть зарегестрирован в программе, попробуйте позднее." />
      <set item="Content" conditionEx="#{'${Result}'='0'}" value="Спасибо! Ваша заявка на регистрацию в программе МТС Бонус принята." />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${AssignAccount}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <!-- BUC_30: ICampaign.AddCampaignInvitation.  -->
  <template procedureName="MTSBonusGetAccountCampaignParticipationStatusForInvitation" handler="_BMSHND" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${token0}" matches="^_MTS_BONUS_SERVICE_CODE$" />
      <test item="${token1}" matches="^4$" />
      <test item="${token2}" matches="^(\+7|8|7){0,1}[0-9]{10}$" />
    </condition>
    <receiveTemplate>
      <Message type="getaccountcampaignparticipationstatus" initiator="ussd" id="${guid}" session_id="@{setSessionId(${guid})}">
        <Item procedureName="GetAccountCampaignParticipationStatus">
          <Attribute name="Account" value="${Sender}" />
          <Attribute name="CampaignCode" value="_CAMPAIGN_CODE" />
          <Attribute name="LanguageCode" value="_LANGUAGE_CODE" />
          <Attribute name="ParticipationStatus" />
          <Attribute name="Result" />
        </Item>
        @{store(sTargetAccount,7#{substring(normalize-space('${token2}'),string-length(normalize-space('${token2}'))-9)})}
        @{store(sSender,${Sender}}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'!='0' or ('${ParticipationStatus}'!='AWC' and '${ParticipationStatus}'!='ACT')}">
      <set item="Content" value="Уважаемый абонент! Зарегистрируйтесь в программе МТС Бонус - отправьте 1 на 4555." />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Account}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="MTSBonusGetAccountCampaignParticipationStatusForInvitationTarget">
      <set item="Content" value="${sTargetAccount}" />
      <set item="Sender" value="${sSender}" />
      <set item="Recipient" value="_USSD_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="MTSBonusGetAccountCampaignParticipationStatusForInvitationTarget" handler="_BMSHND" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="getaccountcampaignparticipationstatus" initiator="ussd" id="${guid}" session_id="@{SessionId}">
        <Item procedureName="GetAccountCampaignParticipationStatus">
          <Attribute name="Account" value="${sTargetAccount}" />
          <Attribute name="CampaignCode" value="_CAMPAIGN_CODE" />
          <Attribute name="LanguageCode" value="_LANGUAGE_CODE" />
          <Attribute name="ParticipationStatus" />
          <Attribute name="Result" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${ParticipationStatus}'='AWC' or '${ParticipationStatus}'='ACT'}">
      <set item="Content" value="Абонент с номером ${sTargetAccount} уже зарегистрирован в программе МТС Бонус. Пожалуйста, попробуйте пригласить другого абонента." />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Account}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="MTSBonusAddCampaignInvitation">
      <set item="Content" value="${sTargetAccount}" />
      <set item="Sender" value="${sSender}" />
      <set item="Recipient" value="_USSD_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="MTSBonusAddCampaignInvitation" handler="_BMSHND" sessionStorage="Memory">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="addcampaigninvitation" initiator="ussd" id="${guid}" session_id="@{SessionId}">
        <Item procedureName="AddCampaignInvitation">
          <Attribute name="InvitationSourceAccount" value="${Sender}" />
          <Attribute name="CampaignCode" value="_CAMPAIGN_CODE" />
          <Attribute name="InvitedAccount" value="${sTargetAccount}" />
          <Attribute name="UserIdOfChange" value="_USER_ID_OF_CHANGE" />
          <Attribute name="InvitationResponse" />
          <Attribute name="Result" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="По техническим причинам отправка приглашения будет доступна позднее. Приносим извинения за доставленные неудобства." />
      <set item="Content" conditionEx="#{'${Result}'='0'}" value="Спасибо! Приглашение в МТС Бонус для {0} успешно отправлено. В течение 7 дней после регистрации данного номера в программе вы получите 50 баллов." />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${sSender}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <!-- BUC_16: IOrder.OrderGift, Заказ вознаграждения через SMS\USSD  -->
  <template procedureName="MTSBonusGetAccountCampaignParticipationStatusForOrderGift" handler="_BMSHND" sessionStorage="Memory" sessionLifetime="300">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${token0}" matches="^_MTS_BONUS_SERVICE_CODE$" />
      <test item="#{if(document('..\..\config\mts_bonus\gifts.xml')/gifts/gift[@ussdcode='${token1}']/@bmscode != '',1,0)}" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="getaccountcampaignparticipationstatus" initiator="ussd" id="${guid}" session_id="@{setSessionId(${guid})}">
        <Item procedureName="GetAccountCampaignParticipationStatus">
          <Attribute name="Account" value="${Sender}" />
          <Attribute name="CampaignCode" value="_CAMPAIGN_CODE" />
          <Attribute name="LanguageCode" value="_LANGUAGE_CODE" />
          <Attribute name="ParticipationStatus" />
          <Attribute name="Result" />
        </Item>
        @{store(sGiftCode,#{document('..\..\config\mts_bonus\gifts.xml')/gifts/gift[@ussdcode='${token1}']/@bmscode})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'='0' and '${ParticipationStatus}'='AWC')}">
      <set item="Content" value="Пожалуйста, дождитесь SMS-подтверждения вашего участия в программе, после чего повторите заказ." />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Account}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'!='0' or ('${ParticipationStatus}'!='AWC' and '${ParticipationStatus}'!='ACT')}">
      <set item="Content" value="Уважаемый абонент! Зарегистрируйтесь в программе МТС Бонус - отправьте 1 на 4555." />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Account}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="MTSBonusOrderGiftValidation">
      <set item="Content" value="${sGiftCode}" />
      <set item="Sender" value="${Account}" />
      <set item="Recipient" value="_USSD_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="MTSBonusOrderGiftValidation" handler="_BMSHND" sessionStorage="Memory">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="ordergiftvalidation" initiator="ussd" id="${guid}" session_id="${SessionId}">
        <Item procedureName="OrderGiftValidation">
          <Attribute name="Account" value="${Sender}" />
          <Attribute name="TargetAccount" value="" />
          <Attribute name="Quantity" value="1" />
          <Attribute name="GiftCode" value="${Content}" />
          <Attribute name="ChannelCode" value="_CHANNEL_CODE" />
          <Attribute name="ValidationResult" />
          <Attribute name="ResultReason" />
          <Attribute name="Result" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'!='0'}">
      <set item="Content" value="Заказ приза с таким номером не доступен. Чтобы узнать доступное Вам вознаграждение, отправьте Бонус на 4555. Все вознаграждения www.bonus.mts.ru" />
      <set item="Content" conditionEx="#{'${Result}'='-771002'}" value="${ResultReason}" />
      <set item="Content" conditionEx="#{'${Result}'='-771001' or '${Result}'='-771040'}" value="По техническим причинам заказ данного вознаграждения будет доступен позднее. Приносим извинения за доставленные неудобства." />
      <set item="Content" conditionEx="#{'${Result}'='-771003'}" value="Уважаемый абонент! Зарегистрируйтесь в программе МТС Бонус - отправьте 1 на 4555." />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Account}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{'${Result}'='0' and '${ValidationResult}'='4'}">
      <set item="Content" value="У вас недостаточно баллов для заказа пакета Покупка за баллы в салонах МТС - 3000 руб.. Узнайте доступный баланс, отправив BAL на 4555" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Account}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate call="MTSBonusOrderGift">
      <set item="Content" value="${sGiftCode}" />
      <set item="Sender" value="${Account}" />
      <set item="Recipient" value="_USSD_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="MTSBonusOrderGift" handler="_BMSHND" sessionStorage="Memory">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="ordergift" initiator="ussd" id="${guid}" session_id="${SessionId}">
        <Item procedureName="OrderGift">
          <Attribute name="Msisdn" value="${Sender}" />
          <Attribute name="GiftCode" value="${Content}" />
          <Attribute name="Quantity" value="1" />
          <Attribute name="ChannelCode" value="_CHANNEL_CODE" />
          <Attribute name="TargetMsisdn" value="" />
          <Attribute name="UserIdOfChange" value="_USER_ID_OF_CHANGE" />
          <Attribute name="Result" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="По техническим причинам заказ данного вознаграждения будет доступен позднее. Приносим извинения за доставленные неудобства." />
      <set item="Content" conditionEx="#{'${Result}'='0'}" value="#{document('..\..\config\mts_bonus\gifts.xml')/gifts/gift[@bmscode='${GiftCode}']/ussdtext/text()}" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Msisdn}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="MTSBonusInvalidFormat">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${token0}" matches="^_MTS_BONUS_SERVICE_CODE$" />
    </condition>
    <receiveTemplate>
      <Message id="${guid}" session_id="${guid}">
        <Attribute name="Customer" value="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Неверный формат запроса" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
    </deliveryTemplate>
  </template>
</templateGroup>