<templateGroup name="VM2Email">
  <macros>
    <define name="_ADD_VM2EMAIL_SERVICE_NUMBER" value="111" />
    <define name="_VM2EMAIL_SERVICE_ID" value="VM2EMAIL" />
    <define name="_SECRETARY_SERVICE_ID" value="CB401050" />
  </macros>
  <template procedureName="CheckService_Secretary" sessionStorage="Memory" sessionLifetime="240">
    <condition>
      <test item="${Recipient}" matches="^_ADD_VM2EMAIL_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^21174\s+.+$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="smscon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
        <Item customer="${Sender}">
          <Service id="_SECRETARY_SERVICE_ID" action="interrogation" />
        </Item>
        @{store(sContent,#{normalize-space('${Content}')})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{(${dbresult}=0) and ('${subscription}'='1')}" call="CheckService_VM2EMAIL">
      <set item="Content" value="${sContent}" />
      <set item="Sender" value="${Customer}" />
      <set item="Recipient" value="_ADD_VM2EMAIL_SERVICE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Для пересылки ГФП на e-mail требуется добавить &quot;ГФП класса Секретарь&quot;.Для добавления наберите *111*2117#Вызов" />
      <set item="Sender" value="_ADD_VM2EMAIL_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="CheckService_VM2EMAIL" sessionStorage="Memory" sessionLifetime="120">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceinterrogation" initiator="smscon" id="${guid}" session_id="${SessionId}">
        <Item customer="${Sender}">
          <Service id="_VM2EMAIL_SERVICE_ID" action="interrogation" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}" call="ActivateService_VM2EMAIL">
      <set conditionEx="0@{store(sServicePresents,${subscription})}" />
      <set item="Content" value="${sContent}" />
      <set item="Sender" value="${customer}" />
      <set item="Recipient" value="_ADD_VM2EMAIL_SERVICE_NUMBER" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Услуга 'ГФП на e-mail' не предоставляется для вашего тарифного плана" />
      <set item="Sender" value="_ADD_VM2EMAIL_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="ActivateService_VM2EMAIL" sessionStorage="Memory" sessionLifetime="120">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="${SessionId}">
        <Item customer="${Sender}">
          <Service id="_VM2EMAIL_SERVICE_ID" action="#{if('${sServicePresents}'='1',8,2)}" needtariffication="0" enddate="" informOnImpossibility="1" sourcetypeid="26" userid="1" createrequest="1" externalsystemid="576">
            <Attribute name="email" value="#{substring-after('${sContent}',' ')}" />
          </Service>
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сообщение об ошибке согласованное с МТС." />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Сообщение об успешном создании заявки, согласованное с МТС" />
      <set item="Content" conditionEx="#{${dbresult}=320162}" value="Неверный формат e-mail адреса" />
      <set item="Sender" value="_ADD_VM2EMAIL_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="DeactivateService_VM2EMAIL" sessionStorage="Memory" sessionLifetime="120">
    <condition>
      <test item="${Recipient}" matches="^_ADD_VM2EMAIL_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^211740$" />
    </condition>
    <receiveTemplate>
      <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}">
          <Service id="_VM2EMAIL_SERVICE_ID" action="3" needtariffication="0" enddate="" informOnImpossibility="1" sourcetypeid="26" userid="1" createrequest="1" externalsystemid="576" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сообщение об ошибке согласованное с МТС" />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Сообщение об успешном создании заявки на удаление услуги, согласованное с МТС" />
      <set item="Sender" value="_ADD_VM2EMAIL_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="ActivateService_VM2EMAIL_ErrorInput">
    <condition>
      <test item="${Recipient}" matches="^_ADD_VM2EMAIL_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^21174.*$" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Запрос неверный" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Recipient" value="${customer}" />
      <set item="Sender" value="_ADD_VM2EMAIL_SERVICE_NUMBER" />
    </deliveryTemplate>
  </template>
</templateGroup>