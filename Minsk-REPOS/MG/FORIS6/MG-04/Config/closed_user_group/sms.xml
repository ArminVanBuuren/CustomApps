<templateGroup name="GroupManager">
  <macros>
    <define name="_ADD_TO_GROUP_NUMBER" value="5225" />
    <define name="_RESPONSE_INVITEE_NUMBER" value="5005" />
    <define name="_REMOVE_FROM_GROUP_NUMBER" value="5335" />
    <define name="_GET_MEMBER_LIST_NUMBER" value="5445" />
    <define name="_PRODUCT_TYPE_ID" value="#{document('..\..\config\closed_user_group\product_id.xml')/groups/group[@ussdcode='${Recipient}']/@product_id}" />
    <define name="_GROUP_TYPE_NAME" value="#{document('..\..\config\closed_user_group\product_id.xml')/groups/group[@ussdcode='${Recipient}']/@smscode}" />
    <define name="_GROUP_TO_PRODUCT_TYPE" value="#{document('..\..\config\closed_user_group\product_id.xml')/groups/group[@smscode='${sGroupType}']/@product_id}" />
    <define name="_CHECK_RECIPIENT_NUMBER" value="#{count(document('..\..\config\closed_user_group\product_id.xml')/groups/group[@ussdcode='${Recipient}'])}" />
  </macros>
  <template procedureName="DelFromGroup_USSD">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Заявка на удаление из группы зарегистрирована" />
      <set item="Sender" value="_REMOVE_FROM_GROUP_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate condition="//Item/@dbresult=320708">
      <set item="Content" value="Вы не состоите в группе" />
      <set item="Sender" value="_REMOVE_FROM_GROUP_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Ошибка удаления из группы" />
      <set item="Sender" value="_REMOVE_FROM_GROUP_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup3_CUGT_USSD" sessionStorage="Database" sessionLifetime="86400">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Приглашение в группу от ${sInviter}.Отправьте ДА или НЕТ на _RESPONSE_INVITEE_NUMBER" />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="InviteMember_Error" sessionStorage="Database">
    <condition>
      <test item="${Recipient}" matches="^_ADD_TO_GROUP_NUMBER$" />
      <test item="${Content}" matches="^\w+ \d{11}$" />
      <test item="@{SessionExists(InviteMember(${token1}))}" matches="^[Tt][Rr][Uu][Ee]$" />
    </condition>
    <receiveTemplate>
      <Message type="transfer_data" id="${guid}" session_id="${guid}">
        <Attribute name="Customer" value="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="В один момент времени может быть активно только одно приглашение в группу." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_ADD_TO_GROUP_NUMBER" />
      <set item="Recipient" value="${Customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="InviteMember" sessionStorage="Database" sessionLifetime="86400" onClean="GroupManager.AddToGroup_onClean">
    <condition>
      <test item="${Recipient}" matches="^_ADD_TO_GROUP_NUMBER$" />
      <test item="${Content}" matches="^\w+ \d{11}$" />
      <test item="@{SessionExists(InviteMember(${token1}))}" matches="^[Ff][Aa][Ll][Ss][Ee]$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="${guid}" session_id="@{setSessionId(InviteMember(${token1}))}">
        @{store(sInviter,${sender})}
        @{store(sInvited,${token1})}
        @{store(sGroupType,#{toupper('${token0}')})}
        <Item customer="${sInviter}" action="3">
          <Attribute name="groupmember" value="${sInvited}" />
          <Attribute name="index" value="_GROUP_TO_PRODUCT_TYPE" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}" call="CheckGroupBoundary">
      <set item="Content" value="Initiator='${sInviter}', Invitee='${sInvited}', GroupType='${sGroupType}'" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="${sInviter}" />
      <set item="Recipient" value="_ADD_TO_GROUP_NUMBER" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже." />
      <set item="Content" conditionEx="#{${dbresult}=320205}" value="Согласованное с МТС, сообщение о том, что услуга уже подключена." />
      <set item="Content" conditionEx="#{${dbresult}=320707}" value="Согласованное с МТС, сообщение о том, что у пользователей разные регионы." />
      <set item="Content" conditionEx="#{${dbresult}=320203}" value="Согласованное с МТС, сообщение о том, что существует открытая заявка." />
      <set item="Content" conditionEx="#{${dbresult}=320194}" value="Согласованное с МТС, сообщение о том, что операции с группой запрещены." />
      <set item="Content" conditionEx="#{${dbresult}=320204}" value="Согласованное с МТС, сообщение о том, что у пользователя нет услуги или неизвестный тип группы." />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Согласованное с МТС, сообщение о том, что недостаточно средств." />
      <set item="Content" conditionEx="#{${dbresult}=320705}" value="Согласованное с МТС, сообщение о том, что достигнут предел числа участников группы." />
      <set item="Content" conditionEx="#{${dbresult}=320706}" value="Согласованное с МТС, сообщение о том, что пользователь уже включен в другую группу." />
      <set item="Content" conditionEx="#{${dbresult}=320341}" value="Согласованное с МТС, сообщение о том, что неизвестный номер телефона." />
      <set item="Content" conditionEx="#{${dbresult}=320347}" value="Согласованное с МТС, сообщение о том, что пользователь находится в блокировке." />
      <set item="Content" conditionEx="#{${dbresult}=330003}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашающего не позволяет создавать группу." />
      <set item="Content" conditionEx="#{${dbresult}=330004}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашаемого не позволяет вступать в группу." />
      <set item="Content" conditionEx="#{${dbresult}=330005}" value="Согласованное с МТС, сообщение о том, что для вступления в группу необходимо сменить тарифный план." />
      <set item="Content" conditionEx="#{${dbresult}=330006}" value="Согласованное с МТС, сообщение о том, что User group type was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330007}" value="Согласованное с МТС, сообщение о том, что Customer cannot change user group." />
      <set item="Content" conditionEx="#{${dbresult}=330008}" value="Согласованное с МТС, сообщение о том, что Foreign customer is not supported by this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330009}" value="Согласованное с МТС, сообщение о том, что User group was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330010}" value="Согласованное с МТС, сообщение о том, что Inviter tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330011}" value="Согласованное с МТС, сообщение о том, что Member tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330012}" value="Согласованное с МТС, сообщение о том, что A minimun number of group members was achieved. No one can be deleted." />
      <set item="Content" conditionEx="#{${dbresult}=330013}" value="Согласованное с МТС, сообщение о том, что A member can be added to the group only after invitation." />
      <set item="Sender" value="_ADD_TO_GROUP_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="CheckGroupBoundary" sessionStorage="Database">
    <condition>
      <test item="0" matches="^1$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="${guid}" session_id="${session_id}">
        <Item customer="${sInviter}" action="2">
          <Attribute name="groupmember" value="${sInvited}" />
          <Attribute name="index" value="_GROUP_TO_PRODUCT_TYPE" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and (${count}&lt;number('${maxcount}') or '${maxcount}'='')}" terminating="false">
      <set item="Content" value="Текст приглашения новому абоненту, согласованный с МТС." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_ADD_TO_GROUP_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and (${count}&lt;number('${maxcount}') or '${maxcount}'='')}">
      <set item="Content" value="Абоненту ${sInvited} отправлено приглашение в группу" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_ADD_TO_GROUP_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Новый участник не может быть добавлен, т.к. достигнут предел числа участников группы, составляющий ${maxcount}." />
      <set item="Sender" value="_ADD_TO_GROUP_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже." />
      <set item="Content" conditionEx="#{${dbresult}=320205}" value="Согласованное с МТС, сообщение о том, что услуга уже подключена." />
      <set item="Content" conditionEx="#{${dbresult}=320707}" value="Согласованное с МТС, сообщение о том, что у пользователей разные регионы." />
      <set item="Content" conditionEx="#{${dbresult}=320203}" value="Согласованное с МТС, сообщение о том, что существует открытая заявка." />
      <set item="Content" conditionEx="#{${dbresult}=320194}" value="Согласованное с МТС, сообщение о том, что операции с группой запрещены." />
      <set item="Content" conditionEx="#{${dbresult}=320204}" value="Согласованное с МТС, сообщение о том, что у пользователя нет услуги или неизвестный тип группы." />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Согласованное с МТС, сообщение о том, что недостаточно средств." />
      <set item="Content" conditionEx="#{${dbresult}=320705}" value="Согласованное с МТС, сообщение о том, что достигнут предел числа участников группы." />
      <set item="Content" conditionEx="#{${dbresult}=320706}" value="Согласованное с МТС, сообщение о том, что пользователь уже включен в другую группу." />
      <set item="Content" conditionEx="#{${dbresult}=320341}" value="Согласованное с МТС, сообщение о том, что неизвестный номер телефона." />
      <set item="Content" conditionEx="#{${dbresult}=320347}" value="Согласованное с МТС, сообщение о том, что пользователь находится в блокировке." />
      <set item="Content" conditionEx="#{${dbresult}=330003}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашающего не позволяет создавать группу." />
      <set item="Content" conditionEx="#{${dbresult}=330004}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашаемого не позволяет вступать в группу." />
      <set item="Content" conditionEx="#{${dbresult}=330005}" value="Согласованное с МТС, сообщение о том, что для вступления в группу необходимо сменить тарифный план." />
      <set item="Content" conditionEx="#{${dbresult}=330006}" value="Согласованное с МТС, сообщение о том, что User group type was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330007}" value="Согласованное с МТС, сообщение о том, что Customer cannot change user group." />
      <set item="Content" conditionEx="#{${dbresult}=330008}" value="Согласованное с МТС, сообщение о том, что Foreign customer is not supported by this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330009}" value="Согласованное с МТС, сообщение о том, что User group was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330010}" value="Согласованное с МТС, сообщение о том, что Inviter tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330011}" value="Согласованное с МТС, сообщение о том, что Member tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330012}" value="Согласованное с МТС, сообщение о том, что A minimun number of group members was achieved. No one can be deleted." />
      <set item="Content" conditionEx="#{${dbresult}=330013}" value="Согласованное с МТС, сообщение о том, что A member can be added to the group only after invitation." />
      <set item="Sender" value="_ADD_TO_GROUP_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddToGroup_onClean">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <deliveryTemplate terminating="false">
      <set item="Content" value="Абонент ${sInvited} не подтвердил участие в группе. Ваше приглашение аннулировано." />
      <set item="Recipient" value="${sInviter}" />
      <set item="Sender" value="_ADD_TO_GROUP_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Вы не подтвердили участие в группе. Приглашение аннулировано." />
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_ADD_TO_GROUP_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="InviteMember_InvalidFormat">
    <condition>
      <test item="${Recipient}" matches="^_ADD_TO_GROUP_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message type="transfer_data" id="${guid}" session_id="@{newGuid}">
        <Attribute name="Customer" value="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Сообщение о неверном формате запроса на добавление в группу, согласованное с МТС." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_ADD_TO_GROUP_NUMBER" />
      <set item="Recipient" value="${Customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="AcceptInviteResponse" sessionStorage="Database">
    <condition>
      <test item="${Recipient}" matches="^_RESPONSE_INVITEE_NUMBER$" />
      <test item="${Content}" matches="^\s*[Yy][Ee][Ss]\s*$" />
      <test item="@{SessionExists(InviteMember(${Sender}))}" matches="^[Tt]rue$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="${guid}" session_id="@{setSessionId(InviteMember(${Sender}))}">
        <Item customer="${sInviter}" action="2">
          <Attribute name="groupmember" value="${Sender}" />
          <Attribute name="index" value="_GROUP_TO_PRODUCT_TYPE" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and (${count}&lt;number('${maxcount}') or '${maxcount}'='')}" call="AddMember">
      <set item="Content" value="Initiator='${sInviter}', Invitee='${sInvited}', GroupType='${sGroupType}'" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Новый участник не может быть добавлен, т.к. достигнут предел числа участников группы, составляющий ${maxcount}." />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1}">
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже." />
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже." />
      <set item="Content" conditionEx="#{${dbresult}=320205}" value="Согласованное с МТС, сообщение о том, что услуга уже подключена." />
      <set item="Content" conditionEx="#{${dbresult}=320707}" value="Согласованное с МТС, сообщение о том, что у пользователей разные регионы." />
      <set item="Content" conditionEx="#{${dbresult}=320203}" value="Согласованное с МТС, сообщение о том, что существует открытая заявка." />
      <set item="Content" conditionEx="#{${dbresult}=320194}" value="Согласованное с МТС, сообщение о том, что операции с группой запрещены." />
      <set item="Content" conditionEx="#{${dbresult}=320204}" value="Согласованное с МТС, сообщение о том, что у пользователя нет услуги или неизвестный тип группы." />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Согласованное с МТС, сообщение о том, что недостаточно средств." />
      <set item="Content" conditionEx="#{${dbresult}=320705}" value="Согласованное с МТС, сообщение о том, что достигнут предел числа участников группы." />
      <set item="Content" conditionEx="#{${dbresult}=320706}" value="Согласованное с МТС, сообщение о том, что пользователь уже включен в другую группу." />
      <set item="Content" conditionEx="#{${dbresult}=320341}" value="Согласованное с МТС, сообщение о том, что неизвестный номер телефона." />
      <set item="Content" conditionEx="#{${dbresult}=320347}" value="Согласованное с МТС, сообщение о том, что пользователь находится в блокировке." />
      <set item="Content" conditionEx="#{${dbresult}=330003}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашающего не позволяет создавать группу." />
      <set item="Content" conditionEx="#{${dbresult}=330004}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашаемого не позволяет вступать в группу." />
      <set item="Content" conditionEx="#{${dbresult}=330005}" value="Согласованное с МТС, сообщение о том, что для вступления в группу необходимо сменить тарифный план." />
      <set item="Content" conditionEx="#{${dbresult}=330006}" value="Согласованное с МТС, сообщение о том, что User group type was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330007}" value="Согласованное с МТС, сообщение о том, что Customer cannot change user group." />
      <set item="Content" conditionEx="#{${dbresult}=330008}" value="Согласованное с МТС, сообщение о том, что Foreign customer is not supported by this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330009}" value="Согласованное с МТС, сообщение о том, что User group was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330010}" value="Согласованное с МТС, сообщение о том, что Inviter tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330011}" value="Согласованное с МТС, сообщение о том, что Member tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330012}" value="Согласованное с МТС, сообщение о том, что A minimun number of group members was achieved. No one can be deleted." />
      <set item="Content" conditionEx="#{${dbresult}=330013}" value="Согласованное с МТС, сообщение о том, что A member can be added to the group only after invitation." />
      <set item="Content" value="${Content} Приглашение аннулировано." />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="AddMember" sessionStorage="Database">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="${guid}" session_id="${session_id}">
        <!-- Item customer="${sInviter}" action="0" -->
        <Item customer="${sInvited}" action="0">
          <!-- Attribute name="groupmember" value="${sInvited}" / -->
          <Attribute name="groupmember" value="${sInviter}" />
          <Attribute name="index" value="_GROUP_TO_PRODUCT_TYPE" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}" terminating="false">
      <set item="Content" value="Абонент ${sInvited} подтвердил участие в группе." />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Recipient" value="${sInviter}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Вы подтвердили участие в группе." />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=-1}">
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже." />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" conditionEx="#{${dbresult}=320205}" value="Согласованное с МТС, сообщение о том, что услуга уже подключена." />
      <set item="Content" conditionEx="#{${dbresult}=320707}" value="Согласованное с МТС, сообщение о том, что у пользователей разные регионы." />
      <set item="Content" conditionEx="#{${dbresult}=320203}" value="Согласованное с МТС, сообщение о том, что существует открытая заявка." />
      <set item="Content" conditionEx="#{${dbresult}=320194}" value="Согласованное с МТС, сообщение о том, что операции с группой запрещены." />
      <set item="Content" conditionEx="#{${dbresult}=320204}" value="Согласованное с МТС, сообщение о том, что у пользователя нет услуги или неизвестный тип группы." />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Согласованное с МТС, сообщение о том, что недостаточно средств." />
      <set item="Content" conditionEx="#{${dbresult}=320705}" value="Согласованное с МТС, сообщение о том, что достигнут предел числа участников группы." />
      <set item="Content" conditionEx="#{${dbresult}=320706}" value="Согласованное с МТС, сообщение о том, что пользователь уже включен в другую группу." />
      <set item="Content" conditionEx="#{${dbresult}=320341}" value="Согласованное с МТС, сообщение о том, что неизвестный номер телефона." />
      <set item="Content" conditionEx="#{${dbresult}=320347}" value="Согласованное с МТС, сообщение о том, что пользователь находится в блокировке." />
      <set item="Content" conditionEx="#{${dbresult}=330003}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашающего не позволяет создавать группу." />
      <set item="Content" conditionEx="#{${dbresult}=330004}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашаемого не позволяет вступать в группу." />
      <set item="Content" conditionEx="#{${dbresult}=330005}" value="Согласованное с МТС, сообщение о том, что для вступления в группу необходимо сменить тарифный план." />
      <set item="Content" conditionEx="#{${dbresult}=330006}" value="Согласованное с МТС, сообщение о том, что User group type was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330007}" value="Согласованное с МТС, сообщение о том, что Customer cannot change user group." />
      <set item="Content" conditionEx="#{${dbresult}=330008}" value="Согласованное с МТС, сообщение о том, что Foreign customer is not supported by this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330009}" value="Согласованное с МТС, сообщение о том, что User group was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330010}" value="Согласованное с МТС, сообщение о том, что Inviter tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330011}" value="Согласованное с МТС, сообщение о том, что Member tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330012}" value="Согласованное с МТС, сообщение о том, что A minimun number of group members was achieved. No one can be deleted." />
      <set item="Content" conditionEx="#{${dbresult}=330013}" value="Согласованное с МТС, сообщение о том, что A member can be added to the group only after invitation." />
      <set item="Content" value="${Content} Приглашение аннулировано." />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Recipient" value="${sInvited}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="RejectInviteResponse" sessionStorage="Database">
    <condition>
      <test item="${Recipient}" matches="^_RESPONSE_INVITEE_NUMBER$" />
      <test item="${Content}" matches="^\s*[Nn][Oo]\s*$" />
      <test item="@{SessionExists(InviteMember(${Sender}))}" matches="^[Tt][Rr][Uu][Ee]$" />
    </condition>
    <receiveTemplate>
      <Message type="transfer_data" initiator="smscon" id="${guid}" session_id="@{setSessionId(InviteMember(${Sender}))}" />
    </receiveTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Абонент ${sInvited} отклонил приглашение в группу. Приглашение аннулировано." />
      <set item="Recipient" value="${sInviter}" />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Вы отклонили приглашение в группу. Приглашение аннулировано." />
      <set item="Recipient" value="${sInvited}" />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Response_NoInvitation">
    <condition>
      <test item="${Recipient}" matches="^_RESPONSE_INVITEE_NUMBER$" />
      <test item="@{SessionExists(InviteMember(${Sender}))}" matches="^[Ff]alse$" />
    </condition>
    <receiveTemplate>
      <Message type="transfer_data" id="${guid}" session_id="@{newGuid}">
        <Attribute name="Customer" value="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="У вас нет активных приглашений." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="Response_InvalidFormat">
    <condition>
      <test item="${Recipient}" matches="^_RESPONSE_INVITEE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message type="transfer_data" id="${guid}" session_id="@{newGuid}">
        <Attribute name="Customer" value="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Сообщение о неверном формате сообщения с ответом на приглашение, согласованное с МТС." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_RESPONSE_INVITEE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="RemoveMemeber">
    <condition>
      <test item="${Recipient}" matches="^_REMOVE_FROM_GROUP_NUMBER$" />
      <test item="${Content}" matches="^\w+$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="${guid}" session_id="${guid}">
        <Item customer="${Sender}" action="1">
          <Attribute name="index" value="_PRODUCT_TYPE_ID" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Вы удалены из группы." />
      <set item="Sender" value="_REMOVE_FROM_GROUP_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже." />
      <set item="Content" conditionEx="#{${dbresult}=320205}" value="Согласованное с МТС, сообщение о том, что услуга уже подключена." />
      <set item="Content" conditionEx="#{${dbresult}=320707}" value="Согласованное с МТС, сообщение о том, что у пользователей разные регионы." />
      <set item="Content" conditionEx="#{${dbresult}=320203}" value="Согласованное с МТС, сообщение о том, что существует открытая заявка." />
      <set item="Content" conditionEx="#{${dbresult}=320194}" value="Согласованное с МТС, сообщение о том, что операции с группой запрещены." />
      <set item="Content" conditionEx="#{${dbresult}=320204}" value="Согласованное с МТС, сообщение о том, что у пользователя нет услуги или неизвестный тип группы." />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Согласованное с МТС, сообщение о том, что недостаточно средств." />
      <set item="Content" conditionEx="#{${dbresult}=320705}" value="Согласованное с МТС, сообщение о том, что достигнут предел числа участников группы." />
      <set item="Content" conditionEx="#{${dbresult}=320706}" value="Согласованное с МТС, сообщение о том, что пользователь уже включен в другую группу." />
      <set item="Content" conditionEx="#{${dbresult}=320341}" value="Согласованное с МТС, сообщение о том, что неизвестный номер телефона." />
      <set item="Content" conditionEx="#{${dbresult}=320347}" value="Согласованное с МТС, сообщение о том, что пользователь находится в блокировке." />
      <set item="Content" conditionEx="#{${dbresult}=330003}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашающего не позволяет создавать группу." />
      <set item="Content" conditionEx="#{${dbresult}=330004}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашаемого не позволяет вступать в группу." />
      <set item="Content" conditionEx="#{${dbresult}=330005}" value="Согласованное с МТС, сообщение о том, что для вступления в группу необходимо сменить тарифный план." />
      <set item="Content" conditionEx="#{${dbresult}=330006}" value="Согласованное с МТС, сообщение о том, что User group type was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330007}" value="Согласованное с МТС, сообщение о том, что Customer cannot change user group." />
      <set item="Content" conditionEx="#{${dbresult}=330008}" value="Согласованное с МТС, сообщение о том, что Foreign customer is not supported by this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330009}" value="Согласованное с МТС, сообщение о том, что User group was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330010}" value="Согласованное с МТС, сообщение о том, что Inviter tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330011}" value="Согласованное с МТС, сообщение о том, что Member tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330012}" value="Согласованное с МТС, сообщение о том, что A minimun number of group members was achieved. No one can be deleted." />
      <set item="Content" conditionEx="#{${dbresult}=330013}" value="Согласованное с МТС, сообщение о том, что A member can be added to the group only after invitation." />
      <set item="Sender" value="_REMOVE_FROM_GROUP_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="RemoveMemeber_InvalidFormat">
    <condition>
      <test item="${Recipient}" matches="^_REMOVE_FROM_GROUP_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message type="transfer_data" id="${guid}" session_id="@{newGuid}">
        <Attribute name="Customer" value="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Сообщение о неверном формате запроса на выход из группы, согласованное с МТС." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_REMOVE_FROM_GROUP_NUMBER" />
      <set item="Recipient" value="${Customer}" />
    </deliveryTemplate>
  </template>
  <template procedureName="GetMemberList">
    <condition>
      <test item="${Recipient}" matches="^_GET_MEMBER_LIST_NUMBER$" />
      <test item="${Content}" matches="^\w+$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="smscon" id="${guid}" session_id="@{newguid}">
        <Item customer="${Sender}" action="2">
          <Attribute name="index" value="_PRODUCT_TYPE_ID" />
          <Attribute name="groupmember" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Список участников:${grouplisting}" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_GET_MEMBER_LIST_NUMBER" />
      <set item="Recipient" value="${Customer}" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="Сервис временно недоступен. Пожалуйста, повторите попытку позже." />
      <set item="Content" conditionEx="#{${dbresult}=320205}" value="Согласованное с МТС, сообщение о том, что услуга уже подключена." />
      <set item="Content" conditionEx="#{${dbresult}=320707}" value="Согласованное с МТС, сообщение о том, что у пользователей разные регионы." />
      <set item="Content" conditionEx="#{${dbresult}=320203}" value="Согласованное с МТС, сообщение о том, что существует открытая заявка." />
      <set item="Content" conditionEx="#{${dbresult}=320194}" value="Согласованное с МТС, сообщение о том, что операции с группой запрещены." />
      <set item="Content" conditionEx="#{${dbresult}=320204}" value="Согласованное с МТС, сообщение о том, что у пользователя нет услуги или неизвестный тип группы." />
      <set item="Content" conditionEx="#{${dbresult}=320191}" value="Согласованное с МТС, сообщение о том, что недостаточно средств." />
      <set item="Content" conditionEx="#{${dbresult}=320705}" value="Согласованное с МТС, сообщение о том, что достигнут предел числа участников группы." />
      <set item="Content" conditionEx="#{${dbresult}=320706}" value="Согласованное с МТС, сообщение о том, что пользователь уже включен в другую группу." />
      <set item="Content" conditionEx="#{${dbresult}=320341}" value="Согласованное с МТС, сообщение о том, что неизвестный номер телефона." />
      <set item="Content" conditionEx="#{${dbresult}=320347}" value="Согласованное с МТС, сообщение о том, что пользователь находится в блокировке." />
      <set item="Content" conditionEx="#{${dbresult}=330003}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашающего не позволяет создавать группу." />
      <set item="Content" conditionEx="#{${dbresult}=330004}" value="Согласованное с МТС, сообщение о том, что тарифный план приглашаемого не позволяет вступать в группу." />
      <set item="Content" conditionEx="#{${dbresult}=330005}" value="Согласованное с МТС, сообщение о том, что для вступления в группу необходимо сменить тарифный план." />
      <set item="Content" conditionEx="#{${dbresult}=330006}" value="Согласованное с МТС, сообщение о том, что User group type was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330007}" value="Согласованное с МТС, сообщение о том, что Customer cannot change user group." />
      <set item="Content" conditionEx="#{${dbresult}=330008}" value="Согласованное с МТС, сообщение о том, что Foreign customer is not supported by this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330009}" value="Согласованное с МТС, сообщение о том, что User group was not found." />
      <set item="Content" conditionEx="#{${dbresult}=330010}" value="Согласованное с МТС, сообщение о том, что Inviter tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330011}" value="Согласованное с МТС, сообщение о том, что Member tariff plan is not allowed for this user group type." />
      <set item="Content" conditionEx="#{${dbresult}=330012}" value="Согласованное с МТС, сообщение о том, что A minimun number of group members was achieved. No one can be deleted." />
      <set item="Content" conditionEx="#{${dbresult}=330013}" value="Согласованное с МТС, сообщение о том, что A member can be added to the group only after invitation." />
      <set item="Sender" value="_GET_MEMBER_LIST_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
  <template procedureName="GetMemberList_InvalidFormat">
    <condition>
      <test item="${Recipient}" matches="^_GET_MEMBER_LIST_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message type="transfer_data" id="${guid}" session_id="@{newGuid}">
        <Attribute name="Customer" value="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Сообщение о неверном формате запроса списка группы, согласованное с МТС." />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_GET_MEMBER_LIST_NUMBER" />
      <set item="Recipient" value="${Customer}" />
    </deliveryTemplate>
  </template>
</templateGroup>