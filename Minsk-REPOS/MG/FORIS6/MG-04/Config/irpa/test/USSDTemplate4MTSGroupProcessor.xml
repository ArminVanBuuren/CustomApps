<templates>
  #include "C:\FORIS\Messaging Gateway\config\closed_user_group\ussd.xml"
  <macros>
    <define name="_USSD_SERVICE_NUMBER" value="580" />
    <define name="_INVITE_OPERATION_CODE" value="0" />
    <define name="_DEL_OPERATION_CODE" value="1" />
    <define name="_LIST_OPERATION_CODE" value="2" />
    <define name="_DUET_INVITE_CODE" value="001" />
    <define name="_DUET_DEL_CODE" value="002" />
    <define name="_DUET_LIST_CODE" value="003" />
    <define name="_USSD_NUMBER_MAXIDUET" value="138" />
    <!-- Udalit' eto Dialog	
    <define name="_MAXIDUET_INVITE_CODE" value="0" />
-->
    <define name="_MAXIDUET_DEL_CODE" value="2" />
    <define name="_MAXIDUET_LIST_CODE" value="1" />
    <define name="_SMSCON" value="SMSCON_01_01" />
  </macros>
  <template procedureName="GetIndividualBillingPeriodDate">
    <condition>
      <test item="${Recipient}" matches="^12345$" />
      <test item="${Content}" matches="^12345$" />
    </condition>
    <receiveTemplate>
      <Message type="getindividualbillingperioddate" initiator="ussd" id="${guid}" session_id="${guid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Данный запрос сейчас не может быть выполнен. Повторите пожалуйста позже." />
      <set item="Content" conditionEx="#{${dbresult}=0}" value="Дата списания ежемесячной платы - #{substring('${IndividualBillingPeriodDate}',1,2)} число месяца" />
      <set item="Content" conditionEx="#{${dbresult}=330161}" value="Дата списания ежемесячной платы за услуги и опции будет установлена после активации номера" />
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>
  <!--
<template procedureName="MTSGroupDialogClose">
        <condition>
            <test item="${Recipient}" matches="^138$" />
        </condition>                                    
        <receiveTemplate>
           <Message id="${guid}" session_id="@{newGuid}">
               <Item customer="${Sender}" />
           </Message>
        </receiveTemplate>
        <deliveryTemplate direction="input">            
            <set item="Content"   value="Услуга больше недоступна." />
            <set item="Sender" value="138" />
            <set item="Recipient" value="${Customer}" />
            <set item="Encoding" value="unicodefffe" />
        </deliveryTemplate>
  </template>  -->
  <!-- Mi -->
  <template procedureName="AddToGroup1" sessionStorage="Database" sessionLifetime="86400" onClean="AddToGroup_onClean">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^_INVITE_OPERATION_CODE\*[0-9]{11}$" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="ussd" id="@{newGuid}" session_id="@{setSessionId(MTSGROUP7#{substring('${token1}',string-length('${token1}')-9)})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="1" />
          <Attribute name="checkblocks" value="1" />
          <Attribute name="grouptype" value="@{switch(${token0}|UNDEFINED,_INVITE_OPERATION_CODE|MTSGROUP,_DUET_INVITE_CODE|DUET)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'='${Customer}'}">
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="U abonenta ${sInvited} est vashe aktivnoe priglashenie.Chtoby prinyat ego abonent ${sInvited} dolgen otpravit SMS s slovom DA na nomer 5800" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'!='${Customer}'}">
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="U abonenta ${sInvited} est aktivnoe priglashenie v druguju gruppu. Povtorite zapros pozzhe" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${Customer}'='7#{substring('${session_id}',string-length('${session_id}')-9)}'}">
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="Nomer priglashennogo abonenta ${Customer} sovpadaet s vashim. Zayvka ne prinyata" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Vasha zajavka prinjata" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="ascii" />
      <set conditionEx="0@{store(sAlreadyInvited,1)}" />
      <set conditionEx="0@{store(sInviter,${Customer})}" />
      <set conditionEx="0@{store(sInvited,7#{substring('${session_id}',string-length('${session_id}')-9)})}" />
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set conditionEx="0@{store(sGroupType,${grouptype})}" />
    </deliveryTemplate>
    <deliveryTemplate connector="_SMSCON" />
  </template>
  <!-- DUET  -->
  <template procedureName="AddToGroup1_DUET" sessionStorage="Database" sessionLifetime="86400" onClean="AddToGroup_onClean">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^_DUET_INVITE_CODE\*[0-9]{11}$" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="ussd" id="@{newGuid}" session_id="@{setSessionId(MTSGROUP7#{substring('${token1}',string-length('${token1}')-9)})}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
          <Attribute name="grouptype" value="@{switch(${token0}|UNDEFINED,_INVITE_OPERATION_CODE|MTSGROUP,_DUET_INVITE_CODE|DUET)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'='${Customer}'}">
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="U abonenta ${sInvited} est vashe aktivnoe priglashenie.Chtoby prinyat ego abonent ${sInvited} dolgen otpravit SMS s slovom DA na nomer 5800" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'!='${Customer}'}">
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="У абонента ${sInvited} есть активное приглашение в другую группу" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" conditionEx="#{'${Customer}'='7#{substring('${session_id}',string-length('${session_id}')-9)}'}">
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Content" value="Номер приглашаемого абонента ${Customer} совпадает с вашим." />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Ваша заявка принята" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
      <set conditionEx="0@{store(sAlreadyInvited,1)}" />
      <set conditionEx="0@{store(sInviter,${Customer})}" />
      <set conditionEx="0@{store(sInvited,7#{substring('${session_id}',string-length('${session_id}')-9)})}" />
      <set conditionEx="0@{store(sTryCount,1)}" />
      <set conditionEx="0@{store(sGroupType,${grouptype})}" />
    </deliveryTemplate>
    <deliveryTemplate connector="_SMSCON" />
  </template>
  <!--Udalit' eto DIALOG
  <template procedureName="AddToGroup1_MAXIDUET" sessionStorage="Database" sessionLifetime="86400" onClean="AddToGroup_onClean">
        <condition>
            <test item="${Recipient}" matches="^_USSD_NUMBER_MAXIDUET$" />
            <test item="${Content}" matches="^_MAXIDUET_INVITE_CODE\*[0-9]{11}$" />
        </condition>         
        <receiveTemplate>
            <Message type="verificationrequest" initiator="ussd" id="@{newGuid}" session_id="@{setSessionId(MAXIDUET7#{substring('${token1}',string-length('${token1}')-9)})}">
                <Item customer="${Sender}">
                    <Attribute name="checkivrservice" value="0" />
                    <Attribute name="checkblocks" value="0" />
                    <Attribute name="grouptype" value="MAXIDUET" />
                </Item>
            </Message>
        </receiveTemplate>
        <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'='${Customer}'}">            
            <set item="Sender" value="_USSD_NUMBER_MAXIDUET" />
            <set item="Recipient" value="${Customer}" />
			<set item="Content"   value="У абонента ${sInvited} есть ваше активное приглашение" />
            <set item="Encoding" value="unicodefffe" />
        </deliveryTemplate>
        <deliveryTemplate direction="input" conditionEx="#{'${sAlreadyInvited}'!='' and '${sInviter}'!='${Customer}'}">    
            <set item="Sender" value="_USSD_NUMBER_MAXIDUET" />
            <set item="Recipient" value="${Customer}" />
	<set item="Content"   value="У абонента ${sInvited} есть активное приглашение в другую группу" />
            <set item="Encoding" value="unicodefffe" />
        </deliveryTemplate>
        <deliveryTemplate direction="input" conditionEx="#{'${Customer}'='7#{substring('${session_id}',string-length('${session_id}')-9)}'}">
             <set item="Sender" value="_USSD_NUMBER_MAXIDUET" />
             <set item="Recipient" value="${Customer}" />
             <set item="Content"   value="Номер приглашаемого абонента ${Customer} совпадает с вашим." />
             <set item="Encoding" value="unicodefffe" />
             <set conditionEx="0@{freeSession}"  /> 
        </deliveryTemplate>        
        <deliveryTemplate direction="input" terminating="false">            
	<set item="Content"   value="Ваша заявка принята" />
            <set item="Sender" value="_USSD_NUMBER_MAXIDUET" />
            <set item="Recipient" value="${Customer}" />
            <set item="Encoding" value="unicodefffe" />
            <set conditionEx="0@{store(sAlreadyInvited,1)}" />
            <set conditionEx="0@{store(sInviter,${Customer})}" />
            <set conditionEx="0@{store(sInvited,7#{substring('${session_id}',string-length('${session_id}')-9)})}" />
            <set conditionEx="0@{store(sTryCount,1)}" />
            <set conditionEx="0@{store(sGroupType,${grouptype})}" />
        </deliveryTemplate>
        <deliveryTemplate connector="_SMSCON" />
  </template>    
 -->
  <template procedureName="AddToGroup_onClean" sessionStorage="Database">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message id="@{newGuid}" session_id="${SessionId}" />
    </receiveTemplate>
    <deliveryTemplate connector="_SMSCON" />
  </template>
  <!-- Mi -->
  <template procedureName="ListOfGroup">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^_LIST_OPERATION_CODE$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="@{switch(${Content}|-1,_LIST_OPERATION_CODE|44822,_DUET_LIST_CODE|44824)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Vasha zajavka prinjata" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate connector="_SMSCON" />
  </template>
  <!-- DUET -->
  <template procedureName="ListOfGroup_DUET">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^_DUET_LIST_CODE$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="@{switch(${Content}|-1,_LIST_OPERATION_CODE|44822,_DUET_LIST_CODE|44824)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Ваша заявка принята" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate connector="_SMSCON" />
  </template>
  <!-- Begin DIALOG Prosmotr -->
  <template procedureName="ListOfGroup_MAXIDUET">
    <condition>
      <test item="${Recipient}" matches="^_USSD_NUMBER_MAXIDUET$" />
      <test item="${Content}" matches="^_MAXIDUET_LIST_CODE$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="2">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="@{switch(${Content}|-1,_LIST_OPERATION_CODE|3,_DUET_LIST_CODE|4,_MAXIDUET_LIST_CODE|5)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Ваша заявка принята" />
      <set item="Sender" value="_USSD_NUMBER_MAXIDUET" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate connector="_SMSCON" />
  </template>
  <!-- END Dialog Prosmotr-->
  <!-- Mi  -->
  <template procedureName="DelFromGroup">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^_DEL_OPERATION_CODE$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="1">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="@{switch(${Content}|-1,_DEL_OPERATION_CODE|3,_DUET_DEL_CODE|4)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Vasha zajavka prinjata" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="ascii" />
    </deliveryTemplate>
    <deliveryTemplate connector="_SMSCON" />
  </template>
  <!-- DUET -->
  <template procedureName="DelFromGroup_DUET">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
      <test item="${Content}" matches="^_DUET_DEL_CODE$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="1">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="@{switch(${Content}|-1,_DEL_OPERATION_CODE|3,_DUET_DEL_CODE|4)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Ваша заявка принята" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate connector="_SMSCON" />
  </template>
  <!-- Begin DIALOG Udalenie -->
  <template procedureName="DelFromGroup_MAXIDUET">
    <condition>
      <test item="${Recipient}" matches="^_USSD_NUMBER_MAXIDUET$" />
      <test item="${Content}" matches="^_MAXIDUET_DEL_CODE$" />
    </condition>
    <receiveTemplate>
      <Message type="customergroup" initiator="ussd" id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" action="1">
          <Attribute name="groupmember" value="0" />
          <Attribute name="index" value="@{switch(${Content}|-1,_DEL_OPERATION_CODE|3,_DUET_DEL_CODE|4,_MAXIDUET_DEL_CODE|5)}" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Ваша заявка принята" />
      <set item="Sender" value="_USSD_NUMBER_MAXIDUET" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate connector="_SMSCON" />
  </template>
  <!-- End DIALOG Udalenie-->
  <!-- Begin Ohibka Dialog -->
  <template procedureName="MAXIDUETSyntaxError1">
    <condition>
      <test item="${Recipient}" matches="^_USSD_NUMBER_MAXIDUET" />
    </condition>
    <receiveTemplate>
      <Message type="verificationrequest" initiator="ussd" id="@{newGuid}" session_id="${SessionId}">
        <Item customer="${Sender}">
          <Attribute name="checkivrservice" value="0" />
          <Attribute name="checkblocks" value="0" />
        </Item>
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input" terminating="false">
      <set item="Content" value="Ваша заявка принята. Ждите ответа по смс." />
      <set item="Sender" value="_USSD_NUMBER_MAXIDUET" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
    <deliveryTemplate connector="_SMSCON" />
  </template>
  <!--End Ohibka DIALOG-->
  <!-- Mi  -->
  <template procedureName="MTSGroupSyntaxError">
    <condition>
      <test item="${Recipient}" matches="^_USSD_SERVICE_NUMBER$" />
    </condition>
    <receiveTemplate>
      <Message id="${guid}" session_id="@{newGuid}">
        <Item customer="${Sender}" />
      </Message>
    </receiveTemplate>
    <deliveryTemplate direction="input">
      <set item="Content" value="Ошибка в запросе, создайте запрос в формате: *_USSD_SERVICE_NUMBER*код*7YYYXXXXXXX#" />
      <set item="Sender" value="_USSD_SERVICE_NUMBER" />
      <set item="Recipient" value="${Customer}" />
      <set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
  </template>
</templates>