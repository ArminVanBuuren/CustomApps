<?xml version="1.0" encoding="utf-8"?>

<templates connector="SMS">

	<!-- Запрос баланса через SMS    -->
	<template procedureName="SMS_Balans_new">
	<condition>
			<!--<test item="${Sender}" matches="^(375297001003|375297776319)$" /> -->
			<test item="${Recipient}" matches="^(087011|088011)$" />
        </condition>
       <receiveTemplate>
		<Message type="retrievecustomerdata" initiator="smscon" id="${guid}" session_id="@{newGuid}">
			<Item customer="${Sender}" subject='balance' datasource='state'></Item>
		</Message>
       </receiveTemplate>
       <deliveryTemplate>
		<set item="Content" value="К сожалению, произошла ошибка. Попробуйте еще раз." />
		<set item="Content" condition="//Item/@dbresult='1'" value="${rez}" />
		<set item="Sender" value="0870" />
		<set item="Recipient" value="${customer}" />
           	<set item="Encoding" value="unicodefffe" />
       </deliveryTemplate>
       </template>

	<!-- ОБЕЩАНЫЙ ПЛАТЕЖ -->
   <template procedureName="SMS_Check_GuaranteedPayment" sessionLifetime="1800" >
	<condition>
        <test item="${Recipient}" matches="^087013$" />
        <test item="${Content}" matches="^[0-9]{1,5}$" />
	</condition>
        <receiveTemplate>
          <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{setSessionId(@{newGuid})}">
            <Item customer="${Sender}" datasource="state">
                <Service id="guaranteedpayment" action="6">
                    <Attribute name="amount" value="${Content}" />
                    <Attribute name="currency" value="974" />
                    <Attribute name="init" value="6" /> 
					<Attribute name="p_addon" value="0" /> 
                </Service>
            </Item>
			@{store(sContent,${Content})}
          </Message>
       </receiveTemplate>
	<deliveryTemplate conditionEx="#{('${allowed}' = 1 and '${dbresult}'= 0) }" call="SMS_GuaranteedPayment">
		<set item="Sender" value="${customer}" />
		<set item="Content" value="${sContent}" />
		<set conditionEx="0@{freeSession}" />
       </deliveryTemplate>       
	<deliveryTemplate>
		<set item="Content" value="Извините, но данный запрос не может быть выполнен." />
		<set item="Content" condition="//Item/@dbresult=0" value="Обещанный платеж не может быть принят." />
		<set item="Content" condition="//Item/@dbresult=329203" value="${pending_str}" />
		<!--set item="Content" condition="//Item/@dbresult=320203" value="Регистрация запрещена - предыдущий обещанный платеж не оплачен." /-->
		<set item="Content" condition="//Item/@dbresult=320111" value="Превышена разрешенная сумма обещанного платежа в 10000 руб." />
		<set item="Content" condition="//Item/@dbresult=320114" value="${pending_str}" />	
		<set item="Content" condition="//Item/@dbresult=320115" value="${pending_str}" />	
		<set item="Content" condition="//Item/@dbresult=320116" value="${pending_str}" />
		<set item="Content" condition="//Item/@dbresult=320121" value="Платеж не может быть зарегистрирован." />
		<set item="Content" condition="//Item/@dbresult=320341" value="${pending_str}" />
	    <!--set item="Content" condition="//Item/@dbresult=320341" value="Нельзя ввести обещанный платеж на Вашем тарифном плане" /-->
		<set item="Content" condition="//Item/@dbresult=320203" value="${pending_str}" />
		<set item="Content" condition="//Item/@dbresult=100001" value="${pending_str}" />
		<set item="Encoding" value="unicodefffe" />
		<set item="Sender" value="0870" />
		<set item="Recipient" value="${customer}" />
		<set conditionEx="0@{freeSession}" />
       </deliveryTemplate>    
    </template>
    <template procedureName="SMS_GuaranteedPayment">
	<condition>
         <test item="0" matches="1" />
        </condition>
        <receiveTemplate>
          <Message type="serviceorder" initiator="smscon" id="${guid}" session_id="@{newGuid}">
            <Item customer="${Sender}" datasource="state">
                <Service id="guaranteedpayment" action="7">
                    <Attribute name="amount" value="${Content}" />
                    <Attribute name="currency" value="974" />
                    <Attribute name="init" value="6" /> 
					<Attribute name="p_addon" value="0" /> 
                </Service>
            </Item>
          </Message>
       </receiveTemplate>
       <deliveryTemplate>
            <set item="Content" value="Услуга не предоставляется для Вашего тарифного плана." />
            <set item="Content" condition="//Item/@dbresult=0" value="Обещанный платеж на сумму ${amount} р. принят.Отображение на балансе в течение 10 минут." />
            <set item="Content" condition="//Item/@dbresult=320203" value="Регистрация запрещена - предыдущий обещанный платеж не оплачен." />
            <set item="Content" condition="//Item/@dbresult=320111" value="Превышена разрешенная сумма обещанного платежа в 10000 руб." />
            <set item="Content" condition="//Item/@dbresult=320121" value="Платеж не может быть зарегистрирован." />
	    <set item="Content" condition="//Item/@dbresult=320341" value="Нельзя ввести обещанный платеж на Вашем тарифном плане" />
            <set item="Content" condition="//Item/@dbresult=-1" value="Обещанный платеж не может быть принят." />
            <set item="Encoding" value="unicodefffe" />
            <set item="Sender" value="0870" />
            <set item="Recipient" value="${customer}" />
       </deliveryTemplate>
    </template>
	<template procedureName="GuaranteedPayment_SyntaxError">
    <condition>
        <test item="${Recipient}" matches="^087013$" />
    </condition>
    <receiveTemplate>
		<Message> <Item customer="${Sender}" /> </Message>
	</receiveTemplate>
    <deliveryTemplate direction="input">
		<set item="Content" value="Пожалуйста, посылайте только цифры!"/>
		<set item="Sender" value="0870" />
		<set item="Recipient" value="${customer}"/>
		<set item="Encoding" value="unicodefffe" />
    </deliveryTemplate>
	</template>

<!-- ACHTUNG P-t-P -->

<template procedureName="check_p2p">
	<condition>
	<test item="${Recipient}" matches="^363$" />
	<test item="${token0}" matches="^\d{12}$" /> 
	<test item="${token1}" matches="^[0-9]{1,7}$" />
	</condition>

	<receiveTemplate>
		<Message type="serviceorder"  initiator="smscon" id="${guid}" session_id="@{newGuid}">
  			<Item customer="${Sender}">
    				<Service id="movepaymentrequest" action="5">
      					<Attribute name="receiver" value="${token0}" />
      					<Attribute name="amount" value="${token1}" />
    				</Service>
 			</Item>
		</Message>
       </receiveTemplate>

       <deliveryTemplate>
		<set item="Content" value="Perevod nevozmojen, povtorite pozje" />
		<set item="Content" condition="//Item/@dbresult='0'" value="Dlya podtwerjdeniya perevoda #{/Message/Item/Service/Attribute[@name='amount']/@value div 100} r. abonentu ${receiver} prishlite kod #{/Message/Item/Service/Attribute[@name='code']/@value} na nomer 363" />
		<set item="Content" condition="//Item/@dbresult='320060'" value="U Vas net prav dlya obrabotki zaprosa." />
		<set item="Content" condition="//Item/@dbresult='320705'" value="Takaya zajavka ne budet obrabotana" />
		<set item="Content" condition="//Item/@dbresult='320704'" value="Prediduschaja zajavka ne obrabotana, povtorite pozje" />	
		<set item="Content" condition="//Item/@dbresult='320666'" value="Nevernij kod awtorizatsii" />
		<set item="Content" condition="//Item/@dbresult='320999'" value="Srok dejstvija koda avtorizatsii istek" />
		<set item="Content" condition="//Item/@dbresult='320362'" value="U abonenta #{/Message/Item/Service/Attribute[@name='receiver']/@value} otkljuchena vozmozhnost priema P-t-P" />
		<set item="Content" condition="//Item/@dbresult='320703'" value="Nepravilno ukazan nomer poluchatelya" />
		<set item="Content" condition="//Item/@dbresult='320361'" value="Usluga zablokirovana, obratites v slujbu podderzhki" />
		<set item="Content" condition="//Item/@dbresult='320702'" value="Usluga zablokirovana, obratites v slujbu podderzhki" />
		<set item="Content" condition="//Item/@dbresult='320101'" value="Povtornij vvod informatsii, pojalujsta, sledujte instruktsii" />
		<set item="Content" condition="//Item/@dbresult='320714'" value="Dostignut predel chisla poluchatelej" />
		<set item="Content" condition="//Item/@dbresult='320710'" value="Slishkom malenkaja summa perevoda" />
		<set item="Content" condition="//Item/@dbresult='320701'" value="Slishkom bolshaja summa perevoda" />
		<set item="Content" condition="//Item/@dbresult='320711'" value="Ukazannaja summa previshaet limit perevodimih sredstv na segodnja" />
		<set item="Content" condition="//Item/@dbresult='320712'" value="Prevyshen limit dlya poluchatelya za sutki" />
		<set item="Content" condition="//Item/@dbresult='320191'" value="Na vashem schetu nedostatochno sredstv dlja perevoda abonentu #{/Message/Item/Service/Attribute[@name='receiver']/@value}" />
		<set item="Content" condition="//Item/@dbresult='320713'" value="Nomer poluchatelja sovpadaet s Vashim nomerom, pojalujsta, povtorite vvod" />
		<set item="Content" condition="//Item/@dbresult='320709'" value="Usluga zablokirovana, obratites w slujbu podderzhki" />
		<set item="Sender" value="363" />
		<set item="Recipient" value="${customer}" />
		<set item="Encoding" value="iso-8859-1" />
       </deliveryTemplate>

  </template>
    
  <template procedureName="confirm_p2p">
	<condition>
		<test item="${Recipient}" matches="^363$" />
		<test item="${Content}" matches="^[0-9]{4}$" />
	</condition>
	<receiveTemplate>
		<Message type="serviceorder"  initiator="smscon" id="${guid}" session_id="@{newGuid}">
  			<Item customer="${Sender}">
    				<Service id="movepaymentacceptance" action="5">
      					<Attribute name="code" value="${Content}" />
				</Service>
 			</Item>
		</Message>
       </receiveTemplate>
       <deliveryTemplate conditionEx="#{${dbresult}!=0}" terminating="true">
		<set item="Content" value="Perevod newozmojen, povtorite pozje" />
		<set item="Content" condition="//Item/@dbresult='-1'" value="Perevod newozmojen, povtorite pozje" />
		<set item="Content" condition="//Item/@dbresult='0'" value="S Vashego litsevogo scheta perevedeno #{/Message/Item/Service/Attribute[@name='amount']/@value div 100} r. abonentu #{/Message/Item/Service/Attribute[@name='receiver']/@value}" />
		<set item="Content" condition="//Item/@dbresult='320666'" value="Nevernij kod awtorizatsii" />
		<set item="Content" condition="//Item/@dbresult='320704'" value="Prediduschaja zajavka ne obrabotana, povtorite pozje" />
		<set item="Content" condition="//Item/@dbresult='320999'" value="Srok dejstwija koda awtorizatsii istek" />
		<set item="Content" condition="//Item/@dbresult='320362'" value="U abonenta #{/Message/Item/Service/Attribute[@name='receiver']/@value} otkljuchena vozmozhnost priema P-t-P" />
		<set item="Content" condition="//Item/@dbresult='320361'" value="Usluga zablokirovana, obratites w slujbu podderzhki" />
		<set item="Content" condition="//Item/@dbresult='320101'" value="Powtornij vvod informatsii, pojalujsta, sledujte instruktsii" />
		<set item="Content" condition="//Item/@dbresult='320714'" value="Dostignut predel chisla poluchatelej" />
		<set item="Content" condition="//Item/@dbresult='320710'" value="Slishkom malenkaja summa perevoda" />
		<set item="Content" condition="//Item/@dbresult='320701'" value="Slishkom bolshaja summa perevoda" />
		<set item="Content" condition="//Item/@dbresult='320711'" value="Ukazannaja summa previshaet limit perevodimih sredstv na segodnja" />
		<set item="Content" condition="//Item/@dbresult='320712'" value="Prevyshen limit dlya poluchatelya za sutki" />
		<set item="Content" condition="//Item/@dbresult='320713'" value="Nomer poluchatelja sovpadaet s Vashim nomerom, pojalujsta, povtorite vvod" />
		<set item="Content" condition="//Item/@dbresult='320709'" value="Usluga zablokirovana, obratites w slujbu podderzhki" />
		<set item="Content" condition="//Item/@dbresult='320191'" value="Na vashem schetu nedostatochno sredstv dlja perevoda abonentu #{/Message/Item/Service/Attribute[@name='receiver']/@value}" />
		<set item="Content" condition="//Item/@dbresult='320713'" value="Nomer poluchatelja sovpadaet s Vashim nomerom, pojalujsta, povtorite vvod" />
		<set item="Content" condition="//Item/@dbresult='320709'" value="Usluga zablokirovana, obratites w slujbu podderzhki" />
		<set item="Sender" value="363" />
		<set item="Recipient" value="${customer}" />
		<set item="Encoding" value="iso-8859-1" />
       </deliveryTemplate>
       <deliveryTemplate dropReply="true">
       </deliveryTemplate>
  </template>

  <template procedureName="rej_p2p">
	<condition>
		<test item="${Recipient}" matches="^363$" />
	</condition>
		<receiveTemplate>
		<Message> <Item customer="${Sender}" /> </Message>
       		</receiveTemplate>
	<deliveryTemplate direction="input">
		<set item="Content" value="Oshibka v zaprose - proverte i sozdayte zapros snowa v formate: 375xxxxxxxxx summa"/>
		<set item="Recipient" value="${customer}"/>
		<set item="Sender" value="363" />
		<set item="Encoding" value="iso-8859-1" />
	</deliveryTemplate>
  </template> 

</templates>
