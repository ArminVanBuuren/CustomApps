<templates connector="IVR">
	<macros>
  		<define name="_SMSCON" value="SMSCON_01" />
	</macros>

	<template procedureName="DB_PayVerification">
		<receiveTemplate>
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="${guid}">
				<Item customer="${customer}">
					<Service id="guaranteedpayment" action="6" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate />
		<input>
			<param name="customer" />
		</input>
		<output>
		    <param name="dbresult"	 type="3" value="0"/>
			<param name="maximumusd" type="3" value="0" />
			<param name="maximumrur" type="3" value="0" />
			<param name="balance" type="3" value="0" />
        </output>
	</template>
	
	<template procedureName="DB_PayAcceptance">
		<receiveTemplate>
			<Message type="serviceorder" initiator="ivrcon" id="${guid}" session_id="${guid}">
				<Item customer="${customer}">
					<Service id="guaranteedpayment" action="7">
						<Attribute name="amount" value="#{if('${amount}'='','',number('${amount}') * 100)}" />
						<Attribute name="currency" value="${currency}" />
					</Service>
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate terminating="false" />
		<deliveryTemplate conditionEx="#{${dbresult}=0}" connector="_SMSCON" call="GuaranteedPayment.Acceptance" />
		<input>
			<param name="customer" />
			<param name="currency" />
			<param name="amount" />
		</input>
		<output>
		    <param name="dbresult" type="3" value="0"/>
			<param name="maximumusd" type="3" value="0" />
			<param name="maximumrur" type="3" value="0" />
		    <param name="balance" type="3" value="0" />
		</output>
	</template>
	
	<template procedureName="DB_PromisedPaymentRetriev">
		<receiveTemplate>
			<Message type="retrievecustomerdata" initiator="ivrcon" id="${guid}" session_id="@{setSessionId(${guid})}">
			    <Item customer="${customer}" subject="get_guaranteedpayment" />
			    @{store(sIndex,#{number('${index}')+1})}
			</Message>
		</receiveTemplate>
		<deliveryTemplate conditionEx="#{'${count}'='0' or number('${sIndex}') > number('${count}') or 0 >= number('${sIndex}')}">
			<set item="param:dbresult" value="${dbresult}" />
			<set item="param:count" value="${count}" />
			<set item="param:day" value="" />
			<set item="param:currency" value="0" />
			<set item="param:intpartfracpart" value="0" />
			<set item="param:" conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<deliveryTemplate>
			<set item="param:dbresult" value="${dbresult}" />
			<set item="param:count" value="#{//Item/@count}" />
			<set item="param:day" value="#{//Item/row[${sIndex}]/Attribute[@name='expirationdate']/@value}" />
			<set item="param:currency" value="#{//Item/row[${sIndex}]/Attribute[@name='currency']/@value}" />
			<set item="param:intpartfracpart" value="#{//Item/row[${sIndex}]/Attribute[@name='intpartfracpart']/@value}" />
			<set item="param:" conditionEx="0@{freeSession}" />
		</deliveryTemplate>
		<input>
			<param name="customer" />
			<param name="index" />
		</input>
		<output>
		    <param name="dbresult" type="3" value="0" />
		    <param name="count" type="3" value="0" />
		    <param name="day" type="4" value="" />
		    <param name="currency" type="3" value="0" />
		    <param name="intpartfracpart" type="3" value="0" />
		</output>
	</template>

</templates>