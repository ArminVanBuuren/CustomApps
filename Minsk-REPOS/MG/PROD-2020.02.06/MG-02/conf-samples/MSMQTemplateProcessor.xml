<templates connector="MSMQ">
	<macros>
		<define name="_SMSCON" value="SMSCON_01" />
	</macros>

	<template procedureName="JustString">
		<condition>
			<test item="${Content}" matches="^testtest$" />
		</condition>
		<receiveTemplate>
			<Message type="verificationrequest" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="${Content}">
					<Attribute name="checkivrservice" value="2" />
					<Attribute name="checkblocks" value="2" />
				</Item>
			</Message>
		</receiveTemplate>
	    <deliveryTemplate direction="input" />
	</template>

	<template procedureName="Gateway">
		<condition>
			<test item="#{/Message/@type}" matches="^verificationrequest$" />
		</condition>
		<receiveTemplate />
		<deliveryTemplate direction="input" connector="_SMSCON" call="DeliveryRequestFromMSMQ" />
	</template>

  <template procedureName="RouteRequests" handler="DBCON_01" sessionStorage="Remoting" sessionLifetime="300" persistent="false">
    <receiveTemplate>
      <Message type="getsite" initiator="msmqcon" id="${guid}" session_id="@{setSessionId(${id})}">
        <Item procedureName="test_of_router.get_site">
          <Attribute name="p_msisdn"	type="STRING"	value="${customer}" />
          <Attribute name="p_site"	type="STRING" />
        </Item>
        @{store(sOrigin,OREL)}
        @{store(sContent,${no-escape:Content})}
      </Message>
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0 and '${p_site}'='MOSCOW'}">
      <set item="Content" value="${no-escape:sContent}" />
      <set item="DestQueue" value="MOSCOW_INPUT" />
      <set item="Label" value="CRM" />
    </deliveryTemplate>
    <deliveryTemplate>
      <set item="Content" value="${no-escape:sContent}" />
      <set item="DestQueue" value="OREL_INPUT" />
      <set item="Label" value="CRM" />
    </deliveryTemplate>
  </template>

  <template procedureName="RouteDeliveryRequests" persistent="false">
		<condition>
			<test item="#{Message/@request_id}" matches="" />
		</condition>
		<receiveTemplate>
			<Message id="${guid}" session_id="${guid}">
			    <Item content="${InputMessage.Content}" />
			</Message>
		</receiveTemplate>
	    <deliveryTemplate direction="input">
			<set item="Content" value="${no-escape:Content}" />
			<set item="DestQueue" value="MOSCOW_OUTPUT" />
			<set item="Label" value="CRM" />
		</deliveryTemplate>
	</template>

	<template procedureName="RouteResponses" sessionStorage="Remoting" sessionLifetime="300" persistent="false">
		<receiveTemplate>
			<Message id="${guid}" session_id="@{setSessionId(${request_id})}">
			    <Item content="${InputMessage.Content}" />
			</Message>
		</receiveTemplate>
	    <deliveryTemplate direction="input" conditionEx="#{'${sOrigin}'='OREL'}">
			<set item="Content" value="${no-escape:Content}" />
			<set item="DestQueue" value="OREL_OUTPUT" />
			<set item="Label" value="CRM" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
	    <deliveryTemplate direction="input">
			<set item="Content" value="${no-escape:Content}" />
			<set item="DestQueue" value="MOSCOW_OUTPUT" />
			<set item="Label" value="CRM" />
			<set conditionEx="0@{freeSession}" />
		</deliveryTemplate>
	</template>
	
	<template procedureName="BuildsOutgoingContentFast">
		<condition>
			<test item="#{/Message/@type}" matches="^verificationrequest$" />
		</condition>
		<receiveTemplate>
			<Message type="verificationrequest" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="#{/Message/Item/@customer}">
					<Attribute name="checkivrservice" value="2" />
					<Attribute name="checkblocks" value="2" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="Content" value="${no-escape:DbMessage.CrmXML}" />
			<set item="Label" value="TEST" />
			<set item="Priority" value="6" />
		</deliveryTemplate>
	</template>

	<template procedureName="BuildsOutgoingContentSlow">
		<condition>
			<test item="#{/Message/@type}" matches="^verificationrequest$" />
		</condition>
		<receiveTemplate>
			<Message type="verificationrequest" initiator="ivrcon" id="${guid}" session_id="@{newGuid}">
				<Item customer="#{/Message/Item/@customer}">
					<Attribute name="checkivrservice" value="2" />
					<Attribute name="checkblocks" value="2" />
				</Item>
			</Message>
		</receiveTemplate>
		<deliveryTemplate>
			<set item="Content" value="#{NodesetToString(Current())}" />
			<set item="Label" value="TEST" />
			<set item="Priority" value="6" />
		</deliveryTemplate>
	</template>

</templates>