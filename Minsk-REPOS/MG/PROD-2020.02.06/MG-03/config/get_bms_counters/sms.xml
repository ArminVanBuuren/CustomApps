<!--	
<templateGroup name="BMS">

<template procedureName="BMS_OrderGift_SMS" sessionStorage="Memory" sessionLifetime="120" >
    <condition>
	        <test item="${Recipient}" matches="^7070$" />
			<test item="${token0}" matches="^\d{2}$" /> 
			<test item="#{if(document('config\get_bms_counters\bmsgifts.xml')//gifts/gift/@number='${token0}',1,0)}" matches="1" />
			<test item="${Sender}" matches="^(375336036086|375297776601|375292502521|375292620793|375292537090|375292504781|375295544074)$"  />
    </condition>
    <receiveTemplate>
	      	<Message type="orderbonusgiftrequest" initiator="SMSCON" id="@{setMessageId(@{newGuid})}" session_id="@{setSessionId(@{newGuid})}">
				<Item customer="${Sender}">
					<Attribute name="giftcode" value="#{document('config\get_bms_counters\bmsgifts.xml')/gifts/gift[@number='${content}']/@code}" />
				</Item>
				@{store(sGCode,${content})} 				                  
			</Message>
    </receiveTemplate>
    <deliveryTemplate>
			<set item="Content" value="Произошла ошибка при заказе подарка." />
			<set item="Content" condition="//Item/@dbresult='320301'" value="Недостаточно бонусных баллов!" /> 
			<set item="Content" condition="//Item/@dbresult='0'" value="Вы заказали #{document('config\get_bms_counters\bmsgifts.xml')/gifts/gift[@number='${sGCode}']/@name}. Стоимость: ${ordercost} бонусных балов." />
            <set item="Recipient" value="${customer}" />
			<set item="Sender" value="0870" />
			<set item="Encoding" value="unicodefffe" />
	        <set conditionEx="0@{freeSession}" />
    </deliveryTemplate>
  </template>

   <template procedureName="BMS_OrderGift" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate>
      <set item="Content" value="Произошла ошибка при заказе подарка. Пожалуйста,повторите попытку позже." />            
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="0870" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>	
  </template>	 
	
    <template procedureName="BMS_OrderGift_Step2" persistent="false">
    <condition>
      <test item="0" matches="1" />
    </condition>
    <receiveTemplate>
      <Message />
    </receiveTemplate>
    <deliveryTemplate conditionEx="#{${dbresult}=0}">
      <set item="Content" value="Заказ подарка получен. Стоимость ${ordercost} бонусных балов" />            
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="0870" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>	
    <deliveryTemplate>
      <set item="Content" value="Произошла ошибка при заказе подарка." />            
      <set item="Encoding" value="unicodefffe" />
      <set item="Sender" value="0870" />
      <set item="Recipient" value="${customer}" />
    </deliveryTemplate>
  </template>	 
  
  <template procedureName="AddDelBMSService_LF" sessionStorage="Memory" sessionLifetime="100">
  <condition>
   <test item="${Recipient}" matches="^707$" />
   <test item="${Content}" matches="^(A|a|R|r)$"/>
   <test item="${Sender}" matches="^(375336036086|375297776601|375292502521|375292620793|375292537090|375292504781|375295544074)$"  />
   </condition> 
  <receiveTemplate>
    <Message type="serviceorder" initiator="smscon" id="@{newGuid}" session_id="${session_id}">
     <Item customer="${Sender}">
      <Service id="FRBONBPS" service_id="FRBONBPS" action="@{switch(${Token0}|2,a|2,A|2,R|3,r|3)}"/>
     </Item> 
    </Message> 
  </receiveTemplate>
   <deliveryTemplate>
  <set item="Content" value="К сожалению, произошла ошибка. Попробуйте еще раз." />
  <set item="Content" condition="//Item/@dbresult=320191" value="На балансе недостаточно средств для проведения операции." />
  <set item="Content" condition="//Item/@dbresult=320174" value="Неверно задана операция." />
  <set item="Content" condition="//Item/@dbresult=320172" value="Неверно задана услуга." />
  <set item="Content" condition="//Item/@dbresult=320173" value="На тарифном плане нет данной услуги." />
  <set item="Content" condition="//Item/@dbresult=320203" value="Существует заявка на удаление услуги." />
  <set item="Content" condition="//Item/@dbresult=320204" value="Существует заявка на добавление услуги." />
  <set item="Content" condition="//Item/@dbresult=320205" value="Услуга уже существует." />
  <set item="Content" condition="//Item/@dbresult=320206" value="Услуга не назначена." />
  <set item="Content" condition="//Item/@dbresult=0" value="Заявка успешно принята." />
  <set item="Content" condition="//Item/@dbresult=-1" value="Данный запрос не может быть выполнен." />
  <set item="Sender" value="0870" />
  <set item="Recipient" value="${customer}" />
  <set item="Encoding" value="unicodefffe" />

   </deliveryTemplate>
 
 </template>
 
 <template procedureName="wrongformat_707" persistent="false">
    	<condition>
        	<test item="${Recipient}" matches="^707$" />
			<test item="${Sender}" matches="^(375336036086|375297776601|375292502521|375292620793|375292537090|375292504781|375295544074)$" />
    	</condition>
   	<receiveTemplate>
    		<Message initiator="smscon" id="${guid}" session_id="@{newGuid}">
      			<Item customer="${Sender}" />
    		</Message>
   	</receiveTemplate>
    	<deliveryTemplate direction="input">
		<set item="Content" value="Неправильный формат запроса" />
		<set item="Sender" value="0870" />
		<set item="Recipient" value="${customer}" />
		<set item="Encoding" value="unicodefffe" />
	</deliveryTemplate>
</template>

</templateGroup>
-->
	<template procedureName="DB_AddRemoveService">
        <condition>
            <test item="0" matches="1" />
        </condition>
	<retry delay="300" attempts="2" />
        <deliveryTemplate>
            <set item="Content" value="#{//Content/text()}" />
            <set item="Sender" value="0870" />
            <set item="Recipient" value="${customer}" />
            <set item="Encoding" value="ascii" />
            <set item="ScheduleDeliveryTime" value="#{getTimeInRange('08:00','23:30')}" />  <!-- 000000HHMMSS000R -->
            <set item="ValidityPeriod" value="#{getTimeInRange('11:00','23:30')}" />  <!-- 000000HHMMSS000R -->
            <set item="RegisteredDelivery" value="false" />
        </deliveryTemplate>
	 </template>

	<template procedureName="DeliveryRequestBMS">
        <condition>
            <test item="0" matches="1" />
        </condition>
	<retry delay="300" attempts="2" />
        <deliveryTemplate >
            <set item="Content" value="#{//Content/text()}" />
            <set item="Sender" value="0870" />
            <set item="Recipient" value="${customer}" />
            <set item="Encoding" value="ascii" />
            <set item="ScheduleDeliveryTime" value="#{getTimeInRange('08:00','23:30')}" />  
            <set item="ValidityPeriod" value="#{getTimeInRange('11:00','23:30')}" />  
            <set item="RegisteredDelivery" value="false" />
        </deliveryTemplate>
	 </template> 

<!--	<template procedureName="DeliveryRequestBMS">
        <condition>
            <test item="0" matches="1" />
        </condition>
	<deliveryTemplate dropReply="true" /> 
	 </template> 	 
-->	 
	 
	<template procedureName="DeliveryRequestIssa" persistent="false">
	<retry delay="300" attempts="2" />
	<deliveryTemplate>
      <set item="Content" value="#{//Content/text()}" />
      <set item="Sender" value="#{if(substring('${Sender}',1,3)='375','1241${Sender}','0870')}" />
      <set item="Recipient" value="${customer}" />
      <set item="Encoding" value="#{//Content/@charset}" />
      <set item="Encoding" condition="not(//Content/@charset)" value="unicodefffe" />
      <set item="ValidityPeriod" condition = "//Item/@validityPeriod" value="${validityPeriod}" />
      <set item="ScheduleDeliveryTime" condition = "//Item/@scheduleTime" value="${scheduleTime}" />
	</deliveryTemplate> 
	</template> 


<!--	<template procedureName="DeliveryRequestIssa" persistent="false">
        <condition>
            <test item="0" matches="1" />
        </condition>
	<deliveryTemplate dropReply="true" /> 
	 </template>  
-->	 

