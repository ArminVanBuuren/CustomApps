<Command Name="SC.ChangeTariff.Composite">
  <Description>Смена тарифного плана одной большой командой на ФП</Description>
  <Author Name="Daniil Lukinov" Date="2019-09-02+12:00" />
  <Properties GenerationType="DataSetXml" />
  <Request>
    <RequestTemplate>
      <![CDATA[
        <DataSet Name="SendRequestDataSet">
          <Attributes>
            <Attribute Name="Operations" Type="System.String" Value="CreatePA, CreateTDC, ChangeTariffPlanAndServices, ManageFnFNumbers"/>
            <Attribute Name="Protocol" Type="System.String" Value="AsyncWcf"/>
            <Attribute Name="ClientId" Type="System.String" Value="[SCP_MARKER]"/>
          </Attributes>
          
          <DataTable Name="CreatePADataTable">
            <Columns>
              <Column Name="REQUEST_ID" Type="System.String"/>
              <Column Name="PERSONAL_ACCOUNT_ID" Type="System.Int64"/>
              <Column Name="BALANCE" Type="System.Decimal"/>
              <Column Name="CURRENCY_CODE" Type="System.String"/>
              <Column Name="PA_BALANCE_STATUS" Type="System.Int32"/>
              <Column Name="PA_STATUS" Type="System.Int32"/>
              <Column Name="SERVICE_PROVIDER_CODE" Type="System.Int32"/>
              <Column Name="BLOCK_LIMIT" Type="System.Decimal"/>
              <Column Name="UNBLOCK_LIMIT" Type="System.Decimal"/>
              <Column Name="PARTIAL_BLOCK_LIMIT" Type="System.Decimal"/>
              <Column Name="EXPIRES" Type="System.DateTime"/>
              <Column Name="EXPIRATION_DATE_MONITOR" Type="System.Int32"/>
              <Column Name="ADMIN_BLOCK" Type="System.Int32"/>
              <Column Name="ADMIN_BLOCKED_DATE" Type="System.DateTime"/>
              <Column Name="BLOCKED_END_DATE" Type="System.String"/>
              <Column Name="TAX_GROUP_ID" Type="System.Int32"/>
              <Column Name="CUSTOMER_TYPE_ID" Type="System.Int32"/>
              <Column Name="MAX_BLOCKED_PERIOD" Type="System.Int32"/>
              <Column Name="AFTER_GRACE_PERIOD" Type="System.Int32"/>
              <Column Name="IS_GRACE_STARTS_ON_BLOCK" Type="System.Int32"/>
              <Column Name="VALIDITY_PERIOD" Type="System.Int32"/>
              <Column Name="NOTIFICATION_LIMITS" Type="System.String"/>
              <Column Name="PA_STATUS_CHANGE_DATE" Type="System.DateTime"/>
              <Column Name="PA_BALANCE_STATUS_CHANGE_DATE" Type="System.DateTime"/>
              <Column Name="PSP_DAY_OF_MONTH" Type="System.Int32"/>
              <Column Name="BILLING_GROUP_ID" Type="System.Int64"/>
              <Column Name="KEEP_BALANCES" Type="System.Boolean"/>
            </Columns>
            <Rows>
              <Row REQUEST_ID="##ASYNC_REQUEST_ID##" PERSONAL_ACCOUNT_ID="##PersonalAccount##" BALANCE="##SC.BALANCE##" CURRENCY_CODE="##SC.CURRENCY_CODE##" 
        ##SC.PA_BALANCE_STATUS## PA_STATUS="##SC.PA_STATUS##" ##SC.SERVICE_PROVIDER_CODE## BLOCK_LIMIT="##SC.BLOCK_LIMIT##" UNBLOCK_LIMIT="##SC.UNBLOCK_LIMIT##" 
        PARTIAL_BLOCK_LIMIT="##SC.PARTIAL_BLOCK_LIMIT##" EXPIRES="##SC.EXPIRES##" EXPIRATION_DATE_MONITOR="##SC.EXPIRATION_DATE_MONITOR##" ##SC.PA.ADMIN_BLOCK## 
        ##SC.PA.ADMIN_BLOCKED_DATE## ##SC.BLOCKED_END_DATE## TAX_GROUP_ID="##TAX_GROUP_ID##" CUSTOMER_TYPE_ID="##CUSTOMER_TYPE_ID##" 
        MAX_BLOCKED_PERIOD="##SC.MAX_BLOCKED_PERIOD##" AFTER_GRACE_PERIOD="##SC.AFTER_GRACE_PERIOD##" IS_GRACE_STARTS_ON_BLOCK="##SC.IS_GRACE_STARTS_ON_BLOCK##"
        VALIDITY_PERIOD="##SC.VALIDITY_PERIOD##" ##PA_STATUS_CHANGE_DATE## ##PA_BALANCE_STATUS_CHANGE_DATE## ##PSP_DAY_OF_MONTH## BILLING_GROUP_ID="##BILLING_GROUP_ID##" 
        KEEP_BALANCES="##SC.KEEP_BALANCES##"/>
            </Rows>
          </DataTable>
          
           <DataTable Name="CreateTDCDataTable">
            <Columns>
              <Column Name="REQUEST_ID" Type="System.String"/>
              <Column Name="PERSONAL_ACCOUNT_ID" Type="System.Int64"/>
              <Column Name="TERMINAL_DEVICE_CONTRACT_ID" Type="System.Int64"/>
              <Column Name="TARIFF_PLAN_ID" Type="System.Int32"/>
              <Column Name="BILLING_GROUP_ID" Type="System.Int64"/>
              <Column Name="TERMINAL_DEVICE_STATE" Type="System.Int32"/>
              <Column Name="ADMIN_BLOCK" Type="System.Int32"/>
              <Column Name="ADMIN_BLOCKED_DATE" Type="System.DateTime"/>
              <Column Name="FIRST_CALL_END_DATE" Type="System.DateTime"/>
              <Column Name="MAX_INACTIVE_PERIOD" Type="System.Int32"/>
              <Column Name="MSISDN" Type="System.String"/>
              <Column Name="IMSI" Type="System.String"/>
              <Column Name="LANGUAGE" Type="System.String"/>
              <Column Name="TIME_ZONE" Type="System.Int32"/>
              <Column Name="PRIVATE_USER_GROUPS" Type="System.String"/>
              <Column Name="TERMINAL_DEVICE_CLASS" Type="System.Int32"/>
              <Column Name="SMS_USSD_LANG" Type="System.Int32"/>
              <Column Name="KEEP_BALANCES" Type="System.Boolean"/>
            </Columns>
            <Rows>
              <Row REQUEST_ID="##ASYNC_REQUEST_ID##" PERSONAL_ACCOUNT_ID="##PersonalAccount##" TERMINAL_DEVICE_CONTRACT_ID="##TerminalDeviceID##" 
        TARIFF_PLAN_ID="##TARIFF_PLAN_ID##" BILLING_GROUP_ID="##BILLING_GROUP_ID##" TERMINAL_DEVICE_STATE="##SC.TERMINAL_DEVICE_STATE##" ##SC.TD.ADMIN_BLOCK## 
        ##SC.TD.ADMIN_BLOCKED_DATE## ##SC.FIRST_CALL_END_DATE## MAX_INACTIVE_PERIOD="##SC.MAX_INACTIVE_PERIOD##" MSISDN="##msisdn##" IMSI="##imsi##" LANGUAGE="##LANGUAGE##" 
        TIME_ZONE="##SC.TIME_ZONE##" PRIVATE_USER_GROUPS="##PRIVATE_USER_GROUPS##" TERMINAL_DEVICE_CLASS="##TERMINAL_DEVICE_CLASS##" SMS_USSD_LANG="##SC.SMS_USSD_LANG##" 
        KEEP_BALANCES="##SC.KEEP_BALANCES##"/>
            </Rows>
          </DataTable>
          
          <DataTable Name="ChangeTariffPlanDataTable">
            <Columns>
              <Column Name="REQUEST_ID" Type="System.String"/>
              <Column Name="TERMINAL_DEVICE_CONTRACT_ID" Type="System.Int64"/>
              <Column Name="OLD_TARIFF_PLAN_ID" Type="System.Int32"/>
              <Column Name="NEW_TARIFF_PLAN_ID" Type="System.Int32"/>
            </Columns>
            <Rows>
              <Row REQUEST_ID="##ASYNC_REQUEST_ID##" TERMINAL_DEVICE_CONTRACT_ID="##TerminalDeviceID##"
                   OLD_TARIFF_PLAN_ID="##OLD_TARIFF_PLAN_ID##" NEW_TARIFF_PLAN_ID="##NEW_TARIFF_PLAN_ID##"/>
            </Rows>
          </DataTable>
          
          <DataTable Name="LowBalanceLimitsDataTable">
            <Columns>
              <Column Name="PERSONAL_ACCOUNT_ID" Type="System.Int64"/>
              <Column Name="LIMIT_VALUE" Type="System.Decimal"/>
              <Column Name="LIMIT_LEVEL" Type="System.Decimal"/>
            </Columns>
            <Rows>
              ##Limits##
            </Rows>
          </DataTable>
          
          <DataTable Name="ServiceCodeDataTable">
            <Columns>
              <Column Name="SERVICE_ROW_ID" Type="System.Int64"/>
              <Column Name="REQUEST_ID" Type="System.String"/>
              <Column Name="PERSONAL_ACCOUNT_ID" Type="System.Int64"/>
              <Column Name="TERMINAL_DEVICE_CONTRACT_ID" Type="System.Int64"/>
              <Column Name="SERVICE_CODE" Type="System.String"/>
            </Columns>
            <Rows>
              ##InitialServices##
              ##InitialFavoriteNumbersServices##
            </Rows>
          </DataTable>
          
          <DataTable Name="ServiceParameters">
            <Columns>
              <Column Name="SERVICE_ROW_ID" Type="System.Int64"/>
              <Column Name="PARAM_CODE" Type="System.String"/>
              <Column Name="PARAM_VALUE" Type="System.String"/>
            </Columns>
            <Rows>
              ##InitialServicesParams##
            </Rows>
          </DataTable>
          
          <DataTable Name="NewServiceCodeDataTable">
            <Columns>
              <Column Name="SERVICE_ROW_ID" Type="System.Int64"/>
              <Column Name="REQUEST_ID" Type="System.String"/>
              <Column Name="PERSONAL_ACCOUNT_ID" Type="System.Int64"/>
              <Column Name="TERMINAL_DEVICE_CONTRACT_ID" Type="System.Int64"/>
              <Column Name="SERVICE_CODE" Type="System.String"/>
            </Columns>
            <Rows>
              ##RegisteredServices##
              ##PAServices##
              ##RegisteredFavoriteNumbersServices##
              ##CugServices##
            </Rows>
          </DataTable>
          
          <DataTable Name="NewServiceParameters">
            <Columns>
              <Column Name="SERVICE_ROW_ID" Type="System.Int64"/>
              <Column Name="PARAM_CODE" Type="System.String"/>
              <Column Name="PARAM_VALUE" Type="System.String"/>
            </Columns>
            <Rows>
              ##RegisteredServicesParams##
              ##PAServicesParams##
            </Rows>
          </DataTable>  
          
          <DataTable Name="TDCIdentitiesDataTable">
            <Columns>
              <Column Name="REQUEST_ID" Type="System.String"/>
              <Column Name="TERMINAL_DEVICE_CONTRACT_ID" Type="System.Int64"/>
              <Column Name="IDENTITY_TYPE" Type="System.Int32"/>
              <Column Name="IDENTITY_VALUE" Type="System.String"/>
            </Columns>
            <Rows>##AdditionalNumbers##</Rows>
          </DataTable>
          
          <DataTable Name="ManageFnFDataTable">
            <Columns>
              <Column Name="REQUEST_ID" Type="System.String"/>
              <Column Name="TERMINAL_DEVICE_CONTRACT_ID" Type="System.Int64"/>
              <Column Name="PERSONAL_ACCOUNT_ID" Type="System.Int64"/>
              <Column Name="FNF_POSITION" Type="System.Int32"/>
              <Column Name="FNF_NUMBER" Type="System.String"/>
              <Column Name="EXTENDED_SERVICE_CODE" Type="System.String"/>
              <Column Name="ACTION" Type="System.Int32"/>
            </Columns>
            <Rows>##FavoriteNumbers##</Rows>
          </DataTable>
          
        </DataSet>
      ]]>
    </RequestTemplate>
    <EmulationPrintoutTemplate>
      <![CDATA[]]>
    </EmulationPrintoutTemplate>
    <Item Name="TerminalDeviceID" Type="Wellknown" />
    <Item Name="PersonalAccount" Type="Wellknown" />
    <Item Name="InitialServices" Type="LocalDynamicParameter" />
    <Item Name="InitialFavoriteNumbersServices" Type="LocalDynamicParameter" />
    <Item Name="InitialServicesParams" Type="LocalDynamicParameter" />
    <Item Name="RegisteredServices" Type="LocalDynamicParameter" />
    <Item Name="PAServices" Type="LocalDynamicParameter" />
    <Item Name="RegisteredFavoriteNumbersServices" Type="LocalDynamicParameter" />
    <Item Name="CugServices" Type="LocalDynamicParameter" />
    <Item Name="RegisteredServicesParams" Type="LocalDynamicParameter" />
    <Item Name="PAServicesParams" Type="LocalDynamicParameter" />
    <Item Name="Limits" Type="LocalDynamicParameter" />
    <Item Name="FavoriteNumbers" Type="LocalDynamicParameter" />
    <Item Name="AdditionalNumbers" Type="LocalDynamicParameter" />
    <Item Name="SC.BALANCE" Type="Parameter" />
    <Item Name="SC.CURRENCY_CODE" Type="Parameter" />
    <Item Name="SC.PA_STATUS" Type="Parameter" />
    <Item Name="SC.SERVICE_PROVIDER_CODE" Type="Parameter" />
    <Item Name="SC.BLOCK_LIMIT" Type="Parameter" />
    <Item Name="SC.UNBLOCK_LIMIT" Type="Parameter" />
    <Item Name="SC.PARTIAL_BLOCK_LIMIT" Type="Parameter" />
    <Item Name="SC.EXPIRES" Type="Parameter" />
    <Item Name="SC.EXPIRATION_DATE_MONITOR" Type="Parameter" />
    <Item Name="SC.BLOCKED_END_DATE" Type="Parameter" />
    <Item Name="TAX_GROUP_ID" Type="Parameter" />
    <Item Name="SC.MAX_BLOCKED_PERIOD" Type="Parameter" />
    <Item Name="SC.AFTER_GRACE_PERIOD" Type="Parameter" />
    <Item Name="SC.IS_GRACE_STARTS_ON_BLOCK" Type="Parameter" />
    <Item Name="SC.VALIDITY_PERIOD" Type="Parameter" />
    <Item Name="CUSTOMER_TYPE_ID" Type="Parameter" />
    <Item Name="datetime" Type="Wellknown" />
    <Item Name="SC.PA_BALANCE_STATUS" Type="Parameter" />
    <Item Name="PA_STATUS_CHANGE_DATE" Type="Parameter" />
    <Item Name="PA_BALANCE_STATUS_CHANGE_DATE" Type="Parameter" />
    <Item Name="PSP_DAY_OF_MONTH" Type="Parameter" />
    <Item Name="BILLING_GROUP_ID" Type="Parameter" />
    <Item Name="SC.KEEP_BALANCES" Type="Parameter" />
    <Item Name="TARIFF_PLAN_ID" Type="Parameter" />
    <Item Name="SC.TERMINAL_DEVICE_STATE" Type="Parameter" />
    <Item Name="SC.FIRST_CALL_END_DATE" Type="Parameter" />
    <Item Name="SC.MAX_INACTIVE_PERIOD" Type="Parameter" />
    <Item Name="msisdn" Type="Wellknown" />
    <Item Name="imsi" Type="Wellknown" />
    <Item Name="LANGUAGE" Type="Parameter" />
    <Item Name="SC.TIME_ZONE" Type="Parameter" />
    <Item Name="PRIVATE_USER_GROUPS" Type="Constant" />
    <Item Name="TERMINAL_DEVICE_CLASS" Type="Parameter" />
    <Item Name="SC.SMS_USSD_LANG" Type="Parameter" />
    <Item Name="SC.PA.ADMIN_BLOCK" Type="LocalParameter" />
    <Item Name="SC.PA.ADMIN_BLOCKED_DATE" Type="LocalParameter" />
    <Item Name="SC.TD.ADMIN_BLOCK" Type="LocalParameter" />
    <Item Name="SC.TD.ADMIN_BLOCKED_DATE" Type="LocalParameter" />
    <Item Name="OLD_TARIFF_PLAN_ID" Type="LocalParameter" />
    <Item Name="NEW_TARIFF_PLAN_ID" Type="LocalParameter" />
  </Request>
  <ParametersList>
    <Parameter Name="SC.PA.ADMIN_BLOCK">
      <Source Path="//AdditionalData/AddList//PaStatus/BlockStatus" AbsenceValue="" PostFormat="ADMIN_BLOCK=&quot;{0}&quot;" />
    </Parameter>
    <Parameter Name="SC.PA.ADMIN_BLOCKED_DATE">
      <Source Path="//AdditionalData/AddList//PaStatus/AdminBlockedDate[string-length(.) &gt; 0]" AbsenceValue="" PostFormat="ADMIN_BLOCKED_DATE=&quot;{0}&quot;" />
    </Parameter>
    <Parameter Name="SC.TD.ADMIN_BLOCK">
      <Source Path="//AdditionalData/AddList//TdStatus/BlockStatus" AbsenceValue="" PostFormat="ADMIN_BLOCK=&quot;{0}&quot;" />
      <PossibleValues StringToKeyTable="true" />
    </Parameter>
    <Parameter Name="SC.TD.ADMIN_BLOCKED_DATE">
      <Source Path="//AdditionalData/AddList//TdStatus/AdminBlockedDate[string-length(.) &gt; 0]" AbsenceValue="" PostFormat="ADMIN_BLOCKED_DATE=&quot;{0}&quot;" />
      <PossibleValues StringToKeyTable="true" />
    </Parameter>
    <Parameter Name="OLD_TARIFF_PLAN_ID">
      <Source Path="//AdditionalData//ChangeTP/PreviousTariffPlanId" />
    </Parameter>
    <Parameter Name="NEW_TARIFF_PLAN_ID">
      <Source Path="//AdditionalData//ChangeTP/NewTariffPlanId" />
    </Parameter>
  </ParametersList>
  <DynamicParametersList>
    <DynamicParameter Name="InitialServices">
      <Source Path="//string" />
      <DynamicObject Name="InitialServices" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="InitialFavoriteNumbersServices">
      <Source Path="//string" />
      <DynamicObject Name="InitialFavoriteNumbersServices" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="InitialServicesParams">
      <Source Path="//string" />
      <DynamicObject Name="InitialServicesParams" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="RegisteredServices">
      <Source Path="//string" />
      <DynamicObject Name="RegisteredServices" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="PAServices">
      <Source Path="//string" />
      <DynamicObject Name="PAServices" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="RegisteredFavoriteNumbersServices">
      <Source Path="//string" />
      <DynamicObject Name="RegisteredFavoriteNumbersServices" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="CugServices">
      <Source Path="//string" />
      <DynamicObject Name="CugServices" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="RegisteredServicesParams">
      <Source Path="//string" />
      <DynamicObject Name="RegisteredServicesParams" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="PAServicesParams">
      <Source Path="//string" />
      <DynamicObject Name="PAServicesParams" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="FavoriteNumbers">
      <Source Path="//string" />
      <DynamicObject Name="FavoriteNumbers" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="AdditionalNumbers">
      <Source Path="//string" />
      <DynamicObject Name="AdditionalNumbers" SkipMissed="True" />
    </DynamicParameter>
    <DynamicParameter Name="Limits">
      <Source Path="//string" />
      <DynamicObject Name="Limits" SkipMissed="True" />
    </DynamicParameter>
  </DynamicParametersList>
</Command>